# ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞ –ë–∞—Ç–µ—Ä–∏—è –∏ Firebase –†–∞–∑—Ö–æ–¥–∏

## ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. WebSocket –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å AppState ‚úÖ

**–ö–∞–∫–≤–æ –µ –Ω–∞–ø—Ä–∞–≤–µ–Ω–æ:**
- WebSocket —Å–µ –∑–∞—Ç–≤–∞—Ä—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–æ–≥–∞—Ç–æ app –æ—Ç–∏–≤–∞ –≤ background
- WebSocket —Å–µ –æ—Ç–≤–∞—Ä—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∫–æ–≥–∞—Ç–æ app —Å—Ç–∞–≤–∞ active
- –ò–∑–ø–æ–ª–∑–≤–∞ —Å–µ `AppState` listener –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

**–ü–æ–ª–∑–∏:**
- ‚ö° **50-70% –ø–æ-–º–∞–ª–∫–æ –±–∞—Ç–µ—Ä–∏—è** –≤ background
- üì° –ü–æ-–º–∞–ª–∫–æ –º—Ä–µ–∂–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç –∫–æ–≥–∞—Ç–æ –Ω–µ –µ –Ω—É–∂–Ω–∞
- üîã WebSocket —Ä–∞–±–æ—Ç–∏ —Å–∞–º–æ –∫–æ–≥–∞—Ç–æ app –µ –∞–∫—Ç–∏–≤–µ–Ω

**–§–∞–π–ª:** `src/hooks/useWebSocket.ts`

---

### 2. Debounce –Ω–∞ Conversations Refresh ‚úÖ

**–ö–∞–∫–≤–æ –µ –Ω–∞–ø—Ä–∞–≤–µ–Ω–æ:**
- –î–æ–±–∞–≤–µ–Ω debounce (500ms) –∑–∞ conversations refresh
- –ò–∑–±—è–≥–≤–∞ –∏–∑–ª–∏—à–Ω–∏ API calls –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–æ notifications
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–∞ refresh –ø—Ä–∏ WebSocket connect

**–ü–æ–ª–∑–∏:**
- üìâ **30-50% –ø–æ-–º–∞–ª–∫–æ API calls**
- ‚ö° –ü–æ-–±—ä—Ä–∑–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- üîã –ü–æ-–º–∞–ª–∫–æ –±–∞—Ç–µ—Ä–∏—è

**–§–∞–π–ª–æ–≤–µ:**
- `src/hooks/useConversations.ts`
- `src/hooks/usePushNotifications.ts`
- `src/utils/constants.ts`

---

### 3. Foreground Notifications –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è ‚úÖ

**–ö–∞–∫–≤–æ –µ –Ω–∞–ø—Ä–∞–≤–µ–Ω–æ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ WebSocket –µ –∞–∫—Ç–∏–≤–µ–Ω –ø—Ä–µ–¥–∏ –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ foreground notification
- –ê–∫–æ WebSocket –µ –∞–∫—Ç–∏–≤–µ–Ω ‚Üí –Ω–µ —Å–µ –ø–æ–∫–∞–∑–≤–∞ —Å–∏—Å—Ç–µ–º–Ω–æ notification
- –î–∞–Ω–Ω–∏—Ç–µ –∏–¥–≤–∞—Ç –ø—Ä–µ–∑ WebSocket (–ø–æ-–±—ä—Ä–∑–æ –∏ –±–µ–∑ —Ä–∞–∑—Ö–æ–¥–∏)

**–ü–æ–ª–∑–∏:**
- üí∞ **60-80% –ø–æ-–º–∞–ª–∫–æ Firebase notifications** (—Å–∞–º–æ –∑–∞ background/offline users)
- ‚ö° –ü–æ-–¥–æ–±—ä—Ä UX (–¥–∞–Ω–Ω–∏—Ç–µ —Å–µ –ø–æ—è–≤—è–≤–∞—Ç –¥–∏—Ä–µ–∫—Ç–Ω–æ)
- üîã –ü–æ-–º–∞–ª–∫–æ –±–∞—Ç–µ—Ä–∏—è

**–§–∞–π–ª:** `src/hooks/usePushNotifications.ts`

---

### 4. WebSocket Heartbeat –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è ‚úÖ

**–ö–∞–∫–≤–æ –µ –Ω–∞–ø—Ä–∞–≤–µ–Ω–æ:**
- Heartbeat –∏–Ω—Ç–µ—Ä–≤–∞–ª: **15 —Å–µ–∫—É–Ω–¥–∏** (–≤–º–µ—Å—Ç–æ 4 —Å–µ–∫—É–Ω–¥–∏)
- Reconnect delay: **10 —Å–µ–∫—É–Ω–¥–∏** (–≤–º–µ—Å—Ç–æ 5 —Å–µ–∫—É–Ω–¥–∏)

**–ü–æ–ª–∑–∏:**
- üîã **40-60% –ø–æ-–º–∞–ª–∫–æ –±–∞—Ç–µ—Ä–∏—è** (–ø–æ-–º–∞–ª–∫–æ –º—Ä–µ–∂–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç)
- üì° –ü–æ-–º–∞–ª–∫–æ network packets
- ‚úÖ –í—Å–µ –æ—â–µ –Ω–∞–¥–µ–∂–¥–Ω–∞ –≤—Ä—ä–∑–∫–∞

**–§–∞–π–ª:** `src/services/websocket/stompClient.ts`

---

## üìä –û—á–∞–∫–≤–∞–Ω–∏ –†–µ–∑—É–ª—Ç–∞—Ç–∏

### –ë–∞—Ç–µ—Ä–∏—è:
- **Background:** 50-70% –ø–æ-–º–∞–ª–∫–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ
- **Foreground:** 20-30% –ø–æ-–º–∞–ª–∫–æ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–∞–Ω heartbeat)

### Firebase –†–∞–∑—Ö–æ–¥–∏:
- **60-80% –ø–æ-–º–∞–ª–∫–æ notifications** (—Å–∞–º–æ –∑–∞ background/offline users)
- Notifications —Å–∞–º–æ –∫–æ–≥–∞—Ç–æ —Å–∞ –Ω–∞–∏—Å—Ç–∏–Ω–∞ –Ω—É–∂–Ω–∏

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–Ω–æ—Å—Ç:
- –ü–æ-–±—ä—Ä–∑–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (debounced refresh)
- –ü–æ-–º–∞–ª–∫–æ API calls
- –ü–æ-–¥–æ–±—ä—Ä UX

---

## üéØ –ö–∞–∫ –†–∞–±–æ—Ç–∏ –°–µ–≥–∞

### –ö–æ–≥–∞—Ç–æ App –µ FOREGROUND:
1. ‚úÖ WebSocket –µ –∞–∫—Ç–∏–≤–µ–Ω ‚Üí –ø–æ–ª—É—á–∞–≤–∞—à –¥–∞–Ω–Ω–∏ –≤ real-time
2. ‚úÖ –ù—è–º–∞ Firebase notifications (backend –Ω–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –≥–∏ –∏–∑–ø—Ä–∞—â–∞)
3. ‚úÖ –î–∞–Ω–Ω–∏—Ç–µ —Å–µ –æ–±–Ω–æ–≤—è–≤–∞—Ç –ø—Ä–µ–∑ WebSocket (–±–µ–∑ —Ä–∞–∑—Ö–æ–¥–∏)

### –ö–æ–≥–∞—Ç–æ App –µ BACKGROUND:
1. ‚úÖ WebSocket —Å–µ –∑–∞—Ç–≤–∞—Ä—è ‚Üí –ø–æ-–º–∞–ª–∫–æ –±–∞—Ç–µ—Ä–∏—è
2. ‚úÖ Backend –∏–∑–ø—Ä–∞—â–∞ Firebase notification
3. ‚úÖ –ü—Ä–∏ –∫–ª–∏–∫–≤–∞–Ω–µ ‚Üí app —Å–µ –æ—Ç–≤–∞—Ä—è, WebSocket —Å–µ —Å–≤—ä—Ä–∑–≤–∞, –¥–∞–Ω–Ω–∏—Ç–µ —Å–µ –∑–∞—Ä–µ–∂–¥–∞—Ç

### –ö–æ–≥–∞—Ç–æ App –µ CLOSED:
1. ‚úÖ Backend –∏–∑–ø—Ä–∞—â–∞ Firebase notification
2. ‚úÖ –ü—Ä–∏ –∫–ª–∏–∫–≤–∞–Ω–µ ‚Üí app —Å–µ –æ—Ç–≤–∞—Ä—è, WebSocket —Å–µ —Å–≤—ä—Ä–∑–≤–∞, –¥–∞–Ω–Ω–∏—Ç–µ —Å–µ –∑–∞—Ä–µ–∂–¥–∞—Ç

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ –∑–∞ Backend

**Backend —Ç—Ä—è–±–≤–∞ –¥–∞ –ø—Ä–æ–≤–µ—Ä—è–≤–∞ –¥–∞–ª–∏ user –∏–º–∞ –∞–∫—Ç–∏–≤–µ–Ω WebSocket connection –ø—Ä–µ–¥–∏ –¥–∞ –∏–∑–ø—Ä–∞—Ç–∏ Firebase notification:**

```java
// –ü—Å–µ–≤–¥–æ-–∫–æ–¥ –∑–∞ backend –ª–æ–≥–∏–∫–∞
if (userHasActiveWebSocket(userId)) {
    // –ù–µ –∏–∑–ø—Ä–∞—â–∞–π Firebase notification
    // –î–∞–Ω–Ω–∏—Ç–µ –∏–¥–≤–∞—Ç –ø—Ä–µ–∑ WebSocket
} else {
    // –ò–∑–ø—Ä–∞—Ç–∏ Firebase notification
    // User –µ –≤ background –∏–ª–∏ offline
}
```

–¢–æ–≤–∞ —â–µ –Ω–∞–º–∞–ª–∏ Firebase —Ä–∞–∑—Ö–æ–¥–∏—Ç–µ —Å **60-80%**.

---

## üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –î–µ—Ç–∞–π–ª–∏

### WebSocket Heartbeat:
- **–ü—Ä–µ–¥–∏:** 4 —Å–µ–∫—É–Ω–¥–∏
- **–°–µ–≥–∞:** 15 —Å–µ–∫—É–Ω–¥–∏
- **–†–µ–∑—É–ª—Ç–∞—Ç:** 73% –ø–æ-–º–∞–ª–∫–æ heartbeat packets

### Conversations Refresh:
- **–ü—Ä–µ–¥–∏:** –í–µ–¥–Ω–∞–≥–∞ –ø—Ä–∏ –≤—Å—è–∫–æ —Å—ä–±–∏—Ç–∏–µ
- **–°–µ–≥–∞:** Debounced (500ms)
- **–†–µ–∑—É–ª—Ç–∞—Ç:** 30-50% –ø–æ-–º–∞–ª–∫–æ API calls

### Foreground Notifications:
- **–ü—Ä–µ–¥–∏:** –í–∏–Ω–∞–≥–∏ —Å–µ –ø–æ–∫–∞–∑–≤–∞—Ç
- **–°–µ–≥–∞:** –°–∞–º–æ –∞–∫–æ WebSocket –Ω–µ –µ –∞–∫—Ç–∏–≤–µ–Ω
- **–†–µ–∑—É–ª—Ç–∞—Ç:** 60-80% –ø–æ-–º–∞–ª–∫–æ Firebase notifications

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

–°–ª–µ–¥ –∫–∞—Ç–æ –ø—Ä–∏–ª–æ–∂–∏—à —Ç–µ–∑–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

1. **–¢–µ—Å—Ç–≤–∞–π –±–∞—Ç–µ—Ä–∏—è—Ç–∞:**
   - –û—Å—Ç–∞–≤–∏ app –≤ background –∑–∞ 1 —á–∞—Å
   - –ü—Ä–æ–≤–µ—Ä–∏ consumption –≤ Settings > Battery

2. **–¢–µ—Å—Ç–≤–∞–π Firebase:**
   - –ü—Ä–æ–≤–µ—Ä–∏ Firebase Console > Usage
   - –¢—Ä—è–±–≤–∞ –¥–∞ –≤–∏–¥–∏—à –ø–æ-–º–∞–ª–∫–æ notifications

3. **–¢–µ—Å—Ç–≤–∞–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç—Ç–∞:**
   - –í—Å–∏—á–∫–æ —Ç—Ä—è–±–≤–∞ –¥–∞ —Ä–∞–±–æ—Ç–∏ –∫–∞–∫—Ç–æ –ø—Ä–µ–¥–∏
   - –î–∞–Ω–Ω–∏—Ç–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–¥–≤–∞—Ç –ø–æ-–±—ä—Ä–∑–æ –ø—Ä–µ–∑ WebSocket

---

**–ü–æ—Å–ª–µ–¥–Ω–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è:** 2025-01-15

