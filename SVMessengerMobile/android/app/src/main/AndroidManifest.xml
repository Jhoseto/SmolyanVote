<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">
    
    <uses-sdk tools:overrideLibrary="com.facebook.react" />

    <!-- Attribution Tag declaration to fix 'attributionTag not declared' error -->
    <attribution android:tag="call_service" android:label="@string/attribution_call_service" />

    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
    <uses-permission android:name="android.permission.VIBRATE" />
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
    <!-- Full Screen Intent permission - REQUIRED for incoming call UI when app is closed -->
    <uses-permission android:name="android.permission.USE_FULL_SCREEN_INTENT" />
    <!-- SCHEDULE_EXACT_ALARM permission for Android 12+ (API 31+) - Required for precise notifications -->
    <uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />
    <!-- REQUEST_IGNORE_BATTERY_OPTIMIZATIONS - Required for reliable background notifications -->
    <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />
    <!-- FOREGROUND_SERVICE permission - Required for foreground service -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    <!-- FOREGROUND_SERVICE_PHONE_CALL permission - Required for phone call foreground service on Android 14+ (API 34+) -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_PHONE_CALL" />

    <!-- Storage Permissions for Image/Video sharing -->
    <!-- Android 13+ (API 33+) permissions -->
    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
    <uses-permission android:name="android.permission.READ_MEDIA_VIDEO" />
    <uses-permission android:name="android.permission.READ_MEDIA_AUDIO" />
    <!-- Android 12 and below permissions (maxSdkVersion=32) -->
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" android:maxSdkVersion="32" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="29" />

    <!-- Permissions for voice and video calls -->
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.RECORD_AUDIO" />
    <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
    <uses-permission android:name="android.permission.WAKE_LOCK" />
    <uses-permission android:name="android.permission.BLUETOOTH" />
    <uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />
    
    <!-- Camera features for video calls -->
    <uses-feature android:name="android.hardware.camera" android:required="false" />
    <uses-feature android:name="android.hardware.camera.autofocus" android:required="false" />

    <!-- Queries for Android 11+ (API 30+) - Required for Facebook SDK and package visibility -->
    <queries>
        <!-- Facebook App -->
        <package android:name="com.facebook.katana" />
        <package android:name="com.facebook.orca" />
        <!-- Intent queries for Facebook login -->
        <intent>
            <action android:name="android.intent.action.VIEW" />
            <category android:name="android.intent.category.BROWSABLE" />
            <data android:scheme="fb1381612716938832" />
        </intent>
    </queries>

    <application
      android:name=".MainApplication"
      android:label="@string/app_name"
      android:icon="@mipmap/ic_launcher"
      android:roundIcon="@mipmap/ic_launcher_round"
      android:allowBackup="false"
      android:theme="@style/AppTheme"
      android:usesCleartextTraffic="true"
      android:networkSecurityConfig="@xml/network_security_config"
      android:supportsRtl="true">
      
      <!-- Facebook App ID -->
      <meta-data android:name="com.facebook.sdk.ApplicationId" android:value="@string/facebook_app_id"/>
      <meta-data android:name="com.facebook.sdk.ClientToken" android:value="@string/facebook_client_token"/>
      <!-- Facebook Advertiser ID Collection (suppresses warning) -->
      <meta-data android:name="com.facebook.sdk.AdvertiserIDCollectionEnabled" android:value="true"/>
      
      <!-- Facebook Activity -->
      <activity android:name="com.facebook.FacebookActivity"
          android:configChanges="keyboard|keyboardHidden|screenLayout|screenSize|orientation"
          android:label="@string/app_name"
          android:exported="true" />
      <activity
          android:name="com.facebook.CustomTabActivity"
          android:exported="true">
          <intent-filter>
              <action android:name="android.intent.action.VIEW" />
              <category android:name="android.intent.category.DEFAULT" />
              <category android:name="android.intent.category.BROWSABLE" />
              <!-- Facebook login protocol scheme -->
              <data android:scheme="fb1381612716938832" />
          </intent-filter>
      </activity>
      <activity
        android:name=".MainActivity"
        android:label="@string/app_name"
        android:configChanges="keyboard|keyboardHidden|orientation|screenLayout|screenSize|smallestScreenSize|uiMode"
        android:launchMode="singleTask"
        android:windowSoftInputMode="adjustResize"
        android:exported="true">
        <intent-filter>
            <action android:name="android.intent.action.MAIN" />
            <category android:name="android.intent.category.LAUNCHER" />
        </intent-filter>
      </activity>
      
      <!-- Incoming Call Activity - Full Screen Intent для входящи обаждания когато app-ът е затворен -->
      <!-- CRITICAL: This activity must be able to show on lockscreen and turn screen on -->
      <!-- It uses Full Screen Intent to display call UI when app is closed -->
      <!-- CRITICAL FIX: android:exported="true" is REQUIRED on Android 12+ (API 31+) -->
      <!-- Activities launched by system intents (like Full Screen Intent from Firebase) must be exported -->
      <!-- Without this, the system may fail to launch the activity, preventing incoming calls from being displayed -->
      <activity
        android:name=".IncomingCallActivity"
        android:theme="@android:style/Theme.Translucent.NoTitleBar"
        android:launchMode="singleTop"
        android:excludeFromRecents="true"
        android:exported="true"
        android:showWhenLocked="true"
        android:turnScreenOn="true"
        android:taskAffinity=""
        android:allowEmbedded="false"
        android:resizeableActivity="true"
        android:supportsPictureInPicture="true"
        android:configChanges="screenSize|smallestScreenSize|screenLayout|orientation" />
      
      <!-- Firebase Messaging Service for background notifications -->
      <!-- Оптимизирано като Facebook Messenger - Firebase автоматично показва нотификации
           без постоянно работещ background service (не харчи батерия) -->
      <service
        android:name=".SVMessengerFirebaseMessagingService"
        android:exported="false"
        android:directBootAware="true">
        <intent-filter>
          <action android:name="com.google.firebase.MESSAGING_EVENT" />
        </intent-filter>
      </service>
      
      <!-- Incoming Call Foreground Service -->
      <!-- CRITICAL: Foreground service за входящи обаждания когато app-ът е затворен
           Това гарантира че app-ът остава жив достатъчно дълго за да покаже Full Screen Intent
           Professional Best Practice: Използван от WhatsApp, Telegram, Facebook Messenger -->
      <service
        android:name=".IncomingCallService"
        android:exported="false"
        android:foregroundServiceType="phoneCall" />
    </application>
</manifest>
