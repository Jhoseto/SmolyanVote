import{r as e,j as s,$ as t,c as n,R as r}from"./svmessenger-vendor-react.js";import{s as o}from"./svmessenger-svWebSocketService.js";import{R as a,a as i,L as c}from"./svmessenger-vendor-livekit.js";import{p as l,a as d,b as u,f as m,d as h,e as p}from"./svmessenger-vendor.js";import"./svmessenger-vendor-websocket.js";const v="/api/svmessenger",g=async(e,s={})=>{const t={headers:{"Content-Type":"application/json"},credentials:"include"};window.SVMESSENGER_CSRF&&window.SVMESSENGER_CSRF.token&&(t.headers[window.SVMESSENGER_CSRF.headerName]=window.SVMESSENGER_CSRF.token);try{const n=await fetch(e,{...t,...s});if(!n.ok){const e=await n.json().catch(()=>({message:`HTTP ${n.status}: ${n.statusText}`}));throw new Error(e.message||"API request failed")}return n.json()}catch(n){throw console.error("API Error:",n),n}},x=async()=>g(`${v}/conversations`),f=async e=>g(`${v}/conversations/${e}`),C=async(e,s=null)=>g(`${v}/conversations/start`,{method:"POST",body:JSON.stringify({otherUserId:e,initialMessage:s})}),y=async e=>g(`${v}/conversations/${e}/read`,{method:"PUT"}),b=async()=>g(`${v}/messages/delivered`,{method:"PUT"}),j=async e=>g(`${v}/conversations/${e}/hide`,{method:"PUT"}),w=async(e,s=0,t=50)=>g(`${v}/messages/conversation/${e}?page=${s}&size=${t}`),S=async(e,s)=>g(`${v}/messages/send`,{method:"POST",body:JSON.stringify({conversationId:e,text:s,messageType:"TEXT"})}),k=async e=>{const s=e?`${v}/users/following?query=${encodeURIComponent(e)}`:`${v}/users/following`;return g(s)},N=async()=>g(`${v}/unread-count`),I=async(e,s)=>g(`${v}/call/token`,{method:"POST",body:JSON.stringify({conversationId:e,otherUserId:s})});const E=new class{constructor(){this.room=null,this.isConnected=!1,this.currentRoomName=null,this.selectedMicrophone=null,this.selectedSpeaker=null,this.audioStream=null,this.remoteAudioElements=new Map,this.onConnected=null,this.onDisconnected=null,this.onParticipantConnected=null,this.onParticipantDisconnected=null,this.onTrackSubscribed=null,this.onTrackUnsubscribed=null}async connect(e,s){try{if(this.room&&this.isConnected&&await this.disconnect(),this.room=new a,this.currentRoomName=s,this.room.on(i.Connected,()=>{this.isConnected=!0,this.onConnected&&this.onConnected()}),this.room.on(i.Disconnected,()=>{this.isConnected=!1,this.onDisconnected&&this.onDisconnected()}),this.room.on(i.ParticipantConnected,e=>{e.audioTrackPublications.forEach(s=>{s.track&&this.attachRemoteAudioTrack(s.track,e.identity)}),this.onParticipantConnected&&this.onParticipantConnected(e)}),this.room.on(i.ParticipantDisconnected,e=>{this.onParticipantDisconnected&&this.onParticipantDisconnected(e)}),this.room.on(i.TrackSubscribed,(e,s,t)=>{"audio"===e.kind&&this.attachRemoteAudioTrack(e,t.identity),this.onTrackSubscribed&&this.onTrackSubscribed(e,s,t)}),this.room.on(i.TrackUnsubscribed,(e,s,t)=>{"audio"===e.kind&&this.detachRemoteAudioTrack(t.identity),this.onTrackUnsubscribed&&this.onTrackUnsubscribed(e,s,t)}),await this.room.connect("wss://smolyanvote-nq17fbx3.livekit.cloud",e),await new Promise(e=>setTimeout(e,300)),this.selectedMicrophone&&this.audioStream)try{const e=Array.from(this.room.localParticipant.audioTrackPublications.values());for(const t of e)t.track&&await this.room.localParticipant.unpublishTrack(t.track);const s=this.audioStream.getAudioTracks();if(s.length>0){const e=s[0],t=new c(e);await this.room.localParticipant.publishTrack(t,{source:"microphone"})}}catch(t){try{await this.room.localParticipant.setMicrophoneEnabled(!0)}catch(n){console.error("Failed to enable default microphone:",n)}}else if(this.selectedMicrophone)try{await this.room.localParticipant.setMicrophoneEnabled(!0)}catch(r){console.error("Failed to enable default microphone:",r)}else try{await this.room.localParticipant.setMicrophoneEnabled(!0)}catch(r){console.error("Failed to enable default microphone:",r)}return!0}catch(r){throw console.error("Failed to connect to LiveKit room:",r),this.isConnected=!1,r}}async disconnect(){try{this.remoteAudioElements.forEach((e,s)=>{this.detachRemoteAudioTrack(s)}),this.remoteAudioElements.clear(),this.room&&(await this.room.disconnect(),this.room=null,this.isConnected=!1,this.currentRoomName=null)}catch(e){console.error("Error disconnecting from LiveKit:",e)}}async toggleMicrophone(e){try{if(!this.room||!this.isConnected)throw new Error("Not connected to room");const s=this.room.localParticipant;return e?await s.setMicrophoneEnabled(!0):await s.setMicrophoneEnabled(!1),e}catch(s){throw console.error("Error toggling microphone:",s),s}}isMicrophoneEnabled(){return!(!this.room||!this.isConnected)&&this.room.localParticipant.isMicrophoneEnabled}getParticipants(){return this.room?Array.from(this.room.participants.values()):[]}async requestAudioPermissions(){try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:48e3}});return this.audioStream=e,await this.enumerateAudioDevices(),!0}catch(e){throw console.error("âŒ Audio permissions denied:",e),e}}async enumerateAudioDevices(){try{const e=await navigator.mediaDevices.enumerateDevices(),s=e.filter(e=>"audioinput"===e.kind),t=e.filter(e=>"audiooutput"===e.kind);return s.length>0&&!this.selectedMicrophone&&(this.selectedMicrophone=s[0].deviceId),t.length>0&&!this.selectedSpeaker&&(this.selectedSpeaker=t[0].deviceId),{microphones:s,speakers:t}}catch(e){throw console.error("âŒ Error enumerating devices:",e),e}}async setMicrophone(e){try{let r;this.selectedMicrophone=e,this.audioStream&&(this.audioStream.getTracks().forEach(e=>e.stop()),this.audioStream=null);try{r=await navigator.mediaDevices.getUserMedia({audio:{deviceId:!e||{ideal:e},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})}catch(s){r=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})}if(this.audioStream=r,this.room&&this.isConnected)try{await this.room.localParticipant.setMicrophoneEnabled(!1);const e=Array.from(this.room.localParticipant.audioTrackPublications.values());for(const r of e)r.track&&await this.room.localParticipant.unpublishTrack(r.track);const s=r.getAudioTracks();if(0===s.length)throw new Error("No audio track found in stream");const t=s[0],n=new c(t);await this.room.localParticipant.publishTrack(n,{source:"microphone"})}catch(t){try{await this.room.localParticipant.setMicrophoneEnabled(!0)}catch(n){console.error("Failed to enable default microphone:",n)}}}catch(r){try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});this.audioStream=e}catch(n){throw console.error("Failed to get any microphone:",n),n}}}attachRemoteAudioTrack(e,s){try{this.detachRemoteAudioTrack(s);const t=document.createElement("audio");t.autoplay=!0,t.playsInline=!0,t.volume=1,this.selectedSpeaker&&"setSinkId"in HTMLAudioElement.prototype&&t.setSinkId(this.selectedSpeaker).catch(()=>{}),e.attach(t),this.remoteAudioElements.set(s,t),t.addEventListener("error",e=>{console.error("Remote audio error for:",s,e)});const n=t.play();void 0!==n&&n.catch(()=>{document.addEventListener("click",()=>{t.play().catch(()=>{})},{once:!0})})}catch(t){console.error("Error attaching remote audio track:",t)}}detachRemoteAudioTrack(e){const s=this.remoteAudioElements.get(e);s&&(s.pause(),s.srcObject=null,s.remove(),this.remoteAudioElements.delete(e))}async setSpeaker(e){try{this.selectedSpeaker=e,"setSinkId"in HTMLAudioElement.prototype&&this.remoteAudioElements.forEach(s=>{s.setSinkId(e).catch(()=>{})})}catch(s){throw console.error("Error setting speaker:",s),s}}getSelectedDevices(){return{microphone:this.selectedMicrophone,speaker:this.selectedSpeaker}}};window.svLiveKitService=E,window.svWebSocketService=o;const M=e.createContext(null),A=()=>{const s=e.useContext(M);if(!s)throw new Error("useSVMessenger must be used within SVMessengerProvider");return s},T=({children:t,userData:n})=>{const[r]=e.useState(n),[a,i]=e.useState([]),[c,l]=e.useState([]),[d,u]=e.useState({}),[m,h]=e.useState(!1),[p,v]=e.useState({}),[g,k]=e.useState(!1),[A,T]=e.useState(!1),[U,L]=e.useState({}),[z,R]=e.useState(0),[D,P]=e.useState(!1),[O,V]=e.useState(null),[F,_]=e.useState("idle"),[$,B]=e.useState(null),W=e.useRef(null),[H,J]=e.useState(null),[K,G]=e.useState(null),[q,Q]=e.useState(!1),[Y,X]=e.useState("call"),[Z,ee]=e.useState(null),se=e.useRef({}),te=e.useRef(null),ne=e.useRef(1e3),re=e.useRef(a),oe=e.useRef(c),ae=e.useRef(d);e.useEffect(()=>{if(!te.current){const e=new window.Audio("/svmessenger/sounds/s1.mp3");e.preload="auto",te.current=e}},[]),e.useEffect(()=>{re.current=a},[a]),e.useEffect(()=>{oe.current=c},[c]),e.useEffect(()=>{ae.current=d},[d]),e.useEffect(()=>(o.connect({onConnect:Ce,onDisconnect:ye,onError:be,onNewMessage:je,onTypingStatus:we,onReadReceipt:Se,onDeliveryReceipt:ke,onOnlineStatus:Ne,onCallSignal:fe}),Ie(),Ue(),Je(),()=>{o.disconnect()}),[]),e.useEffect(()=>(c.forEach(e=>{o.subscribeToTyping(e.conversation.id,we)}),()=>{c.forEach(e=>{o.unsubscribeFromTyping(e.conversation.id)})}),[c.map(e=>e.id).join(",")]);const ie=e.useCallback(async(e,s,t=null)=>{try{let o=t;if(!o){const s=oe.current.find(s=>s.conversation.id===e);s&&(o=s.conversation)}if(o||(o=re.current.find(s=>s.id===e)),!o)throw new Error("Conversation not found");let a=null,i=!1;try{if(a=localStorage.getItem("svmessenger-audio-settings"),a)try{const e=JSON.parse(a);i=!(!e.microphone||!e.speaker)}catch(n){i=!1}}catch(r){const e=E.getSelectedDevices();e.microphone&&e.speaker&&(i=!0,a=JSON.stringify({microphone:e.microphone,speaker:e.speaker,micVolume:75,speakerVolume:80}))}if(i){const t=JSON.parse(a);t.microphone&&await E.setMicrophone(t.microphone),t.speaker&&await E.setSpeaker(t.speaker),await de(e,s,o)}else ee({type:"start",data:{conversationId:e,otherUserId:s,conversation:o}}),Q(!0)}catch(o){console.error("Failed to start call:",o),_("idle")}},[r]),ce=e.useCallback(e=>`${window.location.origin}/svmessenger/call-window.html?${new URLSearchParams({token:e.token,roomName:e.roomName,conversationId:e.conversationId.toString(),otherUserId:e.otherUserId.toString(),otherUserName:encodeURIComponent(e.otherUserName||""),otherUserAvatar:encodeURIComponent(e.otherUserAvatar||""),currentUserId:e.currentUserId.toString(),currentUserName:encodeURIComponent(e.currentUserName||""),currentUserAvatar:encodeURIComponent(e.currentUserAvatar||""),callType:e.callType||"voice",callState:e.callState||"outgoing"}).toString()}`,[]),le=e.useCallback(()=>{B(e=>(e&&!e.closed&&e.close(),null)),W.current&&W.current.postMessage({type:"CALL_ENDED",data:{}}),V(e=>(e&&_(s=>{const t="outgoing"===s,n={eventType:"CALL_END",conversationId:e.conversationId,callerId:t?r.id:e.otherUserId,receiverId:t?e.otherUserId:r.id,roomName:e.roomName,timestamp:(new Date).toISOString()};return o.sendCallSignal(n),"idle"}),null)),_("idle"),J(null),G(null)},[r]),de=e.useCallback(async(e,s,t)=>{var n,a,i;try{const l=await I(e,s);J(l.token);try{window.__sv_livekit_token=l.token,window.liveKitToken=l.token}catch(c){}const d={conversationId:e,otherUserId:s,roomName:l.roomName,conversation:t};V(d),_("outgoing");const u=ce({token:l.token,roomName:l.roomName,conversationId:e,otherUserId:s,otherUserName:(null==(n=t.otherUser)?void 0:n.realName)||(null==(a=t.otherUser)?void 0:a.username)||"ÐŸÐ¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»",otherUserAvatar:(null==(i=t.otherUser)?void 0:i.imageUrl)||"",currentUserId:r.id,currentUserName:r.realName||r.username,currentUserAvatar:r.imageUrl||"",callType:"voice",callState:"outgoing"}),m=window.open(u,"svmessenger-call","width=400,height=600,resizable=yes,scrollbars=no,menubar=no,toolbar=no,location=no");if(m){B(m);const e=setInterval(()=>{m.closed&&(clearInterval(e),B(null),le())},500)}else console.warn("Popup blocked, using modal fallback");const h={eventType:"CALL_REQUEST",conversationId:e,callerId:r.id,receiverId:s,roomName:l.roomName,timestamp:(new Date).toISOString(),callerName:r.realName||r.username,callerAvatar:r.imageUrl};o.sendCallSignal(h)}catch(l){console.error("Failed to proceed with call start:",l),_("idle")}},[r,ce,le]),ue=e.useCallback(async()=>{try{let t=null,n=!1;try{if(t=localStorage.getItem("svmessenger-audio-settings"),t)try{const e=JSON.parse(t);n=!(!e.microphone||!e.speaker)}catch(e){n=!1}}catch(s){const e=E.getSelectedDevices();e.microphone&&e.speaker&&(n=!0,t=JSON.stringify({microphone:e.microphone,speaker:e.speaker,micVolume:75,speakerVolume:80}))}if(n){const e=JSON.parse(t);e.microphone&&await E.setMicrophone(e.microphone),e.speaker&&await E.setSpeaker(e.speaker),await me()}else ee({type:"accept",data:{}}),Q(!0)}catch(t){console.error("Failed to accept call:",t),le()}},[O,r]),me=e.useCallback(async()=>{var e,s,t,n,a,i;try{const c=O.roomName;if(!c)throw new Error("Missing room name for call accept");const l=await I(O.conversationId,O.otherUserId);l.roomName!==c&&(l.roomName=c),J(l.token);const d={eventType:"CALL_ACCEPT",conversationId:O.conversationId,callerId:O.otherUserId,receiverId:r.id,roomName:c,timestamp:(new Date).toISOString()};o.sendCallSignal(d);const u=ce({token:l.token,roomName:c,conversationId:O.conversationId,otherUserId:O.otherUserId,otherUserName:(null==(s=null==(e=O.conversation)?void 0:e.otherUser)?void 0:s.realName)||(null==(n=null==(t=O.conversation)?void 0:t.otherUser)?void 0:n.username)||"ÐŸÐ¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»",otherUserAvatar:(null==(i=null==(a=O.conversation)?void 0:a.otherUser)?void 0:i.imageUrl)||"",currentUserId:r.id,currentUserName:r.realName||r.username,currentUserAvatar:r.imageUrl||"",callType:"voice",callState:"connected"}),m=window.open(u,"svmessenger-call","width=400,height=600,resizable=yes,scrollbars=no,menubar=no,toolbar=no,location=no");if(m){B(m);const e=setInterval(()=>{m.closed&&(clearInterval(e),B(null),le())},500)}else console.warn("Popup blocked, using modal fallback");_("connected")}catch(c){console.error("Failed to proceed with call accept:",c),le()}},[O,r,ce,le]),he=e.useCallback(()=>{X("settings"),Q(!0)},[]),pe=e.useCallback(async e=>{if(Q(!1),"settings"===Y)X("call");else if(Z){const{type:e,data:s}=Z;ee(null),"start"===e?await de(s.conversationId,s.otherUserId,s.conversation):"accept"===e&&await me()}},[Y,Z]),ve=e.useCallback(()=>{Q(!1),X("call"),ee(null),"settings"!==Y&&(_("idle"),V(null))},[Y]),ge=e.useCallback(()=>{const e={eventType:"CALL_REJECT",conversationId:O.conversationId,callerId:O.otherUserId,receiverId:r.id,roomName:O.roomName,timestamp:(new Date).toISOString()};o.sendCallSignal(e),V(null),_("idle"),J(null),G(null)},[O,r]);e.useEffect(()=>(W.current=new BroadcastChannel("svmessenger-call"),W.current.onmessage=e=>{const{type:s,data:t,message:n}=e.data;switch(s){case"POPUP_LOG":console.log(n,t||"");break;case"CALL_ENDED_FROM_POPUP":_("idle"),V(null),B(null)}},()=>{W.current&&W.current.close()}),[]);const xe=e.useCallback(async e=>{try{await E.connect(e.token,e.roomName),G(e.roomName),await new Promise(e=>setTimeout(e,500));let r=null;try{r=localStorage.getItem("svmessenger-audio-settings")}catch(s){const e=E.getSelectedDevices();e.microphone&&e.speaker&&(r=JSON.stringify({microphone:e.microphone,speaker:e.speaker,micVolume:75,speakerVolume:80}))}if(r)try{const e=JSON.parse(r);e.microphone&&await E.setMicrophone(e.microphone),e.speaker&&await E.setSpeaker(e.speaker)}catch(t){}else try{E.room&&E.isConnected&&await E.room.localParticipant.setMicrophoneEnabled(!0)}catch(n){}}catch(n){throw console.error("Failed to connect to LiveKit:",n),n}},[]),fe=e.useCallback(async e=>{switch(e.eventType){case"TEST_SIGNAL":case"CALL_BUSY":break;case"CALL_REQUEST":if(e.receiverId===r.id){let r=a.find(s=>s.id===e.conversationId);if(!r)try{const s=await C(e.callerId);s&&(r=s,i(e=>e.find(e=>e.id===s.id)?e:[s,...e]))}catch(s){console.error("Failed to load/create conversation:",s);try{const s=await x();i(s),r=s.find(s=>s.id===e.conversationId)}catch(t){console.error("Failed to reload conversations:",t)}}if(r){const s={conversationId:e.conversationId,otherUserId:e.callerId,roomName:e.roomName,conversation:r};V(s),_("incoming");try{window.SVMessenger&&"function"==typeof window.SVMessenger.openChat&&window.SVMessenger.openChat(r.id)}catch(n){console.warn("Failed to auto-open chat for incoming call:",n)}document.hidden&&"Notification"in window&&"granted"===Notification.permission&&new Notification("Incoming Call",{body:`${r.otherUser.realName||r.otherUser.username} is calling you`,icon:r.otherUser.imageUrl||"/images/default-avatar.png"})}else console.error("ðŸ“ž Could not find or create conversation for call")}break;case"CALL_ACCEPT":console.log("ðŸ“ž Processing CALL_ACCEPT signal..."),console.log("ðŸ“ž Current callState:",F),console.log("ðŸ“ž Signal callerId:",e.callerId,"currentUser.id:",r.id),console.log("ðŸ“ž Signal receiverId:",e.receiverId),console.log("ðŸ“ž Current call:",O),V(s=>(_(t=>{console.log("ðŸ“ž CALL_ACCEPT - checking state:",t),console.log("ðŸ“ž CALL_ACCEPT - currentCall from functional setState:",s);const n=s&&s.conversationId===e.conversationId,o=e.callerId===r.id,a=e.receiverId===r.id;console.log("ðŸ“ž CALL_ACCEPT analysis:",{isForThisConversation:n,isCaller:o,isReceiver:a,currentState:t,hasCurrentCall:!!s,currentCallConversationId:null==s?void 0:s.conversationId,signalConversationId:e.conversationId});if(o&&("outgoing"===t||"idle"===t&&null!==$)&&(n||e.roomName)){if(!s&&e.roomName){const s={conversationId:e.conversationId,otherUserId:e.receiverId,roomName:e.roomName,conversation:null};setTimeout(()=>{V(s)},0)}return W.current?(console.log("ðŸ“¤ Sending CALL_ACCEPTED message to popup window"),W.current.postMessage({type:"CALL_ACCEPTED",data:{conversationId:e.conversationId,roomName:e.roomName}})):console.warn("âš ï¸ callChannelRef.current is null, cannot notify popup"),"connected"}if(a&&"connected"===t&&n)return console.log("âœ… CALL_ACCEPT acknowledged - receiver already connected"),t;if(a&&!s){console.log("âš ï¸ CALL_ACCEPT received but currentCall is null - attempting to restore from signal data");const s={conversationId:e.conversationId,otherUserId:e.callerId,roomName:e.roomName,conversation:null};return console.log("ðŸ“ž Restoring currentCall from signal:",s),t}if(a&&"incoming"===t&&n){console.log("âœ… CALL_ACCEPT received - receiver connecting to LiveKit");const t=H||window.__sv_livekit_token||window.liveKitToken||null,n=e.roomName||(null==s?void 0:s.roomName);return t&&n&&(console.log("ðŸ“ž Connecting receiver to LiveKit room:",n),xe({token:t,roomName:n}).catch(e=>{console.error("âŒ Failed to connect receiver to LiveKit:",e)})),"connected"}return console.warn("âš ï¸ CALL_ACCEPT ignored - analysis:",{isCaller:o,isReceiver:a,isForThisConversation:n,currentState:t,hasCurrentCall:!!s,signalConversationId:e.conversationId,currentCallConversationId:null==s?void 0:s.conversationId}),t}),s));break;case"CALL_REJECT":"outgoing"!==F&&"incoming"!==F||(V(null),_("idle"),J(null),G(null));break;case"CALL_END":console.log("ðŸ“ž Received CALL_END signal:",e),console.log("ðŸ“ž Current call state:",F),console.log("ðŸ“ž Current call:",O),V(s=>(_(t=>{const n=s&&s.conversationId===e.conversationId;return console.log("ðŸ“ž CALL_END analysis:",{isForThisCall:n,currentState:t,hasCurrentCall:!!s,signalConversationId:e.conversationId,currentCallConversationId:null==s?void 0:s.conversationId}),"idle"!==t&&n?(W.current&&W.current.postMessage({type:"CALL_ENDED",data:{conversationId:e.conversationId}}),E.disconnect(),"idle"):t}),s&&s.conversationId===e.conversationId?(J(null),G(null),null):s));break;default:console.warn("Unknown call signal type:",e.eventType)}},[F,r,H,xe,a]),Ce=e.useCallback(()=>{P(!0)},[]),ye=e.useCallback(()=>{P(!1)},[]),be=e.useCallback(e=>{console.error("SVMessenger: WebSocket error",e)},[]),je=e.useCallback(e=>{u(s=>({...s,[e.conversationId]:[...s[e.conversationId]||[],e]})),i(s=>s.map(s=>s.id===e.conversationId?{...s,lastMessage:e.text,lastMessageTime:e.sentAt}:s));const s=c.find(s=>s.conversation.id===e.conversationId),t=s&&!s.isMinimized,n=s&&s.isMinimized;if(t);else if(n)i(s=>{const t=s.map(s=>s.id===e.conversationId?{...s,unreadCount:(s.unreadCount||0)+1}:s),n=t.reduce((e,s)=>e+(s.unreadCount||0),0);return R(n),t});else{a.some(s=>s.id===e.conversationId)?i(s=>{const t=s.map(s=>s.id===e.conversationId?{...s,unreadCount:(s.unreadCount||0)+1}:s),n=t.reduce((e,s)=>e+(s.unreadCount||0),0);return R(n),t}):f(e.conversationId).then(e=>{e&&i(s=>{const t=s.some(s=>s.id===e.id)?s.map(s=>s.id===e.id?{...s,unreadCount:(s.unreadCount||0)+1}:s):[{...e,unreadCount:(e.unreadCount||0)+1},...s],n=t.reduce((e,s)=>e+(s.unreadCount||0),0);return R(n),t})}).catch(e=>{console.error("Failed to fetch conversation:",e)}),Ke(),Ge(e)}},[c,a]),we=e.useCallback(e=>{const{conversationId:s,userId:t,isTyping:n}=e;n?(L(e=>({...e,[s]:t})),se.current[s]&&clearTimeout(se.current[s]),se.current[s]=setTimeout(()=>{L(e=>{const t={...e};return delete t[s],t})},3e3)):L(e=>{const t={...e};return delete t[s],t})},[]),Se=e.useCallback(e=>{if(!e)return;const{type:s,conversationId:t,messageId:n,readAt:o}=e;"BULK_READ"===s?(u(e=>({...e,[t]:(e[t]||[]).map(e=>e.senderId===r.id?{...e,isRead:!0,readAt:e.readAt||o}:e)})),i(e=>{const s=e.map(e=>e.id===t?{...e,unreadCount:0}:e),n=s.reduce((e,s)=>e+(s.unreadCount||0),0);return R(n),s})):n&&(u(e=>({...e,[t]:(e[t]||[]).map(e=>e.id===n&&e.senderId===r.id?{...e,isRead:!0,readAt:o}:e)})),i(e=>{const s=e.map(e=>e.id===t?{...e,unreadCount:Math.max(0,(e.unreadCount||0)-1)}:e),n=s.reduce((e,s)=>e+(s.unreadCount||0),0);return R(n),s}))},[a,r]),ke=e.useCallback(e=>{if("BULK_DELIVERY"===e.type){const{conversationIds:s,deliveredAt:t}=e;u(e=>{const n={...e};return s.forEach(e=>{n[e]&&(n[e]=n[e].map(e=>({...e,isDelivered:!0,deliveredAt:e.senderId!==r.id?t:e.deliveredAt})))}),n})}else{const{conversationId:s,messageId:t,deliveredAt:n}=e;u(e=>({...e,[s]:(e[s]||[]).map(e=>e.id===t?{...e,isDelivered:!0,deliveredAt:n}:e)}))}},[r]),Ne=e.useCallback(e=>{const{userId:s,isOnline:t}=e;i(e=>e.map(e=>e.otherUser.id===s?{...e,otherUser:{...e.otherUser,isOnline:t}}:e)),l(e=>e.map(e=>e.conversation.otherUser.id===s?{...e,conversation:{...e.conversation,otherUser:{...e.conversation.otherUser,isOnline:t}}}:e))},[]),Ie=e.useCallback(async()=>{h(!0);try{const s=await x();i(s);const t=s.reduce((e,s)=>e+(s.unreadCount||0),0);R(t);try{await b()}catch(e){console.warn("Failed to mark messages as delivered:",e)}}catch(e){console.error("Failed to load conversations:",e)}finally{h(!1)}},[]),Ee=e.useCallback(async(e,s=0,t=50)=>{v(s=>({...s,[e]:!0}));try{const n=await w(e,s,t);let r=Array.isArray(n)?n:n.content||n.messages||[];r=[...r].sort((e,s)=>new Date(e.sentAt)-new Date(s.sentAt)),u(t=>{const n=t[e]||[];if(0===s){const s=[...r,...n].filter((e,s,t)=>s===t.findIndex(s=>s.id===e.id));return{...t,[e]:s.sort((e,s)=>new Date(e.sentAt)-new Date(s.sentAt))}}return{...t,[e]:[...r,...n]}})}catch(n){console.error("Failed to load messages:",n)}finally{v(s=>({...s,[e]:!1}))}},[]),Me=e.useCallback(async(e,s)=>{if(s.trim()&&D)try{const t=await S(e,s.trim());u(s=>({...s,[e]:[...s[e]||[],t]})),Ie()}catch(t){console.error("Failed to send message:",t),alert("Ð“Ñ€ÐµÑˆÐºÐ° Ð¿Ñ€Ð¸ Ð¸Ð·Ð¿Ñ€Ð°Ñ‰Ð°Ð½Ðµ Ð½Ð° ÑÑŠÐ¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ. ÐœÐ¾Ð»Ñ Ð¾Ð¿Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ Ð¾Ñ‚Ð½Ð¾Ð²Ð¾.")}else console.warn("Cannot send message: empty text or not connected")},[r,D]),Ae=e.useCallback(async e=>{try{const s=await C(e);if(!s||!s.id)throw console.error("startConversation: Invalid conversation from API",s),new Error("Invalid conversation returned from API");return i(e=>e.some(e=>e.id===s.id)?e:[s,...e]),s}catch(s){throw console.error("startConversation: Failed to start conversation:",s),alert("Ð“Ñ€ÐµÑˆÐºÐ° Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ð½Ðµ Ð½Ð° Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€."),s}},[]),Te=e.useCallback(async e=>{try{await y(e),i(s=>{const t=s.map(s=>s.id===e?{...s,unreadCount:0}:s),n=t.reduce((e,s)=>e+(s.unreadCount||0),0);return R(n),t}),u(s=>({...s,[e]:(s[e]||[]).map(e=>({...e,isRead:e.senderId!==r.id||e.isRead,readAt:e.senderId===r.id||e.isRead?e.readAt:(new Date).toISOString()}))}))}catch(s){console.error("Failed to mark as read:",s)}},[a,r]),Ue=e.useCallback(async()=>{try{const e=await N();R(e.count)}catch(e){console.error("Failed to load unread count:",e)}},[]),Le=e.useCallback((e,s)=>{D&&o.sendTypingStatus(e,s)},[D]),ze=e.useCallback(()=>{k(!0),T(!1)},[]),Re=e.useCallback(()=>{k(!1),T(!1)},[]),De=e.useCallback(()=>{T(!0)},[]),Pe=e.useCallback(()=>{T(!1)},[]),Oe=e.useCallback(()=>{const e=window.innerWidth,s=window.innerHeight,t=30*c.filter(e=>!e.isMinimized).length;return{x:Math.max(50,(e-400)/2+t),y:Math.max(50,(s-600)/2+t)}},[c]),Ve=e.useCallback((e,s=null)=>{var t;let n=s||re.current.find(s=>s.id===e);if(n||(n=null==(t=oe.current.find(s=>s.conversation.id===e))?void 0:t.conversation),!n)return console.warn("Conversation not found:",e),void f(e).then(s=>{s&&(i(e=>e.some(e=>e.id===s.id)?e:[s,...e]),setTimeout(()=>Ve(e),100))}).catch(e=>{console.error("Failed to fetch conversation:",e)});const a=oe.current.find(s=>s.conversation.id===e);if(a)return void(a.isMinimized?$e(e):Be(e));const c=re.current.find(s=>s.id===e),d={id:e,conversation:c||n,isMinimized:!1,position:Oe(),zIndex:ne.current++};l(e=>[...e,d]);const m=n.unreadCount>0;Ee(e,0,m?200:50);(ae.current[e]||[]).some(e=>e.senderId!==r.id&&!e.isRead)&&(o.sendRead(e),u(s=>({...s,[e]:(s[e]||[]).map(e=>e.senderId!==r.id?{...e,isRead:!0,readAt:(new Date).toISOString()}:e)})),i(s=>{const t=s.map(s=>s.id===e?{...s,unreadCount:0}:s),n=t.reduce((e,s)=>e+(s.unreadCount||0),0);return R(n),t})),Re()},[r]),Fe=e.useCallback(e=>{l(s=>s.filter(s=>s.conversation.id!==e))},[]),_e=e.useCallback(e=>{l(s=>s.map(s=>s.conversation.id===e?{...s,isMinimized:!0}:s))},[]),$e=e.useCallback(e=>{l(s=>s.map(s=>s.conversation.id===e?{...s,isMinimized:!1,zIndex:ne.current++}:s));(d[e]||[]).some(e=>e.senderId!==r.id&&!e.isRead)&&(o.sendRead(e),u(s=>({...s,[e]:(s[e]||[]).map(e=>e.senderId!==r.id?{...e,isRead:!0,readAt:(new Date).toISOString()}:e)}))),i(s=>{const t=s.map(s=>s.id===e?{...s,unreadCount:0}:s),n=t.reduce((e,s)=>e+(s.unreadCount||0),0);return R(n),t})},[a,d,r]),Be=e.useCallback(e=>{l(s=>s.map(s=>s.conversation.id===e?{...s,zIndex:ne.current++}:s))},[]),We=e.useCallback((e,s)=>{l(t=>t.map(t=>t.conversation.id===e?{...t,position:s}:t))},[]),He=e.useCallback(async e=>{try{(await j(e)).success&&(i(s=>s.filter(s=>s.id!==e)),l(s=>s.filter(s=>s.conversation.id!==e)))}catch(s){console.error("Failed to hide conversation:",s),alert("Ð“Ñ€ÐµÑˆÐºÐ° Ð¿Ñ€Ð¸ ÑÐºÑ€Ð¸Ð²Ð°Ð½Ðµ Ð½Ð° Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð°. ÐœÐ¾Ð»Ñ Ð¾Ð¿Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ Ð¾Ñ‚Ð½Ð¾Ð²Ð¾.")}},[]),Je=()=>{"Notification"in window&&"default"===Notification.permission&&Notification.requestPermission().then(e=>{})},Ke=()=>{te.current&&(te.current.currentTime=0,te.current.play().catch(()=>{}))},Ge=e=>{if("Notification"in window&&"granted"===Notification.permission)try{new Notification(`ÐÐ¾Ð²Ð¾ ÑÑŠÐ¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ ${e.senderUsername}`,{body:e.text.substring(0,100),icon:e.senderImageUrl||"/images/default-avatar.png",badge:"/images/svmessenger-icon.png",tag:`svmessenger-${e.conversationId}`,requireInteraction:!1})}catch(s){console.error("Error showing notification:",s)}};e.useEffect(()=>((()=>{try{const e=async e=>{const s=await Ae(e);return setTimeout(()=>{Ve(s.id)},150),s},s=async e=>{try{const s=await Ae(e);return s&&s.id?(setTimeout(()=>{try{Ve(s.id)}catch(e){console.error("startConversationReactWithAutoOpen: Error in openChat",e)}},150),s):void console.error("startConversationReactWithAutoOpen: Invalid conversation returned",s)}catch(s){throw console.error("startConversationReactWithAutoOpen: Error",s),s}};window.SVMessenger={startConversation:e,startConversationReact:s,openChat:Ve,openChatList:ze,openSearch:De,sendMessage:Me,isConnected:D}}catch(e){console.error("SVMessenger: Error exposing global API:",e)}})(),()=>{window.SVMessenger&&delete window.SVMessenger}),[]);const qe=e.useMemo(()=>({currentUser:r,conversations:a,activeChats:c,messagesByConversation:d,isChatListOpen:g,isSearchOpen:A,isLoadingConversations:m,loadingMessages:p,typingUsers:U,totalUnreadCount:z,isWebSocketConnected:D,currentCall:O,callState:F,showDeviceSelector:q,deviceSelectorMode:Y,handleDeviceSelectorComplete:pe,handleDeviceSelectorCancel:ve,openAudioSettings:he,loadConversations:Ie,loadMessages:Ee,sendMessage:Me,startConversation:Ae,markAsRead:Te,sendTypingStatus:Le,openChatList:ze,closeChatList:Re,openSearch:De,closeSearch:Pe,openChat:Ve,closeChat:Fe,minimizeChat:_e,restoreChat:$e,bringToFront:Be,updateChatPosition:We,removeFromConversationList:He,startCall:ie,acceptCall:ue,rejectCall:ge,endCall:le,callWindowRef:$}),[r,a,c,d,g,A,m,p,U,z,D,O,F,q,Y,pe,ve,he,Ie,Ee,Me,Ae,Te,Le,ze,Re,De,Pe,Ve,Fe,_e,$e,Be,We,He,ie,ue,ge,le],[]);return s.jsx(M.Provider,{value:qe,children:t})},U=e=>{if(!e)return"";try{const s="string"==typeof e?l(e):new Date(e),t=new Date-s,n=Math.floor(t/6e4),r=Math.floor(t/36e5),o=Math.floor(t/864e5);return n<1?"Ð¡ÐµÐ³Ð°":n<60?`${n} Ð¼Ð¸Ð½`:r<24&&d(s)?`${r} Ñ‡`:u(s)?"Ð’Ñ‡ÐµÑ€Ð°":o<7?`${o} Ð´`:m(s,"d MMM",{locale:h})}catch(s){return console.error("Error formatting date:",s),""}},L=e=>{if(!e)return"";try{const s="string"==typeof e?l(e):new Date(e);return d(s)?"Ð”Ð½ÐµÑ":u(s)?"Ð’Ñ‡ÐµÑ€Ð°":m(s,"d MMMM yyyy",{locale:h})}catch(s){return console.error("Error formatting date separator:",s),""}},z=e=>{if(!e)return"";try{const s="string"==typeof e?l(e):new Date(e);return m(s,"HH:mm")}catch(s){return console.error("Error formatting message time:",s),""}},R=(e,s=100)=>e?e.length<=s?e:e.substring(0,s)+"...":"",D=e=>{if(!e)return"";return e.replace(/(https?:\/\/[^\s]+)/g,e=>`<a href="${e}" target="_blank" rel="noopener noreferrer">${e}</a>`)},P=(e,s=50)=>{if(!e)return!0;const{scrollTop:t,scrollHeight:n,clientHeight:r}=e;return n-t-r<s},O=({conversation:e})=>{var t;const{openChat:n,removeFromConversationList:r,activeChats:o}=A(),a=o.some(s=>s.conversation.id===e.id&&!s.isMinimized);return s.jsxs("div",{className:"svmessenger-conversation-item "+(a?"active":""),onClick:()=>{n(e.id)},children:[s.jsx("button",{className:"svmessenger-conversation-remove",onClick:s=>{s.stopPropagation(),r&&r(e.id)},title:"ÐŸÑ€ÐµÐ¼Ð°Ñ…Ð½Ð¸ Ð¾Ñ‚ Ð¿Ð°Ð½ÐµÐ»Ð°",children:s.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})}),s.jsxs("div",{className:"svmessenger-conversation-avatar",children:[s.jsx("img",{src:e.otherUser.imageUrl||"/images/default-avatar.png",alt:e.otherUser.username,onError:e=>{e.target.src="/images/default-avatar.png"}}),e.otherUser.isOnline&&s.jsx("div",{className:"svmessenger-online-indicator"})]}),s.jsxs("div",{className:"svmessenger-conversation-content",children:[s.jsxs("div",{className:"svmessenger-conversation-top-row",children:[s.jsx("h4",{className:"svmessenger-conversation-name",children:e.otherUser.realName||e.otherUser.username}),s.jsx("span",{className:"svmessenger-conversation-time",children:U(null==(t=e.lastMessage)?void 0:t.sentAt)})]}),s.jsxs("div",{className:"svmessenger-conversation-preview",children:[s.jsx("p",{className:"svmessenger-conversation-text",children:e.lastMessage?R(e.lastMessage.text,50):"ÐÑÐ¼Ð° ÑÑŠÐ¾Ð±Ñ‰ÐµÐ½Ð¸Ñ"}),e.unreadCount>0&&s.jsx("span",{className:"svmessenger-conversation-unread",children:e.unreadCount>99?"99+":e.unreadCount})]})]})]})},V=({onClose:t,onSearchClick:n})=>{const{conversations:r,isLoadingConversations:o,loadConversations:a}=A(),[i,c]=e.useState("");e.useEffect(()=>{a()},[a]);const l=r.filter(e=>{var s,t,n;if(!i)return!0;const r=i.toLowerCase();return e.otherUser.username.toLowerCase().includes(r)||(null==(s=e.otherUser.realName)?void 0:s.toLowerCase().includes(r))||(null==(n=null==(t=e.lastMessage)?void 0:t.text)?void 0:n.toLowerCase().includes(r))});return s.jsxs("div",{className:"svmessenger-conversation-list",children:[s.jsxs("div",{className:"svmessenger-conversation-header",children:[s.jsx("h3",{children:"SV Messenger"}),s.jsxs("div",{className:"svmessenger-conversation-actions",children:[s.jsx("button",{className:"svmessenger-search-btn",onClick:n,title:"ÐÐ¾Ð² Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"})})}),s.jsx("button",{className:"svmessenger-close-btn",onClick:t,title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]})]}),s.jsx("div",{className:"svmessenger-search-input",children:s.jsx("input",{type:"text",placeholder:"Ð¢ÑŠÑ€ÑÐ¸ Ð² ÑÑŠÑ‰ÐµÑÑ‚Ð²ÑƒÐ²Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð¸...",value:i,onChange:e=>c(e.target.value)})}),s.jsx("div",{className:"svmessenger-conversations",children:o?s.jsxs("div",{className:"svmessenger-loading",children:[s.jsx("div",{className:"svmessenger-spinner"}),s.jsx("span",{children:"Ð—Ð°Ñ€ÐµÐ¶Ð´Ð°Ð½Ðµ..."})]}):0===l.length?s.jsx("div",{className:"svmessenger-empty",children:i?s.jsxs(s.Fragment,{children:[s.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"})}),s.jsx("p",{children:"ÐÑÐ¼Ð° Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð¸"})]}):s.jsxs(s.Fragment,{children:[s.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"})}),s.jsx("p",{children:"ÐÑÐ¼Ð° ÑÑŠÑ‰ÐµÑÑ‚Ð²ÑƒÐ²Ð°Ñ‰Ð¸ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð¸"}),s.jsx("small",{children:"ÐšÐ»Ð¸ÐºÐ½ÐµÑ‚Ðµ + Ð·Ð° Ð´Ð° Ð·Ð°Ð¿Ð¾Ñ‡Ð½ÐµÑ‚Ðµ Ð½Ð¾Ð² Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€"})]})}):l.map(e=>s.jsx(O,{conversation:e},e.id))})]})},F=({conversation:t,onClose:n,onMinimize:r,onOpenSearch:o,onCall:a,onOpenAudioSettings:i})=>{const[c,l]=e.useState(!1),d=e.useRef(null),{otherUser:u}=t;e.useEffect(()=>{const e=e=>{d.current&&!d.current.contains(e.target)&&l(!1)};return c&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[c]);return s.jsxs("div",{className:"svmessenger-chat-header",children:[s.jsxs("div",{className:"svmessenger-chat-user-info",children:[s.jsx("div",{className:"svmessenger-chat-avatar",children:u.imageUrl?s.jsx("img",{src:u.imageUrl,alt:u.realName||u.username}):s.jsx("div",{className:"svmessenger-chat-avatar-placeholder",children:(u.realName||u.username||"U").charAt(0).toUpperCase()})}),s.jsxs("div",{className:"svmessenger-chat-user-details",children:[s.jsx("div",{className:"svmessenger-chat-username",children:u.realName||u.username}),s.jsx("span",{className:"svmessenger-chat-status "+(u.isOnline?"online":"offline"),children:u.isOnline?"Online":"Offline"})]})]}),s.jsxs("div",{className:"svmessenger-chat-controls",children:[s.jsx("button",{className:"svmessenger-call-btn",onClick:a,title:"Ð—Ð²ÑŠÐ½Ð½Ð¸",style:{display:"flex",alignItems:"center",justifyContent:"center",width:"32px",height:"32px",border:"none",background:"none",color:"#9ca3af",borderRadius:"6px",cursor:"pointer",transition:"all 0.2s ease",marginLeft:"8px"},children:s.jsx("i",{className:"bi bi-telephone",style:{fontSize:"18px",color:"#ffffff"}})}),s.jsxs("div",{className:"svmessenger-chat-menu-container",ref:d,children:[s.jsx("button",{className:"svmessenger-chat-menu-btn",onClick:()=>l(!c),title:"ÐŸÐ¾Ð²ÐµÑ‡Ðµ Ð¾Ð¿Ñ†Ð¸Ð¸",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"})})}),c&&s.jsxs("div",{className:"svmessenger-chat-menu-dropdown",children:[s.jsxs("button",{onClick:()=>{l(!1),window.location.href=`/profile/${u.username}`},className:"svmessenger-menu-item",children:[s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"})}),"ÐŸÑ€ÐµÐ³Ð»ÐµÐ´ Ð½Ð° Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð°"]}),s.jsxs("button",{onClick:()=>{l(!1),o()},className:"svmessenger-menu-item",children:[s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"})}),"Ð¢ÑŠÑ€ÑÐ¸ Ð² Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð°..."]}),s.jsxs("button",{onClick:()=>{l(!1),i&&i()},className:"svmessenger-menu-item",children:[s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"})}),"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð½Ð° Ð·Ð²ÑƒÐºÐ°"]}),s.jsxs("button",{onClick:()=>{l(!1),window.confirm("Ð¡Ð¸Ð³ÑƒÑ€Ð½Ð¸ Ð»Ð¸ ÑÑ‚Ðµ, Ñ‡Ðµ Ð¸ÑÐºÐ°Ñ‚Ðµ Ð´Ð° Ð¸Ð·Ñ‚Ñ€Ð¸ÐµÑ‚Ðµ Ñ‚Ð¾Ð·Ð¸ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€?")},className:"svmessenger-menu-item svmessenger-menu-item-danger",children:[s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"})}),"Ð˜Ð·Ñ‚Ñ€Ð¸Ð¹ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð°"]})]})]}),s.jsx("button",{className:"svmessenger-chat-close",onClick:n,title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸",children:s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]})]})},_=({message:e,searchQuery:t=""})=>{const{currentUser:n}=A(),r=e.senderId===n.id,o=!!(a=e.text)&&/^[\p{Emoji}\s]+$/u.test(a.trim());var a;return s.jsxs("div",{className:"svmessenger-message-item "+(r?"own":"other"),children:[!r&&s.jsx("div",{className:"svmessenger-message-avatar",children:s.jsx("img",{src:e.senderImageUrl||"/images/default-avatar.png",alt:e.senderUsername,onError:e=>{e.target.src="/images/default-avatar.png"}})}),s.jsxs("div",{className:"svmessenger-message-content",children:[s.jsx("div",{className:"svmessenger-message-bubble "+(o?"emoji-only":""),children:s.jsx("div",{className:"svmessenger-message-text",dangerouslySetInnerHTML:{__html:((e,s)=>{if(!s.trim())return D(e);const t=new RegExp(`(${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi"),n=e.replace(t,'<mark class="search-highlight">$1</mark>');return D(n)})(e.text,t)}})}),s.jsxs("div",{className:"svmessenger-message-meta",children:[s.jsx("span",{className:"svmessenger-message-time-only",children:z(e.sentAt)}),r&&s.jsx("div",{className:"svmessenger-message-read-status",children:r?e.isDelivered?e.isDelivered&&!e.isRead?s.jsxs("svg",{width:"18",height:"14",viewBox:"0 0 32 24",fill:"currentColor",className:"double-check-gray",children:[s.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"}),s.jsx("path",{d:"M17 16.17L12.83 12l-1.42 1.41L17 19 29 7l-1.41-1.41z"})]}):e.isDelivered&&e.isRead?s.jsxs("svg",{width:"18",height:"14",viewBox:"0 0 32 24",fill:"currentColor",className:"double-check-green",children:[s.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"}),s.jsx("path",{d:"M17 16.17L12.83 12l-1.42 1.41L17 19 29 7l-1.41-1.41z"})]}):null:s.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",className:"single-check",children:s.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})}):null})]})]})]})},$=({conversationId:e})=>{const{conversations:t,typingUsers:n}=A(),r=t.find(s=>s.id===e),o=n[e];if(!r||!o)return null;const a=r.otherUser;return s.jsxs("div",{className:"svmessenger-typing-indicator",children:[s.jsx("div",{className:"svmessenger-typing-avatar",children:s.jsx("img",{src:a.imageUrl||"/images/default-avatar.png",alt:a.username,onError:e=>{e.target.src="/images/default-avatar.png"}})}),s.jsxs("div",{className:"svmessenger-typing-content",children:[s.jsx("div",{className:"svmessenger-typing-bubble",children:s.jsxs("div",{className:"svmessenger-typing-dots",children:[s.jsx("span",{}),s.jsx("span",{}),s.jsx("span",{})]})}),s.jsxs("span",{className:"svmessenger-typing-text",children:[a.realName||a.username," Ð¿Ð¸ÑˆÐµ..."]})]})]})},B=({conversationId:t,searchQuery:n=""})=>{const{messagesByConversation:r,loadingMessages:o,typingUsers:a,loadMessages:i}=A(),c=Array.isArray(r[t])?r[t]:[],d=n.trim()?c.filter(e=>e.text&&e.text.toLowerCase().includes(n.toLowerCase())):c,u=o[t]||!1,h=a[t],p=e.useRef(null),v=e.useRef(null);e.useLayoutEffect(()=>{if(v.current&&(d.length>0||u)){const e=()=>{v.current&&(v.current.scrollTop=v.current.scrollHeight)};e(),setTimeout(e,10),setTimeout(e,50),setTimeout(e,100)}},[d.length,u]);const g=(e=>{if(!e||0===e.length)return[];const s=[];let t=null;return e.forEach((e,n)=>{const r="string"==typeof e.sentAt?l(e.sentAt):new Date(e.sentAt),o=m(r,"yyyy-MM-dd");o!==t&&(s.push({type:"date",date:r,dateKey:o,formattedDate:L(r)}),t=o),s.push({type:"message",message:e})}),s})(d);return s.jsxs("div",{className:"svmessenger-message-thread",ref:v,children:[u&&s.jsx("div",{className:"svmessenger-loading-messages",children:s.jsx("div",{className:"svmessenger-spinner"})}),s.jsx("div",{className:"svmessenger-messages",children:g.map((e,t)=>{if("date"===e.type)return s.jsx("div",{className:"svmessenger-date-separator",children:s.jsx("span",{className:"svmessenger-date-separator-text",children:e.formattedDate})},`date-${e.dateKey}`);g.length;return s.jsx("div",{ref:null,children:s.jsx(_,{message:e.message,searchQuery:n})},e.message.id)})}),h&&s.jsx($,{conversationId:t}),d.length>0&&!P(v.current)&&s.jsx("button",{className:"svmessenger-scroll-to-bottom",onClick:()=>((e,s=!0)=>{e&&e.scrollTo({top:e.scrollHeight,behavior:s?"smooth":"auto"})})(v.current),title:"Scroll to bottom",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"})})}),s.jsx("div",{ref:p})]})},W={search:"Ð¢ÑŠÑ€ÑÐµÐ½Ðµ",search_no_results_1:"Ðž, Ð½Ðµ!",search_no_results_2:"ÐÑÐ¼Ð° Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸ ÐµÐ¼Ð¾Ð´Ð¶Ð¸Ñ‚Ð°",pick:"Ð˜Ð·Ð±ÐµÑ€Ð¸ ÐµÐ¼Ð¾Ð´Ð¶Ð¸",categories:{activity:"ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸",custom:"ÐŸÐµÑ€ÑÐ¾Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð°Ð½Ð¸",flags:"Ð—Ð½Ð°Ð¼ÐµÐ½Ð°",foods:"Ð¥Ñ€Ð°Ð½Ð° Ð¸ Ð½Ð°Ð¿Ð¸Ñ‚ÐºÐ¸",frequent:"Ð§ÐµÑÑ‚Ð¾ Ð¸Ð·Ð¿Ð¾Ð»Ð·Ð²Ð°Ð½Ð¸",nature:"ÐŸÑ€Ð¸Ñ€Ð¾Ð´Ð°",objects:"ÐžÐ±ÐµÐºÑ‚Ð¸",people:"Ð¥Ð¾Ñ€Ð°",places:"ÐœÐµÑÑ‚Ð°",search:"Ð¢ÑŠÑ€ÑÐµÐ½Ðµ",smileys:"Ð£ÑÐ¼Ð¸Ð²ÐºÐ¸",symbols:"Ð¡Ð¸Ð¼Ð²Ð¾Ð»Ð¸"},skins:{choose:"Ð˜Ð·Ð±ÐµÑ€Ð¸ Ñ‚Ð¾Ð½",1:"Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚ÐµÐ½",2:"Ð¡Ð²ÐµÑ‚ÑŠÐ»",3:"Ð¡Ñ€ÐµÐ´Ð½Ð¾ ÑÐ²ÐµÑ‚ÑŠÐ»",4:"Ð¡Ñ€ÐµÐ´ÐµÐ½",5:"Ð¡Ñ€ÐµÐ´Ð½Ð¾ Ñ‚ÑŠÐ¼ÐµÐ½",6:"Ð¢ÑŠÐ¼ÐµÐ½"}},H=({onEmojiSelect:n,onClose:r,show:o})=>{const a=e.useRef(null);return e.useEffect(()=>{const e=e=>{"Escape"===e.key&&o&&r()};if(o)return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[o,r]),o?s.jsxs("div",{className:"svmessenger-emoji-picker-wrapper",children:[s.jsx("div",{className:"svmessenger-emoji-picker-backdrop",onClick:r}),s.jsx("div",{className:"svmessenger-emoji-picker-container",children:s.jsx(t,{ref:a,data:p,onEmojiSelect:n,skinTonePosition:"search",previewPosition:"none",searchPosition:"bottom",theme:"light",i18n:W,perLine:7,emojiSize:20,emojiButtonSize:28})})]}):null},J=({conversationId:t})=>{const{sendMessage:n}=A(),[r,o]=e.useState(""),[a,i]=e.useState(!1),[c,l]=e.useState(!1),d=e.useRef(null),u=e.useRef(null),{handleTyping:m,stopTyping:h}=(()=>{const s=e.useRef(null),t=e.useRef(!1),n=()=>{s.current&&clearTimeout(s.current),t.current&&(t.current=!1)};return e.useEffect(()=>()=>{n()},[]),{handleTyping:()=>{t.current||(t.current=!0),s.current&&clearTimeout(s.current),s.current=setTimeout(()=>{t.current=!1},2e3)},stopTyping:n}})();e.useEffect(()=>{d.current&&d.current.focus()},[t]),e.useEffect(()=>{if(d.current){const e=d.current,s=40,t=120;e.style.height="auto";const n=Math.min(Math.max(e.scrollHeight,s),t);e.style.height=`${n}px`}},[r]);const p=e=>{e.preventDefault(),r.trim()&&(n(t,r.trim()),o(""),h(),d.current&&(d.current.style.height="40px"))};return s.jsxs("div",{className:"svmessenger-message-input",children:[s.jsxs("form",{onSubmit:p,className:"svmessenger-input-form",children:[s.jsxs("div",{className:"svmessenger-input-container",children:[s.jsx("button",{type:"button",className:"svmessenger-attach-btn",onClick:e=>{e.preventDefault()},title:"ÐŸÑ€Ð¸ÐºÐ°Ñ‡Ð¸ Ñ„Ð°Ð¹Ð»",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"})})}),s.jsx("div",{className:"svmessenger-input-wrapper",children:s.jsx("textarea",{ref:d,className:"svmessenger-text-input",placeholder:"Aa",value:r,onChange:e=>{const s=e.target.value;o(s),s.trim()?m():h()},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),p(e))},onCompositionStart:()=>{i(!0)},onCompositionEnd:()=>{i(!1)},rows:1,maxLength:2e3})}),s.jsx("button",{ref:u,type:"button",className:"svmessenger-emoji-btn "+(c?"active":""),onClick:e=>{e.preventDefault(),l(!c)},title:"Ð•Ð¼Ð¾Ñ‚Ð¸ÐºÐ¾Ð½Ð¸",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-3.5-9c.83 0 1.5-.67 1.5-1.5S9.33 8.5 8.5 8.5 7 9.17 7 10s.67 1.5 1.5 1.5zm7 0c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zm-3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"})})}),r.trim()?s.jsx("button",{type:"submit",className:"svmessenger-send-btn",title:"Ð˜Ð·Ð¿Ñ€Ð°Ñ‚Ð¸ ÑÑŠÐ¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"})})}):s.jsx("button",{type:"button",className:"svmessenger-mic-btn",title:"Ð“Ð»Ð°ÑÐ¾Ð²Ð° Ð¿Ð¾Ñ€ÑŠÐºÐ° (Ð¿Ð¾-ÐºÑŠÑÐ½Ð¾)",disabled:!0,children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"})})})]}),s.jsx("div",{className:"svmessenger-input-helper",children:"ÐÐ°Ñ‚Ð¸ÑÐ½Ð¸ Enter Ð·Ð° Ð¸Ð·Ð¿Ñ€Ð°Ñ‰Ð°Ð½Ðµ â€¢ Shift+Enter Ð·Ð° Ð½Ð¾Ð² Ñ€ÐµÐ´"})]}),s.jsx(H,{show:c,onEmojiSelect:e=>{o(s=>s+e.native),l(!1),d.current&&d.current.focus()},onClose:()=>{l(!1)}})]})},K=({searchQuery:e,onSearchChange:t,onClose:n})=>s.jsxs("div",{className:"svmessenger-chat-search",children:[s.jsx("input",{type:"text",className:"svmessenger-chat-search-input",placeholder:"Ð¢ÑŠÑ€ÑÐ¸ Ð² Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð°...",value:e,onChange:e=>t(e.target.value),autoFocus:!0}),s.jsx("button",{className:"svmessenger-chat-search-close",onClick:n,title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸ Ñ‚ÑŠÑ€ÑÐµÐ½ÐµÑ‚Ð¾",children:"âœ•"})]}),G=({chat:t})=>{const{closeChat:n,minimizeChat:r,bringToFront:o,updateChatPosition:a,markAsRead:i,messagesByConversation:c,currentUser:l,startCall:d,openAudioSettings:u}=A(),m=e.useRef(null),[h,p]=e.useState(!1),[v,g]=e.useState({x:0,y:0}),[x,f]=e.useState(!1),[C,y]=e.useState("");e.useEffect(()=>{t.isMinimized||o(t.conversation.id)},[]);const b=e.useCallback(()=>{if(!t.isMinimized){o(t.conversation.id);(c[t.conversation.id]||[]).some(e=>e.senderId!==l.id&&!e.isRead)&&i(t.conversation.id)}},[t.conversation.id,t.isMinimized,o,i,c,l]),j=e.useCallback(e=>{e.target.closest(".svmessenger-chat-header")&&(e.target.closest(".svmessenger-chat-controls")||(p(!0),g({x:e.clientX-t.position.x,y:e.clientY-t.position.y}),o(t.conversation.id)))},[t.position,t.conversation.id,o]);e.useEffect(()=>{if(!h)return;const e=e=>{const s=e.clientX-v.x,n=e.clientY-v.y,r=window.innerWidth-400,o=window.innerHeight-600,i=Math.max(0,Math.min(s,r)),c=Math.max(0,Math.min(n,o));a(t.conversation.id,{x:i,y:c})},s=()=>{p(!1)};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",s),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",s)}},[h,v,t.conversation.id,a]);const w={left:`${t.position.x}px`,top:`${t.position.y}px`,zIndex:t.zIndex,display:t.isMinimized?"none":"flex"};return s.jsxs("div",{ref:m,className:"svmessenger-chat-window "+(h?"dragging":""),style:w,onMouseDown:j,onClick:b,children:[s.jsx(F,{conversation:t.conversation,onClose:()=>{n(t.conversation.id)},onMinimize:()=>{r(t.conversation.id)},onOpenSearch:()=>{f(!0)},onCall:()=>{d(t.conversation.id,t.conversation.otherUser.id,t.conversation)},onOpenAudioSettings:()=>{console.log("ðŸŽµ Opening audio settings from chat menu"),u()}}),x&&s.jsx(K,{searchQuery:C,onSearchChange:e=>{y(e)},onClose:()=>{f(!1),y("")}}),s.jsx(B,{conversationId:t.conversation.id,searchQuery:C}),s.jsx(J,{conversationId:t.conversation.id})]})},q=({onClose:t})=>{const{startConversation:n,openChat:r}=A(),[o,a]=e.useState(""),[i,c]=e.useState([]),[l,d]=e.useState(!1),[u,m]=e.useState(!1),h=((e,s=300)=>{let t;return function(...n){clearTimeout(t),t=setTimeout(()=>{clearTimeout(t),e(...n)},s)}})(async e=>{d(!0),m(!0);try{const s=await k(e);c(s)}catch(s){console.error("Search error:",s),c([])}finally{d(!1)}},300);e.useEffect(()=>{h("")},[]);const p=e.useCallback(async e=>{try{const s=await n(e.id);s&&s.id?(r(s.id,s),setTimeout(()=>{t()},100)):console.error("SVUserSearch: No conversation returned from startConversation")}catch(s){console.error("SVUserSearch: Failed to start conversation:",s)}},[n,r,t]);return s.jsxs("div",{className:"svmessenger-user-search",children:[s.jsxs("div",{className:"svmessenger-conversation-header",children:[s.jsx("h3",{children:"ÐÐ¾Ð² Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€"}),s.jsx("button",{className:"svmessenger-close-btn",onClick:t,title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]}),s.jsx("div",{className:"svmessenger-search-input",children:s.jsx("input",{type:"text",placeholder:"Ð¢ÑŠÑ€ÑÐ¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»Ð¸...",value:o,onChange:e=>{const s=e.target.value;a(s),h(s)},autoFocus:!0})}),s.jsx("div",{className:"svmessenger-search-results",children:u?l?s.jsxs("div",{className:"svmessenger-search-loading",children:[s.jsx("div",{className:"svmessenger-spinner"}),s.jsx("span",{children:"Ð¢ÑŠÑ€ÑÐµÐ½Ðµ..."})]}):0===i.length?s.jsxs("div",{className:"svmessenger-search-empty",children:[s.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"})}),s.jsx("p",{children:"ÐÑÐ¼Ð° Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸ ÑÐ»ÐµÐ´Ð²Ð°Ð½Ð¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»Ð¸"})]}):s.jsx("div",{className:"svmessenger-search-list",children:i.map(e=>s.jsxs("div",{className:"svmessenger-search-user-item",onClick:()=>p(e),children:[s.jsxs("div",{className:"svmessenger-search-user-avatar",children:[s.jsx("img",{src:e.imageUrl||"/images/default-avatar.png",alt:e.username,onError:e=>{e.target.src="/images/default-avatar.png"}}),e.isOnline&&s.jsx("div",{className:"svmessenger-online-indicator"})]}),s.jsxs("div",{className:"svmessenger-search-user-info",children:[s.jsx("h4",{className:"svmessenger-search-user-name",children:e.realName||e.username}),s.jsxs("p",{className:"svmessenger-search-user-username",children:["@",e.username]})]}),s.jsx("div",{className:"svmessenger-search-user-action",children:s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"})})})]},e.id))}):s.jsxs("div",{className:"svmessenger-search-empty",children:[s.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"})}),s.jsx("p",{children:"Ð—Ð°Ñ€ÐµÐ¶Ð´Ð°Ð½Ðµ Ð½Ð° ÑÐ»ÐµÐ´Ð²Ð°Ð½Ð¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»Ð¸..."})]})})]})},Q=()=>{const{activeChats:t,conversations:n,restoreChat:r,closeChat:o}=A(),a=e.useMemo(()=>t.filter(e=>e.isMinimized).map(e=>({...e,conversation:n.find(s=>s.id===e.conversation.id)||e.conversation})),[t,n]);if(0===a.length)return null;const i=[...a].reverse();return s.jsx("div",{className:"svmessenger-taskbar",children:i.map(e=>s.jsxs("button",{className:"svmessenger-taskbar-button","data-chat-id":e.conversation.id,onClick:()=>r(e.conversation.id),title:`Ð’ÑŠÐ·ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ Ñ ${e.conversation.otherUser.realName||e.conversation.otherUser.username}`,children:[s.jsxs("div",{className:"svmessenger-taskbar-avatar",children:[s.jsx("img",{src:e.conversation.otherUser.imageUrl||"/images/default-avatar.png",alt:e.conversation.otherUser.username,onError:e=>{e.target.src="/images/default-avatar.png"}}),e.conversation.otherUser.isOnline&&s.jsx("div",{className:"svmessenger-online-indicator"})]}),s.jsx("span",{className:"svmessenger-taskbar-name",children:e.conversation.otherUser.realName||e.conversation.otherUser.username}),e.conversation.unreadCount>0&&s.jsx("span",{className:"svmessenger-taskbar-badge",children:e.conversation.unreadCount>99?"99+":e.conversation.unreadCount}),s.jsx("button",{className:"svmessenger-taskbar-close",onClick:s=>{s.stopPropagation(),o(e.conversation.id)},title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸ Ñ‡Ð°Ñ‚",children:s.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]},e.conversation.id))})},Y=({callState:t,conversation:n,onAccept:r,onReject:o,onEnd:a})=>{const[i,c]=e.useState(0),[l,d]=e.useState(!1);e.useEffect(()=>{let e;return"connected"===t?e=setInterval(()=>{c(e=>e+1)},1e3):c(0),()=>{e&&clearInterval(e)}},[t]);if(!n||"idle"===t)return null;const{otherUser:u}=n,m=`svmessenger-call-modal svmessenger-call-${t}`;return s.jsx("div",{className:"svmessenger-call-modal-overlay",children:s.jsxs("div",{className:m,children:[s.jsx("div",{className:"svmessenger-call-avatar",children:u.imageUrl?s.jsx("img",{src:u.imageUrl,alt:u.realName||u.username}):s.jsx("div",{className:"svmessenger-call-avatar-placeholder",children:(u.realName||u.username||"U").charAt(0).toUpperCase()})}),s.jsxs("div",{className:"svmessenger-call-status",children:[s.jsxs("div",{className:"svmessenger-call-title",children:["incoming"===t&&"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¾ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½Ðµ","outgoing"===t&&"ÐžÐ±Ð°Ð¶Ð´Ð°Ð½Ðµ...","connected"===t&&"Ð’ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€"]}),s.jsx("div",{className:"svmessenger-call-subtitle",children:"connected"===t?(e=>{const s=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`})(i):u.realName||u.username}),("incoming"===t||"outgoing"===t)&&s.jsx("div",{className:"svmessenger-call-icon",children:s.jsx("i",{className:"bi bi-telephone-fill",style:{fontSize:"24px"}})})]}),s.jsxs("div",{className:"svmessenger-call-actions",children:["incoming"===t&&s.jsxs(s.Fragment,{children:[s.jsx("button",{className:"svmessenger-call-btn-accept",onClick:r,title:"ÐŸÑ€Ð¸ÐµÐ¼Ð¸ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½ÐµÑ‚Ð¾",children:s.jsx("i",{className:"bi bi-headphones",style:{fontSize:"24px"}})}),s.jsx("button",{className:"svmessenger-call-btn-reject",onClick:o,title:"ÐžÑ‚ÐºÐ°Ð¶Ð¸ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½ÐµÑ‚Ð¾",children:s.jsx("i",{className:"bi bi-headphones",style:{fontSize:"24px"}})})]}),"outgoing"===t&&s.jsx("button",{className:"svmessenger-call-btn-end",onClick:a,title:"ÐžÑ‚Ð¼ÐµÐ½Ð¸ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½ÐµÑ‚Ð¾",children:s.jsx("i",{className:"bi bi-telephone-x-fill",style:{fontSize:"24px"}})}),"connected"===t&&s.jsxs(s.Fragment,{children:[s.jsx("button",{className:"svmessenger-call-btn-mute "+(l?"muted":""),onClick:()=>{d(!l)},title:l?"Ð’ÐºÐ»ÑŽÑ‡Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ð°":"Ð˜Ð·ÐºÐ»ÑŽÑ‡Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ð°",children:l?s.jsx("i",{className:"bi bi-mic-mute-fill",style:{fontSize:"20px"}}):s.jsx("i",{className:"bi bi-mic-fill",style:{fontSize:"20px"}})}),s.jsx("button",{className:"svmessenger-call-btn-end",onClick:a,title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½ÐµÑ‚Ð¾",children:s.jsx("i",{className:"bi bi-telephone-x-fill",style:{fontSize:"24px"}})})]})]})]})})},X=({isOpen:t,onComplete:n,onCancel:r})=>{const{deviceSelectorMode:o}=A(),[a,i]=e.useState([]),[c,l]=e.useState([]),[d,u]=e.useState(""),[m,h]=e.useState(""),[p,v]=e.useState(75),[g,x]=e.useState(80),[f,C]=e.useState(!0),[y,b]=e.useState(!1),[j,w]=e.useState(null),[S,k]=e.useState(0),[N,I]=e.useState(null),[M,T]=e.useState(!1),[U,L]=e.useState({x:0,y:0}),[z,R]=e.useState({x:0,y:0}),D=e.useRef(null),P=e.useRef(null),O=e.useRef(null),V=e.useRef(null),F=e.useRef(null),_=e.useRef(null);e.useEffect(()=>{t&&setTimeout(()=>{if(D.current){D.current;const e=(window.innerWidth-400)/2,s=(window.innerHeight-500)/2;L({x:Math.max(0,e),y:Math.max(0,s)})}},0)},[t]);e.useEffect(()=>{if(!M)return;const e=e=>{if(!D.current)return;const s=D.current.offsetWidth,t=D.current.offsetHeight,n=e.clientX-z.x,r=e.clientY-z.y,o=window.innerWidth-s,a=window.innerHeight-t,i=Math.max(0,Math.min(n,o)),c=Math.max(0,Math.min(r,a));L({x:i,y:c})},s=()=>{T(!1)};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",s),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",s)}},[M,z]),e.useEffect(()=>{const e=localStorage.getItem("svmessenger-audio-settings");if(e)try{const s=JSON.parse(e);v(s.micVolume||75),x(s.speakerVolume||80),s.microphone&&(u(s.microphone),E.selectedMicrophone=s.microphone),s.speaker&&(h(s.speaker),E.selectedSpeaker=s.speaker)}catch(s){console.warn("Failed to load saved audio settings:",s)}},[]);const $=e=>{try{try{localStorage.setItem("svmessenger-audio-settings",JSON.stringify(e));localStorage.getItem("svmessenger-audio-settings")}catch(s){}e.microphone&&(E.selectedMicrophone=e.microphone),e.speaker&&(E.selectedSpeaker=e.speaker)}catch(t){console.warn("Failed to save audio settings:",t)}},B=(e,s)=>{"mic"===e?(v(s),$({micVolume:s,speakerVolume:g})):"speaker"===e&&(x(s),$({micVolume:p,speakerVolume:s}))};e.useEffect(()=>(t?W():(J(),G()),()=>{J(),G()}),[t]);const W=async()=>{try{C(!0),w(null),k(0),await E.requestAudioPermissions();const s=await E.enumerateAudioDevices();i(s.microphones),l(s.speakers);const t=localStorage.getItem("svmessenger-audio-settings");let n,r;if(t)try{const e=JSON.parse(t);n=e.microphone,r=e.speaker}catch(e){console.warn("Error parsing saved settings:",e)}const o=n||(s.microphones.length>0?s.microphones[0].deviceId:"");u(o),h(r||(s.speakers.length>0?s.speakers[0].deviceId:"")),o&&setTimeout(()=>{H(o)},100)}catch(s){w(s.message||"Failed to access audio devices"),console.error("Audio device initialization error:",s)}finally{C(!1)}},H=async e=>{try{let t;J(),P.current=new(window.AudioContext||window.webkitAudioContext),O.current=P.current.createAnalyser(),O.current.fftSize=2048,O.current.smoothingTimeConstant=.8;try{t=await navigator.mediaDevices.getUserMedia({audio:{deviceId:!e||{ideal:e},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})}catch(s){t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})}_.current=t,V.current=P.current.createMediaStreamSource(t),V.current.connect(O.current);const n=new Float32Array(O.current.fftSize),r=()=>{if(!O.current)return;O.current.getFloatTimeDomainData(n);let e=0;for(let r=0;r<n.length;r++)e+=n[r]*n[r];const s=Math.sqrt(e/n.length);let t=0;s>0&&(t=Math.min(100,Math.max(0,300*s)),t<50&&(t*=1.5)),k(Math.min(100,t)),F.current=requestAnimationFrame(r)};r()}catch(t){console.error("Error starting audio visualization:",t),k(0)}},J=()=>{F.current&&(cancelAnimationFrame(F.current),F.current=null),V.current&&(V.current.disconnect(),V.current=null),_.current&&(_.current.getTracks().forEach(e=>e.stop()),_.current=null),P.current&&"closed"!==P.current.state&&(P.current.close(),P.current=null),O.current=null,k(0)},K=async()=>{try{b(!0),I(null);const s=new(window.AudioContext||window.webkitAudioContext),t=s.createOscillator(),n=s.createGain(),r=document.createElement("audio");if(m&&"setSinkId"in HTMLAudioElement.prototype)try{await r.setSinkId(m)}catch(e){}const o=s.createMediaStreamDestination();t.connect(n),n.connect(o),r.srcObject=o.stream,r.volume=g/100,t.frequency.setValueAtTime(440,s.currentTime),n.gain.setValueAtTime(1,s.currentTime),t.start(),await r.play(),n.gain.exponentialRampToValueAtTime(.01,s.currentTime+1),t.stop(s.currentTime+1),setTimeout(()=>{r.pause(),r.srcObject=null,s.close(),I({speakerWorking:!0}),b(!1)},1200)}catch(s){console.error("Speaker test failed:",s),I({speakerWorking:!1,error:s.message}),b(!1)}},G=()=>{b(!1),I(null)},q=({level:e,label:t})=>s.jsxs("div",{style:{padding:"8px",background:"#f3f4f6",borderRadius:"6px",marginTop:"6px"},children:[t&&s.jsx("div",{style:{display:"block",marginBottom:"6px",fontSize:"10px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:t}),s.jsx("div",{style:{position:"relative",height:"5px",background:"#d1d5db",borderRadius:"3px",overflow:"hidden"},children:s.jsx("div",{style:{position:"absolute",left:0,top:0,height:"100%",width:`${e}%`,background:e>70?"#22c55e":e>30?"#eab308":"#ef4444",transition:"width 0.1s ease",borderRadius:"3px"}})}),s.jsxs("div",{style:{marginTop:"3px",fontSize:"10px",fontWeight:"600",color:"#6b7280",textAlign:"right"},children:[Math.round(e),"%"]})]});return t?s.jsxs("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1e4,pointerEvents:"none"},children:[s.jsxs("div",{ref:D,style:{position:"absolute",left:`${U.x}px`,top:`${U.y}px`,background:"#ffffff",borderRadius:"12px",width:"400px",maxHeight:"500px",display:"flex",flexDirection:"column",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.25)",pointerEvents:"auto"},children:[s.jsxs("div",{className:"audio-device-header",style:{padding:"14px 20px",borderBottom:"1px solid #e5e7eb",textAlign:"center",position:"sticky",top:0,background:"#ffffff",zIndex:10,borderRadius:"12px 12px 0 0",cursor:M?"grabbing":"grab",userSelect:"none"},onMouseDown:e=>{const s=e.target.closest(".audio-device-header"),t=e.target.closest(".audio-device-close");if(s&&!t&&(T(!0),D.current)){const s=D.current.getBoundingClientRect();R({x:e.clientX-s.left,y:e.clientY-s.top})}},children:[s.jsx("button",{className:"audio-device-close",onClick:r,style:{position:"absolute",top:"12px",right:"12px",background:"none",border:"none",cursor:"pointer",padding:"4px",display:"flex",alignItems:"center",justifyContent:"center",color:"#6b7280",fontSize:"18px",lineHeight:"1",width:"24px",height:"24px",borderRadius:"4px",transition:"all 0.2s ease"},onMouseEnter:e=>{e.currentTarget.style.background="#f3f4f6",e.currentTarget.style.color="#111827"},onMouseLeave:e=>{e.currentTarget.style.background="none",e.currentTarget.style.color="#6b7280"},title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸",children:s.jsx("i",{className:"bi bi-x",style:{fontSize:"20px",fontWeight:"300"}})}),s.jsx("div",{style:{width:"36px",height:"36px",background:"linear-gradient(135deg, #22c55e 0%, #16a34a 100%)",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 10px",boxShadow:"0 4px 12px rgba(34, 197, 94, 0.3)"},children:s.jsx("i",{className:"bi bi-gear-fill",style:{fontSize:"18px",color:"#ffffff"}})}),s.jsx("h2",{style:{margin:"0 0 4px 0",fontSize:"16px",fontWeight:"700",color:"#111827"},children:"ÐÑƒÐ´Ð¸Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸"}),s.jsx("p",{style:{margin:0,fontSize:"10px",color:"#6b7280"},children:"ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°Ñ‚Ð° ÑÐ¸ Ð·Ð° ÐºÐ°Ñ‡ÐµÑÑ‚Ð²ÐµÐ½ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€"})]}),f&&s.jsxs("div",{style:{padding:"32px 20px",textAlign:"center"},children:[s.jsx("div",{style:{width:"36px",height:"36px",border:"3px solid #e5e7eb",borderTop:"3px solid #22c55e",borderRadius:"50%",animation:"spin 1s linear infinite",margin:"0 auto 12px"}}),s.jsx("h4",{style:{margin:"0 0 6px 0",fontSize:"13px",fontWeight:"600",color:"#111827"},children:"Ð˜ÑÐºÐ°Ð½Ðµ Ð½Ð° Ð´Ð¾ÑÑ‚ÑŠÐ¿ Ð´Ð¾ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½"}),s.jsx("p",{style:{margin:0,fontSize:"11px",color:"#6b7280"},children:"ÐœÐ¾Ð»Ñ, Ð¿Ð¾Ð·Ð²Ð¾Ð»ÐµÑ‚Ðµ Ð´Ð¾ÑÑ‚ÑŠÐ¿Ð° Ð² browser Ð¿Ñ€Ð¾Ð·Ð¾Ñ€ÐµÑ†Ð°"})]}),j&&s.jsxs("div",{style:{padding:"24px 20px",textAlign:"center"},children:[s.jsx("div",{style:{width:"40px",height:"40px",background:"#fee2e2",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 12px"},children:s.jsx("i",{className:"bi bi-exclamation-triangle-fill",style:{fontSize:"20px",color:"#ef4444"}})}),s.jsx("h4",{style:{margin:"0 0 6px 0",fontSize:"13px",fontWeight:"600",color:"#ef4444"},children:"Ð“Ñ€ÐµÑˆÐºÐ° Ð¿Ñ€Ð¸ Ð´Ð¾ÑÑ‚ÑŠÐ¿ Ð´Ð¾ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°"}),s.jsx("p",{style:{margin:"0 0 12px 0",fontSize:"11px",color:"#6b7280"},children:j}),s.jsx("button",{onClick:W,style:{background:"#ef4444",color:"#ffffff",border:"none",padding:"8px 18px",borderRadius:"6px",fontSize:"12px",fontWeight:"600",cursor:"pointer",boxShadow:"0 2px 6px rgba(239, 68, 68, 0.3)"},children:"ÐžÐ¿Ð¸Ñ‚Ð°Ð¹ Ð¾Ñ‚Ð½Ð¾Ð²Ð¾"})]}),!f&&!j&&s.jsxs("div",{style:{padding:"16px 20px",overflowY:"auto",flex:1,maxHeight:"calc(500px - 120px)"},children:[s.jsxs("div",{style:{background:"#f9fafb",border:"1px solid #e5e7eb",borderRadius:"10px",padding:"14px",marginBottom:"12px"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",marginBottom:"12px"},children:[s.jsx("div",{style:{width:"32px",height:"32px",background:"#22c55e",borderRadius:"6px",display:"flex",alignItems:"center",justifyContent:"center"},children:s.jsx("i",{className:"bi bi-mic-fill",style:{fontSize:"16px",color:"#ffffff"}})}),s.jsx("h3",{style:{margin:0,fontSize:"13px",fontWeight:"600",color:"#111827"},children:"ÐœÐ¸ÐºÑ€Ð¾Ñ„Ð¾Ð½"})]}),s.jsxs("div",{style:{marginBottom:"12px"},children:[s.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"10px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"Ð£ÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾"}),s.jsx("select",{value:d,onChange:e=>(async e=>{try{await E.setMicrophone(e),u(e),J(),await H(e);const s={...JSON.parse(localStorage.getItem("svmessenger-audio-settings")||"{}"),microphone:e,micVolume:p};$(s)}catch(s){console.error("Error changing microphone:",s)}})(e.target.value),style:{width:"100%",padding:"8px 10px",border:"1px solid #d1d5db",borderRadius:"6px",background:"#ffffff",color:"#111827",fontSize:"12px",cursor:"pointer"},children:a.map(e=>s.jsx("option",{value:e.deviceId,children:e.label||`ÐœÐ¸ÐºÑ€Ð¾Ñ„Ð¾Ð½ ${e.deviceId.slice(0,8)}`},e.deviceId))})]}),s.jsxs("div",{children:[s.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"10px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"Ð¡Ð¸Ð»Ð° Ð½Ð° Ð·Ð²ÑƒÐºÐ°"}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"10px",background:"#f3f4f6",borderRadius:"6px"},children:[s.jsx("i",{className:"bi bi-volume-down-fill",style:{fontSize:"14px",color:"#22c55e"}}),s.jsx("input",{type:"range",min:"0",max:"100",value:p,onChange:e=>B("mic",Number(e.target.value)),style:{flex:1,height:"4px",background:"#d1d5db",borderRadius:"2px",outline:"none",cursor:"pointer"}}),s.jsxs("span",{style:{fontSize:"12px",fontWeight:"600",color:"#111827",minWidth:"35px",textAlign:"right"},children:[p,"%"]})]})]}),s.jsx(q,{level:S})]}),s.jsxs("div",{style:{background:"#f9fafb",border:"1px solid #e5e7eb",borderRadius:"10px",padding:"14px",marginBottom:"12px"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",marginBottom:"12px"},children:[s.jsx("div",{style:{width:"32px",height:"32px",background:"#22c55e",borderRadius:"6px",display:"flex",alignItems:"center",justifyContent:"center"},children:s.jsx("i",{className:"bi bi-headphones",style:{fontSize:"16px",color:"#ffffff"}})}),s.jsx("h3",{style:{margin:0,fontSize:"13px",fontWeight:"600",color:"#111827"},children:"Ð¡Ð»ÑƒÑˆÐ°Ð»ÐºÐ¸"})]}),s.jsxs("div",{style:{marginBottom:"12px"},children:[s.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"10px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"Ð£ÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾"}),s.jsx("select",{value:m,onChange:e=>(async e=>{try{await E.setSpeaker(e),h(e);const s={...JSON.parse(localStorage.getItem("svmessenger-audio-settings")||"{}"),speaker:e,speakerVolume:g};$(s)}catch(s){console.error("Error changing speaker:",s)}})(e.target.value),style:{width:"100%",padding:"8px 10px",border:"1px solid #d1d5db",borderRadius:"6px",background:"#ffffff",color:"#111827",fontSize:"12px",cursor:"pointer"},children:c.map(e=>s.jsx("option",{value:e.deviceId,children:e.label||`Ð¡Ð»ÑƒÑˆÐ°Ð»ÐºÐ¸ ${e.deviceId.slice(0,8)}`},e.deviceId))})]}),s.jsxs("div",{children:[s.jsx("label",{style:{display:"block",marginBottom:"6px",fontSize:"10px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"Ð¡Ð¸Ð»Ð° Ð½Ð° Ð·Ð²ÑƒÐºÐ°"}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"10px",background:"#f3f4f6",borderRadius:"6px"},children:[s.jsx("i",{className:"bi bi-volume-up-fill",style:{fontSize:"14px",color:"#22c55e"}}),s.jsx("input",{type:"range",min:"0",max:"100",value:g,onChange:e=>B("speaker",Number(e.target.value)),style:{flex:1,height:"4px",background:"#d1d5db",borderRadius:"2px",outline:"none",cursor:"pointer"}}),s.jsxs("span",{style:{fontSize:"12px",fontWeight:"600",color:"#111827",minWidth:"35px",textAlign:"right"},children:[g,"%"]})]})]})]}),s.jsxs("div",{style:{background:"#eaffe9",border:"1px solid #fbbf24",borderRadius:"10px",padding:"12px",marginBottom:"12px"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",marginBottom:"10px"},children:[s.jsx("i",{className:"bi bi-info-circle-fill",style:{fontSize:"14px",color:"#22c45e"}}),s.jsx("span",{style:{fontSize:"12px",fontWeight:"600",color:"#124100"},children:"Ð¢ÐµÑÑ‚ Ð½Ð° ÑÐ»ÑƒÑˆÐ°Ð»ÐºÐ¸"})]}),s.jsx("p",{style:{margin:"0 0 10px 0",fontSize:"11px",color:"#004217"},children:"ÐÐ°Ñ‚Ð¸ÑÐ½ÐµÑ‚Ðµ Ð±ÑƒÑ‚Ð¾Ð½Ð° Ð¿Ð¾-Ð´Ð¾Ð»Ñƒ, Ð·Ð° Ð´Ð° Ñ‡ÑƒÐµÑ‚Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð² ÑÐ¸Ð³Ð½Ð°Ð» Ð¸ Ð´Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚Ðµ Ð´Ð°Ð»Ð¸ ÑÐ»ÑƒÑˆÐ°Ð»ÐºÐ¸Ñ‚Ðµ Ñ€Ð°Ð±Ð¾Ñ‚ÑÑ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð½Ð¾."}),s.jsx("button",{onClick:()=>{y?G():K()},disabled:0===c.length||y,style:{width:"100%",padding:"10px",background:y?"#6bb75f":"#2c9002",color:"#ffffff",border:"none",borderRadius:"6px",fontSize:"12px",fontWeight:"600",cursor:0===c.length||y?"not-allowed":"pointer",opacity:0===c.length||y?.5:1,display:"flex",alignItems:"center",justifyContent:"center",gap:"6px"},children:y?s.jsxs(s.Fragment,{children:[s.jsx("div",{style:{width:"14px",height:"14px",border:"2px solid #ffffff",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 0.8s linear infinite"}}),"Ð¢ÐµÑÑ‚Ð²Ð°Ð½Ðµ..."]}):s.jsxs(s.Fragment,{children:[s.jsx("i",{className:"bi bi-play-circle-fill",style:{fontSize:"14px"}}),"Ð¢ÐµÑÑ‚Ð²Ð°Ð¹ ÑÐ»ÑƒÑˆÐ°Ð»ÐºÐ¸"]})}),N&&s.jsx("div",{style:{marginTop:"10px",padding:"10px",background:"#ffffff",borderRadius:"6px"},children:s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"6px"},children:[s.jsx("i",{className:"bi bi-"+(N.speakerWorking?"check-circle-fill":"x-circle-fill"),style:{fontSize:"14px",color:N.speakerWorking?"#22c55e":"#ef4444"}}),s.jsx("span",{style:{fontSize:"12px",color:"#374151"},children:N.speakerWorking?"Ð¡Ð»ÑƒÑˆÐ°Ð»ÐºÐ¸Ñ‚Ðµ Ñ€Ð°Ð±Ð¾Ñ‚ÑÑ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð½Ð¾":"ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼ ÑÑŠÑ ÑÐ»ÑƒÑˆÐ°Ð»ÐºÐ¸Ñ‚Ðµ"})]})})]})]}),s.jsxs("div",{style:{padding:"14px 20px",borderTop:"1px solid #e5e7eb",display:"flex",gap:"10px",justifyContent:"flex-end"},children:[s.jsx("button",{onClick:r,disabled:f,style:{padding:"8px 18px",background:"#ffffff",color:"#6b7280",border:"1px solid #d1d5db",borderRadius:"6px",fontSize:"12px",fontWeight:"600",cursor:f?"not-allowed":"pointer",opacity:f?.5:1},children:"ÐžÑ‚ÐºÐ°Ð·"}),s.jsx("button",{onClick:()=>{J(),G();$({microphone:d,speaker:m,micVolume:p,speakerVolume:g}),n({microphone:d,speaker:m,micVolume:p/100,speakerVolume:g/100})},disabled:f||j||0===a.length,style:{padding:"8px 18px",background:f||j||0===a.length?"#d1d5db":"#22c55e",color:"#ffffff",border:"none",borderRadius:"6px",fontSize:"12px",fontWeight:"600",cursor:f||j||0===a.length?"not-allowed":"pointer",boxShadow:f||j||0===a.length?"none":"0 2px 6px rgba(34, 197, 94, 0.3)"},children:"settings"===o?"Ð—Ð°Ð¿Ð°Ð·Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸":"Ð—Ð°Ð¿Ð¾Ñ‡Ð½Ð¸ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€"})]})]}),s.jsx("style",{children:"\n        @keyframes spin {\n          0% { transform: rotate(0deg); }\n          100% { transform: rotate(360deg); }\n        }\n      "})]}):null},Z=()=>{var e,t,n,r;const{isChatListOpen:o,isSearchOpen:a,activeChats:i,totalUnreadCount:c,openChatList:l,closeChatList:d,openSearch:u,closeSearch:m,currentCall:h,callState:p,acceptCall:v,rejectCall:g,endCall:x,showDeviceSelector:f,handleDeviceSelectorComplete:C,handleDeviceSelectorCancel:y,callWindowRef:b}=A();return s.jsxs("div",{className:"svmessenger-widget",children:[s.jsxs("div",{className:"svmessenger-fab",onClick:l,children:[s.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"})}),c>0&&s.jsx("span",{className:"svmessenger-badge",children:c>99?"99+":c})]}),o&&s.jsx(V,{onClose:d,onSearchClick:()=>{d(),u()}}),a&&s.jsx(q,{onClose:m}),i.map(e=>s.jsx(G,{chat:e},e.conversation.id)),s.jsx(X,{isOpen:f,onComplete:C,onCancel:y}),"idle"!==p&&h&&h.conversation&&!b&&s.jsx(Y,{callState:p,conversation:h.conversation,onAccept:v,onReject:g,onEnd:x}),"idle"!==p&&h&&b&&s.jsx("div",{className:"svmessenger-call-indicator",children:s.jsxs("div",{className:"svmessenger-call-indicator-content",children:[s.jsx("div",{className:"svmessenger-call-indicator-icon",children:s.jsx("i",{className:"bi bi-headphones"})}),s.jsxs("div",{className:"svmessenger-call-indicator-text",children:[s.jsxs("div",{className:"svmessenger-call-indicator-title",children:["outgoing"===p&&"ÐžÐ±Ð°Ð¶Ð´Ð°Ð½Ðµ...","incoming"===p&&"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¾ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½Ðµ","connected"===p&&"Ð’ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€"]}),s.jsx("div",{className:"svmessenger-call-indicator-subtitle",children:(null==(t=null==(e=h.conversation)?void 0:e.otherUser)?void 0:t.realName)||(null==(r=null==(n=h.conversation)?void 0:n.otherUser)?void 0:r.username)||"ÐŸÐ¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»"})]}),s.jsx("button",{className:"svmessenger-call-indicator-close",onClick:x,title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½ÐµÑ‚Ð¾",children:s.jsx("i",{className:"bi bi-x"})})]})}),s.jsx(Q,{})]})};function ee(){const e=window.SVMESSENGER_USER_DATA||{isAuthenticated:!1};return e.isAuthenticated?s.jsx(T,{userData:e,children:s.jsx(Z,{})}):null}const se=document.getElementById("svmessenger-root");se?n.createRoot(se).render(s.jsx(r.StrictMode,{children:s.jsx(ee,{})})):console.warn("SVMessenger: Root element #svmessenger-root not found");
