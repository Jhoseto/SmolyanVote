import{r as e,j as s,$ as n,c as t,R as r}from"./svmessenger-vendor-react.js";import{s as a,a as o,t as i,i as c,l,b as d,c as u,d as m}from"./svmessenger-svHelpers.js";import{p as h,a as g,b as v,f as p,d as x,e as f}from"./svmessenger-vendor.js";import"./svmessenger-vendor-livekit.js";import"./svmessenger-vendor-websocket.js";const C="/api/svmessenger",b=async(e,s={})=>{const n={headers:{"Content-Type":"application/json"},credentials:"include"},t=(()=>{if(window.CSRF_TOKEN)return window.CSRF_TOKEN;if(window.getCsrfToken&&"function"==typeof window.getCsrfToken){const e=window.getCsrfToken();if(e)return e}const e=document.querySelector('meta[name="_csrf"]');if(e&&e.content)return e.content;if(window.SVMESSENGER_CSRF&&window.SVMESSENGER_CSRF.token)return window.SVMESSENGER_CSRF.token;const s=document.cookie.match(/(?:^|; )XSRF-TOKEN=([^;]+)/);return s?decodeURIComponent(s[1]):null})(),r=(()=>{if(window.CSRF_HEADER)return window.CSRF_HEADER;if(window.getCsrfHeader&&"function"==typeof window.getCsrfHeader)return window.getCsrfHeader();const e=document.querySelector('meta[name="_csrf_header"]');return e&&e.content?e.content:window.SVMESSENGER_CSRF&&window.SVMESSENGER_CSRF.headerName?window.SVMESSENGER_CSRF.headerName:"X-XSRF-TOKEN"})();t&&r?n.headers[r]=t:console.warn("âš ï¸ CSRF token not found - API call may fail");try{const t=await fetch(e,{...n,...s});if(!t.ok){const e=await t.json().catch(()=>({message:`HTTP ${t.status}: ${t.statusText}`}));throw new Error(e.message||"API request failed")}return t.json()}catch(a){throw console.error("API Error:",a),a}},j=async()=>b(`${C}/conversations`),y=async e=>b(`${C}/conversations/${e}`),S=async(e,s=null)=>b(`${C}/conversations/start`,{method:"POST",body:JSON.stringify({otherUserId:e,initialMessage:s})}),w=async e=>b(`${C}/conversations/${e}/read`,{method:"PUT"}),N=async()=>b(`${C}/messages/delivered`,{method:"PUT"}),k=async e=>b(`${C}/conversations/${e}/hide`,{method:"PUT"}),I=async(e,s=0,n=50)=>b(`${C}/messages/conversation/${e}?page=${s}&size=${n}`),E=async(e,s)=>b(`${C}/messages/send`,{method:"POST",body:JSON.stringify({conversationId:e,text:s,messageType:"TEXT"})}),M=async e=>b(`${C}/users/search?query=${encodeURIComponent(e||"")}`),R=async e=>{const s=e?`${C}/users/following?query=${encodeURIComponent(e)}`:`${C}/users/following`;return b(s)},T=async()=>b(`${C}/unread-count`),U=async(e,s)=>b(`${C}/call/token`,{method:"POST",body:JSON.stringify({conversationId:e,otherUserId:s})}),A=e.createContext(null),z=()=>{const s=e.useContext(A);if(!s)throw new Error("useMessages must be used within MessagesProvider");return s},L=({children:n,currentUser:t})=>{const[r,o]=e.useState([]),[i,c]=e.useState({}),[l,d]=e.useState(!1),[u,m]=e.useState({}),[h,g]=e.useState({}),[v,p]=e.useState(0),[x,f]=e.useState(!1),C=e.useRef({}),b=e.useRef(null),M=e.useRef(r),R=e.useRef(i),U=e.useRef(new Set);e.useEffect(()=>{if(!b.current){const e=new window.Audio("/svmessenger/sounds/s1.mp3");e.preload="auto",b.current=e}},[]),e.useEffect(()=>{M.current=r},[r]),e.useEffect(()=>{R.current=i},[i]);const z=e.useCallback(()=>{f(!0)},[]),L=e.useCallback(()=>{f(!1)},[]),D=e.useCallback(e=>{console.error("SVMessenger: WebSocket error",e)},[]),O=e.useCallback((e,s=[])=>{if(!(e&&e.id&&e.text&&e.conversationId&&e.sentAt))return void console.warn("handleNewMessage: Invalid message received",e);const n=`${e.id}-${e.conversationId}`;if(U.current.has(n))return;U.current.add(n),setTimeout(()=>{U.current.delete(n)},5e3),c(s=>{const n=(s[e.conversationId]||[]).filter(e=>e&&e.id&&e.text&&e.sentAt),t=n.findIndex(s=>s.id===e.id);if(-1!==t){const r=[...n];return r[t]={...r[t],...e},{...s,[e.conversationId]:r}}return{...s,[e.conversationId]:[...n,e]}}),o(s=>s.map(s=>s.id===e.conversationId?{...s,lastMessage:e.text,lastMessageTime:e.sentAt}:s));const t=s.find(s=>s.conversation.id===e.conversationId),a=t&&!t.isMinimized,i=t&&t.isMinimized;if(a);else if(i)o(s=>{const n=s.map(s=>s.id===e.conversationId?{...s,unreadCount:(s.unreadCount||0)+1}:s),t=n.reduce((e,s)=>e+(s.unreadCount||0),0);return p(t),n});else{r.some(s=>s.id===e.conversationId)?o(s=>{const n=s.map(s=>s.id===e.conversationId?{...s,unreadCount:(s.unreadCount||0)+1}:s),t=n.reduce((e,s)=>e+(s.unreadCount||0),0);return p(t),n}):y(e.conversationId).then(e=>{e&&o(s=>{const n=s.some(s=>s.id===e.id)?s.map(s=>s.id===e.id?{...s,unreadCount:(s.unreadCount||0)+1}:s):[{...e,unreadCount:(e.unreadCount||0)+1},...s],t=n.reduce((e,s)=>e+(s.unreadCount||0),0);return p(t),n})}).catch(e=>{console.error("Failed to fetch conversation:",e)}),Q(),X(e)}},[r]),B=e.useCallback(e=>{const{conversationId:s,userId:n,isTyping:t}=e;t?(g(e=>({...e,[s]:n})),C.current[s]&&clearTimeout(C.current[s]),C.current[s]=setTimeout(()=>{g(e=>{const n={...e};return delete n[s],n})},3e3)):g(e=>{const n={...e};return delete n[s],n})},[]),F=e.useCallback(e=>{if(!e)return;const{type:s,conversationId:n,messageId:r,readAt:a}=e;"BULK_READ"===s?(c(e=>({...e,[n]:(e[n]||[]).filter(e=>e&&e.id&&e.text&&e.sentAt).map(e=>e.senderId===t.id?{...e,isRead:!0,readAt:e.readAt||a}:e)})),o(e=>{const s=e.map(e=>e.id===n?{...e,unreadCount:0}:e),t=s.reduce((e,s)=>e+(s.unreadCount||0),0);return p(t),s})):r&&(c(e=>({...e,[n]:(e[n]||[]).filter(e=>e&&e.id&&e.text&&e.sentAt).map(e=>e.id===r&&e.senderId===t.id?{...e,isRead:!0,readAt:a}:e)})),o(e=>{const s=e.map(e=>e.id===n?{...e,unreadCount:Math.max(0,(e.unreadCount||0)-1)}:e),t=s.reduce((e,s)=>e+(s.unreadCount||0),0);return p(t),s}))},[t]),V=e.useCallback(e=>{if("BULK_DELIVERY"===e.type){const{conversationIds:s,deliveredAt:n}=e;c(e=>{const r={...e};return s.forEach(e=>{r[e]&&(r[e]=r[e].filter(e=>e&&e.id&&e.text&&e.sentAt).map(e=>({...e,isDelivered:!0,deliveredAt:e.senderId!==t.id?n:e.deliveredAt})))}),r})}else{const{conversationId:s,messageId:n,deliveredAt:t}=e;c(e=>({...e,[s]:(e[s]||[]).filter(e=>e&&e.id&&e.text&&e.sentAt).map(e=>e.id===n?{...e,isDelivered:!0,deliveredAt:t}:e)}))}},[t]),$=e.useCallback(e=>{const{userId:s,isOnline:n}=e;o(e=>e.map(e=>e.otherUser.id===s?{...e,otherUser:{...e.otherUser,isOnline:n}}:e))},[]),_=e.useCallback(async()=>{d(!0);try{const s=await j();o(s);const n=s.reduce((e,s)=>e+(s.unreadCount||0),0);p(n);try{await N()}catch(e){console.warn("Failed to mark messages as delivered:",e)}}catch(e){console.error("Failed to load conversations:",e)}finally{d(!1)}},[]),W=e.useCallback(async(e,s=0,n=50)=>{m(s=>({...s,[e]:!0}));try{const t=await I(e,s,n),r=t&&t.content&&Array.isArray(t.content)?t.content:Array.isArray(t)?t:[],a=[...r].reverse().sort((e,s)=>{if(!e||!s)return 0;return(e.sentAt?new Date(e.sentAt).getTime():0)-(s.sentAt?new Date(s.sentAt).getTime():0)});c(n=>{const t=n[e]||[];if(0===s){const s=new Set;a.forEach(e=>{e&&e.id&&s.add(e.id)});const r=t.filter(e=>e&&e.id&&!s.has(e.id)),o=[...a,...r],i=new Map;o.forEach(e=>{e&&e.id&&e.text&&e.sentAt&&i.set(e.id,e)});const c=Array.from(i.values()).sort((e,s)=>(e.sentAt?new Date(e.sentAt).getTime():0)-(s.sentAt?new Date(s.sentAt).getTime():0));return{...n,[e]:c}}{const s=new Set;t.forEach(e=>{e&&e.id&&s.add(e.id)});const r=[...a.filter(e=>e&&e.id&&!s.has(e.id)),...t],o=new Map;r.forEach(e=>{e&&e.id&&e.text&&e.sentAt&&o.set(e.id,e)});const i=Array.from(o.values()).sort((e,s)=>(e.sentAt?new Date(e.sentAt).getTime():0)-(s.sentAt?new Date(s.sentAt).getTime():0));return{...n,[e]:i}}})}catch(t){console.error("Failed to load messages:",t)}finally{m(s=>({...s,[e]:!1}))}},[]),P=e.useCallback(async(e,s)=>{if(s.trim()&&x)try{await E(e,s.trim())}catch(n){console.error("Failed to send message:",n),alert("Ð“Ñ€ÐµÑˆÐºÐ° Ð¿Ñ€Ð¸ Ð¸Ð·Ð¿Ñ€Ð°Ñ‰Ð°Ð½Ðµ Ð½Ð° ÑÑŠÐ¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ. ÐœÐ¾Ð»Ñ Ð¾Ð¿Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ Ð¾Ñ‚Ð½Ð¾Ð²Ð¾.")}else console.warn("Cannot send message: empty text or not connected")},[x]),H=e.useCallback(async e=>{try{const s=await S(e);if(!s||!s.id)throw console.error("Invalid conversation from API",s),new Error("Invalid conversation returned from API");return o(e=>e.some(e=>e.id===s.id)?e:[s,...e]),s}catch(s){throw console.error("Failed to start conversation:",s),alert("Ð“Ñ€ÐµÑˆÐºÐ° Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ð½Ðµ Ð½Ð° Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€."),s}},[]),K=e.useCallback(async e=>{try{await w(e),o(s=>{const n=s.map(s=>s.id===e?{...s,unreadCount:0}:s),t=n.reduce((e,s)=>e+(s.unreadCount||0),0);return p(t),n}),c(s=>({...s,[e]:(s[e]||[]).filter(e=>e&&e.id&&e.text&&e.sentAt).map(e=>({...e,isRead:e.senderId!==t.id||e.isRead,readAt:e.senderId===t.id||e.isRead?e.readAt:(new Date).toISOString()}))}))}catch(s){console.error("Failed to mark as read:",s)}},[t]),J=e.useCallback(async()=>{try{const e=await T();p(e.count)}catch(e){console.error("Failed to load unread count:",e)}},[]),q=e.useCallback((e,s)=>{x&&a.sendTypingStatus(e,s)},[x]),G=e.useCallback(async e=>{try{(await k(e)).success&&o(s=>s.filter(s=>s.id!==e))}catch(s){console.error("Failed to hide conversation:",s),alert("Ð“Ñ€ÐµÑˆÐºÐ° Ð¿Ñ€Ð¸ ÑÐºÑ€Ð¸Ð²Ð°Ð½Ðµ Ð½Ð° Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð°. ÐœÐ¾Ð»Ñ Ð¾Ð¿Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ Ð¾Ñ‚Ð½Ð¾Ð²Ð¾.")}},[]),Q=()=>{b.current&&(b.current.currentTime=0,b.current.play().catch(()=>{}))},X=e=>{if("Notification"in window&&"granted"===Notification.permission)try{new Notification(`ÐÐ¾Ð²Ð¾ ÑÑŠÐ¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ ${e.senderUsername}`,{body:e.text.substring(0,100),icon:e.senderImageUrl||"/images/default-avatar.png",badge:"/images/svmessenger-icon.png",tag:`svmessenger-${e.conversationId}`,requireInteraction:!1})}catch(s){console.error("Error showing notification:",s)}};e.useEffect(()=>{_(),J(),"Notification"in window&&"default"===Notification.permission&&Notification.requestPermission().then(e=>{})},[]);const Y={currentUser:t,conversations:r,messagesByConversation:i,isLoadingConversations:l,loadingMessages:u,typingUsers:h,totalUnreadCount:v,isWebSocketConnected:x,loadConversations:_,loadMessages:W,sendMessage:P,startConversation:H,markAsRead:K,sendTypingStatus:q,removeFromConversationList:G,handleWebSocketConnect:z,handleWebSocketDisconnect:L,handleWebSocketError:D,handleNewMessage:O,handleTypingStatus:B,handleReadReceipt:F,handleDeliveryReceipt:V,handleOnlineStatus:$,conversationsRef:M,messagesByConversationRef:R};return s.jsx(A.Provider,{value:Y,children:n})},D=e.createContext(null),O=()=>{const s=e.useContext(D);if(!s)throw new Error("useCall must be used within CallProvider");return s},B=({children:n,currentUser:t})=>{const{conversations:r,conversationsRef:i}=z(),[c,l]=e.useState(null),[d,u]=e.useState("idle"),[m,h]=e.useState(null),[g,v]=e.useState(null),[p,x]=e.useState(null),[f,C]=e.useState(!1),[b,j]=e.useState("call"),[y,w]=e.useState(null),N=e.useRef(null),k=e.useRef(null),I=e.useCallback(e=>`${window.location.origin}/svmessenger/call-window.html?${new URLSearchParams({token:e.token,roomName:e.roomName,conversationId:e.conversationId.toString(),otherUserId:e.otherUserId.toString(),otherUserName:encodeURIComponent(e.otherUserName||""),otherUserAvatar:encodeURIComponent(e.otherUserAvatar||""),currentUserId:e.currentUserId.toString(),currentUserName:encodeURIComponent(e.currentUserName||""),currentUserAvatar:encodeURIComponent(e.currentUserAvatar||""),callType:e.callType||"voice",callState:e.callState||"outgoing"}).toString()}`,[]),E=e.useCallback(async(e,s,n)=>{var r,o,i;try{const d=await U(e,s);v(d.token);try{window.__sv_livekit_token=d.token,window.liveKitToken=d.token}catch(c){}const m={conversationId:e,otherUserId:s,roomName:d.roomName,conversation:n};l(m),u("outgoing");const g=I({token:d.token,roomName:d.roomName,conversationId:e,otherUserId:s,otherUserName:(null==(r=n.otherUser)?void 0:r.realName)||(null==(o=n.otherUser)?void 0:o.username)||"ÐŸÐ¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»",otherUserAvatar:(null==(i=n.otherUser)?void 0:i.imageUrl)||"",currentUserId:t.id,currentUserName:t.realName||t.username,currentUserAvatar:t.imageUrl||"",callType:"voice",callState:"outgoing"}),p=window.open(g,"svmessenger-call","width=420,height=650,resizable=yes,scrollbars=no,menubar=no,toolbar=no,location=no,status=no,titlebar=no");if(p){h(p);const e=setInterval(()=>{p.closed&&(clearInterval(e),h(null),A())},500)}else console.warn("Popup blocked, using modal fallback");const x={eventType:"CALL_REQUEST",conversationId:e,callerId:t.id,receiverId:s,roomName:d.roomName,timestamp:(new Date).toISOString(),callerName:t.realName||t.username,callerAvatar:t.imageUrl};a.sendCallSignal(x)}catch(d){console.error("Failed to proceed with call start:",d),u("idle")}},[t,I]),M=e.useCallback(async(e,s,n=null)=>{try{let a=n;if(a||(a=i.current.find(s=>s.id===e)),!a)throw new Error("Conversation not found");let c=null,l=!1;try{if(c=localStorage.getItem("svmessenger-audio-video-settings"),c||(c=localStorage.getItem("svmessenger-audio-settings")),c)try{const e=JSON.parse(c);l=!(!e.microphone||!e.speaker)}catch(t){l=!1}}catch(r){const e=o.getSelectedDevices();e.microphone&&e.speaker&&(l=!0,c=JSON.stringify({microphone:e.microphone,speaker:e.speaker,camera:e.camera||null,micVolume:75,speakerVolume:80}))}if(l){const n=JSON.parse(c);n.microphone&&await o.setMicrophone(n.microphone),n.speaker&&await o.setSpeaker(n.speaker),n.camera&&(o.selectedCamera=n.camera),await E(e,s,a)}else w({type:"start",data:{conversationId:e,otherUserId:s,conversation:a}}),C(!0)}catch(a){console.error("Failed to start call:",a),u("idle")}},[t,i,E]),R=e.useCallback(async()=>{var e,s,n,r,o,i;try{const l=c.roomName;if(!l)throw new Error("Missing room name for call accept");const d=await U(c.conversationId,c.otherUserId);d.roomName!==l&&(d.roomName=l),v(d.token);const m={eventType:"CALL_ACCEPT",conversationId:c.conversationId,callerId:c.otherUserId,receiverId:t.id,roomName:l,timestamp:(new Date).toISOString()};a.sendCallSignal(m);const g=I({token:d.token,roomName:l,conversationId:c.conversationId,otherUserId:c.otherUserId,otherUserName:(null==(s=null==(e=c.conversation)?void 0:e.otherUser)?void 0:s.realName)||(null==(r=null==(n=c.conversation)?void 0:n.otherUser)?void 0:r.username)||"ÐŸÐ¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»",otherUserAvatar:(null==(i=null==(o=c.conversation)?void 0:o.otherUser)?void 0:i.imageUrl)||"",currentUserId:t.id,currentUserName:t.realName||t.username,currentUserAvatar:t.imageUrl||"",callType:"voice",callState:"connected"}),p=window.open(g,"svmessenger-call","width=420,height=650,resizable=yes,scrollbars=no,menubar=no,toolbar=no,location=no,status=no,titlebar=no");if(p){h(p);const e=setInterval(()=>{p.closed&&(clearInterval(e),h(null),A())},500)}else console.warn("Popup blocked, using modal fallback");k.current&&(k.current.pause(),k.current.currentTime=0,k.current=null),u("connected")}catch(l){console.error("Failed to proceed with call accept:",l),A()}},[c,t,I]),T=e.useCallback(async()=>{try{let n=null,t=!1;try{if(n=localStorage.getItem("svmessenger-audio-video-settings"),n||(n=localStorage.getItem("svmessenger-audio-settings")),n)try{const e=JSON.parse(n);t=!(!e.microphone||!e.speaker)}catch(e){t=!1}}catch(s){const e=o.getSelectedDevices();e.microphone&&e.speaker&&(t=!0,n=JSON.stringify({microphone:e.microphone,speaker:e.speaker,camera:e.camera||null,micVolume:75,speakerVolume:80}))}if(t){const e=JSON.parse(n);e.microphone&&await o.setMicrophone(e.microphone),e.speaker&&await o.setSpeaker(e.speaker),e.camera&&(o.selectedCamera=e.camera),await R()}else w({type:"accept",data:{}}),C(!0)}catch(n){console.error("Failed to accept call:",n),A()}},[c,t,R]),A=e.useCallback(()=>{k.current&&(k.current.pause(),k.current.currentTime=0,k.current=null),h(e=>(e&&!e.closed&&e.close(),null)),N.current&&N.current.postMessage({type:"CALL_ENDED",data:{}}),l(e=>(e&&u(s=>{const n="outgoing"===s,r={eventType:"CALL_END",conversationId:e.conversationId,callerId:n?t.id:e.otherUserId,receiverId:n?e.otherUserId:t.id,roomName:e.roomName,timestamp:(new Date).toISOString()};return a.sendCallSignal(r),"idle"}),null)),u("idle"),v(null),x(null)},[t]),L=e.useCallback(()=>{k.current&&(k.current.pause(),k.current.currentTime=0,k.current=null);const e={eventType:"CALL_REJECT",conversationId:c.conversationId,callerId:c.otherUserId,receiverId:t.id,roomName:c.roomName,timestamp:(new Date).toISOString()};a.sendCallSignal(e),N.current&&N.current.postMessage({type:"CALL_REJECTED",data:{conversationId:c.conversationId}}),l(null),u("idle"),v(null),x(null)},[c,t]),O=e.useCallback(async e=>{try{await o.connect(e.token,e.roomName),x(e.roomName),await new Promise(e=>setTimeout(e,500));let r=null;try{r=localStorage.getItem("svmessenger-audio-video-settings"),r||(r=localStorage.getItem("svmessenger-audio-settings"))}catch(s){const e=o.getSelectedDevices();e.microphone&&e.speaker&&(r=JSON.stringify({microphone:e.microphone,speaker:e.speaker,camera:e.camera||null,micVolume:75,speakerVolume:80}))}if(r)try{const e=JSON.parse(r);e.microphone&&await o.setMicrophone(e.microphone),e.speaker&&await o.setSpeaker(e.speaker),e.camera&&(o.selectedCamera=e.camera)}catch(n){}else try{o.room&&o.isConnected&&await o.room.localParticipant.setMicrophoneEnabled(!0)}catch(t){}}catch(t){throw console.error("Failed to connect to LiveKit:",t),t}},[]),B=e.useCallback(()=>{j("settings"),C(!0)},[]),F=e.useCallback(async e=>{if(C(!1),"settings"===b)j("call");else if(y){const{type:e,data:s}=y;w(null),"start"===e?await E(s.conversationId,s.otherUserId,s.conversation):"accept"===e&&await R()}},[b,y,E,R]),V=e.useCallback(()=>{C(!1),j("call"),w(null),"settings"!==b&&(u("idle"),l(null))},[b]),$=e.useCallback(async e=>{switch(e.eventType){case"TEST_SIGNAL":case"CALL_BUSY":break;case"CALL_REQUEST":if(e.receiverId===t.id){let n=r.find(s=>s.id===e.conversationId);if(!n)try{const s=await S(e.callerId);s&&(n=s)}catch(s){console.error("Failed to load/create conversation:",s)}if(n){const t={conversationId:e.conversationId,otherUserId:e.callerId,roomName:e.roomName,conversation:n};l(t),u("incoming");try{k.current&&(k.current.pause(),k.current.currentTime=0,k.current=null);const e=new Audio("/svmessenger/sounds/IncomingCall.mp3");e.loop=!0,e.volume=.7,e.preload="auto",k.current=e;const s=e.play();void 0!==s&&s.catch(e=>{console.warn("âš ï¸ Failed to play incoming call sound:",e)})}catch(s){console.error("âŒ Failed to play incoming call sound:",s)}document.hidden&&"Notification"in window&&"granted"===Notification.permission&&new Notification("Incoming Call",{body:`${n.otherUser.realName||n.otherUser.username} is calling you`,icon:n.otherUser.imageUrl||"/images/default-avatar.png"})}}break;case"CALL_ACCEPT":l(s=>(u(n=>{const r=s&&s.conversationId===e.conversationId,a=e.callerId===t.id,o=e.receiverId===t.id;if(a&&("outgoing"===n||"idle"===n&&null!==m)&&(r||e.roomName)){if(!s&&e.roomName){const s={conversationId:e.conversationId,otherUserId:e.receiverId,roomName:e.roomName,conversation:null};setTimeout(()=>{l(s)},0)}return N.current&&N.current.postMessage({type:"CALL_ACCEPTED",data:{conversationId:e.conversationId,roomName:e.roomName}}),"connected"}if(o&&"connected"===n&&r)return n;if(o&&"incoming"===n&&r){const n=g||window.__sv_livekit_token||window.liveKitToken||null,t=e.roomName||(null==s?void 0:s.roomName);return n&&t&&O({token:n,roomName:t}).catch(e=>{console.error("âŒ Failed to connect receiver to LiveKit:",e)}),"connected"}return n}),s));break;case"CALL_REJECT":k.current&&(k.current.pause(),k.current.currentTime=0,k.current=null),N.current&&N.current.postMessage({type:"CALL_REJECTED",data:{conversationId:e.conversationId}}),"outgoing"!==d&&"incoming"!==d||(l(null),u("idle"),v(null),x(null));break;case"CALL_END":l(s=>(u(n=>{const t=s&&s.conversationId===e.conversationId;return"idle"!==n&&t?(k.current&&(k.current.pause(),k.current.currentTime=0,k.current=null),N.current&&N.current.postMessage({type:"CALL_ENDED",data:{conversationId:e.conversationId}}),o.disconnect(),"idle"):n}),s&&s.conversationId===e.conversationId?(v(null),x(null),null):s));break;default:console.warn("Unknown call signal type:",e.eventType)}},[d,t,g,O,r,m]);e.useEffect(()=>(N.current=new BroadcastChannel("svmessenger-call"),N.current.onmessage=e=>{const{type:s,data:n,message:t}=e.data;switch(s){case"POPUP_LOG":console.log(t,n||"");break;case"CALL_ENDED_FROM_POPUP":u("idle"),l(null),h(null)}},()=>{N.current&&N.current.close()}),[]);const _={currentCall:c,callState:d,showDeviceSelector:f,deviceSelectorMode:b,callWindowRef:m,liveKitToken:g,liveKitRoom:p,startCall:M,acceptCall:T,rejectCall:L,endCall:A,connectToLiveKit:O,openAudioSettings:B,handleDeviceSelectorComplete:F,handleDeviceSelectorCancel:V,handleCallSignal:$};return s.jsx(D.Provider,{value:_,children:n})},F=e.createContext(null),V=()=>{const s=e.useContext(F);if(!s)throw new Error("useUI must be used within UIProvider");return s},$=({children:n,currentUser:t})=>{const{conversations:r,conversationsRef:o,messagesByConversation:i,messagesByConversationRef:c,loadMessages:l,startConversation:d}=z(),[u,m]=e.useState([]),[h,g]=e.useState(!1),[v,p]=e.useState(!1),x=e.useRef(1e3),f=e.useRef(u);e.useEffect(()=>{f.current=u},[u]);const C=e.useCallback(()=>{g(!0),p(!1)},[]),b=e.useCallback(()=>{g(!1),p(!1)},[]),j=e.useCallback(()=>{p(!0)},[]),S=e.useCallback(()=>{p(!1)},[]),w=e.useCallback(()=>{const e=window.innerWidth,s=window.innerHeight,n=30*u.filter(e=>!e.isMinimized).length;return{x:Math.max(50,(e-400)/2+n),y:Math.max(50,(s-600)/2+n)}},[u]),N=e.useCallback((e,s=null)=>{var n;let r=s||o.current.find(s=>s.id===e);if(r||(r=null==(n=f.current.find(s=>s.conversation.id===e))?void 0:n.conversation),!r)return console.warn("Conversation not found:",e),void y(e).then(s=>{s&&setTimeout(()=>N(e),100)}).catch(e=>{console.error("Failed to fetch conversation:",e)});const i=f.current.find(s=>s.conversation.id===e);if(i)return void(i.isMinimized?E(e):M(e));const d=o.current.find(s=>s.id===e),u={id:e,conversation:d||r,isMinimized:!1,position:w(),zIndex:x.current++};m(e=>[...e,u]);const h=r.unreadCount>0;l(e,0,h?200:50);(c.current[e]||[]).some(e=>e.senderId!==t.id&&!e.isRead)&&a.sendRead(e),b()},[t,o,f,c,l,w,b]),k=e.useCallback(e=>{m(s=>s.filter(s=>s.conversation.id!==e))},[]),I=e.useCallback(e=>{m(s=>s.map(s=>s.conversation.id===e?{...s,isMinimized:!0}:s))},[]),E=e.useCallback(e=>{m(s=>s.map(s=>s.conversation.id===e?{...s,isMinimized:!1,zIndex:x.current++}:s));(i[e]||[]).some(e=>e.senderId!==t.id&&!e.isRead)&&a.sendRead(e)},[i,t]),M=e.useCallback(e=>{m(s=>s.map(s=>s.conversation.id===e?{...s,zIndex:x.current++}:s))},[]),R=e.useCallback((e,s)=>{m(n=>n.map(n=>n.conversation.id===e?{...n,position:s}:n))},[]);e.useEffect(()=>((()=>{try{const e=async e=>{const s=await d(e);return setTimeout(()=>{N(s.id)},150),s},s=async e=>{try{const s=await d(e);return s&&s.id?(setTimeout(()=>{try{N(s.id)}catch(e){console.error("Error in openChat",e)}},150),s):void console.error("Invalid conversation returned",s)}catch(s){throw console.error("Error",s),s}};window.SVMessenger={startConversation:e,startConversationReact:s,openChat:N,openChatList:C,openSearch:j}}catch(e){console.error("SVMessenger: Error exposing global API:",e)}})(),()=>{window.SVMessenger&&delete window.SVMessenger}),[N,C,j,d]);const T={activeChats:u,isChatListOpen:h,isSearchOpen:v,openChatList:C,closeChatList:b,openSearch:j,closeSearch:S,openChat:N,closeChat:k,minimizeChat:I,restoreChat:E,bringToFront:M,updateChatPosition:R,activeChatsRef:f};return s.jsx(F.Provider,{value:T,children:n})},_=()=>{const s=z(),n=O(),t=V(),r=e.useRef(t.activeChats),o=e.useRef(!1);return e.useEffect(()=>{r.current=t.activeChats},[t.activeChats]),e.useEffect(()=>{if(o.current)return;o.current=!0;return a.connect({onConnect:()=>{var e;return null==(e=s.handleWebSocketConnect)?void 0:e.call(s)},onDisconnect:()=>{var e;return null==(e=s.handleWebSocketDisconnect)?void 0:e.call(s)},onError:e=>{var n;return null==(n=s.handleWebSocketError)?void 0:n.call(s,e)},onNewMessage:e=>{s.handleNewMessage(e,r.current)},onTypingStatus:s.handleTypingStatus,onReadReceipt:s.handleReadReceipt,onDeliveryReceipt:s.handleDeliveryReceipt,onOnlineStatus:s.handleOnlineStatus,onCallSignal:n.handleCallSignal}),()=>{o.current=!1,a.disconnect()}},[]),e.useEffect(()=>(t.activeChats.forEach(e=>{a.subscribeToTyping(e.conversation.id,s.handleTypingStatus)}),()=>{t.activeChats.forEach(e=>{a.unsubscribeFromTyping(e.conversation.id)})}),[t.activeChats.map(e=>e.id).join(",")]),null};e.createContext(null);const W=()=>{const e=z(),s=O(),n=V();return{currentUser:e.currentUser,conversations:e.conversations,messagesByConversation:e.messagesByConversation,isLoadingConversations:e.isLoadingConversations,loadingMessages:e.loadingMessages,typingUsers:e.typingUsers,totalUnreadCount:e.totalUnreadCount,isWebSocketConnected:e.isWebSocketConnected,loadConversations:e.loadConversations,loadMessages:e.loadMessages,sendMessage:e.sendMessage,startConversation:e.startConversation,markAsRead:e.markAsRead,sendTypingStatus:e.sendTypingStatus,removeFromConversationList:e.removeFromConversationList,currentCall:s.currentCall,callState:s.callState,showDeviceSelector:s.showDeviceSelector,deviceSelectorMode:s.deviceSelectorMode,callWindowRef:s.callWindowRef,liveKitToken:s.liveKitToken,liveKitRoom:s.liveKitRoom,startCall:s.startCall,acceptCall:s.acceptCall,rejectCall:s.rejectCall,endCall:s.endCall,connectToLiveKit:s.connectToLiveKit,openAudioSettings:s.openAudioSettings,handleDeviceSelectorComplete:s.handleDeviceSelectorComplete,handleDeviceSelectorCancel:s.handleDeviceSelectorCancel,activeChats:n.activeChats,isChatListOpen:n.isChatListOpen,isSearchOpen:n.isSearchOpen,openChatList:n.openChatList,closeChatList:n.closeChatList,openSearch:n.openSearch,closeSearch:n.closeSearch,openChat:n.openChat,closeChat:n.closeChat,minimizeChat:n.minimizeChat,restoreChat:n.restoreChat,bringToFront:n.bringToFront,updateChatPosition:n.updateChatPosition}},P=({children:e,userData:n})=>s.jsx(L,{currentUser:n,children:s.jsx(B,{currentUser:n,children:s.jsxs($,{currentUser:n,children:[s.jsx(_,{}),e]})})}),H=e=>{if(!e)return"";try{const s="string"==typeof e?h(e):new Date(e),n=new Date-s,t=Math.floor(n/6e4),r=Math.floor(n/36e5),a=Math.floor(n/864e5);return t<1?"Ð¡ÐµÐ³Ð°":t<60?`${t} Ð¼Ð¸Ð½`:r<24&&g(s)?`${r} Ñ‡`:v(s)?"Ð’Ñ‡ÐµÑ€Ð°":a<7?`${a} Ð´`:p(s,"d MMM",{locale:x})}catch(s){return console.error("Error formatting date:",s),""}},K=e=>{if(!e)return"";try{const s="string"==typeof e?h(e):new Date(e);return g(s)?"Ð”Ð½ÐµÑ":v(s)?"Ð’Ñ‡ÐµÑ€Ð°":p(s,"d MMMM yyyy",{locale:x})}catch(s){return console.error("Error formatting date separator:",s),""}},J=e=>{if(!e)return"";try{const s="string"==typeof e?h(e):new Date(e);return p(s,"HH:mm")}catch(s){return console.error("Error formatting message time:",s),""}},q=({conversation:e})=>{var n;const{openChat:t,removeFromConversationList:r,activeChats:a}=W(),o=a.some(s=>s.conversation.id===e.id&&!s.isMinimized);return s.jsxs("div",{className:"svmessenger-conversation-item "+(o?"active":""),onClick:()=>{t(e.id)},children:[s.jsx("button",{className:"svmessenger-conversation-remove",onClick:s=>{s.stopPropagation(),r&&r(e.id)},title:"ÐŸÑ€ÐµÐ¼Ð°Ñ…Ð½Ð¸ Ð¾Ñ‚ Ð¿Ð°Ð½ÐµÐ»Ð°",children:s.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})}),s.jsxs("div",{className:"svmessenger-conversation-avatar",children:[s.jsx("img",{src:e.otherUser.imageUrl||"/images/default-avatar.png",alt:e.otherUser.username,onError:e=>{e.target.src="/images/default-avatar.png"}}),e.otherUser.isOnline&&s.jsx("div",{className:"svmessenger-online-indicator"})]}),s.jsxs("div",{className:"svmessenger-conversation-content",children:[s.jsxs("div",{className:"svmessenger-conversation-top-row",children:[s.jsx("h4",{className:"svmessenger-conversation-name",children:e.otherUser.realName||e.otherUser.username}),s.jsx("span",{className:"svmessenger-conversation-time",children:H(null==(n=e.lastMessage)?void 0:n.sentAt)})]}),s.jsxs("div",{className:"svmessenger-conversation-preview",children:[s.jsx("p",{className:"svmessenger-conversation-text",children:e.lastMessage?i(e.lastMessage.text,50):"ÐÑÐ¼Ð° ÑÑŠÐ¾Ð±Ñ‰ÐµÐ½Ð¸Ñ"}),e.unreadCount>0&&s.jsx("span",{className:"svmessenger-conversation-unread",children:e.unreadCount>99?"99+":e.unreadCount})]})]})]})},G=({onClose:n,onSearchClick:t})=>{const{conversations:r,isLoadingConversations:a,loadConversations:o}=W(),[i,c]=e.useState("");e.useEffect(()=>{o()},[o]);const l=r.filter(e=>{var s,n,t;if(!i)return!0;const r=i.toLowerCase();return e.otherUser.username.toLowerCase().includes(r)||(null==(s=e.otherUser.realName)?void 0:s.toLowerCase().includes(r))||(null==(t=null==(n=e.lastMessage)?void 0:n.text)?void 0:t.toLowerCase().includes(r))});return s.jsxs("div",{className:"svmessenger-conversation-list",children:[s.jsxs("div",{className:"svmessenger-conversation-header",children:[s.jsx("h3",{children:"SV Messenger"}),s.jsxs("div",{className:"svmessenger-conversation-actions",children:[s.jsx("button",{className:"svmessenger-search-btn",onClick:t,title:"ÐÐ¾Ð² Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"})})}),s.jsx("button",{className:"svmessenger-close-btn",onClick:n,title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]})]}),s.jsx("div",{className:"svmessenger-search-input",children:s.jsx("input",{type:"text",placeholder:"Ð¢ÑŠÑ€ÑÐ¸ Ð² ÑÑŠÑ‰ÐµÑÑ‚Ð²ÑƒÐ²Ð°Ñ‰Ð¸Ñ‚Ðµ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð¸...",value:i,onChange:e=>c(e.target.value)})}),s.jsx("div",{className:"svmessenger-conversations",children:a?s.jsxs("div",{className:"svmessenger-loading",children:[s.jsx("div",{className:"svmessenger-spinner"}),s.jsx("span",{children:"Ð—Ð°Ñ€ÐµÐ¶Ð´Ð°Ð½Ðµ..."})]}):0===l.length?s.jsx("div",{className:"svmessenger-empty",children:i?s.jsxs(s.Fragment,{children:[s.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"})}),s.jsx("p",{children:"ÐÑÐ¼Ð° Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð¸"})]}):s.jsxs(s.Fragment,{children:[s.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"})}),s.jsx("p",{children:"ÐÑÐ¼Ð° ÑÑŠÑ‰ÐµÑÑ‚Ð²ÑƒÐ²Ð°Ñ‰Ð¸ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð¸"}),s.jsx("small",{children:"ÐšÐ»Ð¸ÐºÐ½ÐµÑ‚Ðµ + Ð·Ð° Ð´Ð° Ð·Ð°Ð¿Ð¾Ñ‡Ð½ÐµÑ‚Ðµ Ð½Ð¾Ð² Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€"})]})}):l.map(e=>s.jsx(q,{conversation:e},e.id))})]})},Q=({conversation:n,onClose:t,onMinimize:r,onOpenSearch:a,onCall:o,onOpenAudioSettings:i})=>{const[c,l]=e.useState(!1),d=e.useRef(null),{otherUser:u}=n;e.useEffect(()=>{const e=e=>{d.current&&!d.current.contains(e.target)&&l(!1)};return c&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[c]);return s.jsxs("div",{className:"svmessenger-chat-header",children:[s.jsxs("div",{className:"svmessenger-chat-user-info",children:[s.jsx("div",{className:"svmessenger-chat-avatar",children:u.imageUrl?s.jsx("img",{src:u.imageUrl,alt:u.realName||u.username}):s.jsx("div",{className:"svmessenger-chat-avatar-placeholder",children:(u.realName||u.username||"U").charAt(0).toUpperCase()})}),s.jsxs("div",{className:"svmessenger-chat-user-details",children:[s.jsx("div",{className:"svmessenger-chat-username",children:u.realName||u.username}),s.jsx("span",{className:"svmessenger-chat-status "+(u.isOnline?"online":"offline"),children:u.isOnline?"Online":"Offline"})]})]}),s.jsxs("div",{className:"svmessenger-chat-controls",children:[s.jsx("button",{className:"svmessenger-call-btn",onClick:o,title:"Ð—Ð²ÑŠÐ½Ð½Ð¸",style:{display:"flex",alignItems:"center",justifyContent:"center",width:"32px",height:"32px",border:"none",background:"none",color:"#9ca3af",borderRadius:"6px",cursor:"pointer",transition:"all 0.2s ease",marginLeft:"8px"},children:s.jsx("i",{className:"bi bi-telephone",style:{fontSize:"18px",color:"#ffffff"}})}),s.jsxs("div",{className:"svmessenger-chat-menu-container",ref:d,children:[s.jsx("button",{className:"svmessenger-chat-menu-btn",onClick:()=>l(!c),title:"ÐŸÐ¾Ð²ÐµÑ‡Ðµ Ð¾Ð¿Ñ†Ð¸Ð¸",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"})})}),c&&s.jsxs("div",{className:"svmessenger-chat-menu-dropdown",children:[s.jsxs("button",{onClick:()=>{l(!1),window.location.href=`/user/${u.username}`},className:"svmessenger-menu-item",children:[s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"})}),"ÐŸÑ€ÐµÐ³Ð»ÐµÐ´ Ð½Ð° Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð°"]}),s.jsxs("button",{onClick:()=>{l(!1),a()},className:"svmessenger-menu-item",children:[s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"})}),"Ð¢ÑŠÑ€ÑÐ¸ Ð² Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð°..."]}),s.jsxs("button",{onClick:()=>{l(!1),i&&i()},className:"svmessenger-menu-item",children:[s.jsx("i",{className:"bi bi-gear-fill",style:{fontSize:"16px"}}),"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸"]}),s.jsxs("button",{onClick:()=>{l(!1),window.confirm("Ð¡Ð¸Ð³ÑƒÑ€Ð½Ð¸ Ð»Ð¸ ÑÑ‚Ðµ, Ñ‡Ðµ Ð¸ÑÐºÐ°Ñ‚Ðµ Ð´Ð° Ð¸Ð·Ñ‚Ñ€Ð¸ÐµÑ‚Ðµ Ñ‚Ð¾Ð·Ð¸ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€?")},className:"svmessenger-menu-item svmessenger-menu-item-danger",children:[s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"})}),"Ð˜Ð·Ñ‚Ñ€Ð¸Ð¹ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð°"]})]})]}),s.jsx("button",{className:"svmessenger-chat-close",onClick:t,title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸",children:s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]})]})},X=({message:e,searchQuery:n=""})=>{const{currentUser:t}=W();if(!e||!e.id||!e.text)return console.warn("SVMessageItem: Invalid message received",e),null;if(!t||!t.id)return null;const r=e.senderId===t.id,a=c(e.text);return s.jsxs("div",{className:"svmessenger-message-item "+(r?"own":"other"),children:[!r&&s.jsx("div",{className:"svmessenger-message-avatar",children:s.jsx("img",{src:e.senderImageUrl||"/images/default-avatar.png",alt:e.senderUsername,onError:e=>{e.target.src="/images/default-avatar.png"}})}),s.jsxs("div",{className:"svmessenger-message-content",children:[s.jsx("div",{className:"svmessenger-message-bubble "+(a?"emoji-only":""),children:s.jsx("div",{className:"svmessenger-message-text",dangerouslySetInnerHTML:{__html:((e,s)=>{if(!s.trim())return l(e);const n=new RegExp(`(${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi"),t=e.replace(n,'<mark class="search-highlight">$1</mark>');return l(t)})(e.text,n)}})}),s.jsxs("div",{className:"svmessenger-message-meta",children:[s.jsx("span",{className:"svmessenger-message-time-only",children:J(e.sentAt)}),r&&s.jsx("div",{className:"svmessenger-message-read-status",children:r?e.isDelivered?e.isDelivered&&!e.isRead?s.jsxs("svg",{width:"18",height:"14",viewBox:"0 0 32 24",fill:"currentColor",className:"double-check-gray",children:[s.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"}),s.jsx("path",{d:"M17 16.17L12.83 12l-1.42 1.41L17 19 29 7l-1.41-1.41z"})]}):e.isDelivered&&e.isRead?s.jsxs("svg",{width:"18",height:"14",viewBox:"0 0 32 24",fill:"currentColor",className:"double-check-green",children:[s.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"}),s.jsx("path",{d:"M17 16.17L12.83 12l-1.42 1.41L17 19 29 7l-1.41-1.41z"})]}):null:s.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",className:"single-check",children:s.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})}):null})]})]})]})},Y=({conversationId:e})=>{const{conversations:n,typingUsers:t}=W(),r=n.find(s=>s.id===e),a=t[e];if(!r||!a)return null;const o=r.otherUser;return s.jsxs("div",{className:"svmessenger-typing-indicator",children:[s.jsx("div",{className:"svmessenger-typing-avatar",children:s.jsx("img",{src:o.imageUrl||"/images/default-avatar.png",alt:o.username,onError:e=>{e.target.src="/images/default-avatar.png"}})}),s.jsxs("div",{className:"svmessenger-typing-content",children:[s.jsx("div",{className:"svmessenger-typing-bubble",children:s.jsxs("div",{className:"svmessenger-typing-dots",children:[s.jsx("span",{}),s.jsx("span",{}),s.jsx("span",{})]})}),s.jsxs("span",{className:"svmessenger-typing-text",children:[o.realName||o.username," Ð¿Ð¸ÑˆÐµ..."]})]})]})},Z=({conversationId:n,searchQuery:t=""})=>{const{messagesByConversation:r,loadingMessages:a,typingUsers:o}=W(),i=Array.isArray(r[n])?r[n]:[],c=t.trim()?i.filter(e=>e.text&&e.text.toLowerCase().includes(t.toLowerCase())):i,l=a[n]||!1,m=o[n],g=e.useRef(null),v=e.useRef(null);e.useLayoutEffect(()=>{if(v.current&&(c.length>0||l)){const e=()=>{v.current&&(v.current.scrollTop=v.current.scrollHeight)};e(),setTimeout(e,10),setTimeout(e,50),setTimeout(e,100)}},[c.length,l]);const x=(e=>{if(!e||0===e.length)return[];const s=e.filter(e=>e&&e.id&&e.sentAt&&"object"==typeof e);if(0===s.length)return[];const n=[];let t=null;return s.forEach((e,s)=>{if(e&&e.sentAt)try{const s="string"==typeof e.sentAt?h(e.sentAt):new Date(e.sentAt),r=p(s,"yyyy-MM-dd");r!==t&&(n.push({type:"date",date:s,dateKey:r,formattedDate:K(s)}),t=r),n.push({type:"message",message:e})}catch(r){console.warn("Error processing message in groupMessagesByDate:",r,e)}}),n})(c);return s.jsxs("div",{className:"svmessenger-message-thread",ref:v,children:[l&&s.jsx("div",{className:"svmessenger-loading-messages",children:s.jsx("div",{className:"svmessenger-spinner"})}),s.jsx("div",{className:"svmessenger-messages",children:x.map((e,n)=>{if("date"===e.type)return s.jsx("div",{className:"svmessenger-date-separator",children:s.jsx("span",{className:"svmessenger-date-separator-text",children:e.formattedDate})},`date-${e.dateKey}`);if("message"===e.type&&e.message&&e.message.id){x.length;return s.jsx("div",{ref:null,children:s.jsx(X,{message:e.message,searchQuery:t})},e.message.id)}return null})}),m&&s.jsx(Y,{conversationId:n}),c.length>0&&!d(v.current)&&s.jsx("button",{className:"svmessenger-scroll-to-bottom",onClick:()=>u(v.current),title:"Scroll to bottom",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"})})}),s.jsx("div",{ref:g})]})},ee={search:"Ð¢ÑŠÑ€ÑÐµÐ½Ðµ",search_no_results_1:"Ðž, Ð½Ðµ!",search_no_results_2:"ÐÑÐ¼Ð° Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸ ÐµÐ¼Ð¾Ð´Ð¶Ð¸Ñ‚Ð°",pick:"Ð˜Ð·Ð±ÐµÑ€Ð¸ ÐµÐ¼Ð¾Ð´Ð¶Ð¸",categories:{activity:"ÐÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸",custom:"ÐŸÐµÑ€ÑÐ¾Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð°Ð½Ð¸",flags:"Ð—Ð½Ð°Ð¼ÐµÐ½Ð°",foods:"Ð¥Ñ€Ð°Ð½Ð° Ð¸ Ð½Ð°Ð¿Ð¸Ñ‚ÐºÐ¸",frequent:"Ð§ÐµÑÑ‚Ð¾ Ð¸Ð·Ð¿Ð¾Ð»Ð·Ð²Ð°Ð½Ð¸",nature:"ÐŸÑ€Ð¸Ñ€Ð¾Ð´Ð°",objects:"ÐžÐ±ÐµÐºÑ‚Ð¸",people:"Ð¥Ð¾Ñ€Ð°",places:"ÐœÐµÑÑ‚Ð°",search:"Ð¢ÑŠÑ€ÑÐµÐ½Ðµ",smileys:"Ð£ÑÐ¼Ð¸Ð²ÐºÐ¸",symbols:"Ð¡Ð¸Ð¼Ð²Ð¾Ð»Ð¸"},skins:{choose:"Ð˜Ð·Ð±ÐµÑ€Ð¸ Ñ‚Ð¾Ð½",1:"Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚ÐµÐ½",2:"Ð¡Ð²ÐµÑ‚ÑŠÐ»",3:"Ð¡Ñ€ÐµÐ´Ð½Ð¾ ÑÐ²ÐµÑ‚ÑŠÐ»",4:"Ð¡Ñ€ÐµÐ´ÐµÐ½",5:"Ð¡Ñ€ÐµÐ´Ð½Ð¾ Ñ‚ÑŠÐ¼ÐµÐ½",6:"Ð¢ÑŠÐ¼ÐµÐ½"}},se=({onEmojiSelect:t,onClose:r,show:a})=>{const o=e.useRef(null);return e.useEffect(()=>{const e=e=>{"Escape"===e.key&&a&&r()};if(a)return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[a,r]),a?s.jsxs("div",{className:"svmessenger-emoji-picker-wrapper",children:[s.jsx("div",{className:"svmessenger-emoji-picker-backdrop",onClick:r}),s.jsx("div",{className:"svmessenger-emoji-picker-container",children:s.jsx(n,{ref:o,data:f,onEmojiSelect:t,skinTonePosition:"search",previewPosition:"none",searchPosition:"bottom",theme:"light",i18n:ee,perLine:7,emojiSize:20,emojiButtonSize:28})})]}):null},ne=({conversationId:n})=>{const{sendMessage:t}=W(),[r,a]=e.useState(""),[o,i]=e.useState(!1),[c,l]=e.useState(!1),d=e.useRef(null),u=e.useRef(null),{handleTyping:m,stopTyping:h}=(()=>{const s=e.useRef(null),n=e.useRef(!1),t=()=>{s.current&&clearTimeout(s.current),n.current&&(n.current=!1)};return e.useEffect(()=>()=>{t()},[]),{handleTyping:()=>{n.current||(n.current=!0),s.current&&clearTimeout(s.current),s.current=setTimeout(()=>{n.current=!1},2e3)},stopTyping:t}})();e.useEffect(()=>{d.current&&d.current.focus()},[n]),e.useEffect(()=>{if(d.current){const e=d.current,s=40,n=120;e.style.height="auto";const t=Math.min(Math.max(e.scrollHeight,s),n);e.style.height=`${t}px`}},[r]);const g=e=>{e.preventDefault(),r.trim()&&(t(n,r.trim()),a(""),h(),d.current&&(d.current.style.height="40px"))};return s.jsxs("div",{className:"svmessenger-message-input",children:[s.jsxs("form",{onSubmit:g,className:"svmessenger-input-form",children:[s.jsxs("div",{className:"svmessenger-input-container",children:[s.jsx("button",{type:"button",className:"svmessenger-attach-btn",onClick:e=>{e.preventDefault()},title:"ÐŸÑ€Ð¸ÐºÐ°Ñ‡Ð¸ Ñ„Ð°Ð¹Ð»",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"})})}),s.jsx("div",{className:"svmessenger-input-wrapper",children:s.jsx("textarea",{ref:d,className:"svmessenger-text-input",placeholder:"Aa",value:r,onChange:e=>{const s=e.target.value;a(s),s.trim()?m():h()},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),g(e))},onCompositionStart:()=>{i(!0)},onCompositionEnd:()=>{i(!1)},rows:1,maxLength:2e3})}),s.jsx("button",{ref:u,type:"button",className:"svmessenger-emoji-btn "+(c?"active":""),onClick:e=>{e.preventDefault(),l(!c)},title:"Ð•Ð¼Ð¾Ñ‚Ð¸ÐºÐ¾Ð½Ð¸",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-3.5-9c.83 0 1.5-.67 1.5-1.5S9.33 8.5 8.5 8.5 7 9.17 7 10s.67 1.5 1.5 1.5zm7 0c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zm-3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"})})}),r.trim()?s.jsx("button",{type:"submit",className:"svmessenger-send-btn",title:"Ð˜Ð·Ð¿Ñ€Ð°Ñ‚Ð¸ ÑÑŠÐ¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"})})}):s.jsx("button",{type:"button",className:"svmessenger-mic-btn",title:"Ð“Ð»Ð°ÑÐ¾Ð²Ð° Ð¿Ð¾Ñ€ÑŠÐºÐ° (Ð¿Ð¾-ÐºÑŠÑÐ½Ð¾)",disabled:!0,children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"})})})]}),s.jsx("div",{className:"svmessenger-input-helper",children:"ÐÐ°Ñ‚Ð¸ÑÐ½Ð¸ Enter Ð·Ð° Ð¸Ð·Ð¿Ñ€Ð°Ñ‰Ð°Ð½Ðµ â€¢ Shift+Enter Ð·Ð° Ð½Ð¾Ð² Ñ€ÐµÐ´"})]}),s.jsx(se,{show:c,onEmojiSelect:e=>{a(s=>s+e.native),l(!1),d.current&&d.current.focus()},onClose:()=>{l(!1)}})]})},te=({searchQuery:e,onSearchChange:n,onClose:t})=>s.jsxs("div",{className:"svmessenger-chat-search",children:[s.jsx("input",{type:"text",className:"svmessenger-chat-search-input",placeholder:"Ð¢ÑŠÑ€ÑÐ¸ Ð² Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð°...",value:e,onChange:e=>n(e.target.value),autoFocus:!0}),s.jsx("button",{className:"svmessenger-chat-search-close",onClick:t,title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸ Ñ‚ÑŠÑ€ÑÐµÐ½ÐµÑ‚Ð¾",children:"âœ•"})]}),re=({chat:n})=>{const{closeChat:t,minimizeChat:r,bringToFront:a,updateChatPosition:o,markAsRead:i,messagesByConversation:c,currentUser:l,startCall:d,openAudioSettings:u}=W(),m=e.useRef(null),[h,g]=e.useState(!1),[v,p]=e.useState({x:0,y:0}),[x,f]=e.useState(!1),[C,b]=e.useState("");e.useEffect(()=>{n.isMinimized||a(n.conversation.id)},[]);const j=e.useCallback(()=>{if(!n.isMinimized){a(n.conversation.id);(c[n.conversation.id]||[]).some(e=>e.senderId!==l.id&&!e.isRead)&&i(n.conversation.id)}},[n.conversation.id,n.isMinimized,a,i,c,l]),y=e.useCallback(e=>{e.target.closest(".svmessenger-chat-header")&&(e.target.closest(".svmessenger-chat-controls")||(g(!0),p({x:e.clientX-n.position.x,y:e.clientY-n.position.y}),a(n.conversation.id)))},[n.position,n.conversation.id,a]);e.useEffect(()=>{if(!h)return;const e=e=>{const s=e.clientX-v.x,t=e.clientY-v.y,r=window.innerWidth-400,a=window.innerHeight-600,i=Math.max(0,Math.min(s,r)),c=Math.max(0,Math.min(t,a));o(n.conversation.id,{x:i,y:c})},s=()=>{g(!1)};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",s),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",s)}},[h,v,n.conversation.id,o]);const S={left:`${n.position.x}px`,top:`${n.position.y}px`,zIndex:n.zIndex,display:n.isMinimized?"none":"flex"};return s.jsxs("div",{ref:m,className:"svmessenger-chat-window "+(h?"dragging":""),style:S,onMouseDown:y,onClick:j,children:[s.jsx(Q,{conversation:n.conversation,onClose:()=>{t(n.conversation.id)},onMinimize:()=>{r(n.conversation.id)},onOpenSearch:()=>{f(!0)},onCall:()=>{d(n.conversation.id,n.conversation.otherUser.id,n.conversation)},onOpenAudioSettings:()=>{console.log("ðŸŽµ Opening audio settings from chat menu"),u()}}),x&&s.jsx(te,{searchQuery:C,onSearchChange:e=>{b(e)},onClose:()=>{f(!1),b("")}}),s.jsx(Z,{conversationId:n.conversation.id,searchQuery:C}),s.jsx(ne,{conversationId:n.conversation.id})]})},ae=({onClose:n})=>{const{startConversation:t,openChat:r}=W(),[a,o]=e.useState(""),[i,c]=e.useState([]),[l,d]=e.useState([]),[u,h]=e.useState(!0),[g,v]=e.useState(!1),[p,x]=e.useState(!1);e.useEffect(()=>{(async()=>{h(!0);try{const e=await R("");c(e)}catch(e){console.error("Error loading following users:",e),c([])}finally{h(!1)}})()},[]);const f=e.useCallback(async e=>{const s=e.trim();if(!s||0===s.length)return x(!1),void d([]);if(s.length<2)return x(!1),void d([]);x(!0),v(!0);try{const e=await M(s);d(e)}catch(n){console.error("Search error:",n),d([])}finally{v(!1)}},[]),C=e.useCallback(m(e=>{f(e)},300),[f]),b=e.useCallback(async e=>{try{const s=await t(e.id);s&&s.id?(r(s.id,s),setTimeout(()=>{n()},100)):console.error("SVUserSearch: No conversation returned from startConversation")}catch(s){console.error("SVUserSearch: Failed to start conversation:",s)}},[t,r,n]);return s.jsxs("div",{className:"svmessenger-user-search",children:[s.jsxs("div",{className:"svmessenger-conversation-header",children:[s.jsx("h3",{children:"ÐÐ¾Ð² Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€"}),s.jsx("button",{className:"svmessenger-close-btn",onClick:n,title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]}),s.jsxs("div",{className:"svmessenger-search-input",children:[s.jsx("input",{type:"text",placeholder:"Ð¢ÑŠÑ€ÑÐ¸ Ð²ÑÐ¸Ñ‡ÐºÐ¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»Ð¸...",value:a,onChange:e=>{const s=e.target.value;o(s),s.trim().length>=2?C(s):(x(!1),d([]))},autoFocus:!0}),g&&s.jsx("div",{className:"svmessenger-search-loading-indicator",children:s.jsx("div",{className:"svmessenger-spinner-small"})})]}),p&&s.jsxs("div",{className:"svmessenger-search-results-panel",style:{height:g?"120px":0===l.length?"150px":l.length<=6?72*l.length+70+"px":"502px",maxHeight:"502px"},children:[s.jsxs("div",{className:"svmessenger-search-section-header",children:[s.jsx("span",{children:"Ð ÐµÐ·ÑƒÐ»Ñ‚Ð°Ñ‚Ð¸ Ð¾Ñ‚ Ñ‚ÑŠÑ€ÑÐµÐ½ÐµÑ‚Ð¾"}),g&&s.jsx("span",{className:"svmessenger-search-count",children:"Ð¢ÑŠÑ€ÑÐµÐ½Ðµ..."}),!g&&l.length>0&&s.jsxs("span",{className:"svmessenger-search-count",children:[l.length," Ñ€ÐµÐ·ÑƒÐ»Ñ‚Ð°Ñ‚Ð°"]})]}),g?s.jsxs("div",{className:"svmessenger-search-loading",children:[s.jsx("div",{className:"svmessenger-spinner"}),s.jsx("span",{children:"Ð¢ÑŠÑ€ÑÐµÐ½Ðµ..."})]}):0===l.length?s.jsxs("div",{className:"svmessenger-search-empty",children:[s.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"})}),s.jsx("p",{children:"ÐÑÐ¼Ð° Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»Ð¸"})]}):s.jsx("div",{className:"svmessenger-search-list",children:l.map(e=>s.jsxs("div",{className:"svmessenger-search-user-item",onClick:()=>b(e),children:[s.jsxs("div",{className:"svmessenger-search-user-avatar",children:[s.jsx("img",{src:e.imageUrl||"/images/default-avatar.png",alt:e.username,onError:e=>{e.target.src="/images/default-avatar.png"}}),e.isOnline&&s.jsx("div",{className:"svmessenger-online-indicator"})]}),s.jsxs("div",{className:"svmessenger-search-user-info",children:[s.jsx("h4",{className:"svmessenger-search-user-name",children:e.realName||e.username}),s.jsxs("p",{className:"svmessenger-search-user-username",children:["@",e.username]})]}),s.jsx("div",{className:"svmessenger-search-user-action",children:s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"})})})]},e.id))})]}),s.jsxs("div",{className:"svmessenger-following-users-panel",children:[s.jsxs("div",{className:"svmessenger-search-section-header",children:[s.jsx("span",{children:"Ð¡Ð»ÐµÐ´Ð²Ð°Ð½Ð¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»Ð¸"}),!u&&i.length>0&&s.jsx("span",{className:"svmessenger-search-count",children:i.length})]}),u?s.jsxs("div",{className:"svmessenger-search-loading",children:[s.jsx("div",{className:"svmessenger-spinner"}),s.jsx("span",{children:"Ð—Ð°Ñ€ÐµÐ¶Ð´Ð°Ð½Ðµ Ð½Ð° ÑÐ»ÐµÐ´Ð²Ð°Ð½Ð¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»Ð¸..."})]}):0===i.length?s.jsxs("div",{className:"svmessenger-search-empty",children:[s.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"})}),s.jsx("p",{children:"ÐÑÐ¼Ð° ÑÐ»ÐµÐ´Ð²Ð°Ð½Ð¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»Ð¸"})]}):s.jsx("div",{className:"svmessenger-search-list",children:i.map(e=>s.jsxs("div",{className:"svmessenger-search-user-item",onClick:()=>b(e),children:[s.jsxs("div",{className:"svmessenger-search-user-avatar",children:[s.jsx("img",{src:e.imageUrl||"/images/default-avatar.png",alt:e.username,onError:e=>{e.target.src="/images/default-avatar.png"}}),e.isOnline&&s.jsx("div",{className:"svmessenger-online-indicator"})]}),s.jsxs("div",{className:"svmessenger-search-user-info",children:[s.jsx("h4",{className:"svmessenger-search-user-name",children:e.realName||e.username}),s.jsxs("p",{className:"svmessenger-search-user-username",children:["@",e.username]})]}),s.jsx("div",{className:"svmessenger-search-user-action",children:s.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"})})})]},e.id))})]})]})},oe=()=>{const{activeChats:n,conversations:t,restoreChat:r,closeChat:a}=W(),o=e.useMemo(()=>n.filter(e=>e.isMinimized).map(e=>({...e,conversation:t.find(s=>s.id===e.conversation.id)||e.conversation})),[n,t]);if(0===o.length)return null;const i=[...o].reverse();return s.jsx("div",{className:"svmessenger-taskbar",children:i.map(e=>s.jsxs("button",{className:"svmessenger-taskbar-button","data-chat-id":e.conversation.id,onClick:()=>r(e.conversation.id),title:`Ð’ÑŠÐ·ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€ Ñ ${e.conversation.otherUser.realName||e.conversation.otherUser.username}`,children:[s.jsxs("div",{className:"svmessenger-taskbar-avatar",children:[s.jsx("img",{src:e.conversation.otherUser.imageUrl||"/images/default-avatar.png",alt:e.conversation.otherUser.username,onError:e=>{e.target.src="/images/default-avatar.png"}}),e.conversation.otherUser.isOnline&&s.jsx("div",{className:"svmessenger-online-indicator"})]}),s.jsx("span",{className:"svmessenger-taskbar-name",children:e.conversation.otherUser.realName||e.conversation.otherUser.username}),e.conversation.unreadCount>0&&s.jsx("span",{className:"svmessenger-taskbar-badge",children:e.conversation.unreadCount>99?"99+":e.conversation.unreadCount}),s.jsx("button",{className:"svmessenger-taskbar-close",onClick:s=>{s.stopPropagation(),a(e.conversation.id)},title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸ Ñ‡Ð°Ñ‚",children:s.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]},e.conversation.id))})},ie=({callState:n,conversation:t,onAccept:r,onReject:a,onEnd:o})=>{const[i,c]=e.useState(0),[l,d]=e.useState(!1);e.useEffect(()=>{let e;return"connected"===n?e=setInterval(()=>{c(e=>e+1)},1e3):c(0),()=>{e&&clearInterval(e)}},[n]),e.useEffect(()=>{if("incoming"===n){const e=setTimeout(()=>{const e=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});document.dispatchEvent(e)},100);return()=>clearTimeout(e)}},[n]);if(!t||"idle"===n)return null;const{otherUser:u}=t,m=`svmessenger-call-modal svmessenger-call-${n}`;return s.jsx("div",{className:"svmessenger-call-modal-overlay",children:s.jsxs("div",{className:m,children:[s.jsx("div",{className:"svmessenger-call-avatar",children:u.imageUrl?s.jsx("img",{src:u.imageUrl,alt:u.realName||u.username}):s.jsx("div",{className:"svmessenger-call-avatar-placeholder",children:(u.realName||u.username||"U").charAt(0).toUpperCase()})}),s.jsxs("div",{className:"svmessenger-call-status",children:[s.jsxs("div",{className:"svmessenger-call-title",children:["incoming"===n&&"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¾ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½Ðµ","outgoing"===n&&"ÐžÐ±Ð°Ð¶Ð´Ð°Ð½Ðµ...","connected"===n&&"Ð’ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€"]}),s.jsx("div",{className:"svmessenger-call-subtitle",children:"connected"===n?(e=>{const s=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`})(i):u.realName||u.username}),("incoming"===n||"outgoing"===n)&&s.jsxs("div",{className:"svmessenger-call-calling-animation",children:[s.jsxs("div",{className:"svmessenger-call-ripple-container",children:[s.jsx("div",{className:"svmessenger-call-ripple ripple-1"}),s.jsx("div",{className:"svmessenger-call-ripple ripple-2"}),s.jsx("div",{className:"svmessenger-call-ripple ripple-3"}),s.jsx("div",{className:"svmessenger-call-ripple ripple-4"})]}),s.jsx("div",{className:"svmessenger-call-glow-core",children:s.jsx("div",{className:"svmessenger-call-glow-inner"})}),s.jsxs("div",{className:"svmessenger-call-particles",children:[s.jsx("div",{className:"particle particle-1"}),s.jsx("div",{className:"particle particle-2"}),s.jsx("div",{className:"particle particle-3"}),s.jsx("div",{className:"particle particle-4"}),s.jsx("div",{className:"particle particle-5"}),s.jsx("div",{className:"particle particle-6"})]})]})]}),s.jsxs("div",{className:"svmessenger-call-actions",children:["incoming"===n&&s.jsxs(s.Fragment,{children:[s.jsx("button",{className:"svmessenger-call-btn-accept",onClick:r,title:"ÐŸÑ€Ð¸ÐµÐ¼Ð¸ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½ÐµÑ‚Ð¾",children:s.jsx("i",{className:"bi bi-telephone accept-icon"})}),s.jsx("button",{className:"svmessenger-call-btn-reject",onClick:a,title:"ÐžÑ‚ÐºÐ°Ð¶Ð¸ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½ÐµÑ‚Ð¾",children:s.jsx("i",{className:"bi bi-telephone reject-icon"})})]}),"outgoing"===n&&s.jsx("button",{className:"svmessenger-call-btn-end",onClick:o,title:"ÐžÑ‚Ð¼ÐµÐ½Ð¸ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½ÐµÑ‚Ð¾",children:s.jsx("i",{className:"bi bi-telephone end-icon"})}),"connected"===n&&s.jsxs(s.Fragment,{children:[s.jsx("button",{className:"svmessenger-call-btn-mute "+(l?"muted":""),onClick:()=>{d(!l)},title:l?"Ð’ÐºÐ»ÑŽÑ‡Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ð°":"Ð˜Ð·ÐºÐ»ÑŽÑ‡Ð¸ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ð°",children:l?s.jsx("i",{className:"bi bi-mic-mute muted-icon"}):s.jsx("i",{className:"bi bi-mic active-icon"})}),s.jsx("button",{className:"svmessenger-call-btn-end",onClick:o,title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½ÐµÑ‚Ð¾",children:s.jsx("i",{className:"bi bi-telephone end-icon"})})]})]})]})})},ce=({isOpen:n,onComplete:t,onCancel:r})=>{const{deviceSelectorMode:a}=W(),[i,c]=e.useState([]),[l,d]=e.useState([]),[u,m]=e.useState([]),[h,g]=e.useState(""),[v,p]=e.useState(""),[x,f]=e.useState(""),[C,b]=e.useState(75),[j,y]=e.useState(80),[S,w]=e.useState(!0),[N,k]=e.useState(!1),[I,E]=e.useState(!1),[M,R]=e.useState(null),[T,U]=e.useState(0),[A,z]=e.useState(null),[L,D]=e.useState("microphone"),[O,B]=e.useState(!1),[F,V]=e.useState({x:0,y:0}),[$,_]=e.useState({x:0,y:0}),P=e.useRef(null),H=e.useRef(null),K=e.useRef(null),J=e.useRef(null),q=e.useRef(null),G=e.useRef(null);e.useRef(null),e.useRef(null),e.useEffect(()=>{n&&setTimeout(()=>{if(P.current){P.current;const e=(window.innerWidth-400)/2,s=(window.innerHeight-500)/2;V({x:Math.max(0,e),y:Math.max(0,s)})}},0)},[n]);e.useEffect(()=>{if(!O)return;const e=e=>{if(!P.current)return;const s=P.current.offsetWidth,n=P.current.offsetHeight,t=e.clientX-$.x,r=e.clientY-$.y,a=window.innerWidth-s,o=window.innerHeight-n,i=Math.max(0,Math.min(t,a)),c=Math.max(0,Math.min(r,o));V({x:i,y:c})},s=()=>{B(!1)};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",s),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",s)}},[O,$]),e.useEffect(()=>{const e=localStorage.getItem("svmessenger-audio-settings");if(e)try{const s=JSON.parse(e);b(s.micVolume||75),y(s.speakerVolume||80),s.microphone&&(g(s.microphone),o.selectedMicrophone=s.microphone),s.speaker&&(p(s.speaker),o.selectedSpeaker=s.speaker)}catch(s){console.warn("Failed to load saved audio settings:",s)}},[]);const Q=e=>{try{try{localStorage.setItem("svmessenger-audio-video-settings",JSON.stringify(e));localStorage.getItem("svmessenger-audio-video-settings")}catch(s){}e.microphone&&(o.selectedMicrophone=e.microphone),e.speaker&&(o.selectedSpeaker=e.speaker),e.camera&&(o.selectedCamera=e.camera)}catch(n){console.warn("Failed to save audio/video settings:",n)}},X=(e,s)=>{"mic"===e?(b(s),Q({micVolume:s,speakerVolume:j})):"speaker"===e&&(y(s),Q({micVolume:C,speakerVolume:s}))};e.useEffect(()=>(n?Y():(ee(),ne()),()=>{ee(),ne()}),[n]);const Y=async()=>{try{w(!0),R(null),U(0),await o.requestAudioPermissions();try{await o.requestCameraPermissions()}catch(e){console.warn("Camera permissions not granted, cameras may not be available:",e)}const n=await o.enumerateAudioDevices(),t=await o.getCameras();c(n.microphones),d(n.speakers),m(t);const r=localStorage.getItem("svmessenger-audio-video-settings");let a,i,l;if(r)try{const e=JSON.parse(r);a=e.microphone,i=e.speaker,l=e.camera}catch(s){console.warn("Error parsing saved settings:",s)}const u=a||(n.microphones.length>0?n.microphones[0].deviceId:"");g(u),p(i||(n.speakers.length>0?n.speakers[0].deviceId:"")),f(l||(t.length>0?t[0].deviceId:"")),u&&setTimeout(()=>{Z(u)},100)}catch(n){R(n.message||"Failed to access audio/video devices"),console.error("Audio/Video device initialization error:",n)}finally{w(!1)}},Z=async e=>{try{let n;ee(),H.current=new(window.AudioContext||window.webkitAudioContext),K.current=H.current.createAnalyser(),K.current.fftSize=2048,K.current.smoothingTimeConstant=.8;try{n=await navigator.mediaDevices.getUserMedia({audio:{deviceId:!e||{ideal:e},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})}catch(s){n=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})}G.current=n,J.current=H.current.createMediaStreamSource(n),J.current.connect(K.current);const t=new Float32Array(K.current.fftSize),r=()=>{if(!K.current)return;K.current.getFloatTimeDomainData(t);let e=0;for(let r=0;r<t.length;r++)e+=t[r]*t[r];const s=Math.sqrt(e/t.length);let n=0;s>0&&(n=Math.min(100,Math.max(0,300*s)),n<50&&(n*=1.5)),U(Math.min(100,n)),q.current=requestAnimationFrame(r)};r()}catch(n){console.error("Error starting audio visualization:",n),U(0)}},ee=()=>{q.current&&(cancelAnimationFrame(q.current),q.current=null),J.current&&(J.current.disconnect(),J.current=null),G.current&&(G.current.getTracks().forEach(e=>e.stop()),G.current=null),H.current&&"closed"!==H.current.state&&(H.current.close(),H.current=null),K.current=null,U(0)},se=async()=>{try{k(!0),z(null);const s=new(window.AudioContext||window.webkitAudioContext),n=s.createOscillator(),t=s.createGain(),r=document.createElement("audio");if(v&&"setSinkId"in HTMLAudioElement.prototype)try{await r.setSinkId(v)}catch(e){}const a=s.createMediaStreamDestination();n.connect(t),t.connect(a),r.srcObject=a.stream,r.volume=j/100,n.frequency.setValueAtTime(440,s.currentTime),t.gain.setValueAtTime(1,s.currentTime),n.start(),await r.play(),t.gain.exponentialRampToValueAtTime(.01,s.currentTime+1),n.stop(s.currentTime+1),setTimeout(()=>{r.pause(),r.srcObject=null,s.close(),z({speakerWorking:!0}),k(!1)},1200)}catch(s){console.error("Speaker test failed:",s),z({speakerWorking:!1,error:s.message}),k(!1)}},ne=()=>{k(!1),z(null)},te=({level:e,label:n})=>s.jsxs("div",{style:{padding:"8px",background:"#f3f4f6",borderRadius:"6px",marginTop:"6px"},children:[n&&s.jsx("div",{style:{display:"block",marginBottom:"6px",fontSize:"10px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:n}),s.jsx("div",{style:{position:"relative",height:"5px",background:"#d1d5db",borderRadius:"3px",overflow:"hidden"},children:s.jsx("div",{style:{position:"absolute",left:0,top:0,height:"100%",width:`${e}%`,background:e>70?"#22c55e":e>30?"#eab308":"#ef4444",transition:"width 0.1s ease",borderRadius:"3px"}})}),s.jsxs("div",{style:{marginTop:"3px",fontSize:"10px",fontWeight:"600",color:"#6b7280",textAlign:"right"},children:[Math.round(e),"%"]})]});return n?s.jsxs("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1e4,pointerEvents:"none"},children:[s.jsxs("div",{ref:P,style:{position:"absolute",left:`${F.x}px`,top:`${F.y}px`,background:"#ffffff",borderRadius:"12px",width:"400px",maxHeight:"500px",display:"flex",flexDirection:"column",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.25)",pointerEvents:"auto"},children:[s.jsxs("div",{className:"audio-device-header",style:{padding:"14px 20px",borderBottom:"1px solid #e5e7eb",textAlign:"center",position:"sticky",top:0,background:"#ffffff",zIndex:10,borderRadius:"12px 12px 0 0",cursor:O?"grabbing":"grab",userSelect:"none"},onMouseDown:e=>{const s=e.target.closest(".audio-device-header"),n=e.target.closest(".audio-device-close");if(s&&!n&&(B(!0),P.current)){const s=P.current.getBoundingClientRect();_({x:e.clientX-s.left,y:e.clientY-s.top})}},children:[s.jsx("button",{className:"audio-device-close",onClick:r,style:{position:"absolute",top:"12px",right:"12px",background:"none",border:"none",cursor:"pointer",padding:"4px",display:"flex",alignItems:"center",justifyContent:"center",color:"#6b7280",fontSize:"18px",lineHeight:"1",width:"24px",height:"24px",borderRadius:"4px",transition:"all 0.2s ease"},onMouseEnter:e=>{e.currentTarget.style.background="#f3f4f6",e.currentTarget.style.color="#111827"},onMouseLeave:e=>{e.currentTarget.style.background="none",e.currentTarget.style.color="#6b7280"},title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸",children:s.jsx("i",{className:"bi bi-x",style:{fontSize:"20px",fontWeight:"300"}})}),s.jsx("div",{style:{width:"36px",height:"36px",background:"linear-gradient(135deg, #22c55e 0%, #16a34a 100%)",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 10px",boxShadow:"0 4px 12px rgba(34, 197, 94, 0.3)"},children:s.jsx("i",{className:"bi bi-gear-fill",style:{fontSize:"18px",color:"#ffffff"}})}),s.jsx("h2",{style:{margin:"0 0 4px 0",fontSize:"16px",fontWeight:"700",color:"#111827"},children:"ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð½Ð° Ð°ÑƒÐ´Ð¸Ð¾/Ð²Ð¸Ð´ÐµÐ¾"}),s.jsx("p",{style:{margin:0,fontSize:"10px",color:"#6b7280"},children:"ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°Ñ‚Ð° ÑÐ¸ Ð·Ð° ÐºÐ°Ñ‡ÐµÑÑ‚Ð²ÐµÐ½ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€"})]}),S&&s.jsxs("div",{style:{padding:"32px 20px",textAlign:"center"},children:[s.jsx("div",{style:{width:"36px",height:"36px",border:"3px solid #e5e7eb",borderTop:"3px solid #22c55e",borderRadius:"50%",animation:"spin 1s linear infinite",margin:"0 auto 12px"}}),s.jsx("h4",{style:{margin:"0 0 6px 0",fontSize:"13px",fontWeight:"600",color:"#111827"},children:"Ð˜ÑÐºÐ°Ð½Ðµ Ð½Ð° Ð´Ð¾ÑÑ‚ÑŠÐ¿ Ð´Ð¾ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½"}),s.jsx("p",{style:{margin:0,fontSize:"11px",color:"#6b7280"},children:"ÐœÐ¾Ð»Ñ, Ð¿Ð¾Ð·Ð²Ð¾Ð»ÐµÑ‚Ðµ Ð´Ð¾ÑÑ‚ÑŠÐ¿Ð° Ð² browser Ð¿Ñ€Ð¾Ð·Ð¾Ñ€ÐµÑ†Ð°"})]}),M&&s.jsxs("div",{style:{padding:"24px 20px",textAlign:"center"},children:[s.jsx("div",{style:{width:"40px",height:"40px",background:"#fee2e2",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 12px"},children:s.jsx("i",{className:"bi bi-exclamation-triangle-fill",style:{fontSize:"20px",color:"#ef4444"}})}),s.jsx("h4",{style:{margin:"0 0 6px 0",fontSize:"13px",fontWeight:"600",color:"#ef4444"},children:"Ð“Ñ€ÐµÑˆÐºÐ° Ð¿Ñ€Ð¸ Ð´Ð¾ÑÑ‚ÑŠÐ¿ Ð´Ð¾ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°"}),s.jsx("p",{style:{margin:"0 0 12px 0",fontSize:"11px",color:"#6b7280"},children:M}),s.jsx("button",{onClick:Y,style:{background:"#ef4444",color:"#ffffff",border:"none",padding:"8px 18px",borderRadius:"6px",fontSize:"12px",fontWeight:"600",cursor:"pointer",boxShadow:"0 2px 6px rgba(239, 68, 68, 0.3)"},children:"ÐžÐ¿Ð¸Ñ‚Ð°Ð¹ Ð¾Ñ‚Ð½Ð¾Ð²Ð¾"})]}),!S&&!M&&s.jsxs("div",{style:{display:"flex",flexDirection:"column",flex:1,overflow:"hidden"},children:[s.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #e5e7eb",background:"#ffffff",padding:"0 20px"},children:[s.jsxs("button",{onClick:()=>D("microphone"),style:{flex:1,padding:"12px 8px",background:"none",border:"none",borderBottom:"microphone"===L?"2px solid #22c55e":"2px solid transparent",color:"microphone"===L?"#22c55e":"#6b7280",fontSize:"12px",fontWeight:"microphone"===L?"600":"500",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px",transition:"all 0.2s ease"},children:[s.jsx("i",{className:"bi bi-mic-fill",style:{fontSize:"14px"}}),"ÐœÐ¸ÐºÑ€Ð¾Ñ„Ð¾Ð½"]}),s.jsxs("button",{onClick:()=>D("speaker"),style:{flex:1,padding:"12px 8px",background:"none",border:"none",borderBottom:"speaker"===L?"2px solid #22c55e":"2px solid transparent",color:"speaker"===L?"#22c55e":"#6b7280",fontSize:"12px",fontWeight:"speaker"===L?"600":"500",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px",transition:"all 0.2s ease"},children:[s.jsx("i",{className:"bi bi-headphones",style:{fontSize:"14px"}}),"Ð¡Ð»ÑƒÑˆÐ°Ð»ÐºÐ¸"]}),s.jsxs("button",{onClick:()=>D("camera"),style:{flex:1,padding:"12px 8px",background:"none",border:"none",borderBottom:"camera"===L?"2px solid #22c55e":"2px solid transparent",color:"camera"===L?"#22c55e":"#6b7280",fontSize:"12px",fontWeight:"camera"===L?"600":"500",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px",transition:"all 0.2s ease"},children:[s.jsx("i",{className:"bi bi-camera-video-fill",style:{fontSize:"14px"}}),"ÐšÐ°Ð¼ÐµÑ€Ð°"]})]}),s.jsxs("div",{style:{padding:"20px",overflowY:"auto",flex:1,maxHeight:"calc(500px - 200px)"},children:["microphone"===L&&s.jsxs("div",{children:[s.jsxs("div",{style:{marginBottom:"16px"},children:[s.jsx("label",{style:{display:"block",marginBottom:"8px",fontSize:"11px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"Ð£ÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾"}),s.jsx("select",{value:h,onChange:e=>(async e=>{try{await o.setMicrophone(e),g(e),ee(),await Z(e);const s={...JSON.parse(localStorage.getItem("svmessenger-audio-settings")||"{}"),microphone:e,micVolume:C};Q(s)}catch(s){console.error("Error changing microphone:",s)}})(e.target.value),style:{width:"100%",padding:"10px 12px",border:"1px solid #d1d5db",borderRadius:"8px",background:"#ffffff",color:"#111827",fontSize:"13px",cursor:"pointer",transition:"border-color 0.2s ease"},onFocus:e=>e.target.style.borderColor="#22c55e",onBlur:e=>e.target.style.borderColor="#d1d5db",children:i.map(e=>s.jsx("option",{value:e.deviceId,children:e.label||`ÐœÐ¸ÐºÑ€Ð¾Ñ„Ð¾Ð½ ${e.deviceId.slice(0,8)}`},e.deviceId))})]}),s.jsxs("div",{style:{marginBottom:"16px"},children:[s.jsx("label",{style:{display:"block",marginBottom:"8px",fontSize:"11px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"Ð¡Ð¸Ð»Ð° Ð½Ð° Ð·Ð²ÑƒÐºÐ°"}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",padding:"12px",background:"#f9fafb",borderRadius:"8px",border:"1px solid #e5e7eb"},children:[s.jsx("i",{className:"bi bi-volume-down-fill",style:{fontSize:"16px",color:"#22c55e"}}),s.jsx("input",{type:"range",min:"0",max:"100",value:C,onChange:e=>X("mic",Number(e.target.value)),style:{flex:1,height:"6px",background:"#d1d5db",borderRadius:"3px",outline:"none",cursor:"pointer"}}),s.jsxs("span",{style:{fontSize:"13px",fontWeight:"600",color:"#111827",minWidth:"40px",textAlign:"right"},children:[C,"%"]})]})]}),s.jsx(te,{level:T})]}),"speaker"===L&&s.jsxs("div",{children:[s.jsxs("div",{style:{marginBottom:"16px"},children:[s.jsx("label",{style:{display:"block",marginBottom:"8px",fontSize:"11px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"Ð£ÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾"}),s.jsx("select",{value:v,onChange:e=>(async e=>{try{await o.setSpeaker(e),p(e);const s={...JSON.parse(localStorage.getItem("svmessenger-audio-video-settings")||localStorage.getItem("svmessenger-audio-settings")||"{}"),speaker:e,speakerVolume:j};Q(s)}catch(s){console.error("Error changing speaker:",s)}})(e.target.value),style:{width:"100%",padding:"10px 12px",border:"1px solid #d1d5db",borderRadius:"8px",background:"#ffffff",color:"#111827",fontSize:"13px",cursor:"pointer",transition:"border-color 0.2s ease"},onFocus:e=>e.target.style.borderColor="#22c55e",onBlur:e=>e.target.style.borderColor="#d1d5db",children:l.map(e=>s.jsx("option",{value:e.deviceId,children:e.label||`Ð¡Ð»ÑƒÑˆÐ°Ð»ÐºÐ¸ ${e.deviceId.slice(0,8)}`},e.deviceId))})]}),s.jsxs("div",{style:{marginBottom:"16px"},children:[s.jsx("label",{style:{display:"block",marginBottom:"8px",fontSize:"11px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"Ð¡Ð¸Ð»Ð° Ð½Ð° Ð·Ð²ÑƒÐºÐ°"}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",padding:"12px",background:"#f9fafb",borderRadius:"8px",border:"1px solid #e5e7eb"},children:[s.jsx("i",{className:"bi bi-volume-up-fill",style:{fontSize:"16px",color:"#22c55e"}}),s.jsx("input",{type:"range",min:"0",max:"100",value:j,onChange:e=>X("speaker",Number(e.target.value)),style:{flex:1,height:"6px",background:"#d1d5db",borderRadius:"3px",outline:"none",cursor:"pointer"}}),s.jsxs("span",{style:{fontSize:"13px",fontWeight:"600",color:"#111827",minWidth:"40px",textAlign:"right"},children:[j,"%"]})]})]}),s.jsxs("div",{style:{background:"#eaffe9",border:"1px solid #bbf7d0",borderRadius:"10px",padding:"14px",marginTop:"8px"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"10px"},children:[s.jsx("i",{className:"bi bi-info-circle-fill",style:{fontSize:"14px",color:"#22c55e"}}),s.jsx("span",{style:{fontSize:"12px",fontWeight:"600",color:"#166534"},children:"Ð¢ÐµÑÑ‚ Ð½Ð° ÑÐ»ÑƒÑˆÐ°Ð»ÐºÐ¸"})]}),s.jsx("p",{style:{margin:"0 0 12px 0",fontSize:"11px",color:"#166534",lineHeight:"1.5"},children:"ÐÐ°Ñ‚Ð¸ÑÐ½ÐµÑ‚Ðµ Ð±ÑƒÑ‚Ð¾Ð½Ð° Ð¿Ð¾-Ð´Ð¾Ð»Ñƒ, Ð·Ð° Ð´Ð° Ñ‡ÑƒÐµÑ‚Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð² ÑÐ¸Ð³Ð½Ð°Ð» Ð¸ Ð´Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚Ðµ Ð´Ð°Ð»Ð¸ ÑÐ»ÑƒÑˆÐ°Ð»ÐºÐ¸Ñ‚Ðµ Ñ€Ð°Ð±Ð¾Ñ‚ÑÑ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð½Ð¾."}),s.jsx("button",{onClick:()=>{N?ne():se()},disabled:0===l.length||N,style:{width:"100%",padding:"10px",background:N?"#6bb75f":"#22c55e",color:"#ffffff",border:"none",borderRadius:"8px",fontSize:"12px",fontWeight:"600",cursor:0===l.length||N?"not-allowed":"pointer",opacity:0===l.length||N?.6:1,display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",transition:"all 0.2s ease",boxShadow:0===l.length||N?"none":"0 2px 6px rgba(34, 197, 94, 0.3)"},onMouseEnter:e=>{l.length>0&&!N&&(e.currentTarget.style.background="#16a34a")},onMouseLeave:e=>{l.length>0&&!N&&(e.currentTarget.style.background="#22c55e")},children:N?s.jsxs(s.Fragment,{children:[s.jsx("div",{style:{width:"14px",height:"14px",border:"2px solid #ffffff",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 0.8s linear infinite"}}),"Ð¢ÐµÑÑ‚Ð²Ð°Ð½Ðµ..."]}):s.jsxs(s.Fragment,{children:[s.jsx("i",{className:"bi bi-play-circle-fill",style:{fontSize:"14px"}}),"Ð¢ÐµÑÑ‚Ð²Ð°Ð¹ ÑÐ»ÑƒÑˆÐ°Ð»ÐºÐ¸"]})}),A&&s.jsx("div",{style:{marginTop:"12px",padding:"10px",background:"#ffffff",borderRadius:"6px",border:"1px solid #bbf7d0"},children:s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[s.jsx("i",{className:"bi bi-"+(A.speakerWorking?"check-circle-fill":"x-circle-fill"),style:{fontSize:"16px",color:A.speakerWorking?"#22c55e":"#ef4444"}}),s.jsx("span",{style:{fontSize:"12px",color:"#166534",fontWeight:"500"},children:A.speakerWorking?"Ð¡Ð»ÑƒÑˆÐ°Ð»ÐºÐ¸Ñ‚Ðµ Ñ€Ð°Ð±Ð¾Ñ‚ÑÑ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð½Ð¾":"ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼ ÑÑŠÑ ÑÐ»ÑƒÑˆÐ°Ð»ÐºÐ¸Ñ‚Ðµ"})]})})]})]}),"camera"===L&&s.jsxs("div",{children:[s.jsxs("div",{style:{marginBottom:"16px"},children:[s.jsx("label",{style:{display:"block",marginBottom:"8px",fontSize:"11px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"Ð£ÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾"}),s.jsx("select",{value:x,onChange:e=>(async e=>{try{await o.setCamera(e),f(e);const s={...JSON.parse(localStorage.getItem("svmessenger-audio-video-settings")||localStorage.getItem("svmessenger-audio-settings")||"{}"),camera:e};Q(s)}catch(s){console.error("Error changing camera:",s)}})(e.target.value),style:{width:"100%",padding:"10px 12px",border:"1px solid #d1d5db",borderRadius:"8px",background:"#ffffff",color:"#111827",fontSize:"13px",cursor:0===u.length?"not-allowed":"pointer",opacity:0===u.length?.6:1,transition:"border-color 0.2s ease"},disabled:0===u.length,onFocus:e=>{u.length>0&&(e.target.style.borderColor="#3b82f6")},onBlur:e=>e.target.style.borderColor="#d1d5db",children:0===u.length?s.jsx("option",{children:"ÐÑÐ¼Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð½Ð¸ ÐºÐ°Ð¼ÐµÑ€Ð¸"}):u.map(e=>s.jsx("option",{value:e.deviceId,children:e.label||`ÐšÐ°Ð¼ÐµÑ€Ð° ${e.deviceId.slice(0,8)}`},e.deviceId))})]}),s.jsx("div",{style:{background:"#eff6ff",border:"1px solid #bfdbfe",borderRadius:"10px",padding:"14px",fontSize:"12px",color:"#1e40af",lineHeight:"1.5"},children:s.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:"8px"},children:[s.jsx("i",{className:"bi bi-info-circle-fill",style:{fontSize:"14px",marginTop:"2px",flexShrink:0}}),s.jsx("span",{children:"ÐšÐ°Ð¼ÐµÑ€Ð°Ñ‚Ð° Ñ‰Ðµ ÑÐµ Ð¸Ð·Ð¿Ð¾Ð»Ð·Ð²Ð° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾ Ð¿Ñ€Ð¸ Ð²ÐºÐ»ÑŽÑ‡Ð²Ð°Ð½Ðµ Ð½Ð° Ð²Ð¸Ð´ÐµÐ¾ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼Ðµ Ð½Ð° Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€."})]})})]})]})]}),s.jsxs("div",{style:{padding:"14px 20px",borderTop:"1px solid #e5e7eb",display:"flex",gap:"10px",justifyContent:"flex-end"},children:[s.jsx("button",{onClick:r,disabled:S,style:{padding:"8px 18px",background:"#ffffff",color:"#6b7280",border:"1px solid #d1d5db",borderRadius:"6px",fontSize:"12px",fontWeight:"600",cursor:S?"not-allowed":"pointer",opacity:S?.5:1},children:"ÐžÑ‚ÐºÐ°Ð·"}),s.jsx("button",{onClick:()=>{ee(),ne();Q({microphone:h,speaker:v,camera:x,micVolume:C,speakerVolume:j}),t({microphone:h,speaker:v,camera:x,micVolume:C/100,speakerVolume:j/100})},disabled:S||M||0===i.length,style:{padding:"8px 18px",background:S||M||0===i.length?"#d1d5db":"#22c55e",color:"#ffffff",border:"none",borderRadius:"6px",fontSize:"12px",fontWeight:"600",cursor:S||M||0===i.length?"not-allowed":"pointer",boxShadow:S||M||0===i.length?"none":"0 2px 6px rgba(34, 197, 94, 0.3)"},children:"settings"===a?"Ð—Ð°Ð¿Ð°Ð·Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸":"Ð—Ð°Ð¿Ð¾Ñ‡Ð½Ð¸ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€"})]})]}),s.jsx("style",{children:"\n        @keyframes spin {\n          0% { transform: rotate(0deg); }\n          100% { transform: rotate(360deg); }\n        }\n      "})]}):null},le=()=>{var e,n,t,r;const{isChatListOpen:a,isSearchOpen:o,activeChats:i,totalUnreadCount:c,openChatList:l,closeChatList:d,openSearch:u,closeSearch:m,currentCall:h,callState:g,acceptCall:v,rejectCall:p,endCall:x,showDeviceSelector:f,handleDeviceSelectorComplete:C,handleDeviceSelectorCancel:b,callWindowRef:j}=W();return s.jsxs("div",{className:"svmessenger-widget",children:[s.jsxs("div",{className:"svmessenger-fab",onClick:l,children:[s.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:s.jsx("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"})}),c>0&&s.jsx("span",{className:"svmessenger-badge",children:c>99?"99+":c})]}),a&&s.jsx(G,{onClose:d,onSearchClick:()=>{d(),u()}}),o&&s.jsx(ae,{onClose:m}),i.map(e=>s.jsx(re,{chat:e},e.conversation.id)),s.jsx(ce,{isOpen:f,onComplete:C,onCancel:b}),"idle"!==g&&h&&h.conversation&&!j&&s.jsx(ie,{callState:g,conversation:h.conversation,onAccept:v,onReject:p,onEnd:x}),"idle"!==g&&h&&j&&s.jsx("div",{className:"svmessenger-call-indicator",children:s.jsxs("div",{className:"svmessenger-call-indicator-content",children:[s.jsx("div",{className:"svmessenger-call-indicator-icon",children:s.jsx("i",{className:"bi bi-headphones"})}),s.jsxs("div",{className:"svmessenger-call-indicator-text",children:[s.jsxs("div",{className:"svmessenger-call-indicator-title",children:["outgoing"===g&&"ÐžÐ±Ð°Ð¶Ð´Ð°Ð½Ðµ...","incoming"===g&&"Ð’Ñ…Ð¾Ð´ÑÑ‰Ð¾ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½Ðµ","connected"===g&&"Ð’ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€"]}),s.jsx("div",{className:"svmessenger-call-indicator-subtitle",children:(null==(n=null==(e=h.conversation)?void 0:e.otherUser)?void 0:n.realName)||(null==(r=null==(t=h.conversation)?void 0:t.otherUser)?void 0:r.username)||"ÐŸÐ¾Ñ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»"})]}),s.jsx("button",{className:"svmessenger-call-indicator-close",onClick:x,title:"Ð—Ð°Ñ‚Ð²Ð¾Ñ€Ð¸ Ð¾Ð±Ð°Ð¶Ð´Ð°Ð½ÐµÑ‚Ð¾",children:s.jsx("i",{className:"bi bi-x"})})]})}),s.jsx(oe,{})]})};function de(){const e=window.SVMESSENGER_USER_DATA||{isAuthenticated:!1};return e.isAuthenticated?s.jsx(P,{userData:e,children:s.jsx(le,{})}):null}const ue=document.getElementById("svmessenger-root");ue?t.createRoot(ue).render(s.jsx(r.StrictMode,{children:s.jsx(de,{})})):console.warn("SVMessenger: Root element #svmessenger-root not found");
