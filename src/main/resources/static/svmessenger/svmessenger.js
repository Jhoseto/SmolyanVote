import{r as e,j as n,$ as s,c as t,R as r}from"./svmessenger-vendor-react.js";import{s as a,a as o,t as i,i as l,l as c,b as d,c as m,d as u}from"./svmessenger-svHelpers.js";import{p as h,a as p,b as g,f as v,d as x,e as f}from"./svmessenger-vendor.js";import"./svmessenger-vendor-livekit.js";import"./svmessenger-vendor-websocket.js";const b="/api/svmessenger",C=async(e,n={})=>{const s={headers:{"Content-Type":"application/json"},credentials:"include"},t=(()=>{if(window.CSRF_TOKEN)return window.CSRF_TOKEN;if(window.getCsrfToken&&"function"==typeof window.getCsrfToken){const e=window.getCsrfToken();if(e)return e}const e=document.querySelector('meta[name="_csrf"]');if(e&&e.content)return e.content;if(window.SVMESSENGER_CSRF&&window.SVMESSENGER_CSRF.token)return window.SVMESSENGER_CSRF.token;const n=document.cookie.match(/(?:^|; )XSRF-TOKEN=([^;]+)/);return n?decodeURIComponent(n[1]):null})(),r=(()=>{if(window.CSRF_HEADER)return window.CSRF_HEADER;if(window.getCsrfHeader&&"function"==typeof window.getCsrfHeader)return window.getCsrfHeader();const e=document.querySelector('meta[name="_csrf_header"]');return e&&e.content?e.content:window.SVMESSENGER_CSRF&&window.SVMESSENGER_CSRF.headerName?window.SVMESSENGER_CSRF.headerName:"X-XSRF-TOKEN"})();t&&r?s.headers[r]=t:console.warn("‚ö†Ô∏è CSRF token not found - API call may fail");try{const t=await fetch(e,{...s,...n});if(!t.ok){const e=await t.json().catch(()=>({message:`HTTP ${t.status}: ${t.statusText}`}));throw new Error(e.message||"API request failed")}return t.json()}catch(a){throw console.error("API Error:",a),a}},y=async()=>C(`${b}/conversations`),j=async e=>C(`${b}/conversations/${e}`),w=async(e,n=null)=>C(`${b}/conversations/start`,{method:"POST",body:JSON.stringify({otherUserId:e,initialMessage:n})}),S=async e=>C(`${b}/conversations/${e}/read`,{method:"PUT"}),N=async()=>C(`${b}/messages/delivered`,{method:"PUT"}),k=async e=>C(`${b}/conversations/${e}/hide`,{method:"PUT"}),I=async(e,n=0,s=50)=>C(`${b}/messages/conversation/${e}?page=${n}&size=${s}`),E=async(e,n)=>C(`${b}/messages/send`,{method:"POST",body:JSON.stringify({conversationId:e,text:n,messageType:"TEXT"})}),T=async e=>C(`${b}/users/search?query=${encodeURIComponent(e||"")}`),M=async e=>{const n=e?`${b}/users/following?query=${encodeURIComponent(e)}`:`${b}/users/following`;return C(n)},A=async()=>C(`${b}/unread-count`),L=async(e,n)=>C(`${b}/call/token`,{method:"POST",body:JSON.stringify({conversationId:e,otherUserId:n})}),R=async e=>C(`${b}/conversations/${e}/call-history`),U=async(e,n)=>C(`${b}/translate-and-save`,{method:"POST",body:JSON.stringify({messageId:e,targetLanguage:n})}),z=e.createContext(null),D=()=>{const n=e.useContext(z);if(!n)throw new Error("useMessages must be used within MessagesProvider");return n},O=({children:s,currentUser:t})=>{const[r,o]=e.useState([]),[i,l]=e.useState({}),[c,d]=e.useState({}),[m,u]=e.useState(!1),[h,p]=e.useState({}),[g,v]=e.useState({}),[x,f]=e.useState({}),[b,C]=e.useState(0),[T,M]=e.useState(!1),L=e.useRef({}),U=e.useRef(null),D=e.useRef(r),O=e.useRef(i),_=e.useRef(new Set),B=e.useRef(null);e.useEffect(()=>{if(!U.current){const e=new window.Audio("/svmessenger/sounds/s1.mp3");e.preload="auto",U.current=e}},[]),e.useEffect(()=>{D.current=r},[r]),e.useEffect(()=>{O.current=i},[i]);const $=e.useCallback(()=>{M(!0)},[]),H=e.useCallback(()=>{M(!1)},[]),P=e.useCallback(e=>{console.error("SVMessenger: WebSocket error",e)},[]),F=e.useCallback((e,n=[])=>{if(e&&"CALL_HISTORY_UPDATED"===e.type&&e.conversationId)return void(B.current&&B.current(e.conversationId));if(!(e&&e.id&&e.text&&e.conversationId&&e.sentAt))return;const s=`${e.id}-${e.conversationId}`;if(_.current.has(s))return;_.current.add(s),setTimeout(()=>{_.current.delete(s)},5e3),l(n=>{const s=(n[e.conversationId]||[]).filter(e=>e&&e.id&&e.text&&e.sentAt),t=s.findIndex(n=>n.id===e.id);if(-1!==t){const r=[...s];return r[t]={...r[t],...e},{...n,[e.conversationId]:r}}return{...n,[e.conversationId]:[...s,e]}}),o(n=>n.map(n=>n.id===e.conversationId?{...n,lastMessage:e.text,lastMessageTime:e.sentAt}:n));const t=n.find(n=>n.conversation.id===e.conversationId),a=t&&!t.isMinimized,i=t&&t.isMinimized;if(a);else if(i)o(n=>{const s=n.map(n=>n.id===e.conversationId?{...n,unreadCount:(n.unreadCount||0)+1}:n),t=s.reduce((e,n)=>e+(n.unreadCount||0),0);return C(t),s});else{r.some(n=>n.id===e.conversationId)?o(n=>{const s=n.map(n=>n.id===e.conversationId?{...n,unreadCount:(n.unreadCount||0)+1}:n),t=s.reduce((e,n)=>e+(n.unreadCount||0),0);return C(t),s}):j(e.conversationId).then(e=>{e&&o(n=>{const s=n.some(n=>n.id===e.id)?n.map(n=>n.id===e.id?{...n,unreadCount:(n.unreadCount||0)+1}:n):[{...e,unreadCount:(e.unreadCount||0)+1},...n],t=s.reduce((e,n)=>e+(n.unreadCount||0),0);return C(t),s})}).catch(e=>{console.error("Failed to fetch conversation:",e)}),te(),re(e)}},[r]),V=e.useCallback(e=>{const{conversationId:n,userId:s,isTyping:t}=e;t?(f(e=>({...e,[n]:s})),L.current[n]&&clearTimeout(L.current[n]),L.current[n]=setTimeout(()=>{f(e=>{const s={...e};return delete s[n],s})},3e3)):f(e=>{const s={...e};return delete s[n],s})},[]),W=e.useCallback(e=>{if(!e)return;const{type:n,conversationId:s,messageId:r,readAt:a}=e;"BULK_READ"===n?(l(e=>({...e,[s]:(e[s]||[]).filter(e=>e&&e.id&&e.text&&e.sentAt).map(e=>e.senderId===t.id?{...e,isRead:!0,readAt:e.readAt||a}:e)})),o(e=>{const n=e.map(e=>e.id===s?{...e,unreadCount:0}:e),t=n.reduce((e,n)=>e+(n.unreadCount||0),0);return C(t),n})):r&&(l(e=>({...e,[s]:(e[s]||[]).filter(e=>e&&e.id&&e.text&&e.sentAt).map(e=>e.id===r&&e.senderId===t.id?{...e,isRead:!0,readAt:a}:e)})),o(e=>{const n=e.map(e=>e.id===s?{...e,unreadCount:Math.max(0,(e.unreadCount||0)-1)}:e),t=n.reduce((e,n)=>e+(n.unreadCount||0),0);return C(t),n}))},[t]),q=e.useCallback(e=>{if("BULK_DELIVERY"===e.type){const{conversationIds:n,deliveredAt:s}=e;l(e=>{const r={...e};return n.forEach(e=>{r[e]&&(r[e]=r[e].filter(e=>e&&e.id&&e.text&&e.sentAt).map(e=>({...e,isDelivered:!0,deliveredAt:e.senderId!==t.id?s:e.deliveredAt})))}),r})}else{const{conversationId:n,messageId:s,deliveredAt:t}=e;l(e=>({...e,[n]:(e[n]||[]).filter(e=>e&&e.id&&e.text&&e.sentAt).map(e=>e.id===s?{...e,isDelivered:!0,deliveredAt:t}:e)}))}},[t]),J=e.useCallback(e=>{const{userId:n,isOnline:s}=e;o(e=>e.map(e=>e.otherUser.id===n?{...e,otherUser:{...e.otherUser,isOnline:s}}:e))},[]),K=e.useCallback(async()=>{if(null==t?void 0:t.isAuthenticated){u(!0);try{const n=await y();o(n);const s=n.reduce((e,n)=>e+(n.unreadCount||0),0);C(s);try{await N()}catch(e){}}catch(e){console.error("Failed to load conversations:",e)}finally{u(!1)}}},[]),G=e.useCallback(async(e,n=0,s=50)=>{p(n=>({...n,[e]:!0}));try{const t=await I(e,n,s),r=t&&t.content&&Array.isArray(t.content)?t.content:Array.isArray(t)?t:[],a=[...r].reverse().sort((e,n)=>{if(!e||!n)return 0;return(e.sentAt?new Date(e.sentAt).getTime():0)-(n.sentAt?new Date(n.sentAt).getTime():0)});l(s=>{const t=s[e]||[];if(0===n){const n=new Set;a.forEach(e=>{e&&e.id&&n.add(e.id)});const r=t.filter(e=>e&&e.id&&!n.has(e.id)),o=[...a,...r],i=new Map;o.forEach(e=>{e&&e.id&&e.text&&e.sentAt&&i.set(e.id,e)});const l=Array.from(i.values()).sort((e,n)=>(e.sentAt?new Date(e.sentAt).getTime():0)-(n.sentAt?new Date(n.sentAt).getTime():0));return{...s,[e]:l}}{const n=new Set;t.forEach(e=>{e&&e.id&&n.add(e.id)});const r=[...a.filter(e=>e&&e.id&&!n.has(e.id)),...t],o=new Map;r.forEach(e=>{e&&e.id&&e.text&&e.sentAt&&o.set(e.id,e)});const i=Array.from(o.values()).sort((e,n)=>(e.sentAt?new Date(e.sentAt).getTime():0)-(n.sentAt?new Date(n.sentAt).getTime():0));return{...s,[e]:i}}})}catch(t){console.error("Failed to load messages:",t)}finally{p(n=>({...n,[e]:!1}))}},[]),Y=e.useCallback(async(e,n)=>{if(n.trim()&&T)try{await E(e,n.trim())}catch(s){console.error("Failed to send message:",s),alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ. –ú–æ–ª—è –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.")}},[T]),Q=e.useCallback(async e=>{try{const n=await w(e);if(!n||!n.id)throw console.error("Invalid conversation from API",n),new Error("Invalid conversation returned from API");return o(e=>e.some(e=>e.id===n.id)?e:[n,...e]),n}catch(n){throw console.error("Failed to start conversation:",n),alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä."),n}},[]),X=e.useCallback(async e=>{try{await S(e),o(n=>{const s=n.map(n=>n.id===e?{...n,unreadCount:0}:n),t=s.reduce((e,n)=>e+(n.unreadCount||0),0);return C(t),s}),l(n=>({...n,[e]:(n[e]||[]).filter(e=>e&&e.id&&e.text&&e.sentAt).map(e=>({...e,isRead:e.senderId!==t.id||e.isRead,readAt:e.senderId===t.id||e.isRead?e.readAt:(new Date).toISOString()}))}))}catch(n){console.error("Failed to mark as read:",n)}},[t]),Z=e.useCallback(async()=>{if(null==t?void 0:t.isAuthenticated)try{const e=await A();C(e.count)}catch(e){console.error("Failed to load unread count:",e)}},[]),ee=e.useCallback((e,n)=>{T&&a.sendTypingStatus(e,n)},[T]),ne=e.useCallback(async e=>{try{(await k(e)).success&&o(n=>n.filter(n=>n.id!==e))}catch(n){console.error("Failed to hide conversation:",n),alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞. –ú–æ–ª—è –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.")}},[]),se=e.useCallback(async e=>{var n;if(null!=e){v(n=>({...n,[e]:!0}));try{const n=await R(e);d(s=>({...s,[e]:Array.isArray(n)?n:[]}))}catch(s){console.error("‚ùå [MessagesContext] Failed to load call history:",s),console.error("‚ùå [MessagesContext] Error details:",(null==(n=s.response)?void 0:n.data)||s.message),d(n=>({...n,[e]:[]}))}finally{v(n=>({...n,[e]:!1}))}}},[]);e.useEffect(()=>{B.current=se},[se]);const te=()=>{U.current&&(U.current.currentTime=0,U.current.play().catch(()=>{}))},re=e=>{if("Notification"in window&&"granted"===Notification.permission)try{new Notification(`–ù–æ–≤–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –æ—Ç ${e.senderUsername}`,{body:e.text.substring(0,100),icon:e.senderImageUrl||"/images/default-avatar.png",badge:"/images/svmessenger-icon.png",tag:`svmessenger-${e.conversationId}`,requireInteraction:!1})}catch(n){console.error("Error showing notification:",n)}};e.useEffect(()=>{(null==t?void 0:t.isAuthenticated)&&(K(),Z(),"Notification"in window&&"default"===Notification.permission&&Notification.requestPermission().then(e=>{}))},[t,K,Z]);const ae={currentUser:t,conversations:r,messagesByConversation:i,callHistoryByConversation:c,isLoadingConversations:m,loadingMessages:h,loadingCallHistory:g,typingUsers:x,totalUnreadCount:b,isWebSocketConnected:T,loadConversations:K,loadMessages:G,loadCallHistory:se,sendMessage:Y,startConversation:Q,markAsRead:X,sendTypingStatus:ee,removeFromConversationList:ne,handleWebSocketConnect:$,handleWebSocketDisconnect:H,handleWebSocketError:P,handleNewMessage:F,handleTypingStatus:V,handleReadReceipt:W,handleDeliveryReceipt:q,handleOnlineStatus:J,conversationsRef:D,messagesByConversationRef:O};return n.jsx(z.Provider,{value:ae,children:s})},_=e.createContext(null),B=()=>{const n=e.useContext(_);if(!n)throw new Error("useCall must be used within CallProvider");return n},$=({children:s,currentUser:t})=>{const{conversations:r,conversationsRef:i}=D(),[l,c]=e.useState(null),[d,m]=e.useState("idle"),[u,h]=e.useState(null),[p,g]=e.useState(null),[v,x]=e.useState(null),f=e.useRef(null),b=e.useRef(!1),C=e.useRef(!1),[y,j]=e.useState(!1),[S,N]=e.useState("call"),[k,I]=e.useState(null),E=e.useRef(null),T=e.useRef(null),M=e.useRef(null),A=e.useRef("idle");e.useEffect(()=>{A.current=d},[d]);const R=e.useCallback(e=>`${window.location.origin}/svmessenger/call-window.html?${new URLSearchParams({token:e.token,roomName:e.roomName,conversationId:e.conversationId.toString(),otherUserId:e.otherUserId.toString(),otherUserName:encodeURIComponent(e.otherUserName||""),otherUserAvatar:encodeURIComponent(e.otherUserAvatar||""),currentUserId:e.currentUserId.toString(),currentUserName:encodeURIComponent(e.currentUserName||""),currentUserAvatar:encodeURIComponent(e.currentUserAvatar||""),callType:e.callType||"voice",callState:e.callState||"outgoing"}).toString()}`,[]),U=e.useCallback(async(e,n,s)=>{var r,o,i;try{const d=await L(e,n);g(d.token);try{window.__sv_livekit_token=d.token,window.liveKitToken=d.token}catch(l){}const u={conversationId:e,otherUserId:n,roomName:d.roomName,conversation:s,startTime:new Date,isIncoming:!1};b.current=!1,C.current=!1,c(u),m("outgoing");const p=R({token:d.token,roomName:d.roomName,conversationId:e,otherUserId:n,otherUserId:n,otherUserName:(null==(r=s.otherUser)?void 0:r.realName)||(null==(o=s.otherUser)?void 0:o.username)||"–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª",otherUserAvatar:(null==(i=s.otherUser)?void 0:i.imageUrl)||"",currentUserId:t.id,currentUserName:t.realName||t.username,currentUserAvatar:t.imageUrl||"",callType:"voice",callState:"outgoing"}),v=window.open(p,"svmessenger-call","width=420,height=650,resizable=yes,scrollbars=no,menubar=no,toolbar=no,location=no,status=no,titlebar=no");v&&(h(v),M.current&&clearInterval(M.current),M.current=setInterval(()=>{v.closed&&(M.current&&(clearInterval(M.current),M.current=null),h(null),$())},500));const x={eventType:"CALL_REQUEST",conversationId:e,callerId:t.id,receiverId:n,roomName:d.roomName,timestamp:(new Date).toISOString(),callerName:t.realName||t.username,callerAvatar:t.imageUrl};a.sendCallSignal(x)}catch(d){console.error("Failed to proceed with call start:",d),m("idle")}},[t,R]),z=e.useCallback(async(e,n,s=null)=>{try{let a=s;if(a||(a=i.current.find(n=>n.id===e)),!a)throw new Error("Conversation not found");let l=null,c=!1;try{if(l=localStorage.getItem("svmessenger-audio-video-settings"),l||(l=localStorage.getItem("svmessenger-audio-settings")),l)try{const e=JSON.parse(l);c=!(!e.microphone||!e.speaker)}catch(t){c=!1}}catch(r){const e=o.getSelectedDevices();e.microphone&&e.speaker&&(c=!0,l=JSON.stringify({microphone:e.microphone,speaker:e.speaker,camera:e.camera||null,micVolume:75,speakerVolume:80}))}if(c){const s=JSON.parse(l);s.microphone&&await o.setMicrophone(s.microphone),s.speaker&&await o.setSpeaker(s.speaker),s.camera&&(o.selectedCamera=s.camera),await U(e,n,a)}else I({type:"start",data:{conversationId:e,otherUserId:n,conversation:a}}),j(!0)}catch(a){console.error("Failed to start call:",a),m("idle")}},[t,i,U]),O=e.useCallback(async()=>{var e,n,s,r,o,i;console.log("‚ö° [CallContext] proceedWithCallAccept STARTED");try{const c=l.roomName;if(console.log("‚ö° [CallContext] Room Name:",c),!c)throw new Error("Missing room name for call accept");console.log("‚ö° [CallContext] Requesting token for:",{conversationId:l.conversationId,otherUserId:l.otherUserId});const d=await L(l.conversationId,l.otherUserId);console.log("‚ö° [CallContext] Token received:",!!d.token),d.roomName!==c&&(console.warn("‚ö° [CallContext] Room name mismatch!",{expected:c,received:d.roomName}),d.roomName=c),g(d.token);const u={eventType:"CALL_ACCEPT",conversationId:l.conversationId,callerId:l.otherUserId,receiverId:t.id,roomName:c,timestamp:(new Date).toISOString()};console.log("‚ö° [CallContext] Sending CALL_ACCEPT signal"),a.sendCallSignal(u),b.current=!1,C.current=!1;const p=R({token:d.token,roomName:c,conversationId:l.conversationId,otherUserId:l.otherUserId,otherUserName:(null==(n=null==(e=l.conversation)?void 0:e.otherUser)?void 0:n.realName)||(null==(r=null==(s=l.conversation)?void 0:s.otherUser)?void 0:r.username)||"–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª",otherUserAvatar:(null==(i=null==(o=l.conversation)?void 0:o.otherUser)?void 0:i.imageUrl)||"",currentUserId:t.id,currentUserName:t.realName||t.username,currentUserAvatar:t.imageUrl||"",callType:"voice",callState:"connected"});console.log("‚ö° [CallContext] Opening popup window");const v=window.open(p,"svmessenger-call","width=420,height=650,resizable=yes,scrollbars=no,menubar=no,toolbar=no,location=no,status=no,titlebar=no");v?(console.log("‚ö° [CallContext] Popup opened successfully"),h(v),M.current&&clearInterval(M.current),M.current=setInterval(()=>{v.closed&&(console.log("‚ö° [CallContext] Popup closed detected by interval"),M.current&&(clearInterval(M.current),M.current=null),h(null),$())},500)):console.warn("‚ö° [CallContext] Popup failed to open (blocked?)"),T.current&&(T.current.pause(),T.current.currentTime=0,T.current=null),m("connected"),f.current||(f.current=new Date)}catch(c){console.error("‚ùå [CallContext] Failed to proceed with call accept:",c),$()}},[l,t,R]),B=e.useCallback(async()=>{try{let s=null,t=!1;try{if(s=localStorage.getItem("svmessenger-audio-video-settings"),s||(s=localStorage.getItem("svmessenger-audio-settings")),s)try{const e=JSON.parse(s);t=!(!e.microphone||!e.speaker)}catch(e){t=!1}}catch(n){const e=o.getSelectedDevices();e.microphone&&e.speaker&&(t=!0,s=JSON.stringify({microphone:e.microphone,speaker:e.speaker,camera:e.camera||null,micVolume:75,speakerVolume:80}))}if(t){const e=JSON.parse(s);e.microphone&&await o.setMicrophone(e.microphone),e.speaker&&await o.setSpeaker(e.speaker),e.camera&&(o.selectedCamera=e.camera),await O()}else I({type:"accept",data:{}}),j(!0)}catch(s){console.error("Failed to accept call:",s),$()}},[l,t,O]),$=e.useCallback(()=>{if(b.current)return h(e=>(e&&!e.closed&&e.close(),null)),m("idle"),g(null),x(null),void c(null);if(T.current&&(T.current.pause(),T.current.currentTime=0,T.current=null),M.current&&(clearInterval(M.current),M.current=null),h(e=>(e&&!e.closed&&e.close(),null)),E.current&&E.current.postMessage({type:"CALL_ENDED",data:{}}),l){const e=void 0!==l.isIncoming?!l.isIncoming:"outgoing"===A.current,n=new Date,s=f.current?new Date(f.current).toISOString():n.toISOString(),r=n.toISOString(),o=f.current&&n?Math.floor((n.getTime()-new Date(f.current).getTime())/1e3):null,i=C.current||"connected"===A.current||null!==o&&o>0;console.log("üìû [Web endCall] Determining connection status:",{hasEverConnected:C.current,currentState:A.current,durationSeconds:o,FINAL_DECISION:i});const c={eventType:"CALL_END",conversationId:l.conversationId,callerId:e?t.id:l.otherUserId,receiverId:e?l.otherUserId:t.id,roomName:l.roomName,timestamp:n.toISOString(),startTime:s,endTime:r,isVideoCall:!1,wasConnected:i};console.log("üìû [Web endCall] Sending CALL_END signal:",{conversationId:l.conversationId,callerId:c.callerId,receiverId:c.receiverId,startTime:s,endTime:r,durationSeconds:o,wasConnected:c.wasConnected}),b.current=!0,a.sendCallSignal(c),f.current=null}m("idle"),g(null),x(null),setTimeout(()=>{b.current=!1},5e3)},[t,l,d]),H=e.useCallback(()=>{T.current&&(T.current.pause(),T.current.currentTime=0,T.current=null);const e=(new Date).toISOString(),n={eventType:"CALL_REJECT",conversationId:l.conversationId,callerId:l.otherUserId,receiverId:t.id,roomName:l.roomName,timestamp:e,startTime:l.startTime?new Date(l.startTime).toISOString():e,endTime:e,isVideoCall:!1};a.sendCallSignal(n),E.current&&E.current.postMessage({type:"CALL_REJECTED",data:{conversationId:l.conversationId}}),c(null),m("idle"),g(null),x(null)},[l,t]),P=e.useCallback(async e=>{try{await o.connect(e.token,e.roomName),x(e.roomName),await new Promise(e=>setTimeout(e,500));let r=null;try{r=localStorage.getItem("svmessenger-audio-video-settings"),r||(r=localStorage.getItem("svmessenger-audio-settings"))}catch(n){const e=o.getSelectedDevices();e.microphone&&e.speaker&&(r=JSON.stringify({microphone:e.microphone,speaker:e.speaker,camera:e.camera||null,micVolume:75,speakerVolume:80}))}if(r)try{const e=JSON.parse(r);e.microphone&&await o.setMicrophone(e.microphone),e.speaker&&await o.setSpeaker(e.speaker),e.camera&&(o.selectedCamera=e.camera)}catch(s){}else try{o.room&&o.isConnected&&await o.room.localParticipant.setMicrophoneEnabled(!0)}catch(t){}}catch(t){throw console.error("Failed to connect to LiveKit:",t),t}},[]),F=e.useCallback(()=>{N("settings"),j(!0)},[]),V=e.useCallback(async e=>{if(j(!1),"settings"===S)N("call");else if(k){const{type:e,data:n}=k;I(null),"start"===e?await U(n.conversationId,n.otherUserId,n.conversation):"accept"===e&&await O()}},[S,k,U,O]),W=e.useCallback(()=>{j(!1),N("call"),I(null),"settings"!==S&&(m("idle"),c(null))},[S]),q=e.useRef(new Set),J=e.useCallback(async e=>{if("CALL_REQUEST"!==e.eventType&&"CALL_ACCEPT"!==e.eventType||!q.current.has(e.conversationId))switch(e.eventType){case"TEST_SIGNAL":break;case"CALL_REQUEST":if(e.receiverId===t.id){let s=r.find(n=>n.id===e.conversationId);if(!s)try{const n=await w(e.callerId);n&&(s=n)}catch(n){console.error("Failed to load/create conversation:",n)}if(q.current.has(e.conversationId))return void console.log("üõë [CallContext] Aborting CALL_REQUEST after await - Call was cancelled");if(s){const t={conversationId:e.conversationId,otherUserId:e.callerId,roomName:e.roomName,conversation:s,startTime:new Date,isIncoming:!0};b.current=!1,C.current=!1,c(t),m("incoming");try{T.current&&(T.current.pause(),T.current.currentTime=0,T.current=null);const e=new Audio("/svmessenger/sounds/IncomingCall.mp3");e.loop=!0,e.volume=.7,e.preload="auto",T.current=e;const n=e.play();void 0!==n&&n.catch(e=>{})}catch(n){console.error("‚ùå Failed to play incoming call sound:",n)}document.hidden&&"Notification"in window&&"granted"===Notification.permission&&new Notification("Incoming Call",{body:`${s.otherUser.realName||s.otherUser.username} is calling you`,icon:s.otherUser.imageUrl||"/images/default-avatar.png"})}}break;case"CALL_ACCEPT":f.current||(f.current=new Date,console.log("üìû [CallContext] Call start time set on CALL_ACCEPT:",f.current.toISOString())),C.current=!0,c(n=>(m(s=>{const r=n&&n.conversationId===e.conversationId,a=e.callerId===t.id,o=e.receiverId===t.id;if(a&&("outgoing"===s||"idle"===s&&null!==u)&&(r||e.roomName)){if(!n&&e.roomName){const n={conversationId:e.conversationId,otherUserId:e.receiverId,roomName:e.roomName,conversation:null};setTimeout(()=>{c(n)},0)}return E.current&&E.current.postMessage({type:"CALL_ACCEPTED",data:{conversationId:e.conversationId,roomName:e.roomName}}),"connected"}if(o&&"connected"===s&&r)return s;if(o&&"incoming"===s&&r){const s=p||window.__sv_livekit_token||window.liveKitToken||null,t=e.roomName||(null==n?void 0:n.roomName);return s&&t&&P({token:s,roomName:t}).catch(e=>{console.error("‚ùå Failed to connect receiver to LiveKit:",e)}),"connected"}return s}),n));break;case"CALL_REJECT":T.current&&(T.current.pause(),T.current.currentTime=0,T.current=null),E.current&&E.current.postMessage({type:"CALL_REJECTED",data:{conversationId:e.conversationId}}),"outgoing"!==d&&"incoming"!==d||(c(null),m("idle"),g(null),x(null));break;case"CALL_CANCEL":console.log("üìû [CallContext] Received CALL_CANCEL signal",e),q.current.add(e.conversationId),setTimeout(()=>{q.current.delete(e.conversationId)},5e3),T.current&&(console.log("üìû [CallContext] Stopping incoming call sound"),T.current.pause(),T.current.currentTime=0,T.current=null),E.current&&(console.log("üìû [CallContext] Broadcasting CALL_CANCELLED to popup"),E.current.postMessage({type:"CALL_CANCELLED",data:{conversationId:e.conversationId}})),c(n=>{const s=n&&n.conversationId==e.conversationId;return console.log("üìû [CallContext] CALL_CANCEL check:",{currentId:null==n?void 0:n.conversationId,signalId:e.conversationId,shouldClear:s}),s?(g(null),x(null),m("idle"),null):n}),"incoming"!==d&&"idle"!==d||(c(null),m("idle"),g(null),x(null),console.log("üìû [CallContext] Incoming call CANCELLED by caller - Cleared State"),"incoming"===d&&document.hidden&&"Notification"in window&&"granted"===Notification.permission&&new Notification("Missed Call",{body:`Call from ${e.callerName||"Unknown"} was cancelled`,icon:"/images/default-avatar.png"}));break;case"CALL_END":q.current.add(e.conversationId),setTimeout(()=>{q.current.delete(e.conversationId)},5e3),T.current&&(T.current.pause(),T.current.currentTime=0,T.current=null),c(n=>(m(s=>{const t=n&&n.conversationId==e.conversationId;return console.log("üìû [CallContext] CALL_END check:",{currentId:null==n?void 0:n.conversationId,signalId:e.conversationId,isMatch:t}),"idle"!==s&&t?(T.current&&(T.current.pause(),T.current.currentTime=0,T.current=null),E.current&&(E.current.postMessage({type:"CALL_ENDED",data:{conversationId:e.conversationId}}),E.current.postMessage({type:"CLOSE_POPUP"})),o.disconnect(),"idle"):t?(o.disconnect(),"idle"):s}),n&&n.conversationId==e.conversationId?(g(null),x(null),null):n))}else console.log("üõë [CallContext] Ignoring signal for cancelled conversation:",e.conversationId)},[d,t,p,P,r,u]);e.useEffect(()=>(E.current=new BroadcastChannel("svmessenger-call"),E.current.onmessage=e=>{const{type:n,data:s,message:t}=e.data;switch(n){case"POPUP_LOG":break;case"CALL_START_TIME":s&&s.startTime&&(f.current=new Date(s.startTime),console.log("üìû [CallContext] Call start time synced from popup:",f.current.toISOString()),m("connected"));break;case"CALL_ENDED_FROM_POPUP":console.log("üìû CALL_ENDED_FROM_POPUP received - call was ended from popup"),b.current=!0,M.current&&(clearInterval(M.current),M.current=null,console.log("üõë [CallContext] Cleared popup check interval on BROADCAST")),m("idle"),c(null),h(null)}},()=>{E.current&&E.current.close()}),[]);const K={currentCall:l,callState:d,showDeviceSelector:y,deviceSelectorMode:S,callWindowRef:u,liveKitToken:p,liveKitRoom:v,startCall:z,acceptCall:B,rejectCall:H,endCall:$,connectToLiveKit:P,openAudioSettings:F,handleDeviceSelectorComplete:V,handleDeviceSelectorCancel:W,handleCallSignal:J};return n.jsx(_.Provider,{value:K,children:s})},H=e.createContext(null),P=()=>{const n=e.useContext(H);if(!n)throw new Error("useUI must be used within UIProvider");return n},F=({children:s,currentUser:t})=>{const{conversations:r,conversationsRef:o,messagesByConversation:i,messagesByConversationRef:l,loadMessages:c,startConversation:d}=D(),[m,u]=e.useState([]),[h,p]=e.useState(!1),[g,v]=e.useState(!1),[x,f]=e.useState(!1),b=e.useRef(1e3),C=e.useRef(m);e.useEffect(()=>{C.current=m},[m]);const y=e.useCallback(()=>{p(!0),v(!1)},[]),w=e.useCallback(()=>{p(!1),v(!1)},[]),S=e.useCallback(()=>{v(!0)},[]),N=e.useCallback(()=>{v(!1)},[]),k=e.useCallback(()=>{f(!0)},[]),I=e.useCallback(()=>{f(!1)},[]),E=e.useCallback(()=>{const e=window.innerWidth,n=window.innerHeight,s=30*m.filter(e=>!e.isMinimized).length;return{x:Math.max(50,(e-400)/2+s),y:Math.max(50,(n-600)/2+s)}},[m]),T=e.useCallback((e,n=null)=>{var s;let r=n||o.current.find(n=>n.id===e);if(r||(r=null==(s=C.current.find(n=>n.conversation.id===e))?void 0:s.conversation),!r)return void j(e).then(n=>{n&&setTimeout(()=>T(e),100)}).catch(e=>{console.error("Failed to fetch conversation:",e)});const i=C.current.find(n=>n.conversation.id===e);if(i)return void(i.isMinimized?L(e):R(e));const d=o.current.find(n=>n.id===e),m={id:e,conversation:d||r,isMinimized:!1,position:E(),zIndex:b.current++};u(e=>[...e,m]);const h=r.unreadCount>0;c(e,0,h?200:50);(l.current[e]||[]).some(e=>e.senderId!==t.id&&!e.isRead)&&a.sendRead(e),w()},[t,o,C,l,c,E,w]),M=e.useCallback(e=>{u(n=>n.filter(n=>n.conversation.id!==e))},[]),A=e.useCallback(e=>{u(n=>n.map(n=>n.conversation.id===e?{...n,isMinimized:!0}:n))},[]),L=e.useCallback(e=>{u(n=>n.map(n=>n.conversation.id===e?{...n,isMinimized:!1,zIndex:b.current++}:n));(i[e]||[]).some(e=>e.senderId!==t.id&&!e.isRead)&&a.sendRead(e)},[i,t]),R=e.useCallback(e=>{u(n=>n.map(n=>n.conversation.id===e?{...n,zIndex:b.current++}:n))},[]),U=e.useCallback((e,n)=>{u(s=>s.map(s=>s.conversation.id===e?{...s,position:n}:s))},[]);e.useEffect(()=>((()=>{try{const e=async e=>{const n=await d(e);return setTimeout(()=>{T(n.id)},150),n},n=async e=>{try{const n=await d(e);return n&&n.id?(setTimeout(()=>{try{T(n.id)}catch(e){console.error("Error in openChat",e)}},150),n):void console.error("Invalid conversation returned",n)}catch(n){throw console.error("Error",n),n}};window.SVMessenger={startConversation:e,startConversationReact:n,openChat:T,openChatList:y,openSearch:S,openDownloadModal:k}}catch(e){console.error("SVMessenger: Error exposing global API:",e)}})(),()=>{window.SVMessenger&&delete window.SVMessenger}),[T,y,S,d,k]);const z={activeChats:m,isChatListOpen:h,isSearchOpen:g,openChatList:y,closeChatList:w,openSearch:S,closeSearch:N,openChat:T,closeChat:M,minimizeChat:A,restoreChat:L,bringToFront:R,updateChatPosition:U,isDownloadModalOpen:x,openDownloadModal:k,closeDownloadModal:I,activeChatsRef:C};return n.jsx(H.Provider,{value:z,children:s})},V=()=>{const n=D(),s=B(),t=P(),r=e.useRef(t.activeChats),o=e.useRef(!1);return e.useEffect(()=>{r.current=t.activeChats},[t.activeChats]),e.useEffect(()=>{var e;if(!(null==(e=window.SVMESSENGER_USER_DATA)?void 0:e.isAuthenticated))return;if(o.current)return;o.current=!0;return a.connect({onConnect:()=>{var e;return null==(e=n.handleWebSocketConnect)?void 0:e.call(n)},onDisconnect:()=>{var e;return null==(e=n.handleWebSocketDisconnect)?void 0:e.call(n)},onError:e=>{var s;return null==(s=n.handleWebSocketError)?void 0:s.call(n,e)},onNewMessage:e=>{n.handleNewMessage(e,r.current)},onTypingStatus:n.handleTypingStatus,onReadReceipt:n.handleReadReceipt,onDeliveryReceipt:n.handleDeliveryReceipt,onOnlineStatus:n.handleOnlineStatus,onCallSignal:s.handleCallSignal}),()=>{o.current=!1,a.disconnect()}},[]),e.useEffect(()=>{a.updateCallSignalHandler(s.handleCallSignal)},[s.handleCallSignal]),e.useEffect(()=>(t.activeChats.forEach(e=>{a.subscribeToTyping(e.conversation.id,n.handleTypingStatus)}),()=>{t.activeChats.forEach(e=>{a.unsubscribeFromTyping(e.conversation.id)})}),[t.activeChats.map(e=>e.id).join(",")]),null};e.createContext(null);const W=()=>{const e=D(),n=B(),s=P();return{currentUser:e.currentUser,conversations:e.conversations,messagesByConversation:e.messagesByConversation,callHistoryByConversation:e.callHistoryByConversation,isLoadingConversations:e.isLoadingConversations,loadingMessages:e.loadingMessages,loadingCallHistory:e.loadingCallHistory,typingUsers:e.typingUsers,totalUnreadCount:e.totalUnreadCount,isWebSocketConnected:e.isWebSocketConnected,loadConversations:e.loadConversations,loadMessages:e.loadMessages,loadCallHistory:e.loadCallHistory,sendMessage:e.sendMessage,startConversation:e.startConversation,markAsRead:e.markAsRead,sendTypingStatus:e.sendTypingStatus,removeFromConversationList:e.removeFromConversationList,currentCall:n.currentCall,callState:n.callState,showDeviceSelector:n.showDeviceSelector,deviceSelectorMode:n.deviceSelectorMode,callWindowRef:n.callWindowRef,liveKitToken:n.liveKitToken,liveKitRoom:n.liveKitRoom,startCall:n.startCall,acceptCall:n.acceptCall,rejectCall:n.rejectCall,endCall:n.endCall,connectToLiveKit:n.connectToLiveKit,openAudioSettings:n.openAudioSettings,handleDeviceSelectorComplete:n.handleDeviceSelectorComplete,handleDeviceSelectorCancel:n.handleDeviceSelectorCancel,activeChats:s.activeChats,isChatListOpen:s.isChatListOpen,isSearchOpen:s.isSearchOpen,openChatList:s.openChatList,closeChatList:s.closeChatList,openSearch:s.openSearch,closeSearch:s.closeSearch,openChat:s.openChat,closeChat:s.closeChat,minimizeChat:s.minimizeChat,restoreChat:s.restoreChat,bringToFront:s.bringToFront,updateChatPosition:s.updateChatPosition,isDownloadModalOpen:s.isDownloadModalOpen,openDownloadModal:s.openDownloadModal,closeDownloadModal:s.closeDownloadModal}},q=({children:e,userData:s})=>n.jsx(O,{currentUser:s,children:n.jsx($,{currentUser:s,children:n.jsxs(F,{currentUser:s,children:[n.jsx(V,{}),e]})})}),J=e=>{if(!e)return"";try{const n="string"==typeof e?h(e):new Date(e),s=new Date-n,t=Math.floor(s/6e4),r=Math.floor(s/36e5),a=Math.floor(s/864e5);return t<1?"–°–µ–≥–∞":t<60?`${t} –º–∏–Ω`:r<24&&p(n)?`${r} —á`:g(n)?"–í—á–µ—Ä–∞":a<7?`${a} –¥`:v(n,"d MMM",{locale:x})}catch(n){return console.error("Error formatting date:",n),""}},K=e=>{if(!e)return"";try{const n="string"==typeof e?h(e):new Date(e);return p(n)?"–î–Ω–µ—Å":g(n)?"–í—á–µ—Ä–∞":v(n,"d MMMM yyyy",{locale:x})}catch(n){return console.error("Error formatting date separator:",n),""}},G=e=>{if(!e)return"";try{const n="string"==typeof e?h(e):new Date(e);return v(n,"HH:mm")}catch(n){return console.error("Error formatting message time:",n),""}},Y=({conversation:e})=>{var s;const{openChat:t,removeFromConversationList:r,activeChats:a}=W(),o=a.some(n=>n.conversation.id===e.id&&!n.isMinimized);return n.jsxs("div",{className:"svmessenger-conversation-item "+(o?"active":""),onClick:()=>{t(e.id)},children:[n.jsx("button",{className:"svmessenger-conversation-remove",onClick:n=>{n.stopPropagation(),r&&r(e.id)},title:"–ü—Ä–µ–º–∞—Ö–Ω–∏ –æ—Ç –ø–∞–Ω–µ–ª–∞",children:n.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})}),n.jsxs("div",{className:"svmessenger-conversation-avatar",children:[n.jsx("img",{src:e.otherUser.imageUrl||"/images/default-avatar.png",alt:e.otherUser.username,onError:e=>{e.target.src="/images/default-avatar.png"}}),e.otherUser.isOnline&&n.jsx("div",{className:"svmessenger-online-indicator"})]}),n.jsxs("div",{className:"svmessenger-conversation-content",children:[n.jsxs("div",{className:"svmessenger-conversation-top-row",children:[n.jsx("h4",{className:"svmessenger-conversation-name",children:e.otherUser.realName||e.otherUser.username}),n.jsx("span",{className:"svmessenger-conversation-time",children:J(null==(s=e.lastMessage)?void 0:s.sentAt)})]}),n.jsxs("div",{className:"svmessenger-conversation-preview",children:[n.jsx("p",{className:"svmessenger-conversation-text",children:e.lastMessage?i(e.lastMessage.text,50):"–ù—è–º–∞ —Å—ä–æ–±—â–µ–Ω–∏—è"}),e.unreadCount>0&&n.jsx("span",{className:"svmessenger-conversation-unread",children:e.unreadCount>99?"99+":e.unreadCount})]})]})]})},Q=({onClose:s,onSearchClick:t})=>{const{conversations:r,isLoadingConversations:a,loadConversations:o}=W(),[i,l]=e.useState("");e.useEffect(()=>{o()},[o]);const c=r.filter(e=>{var n,s,t;if(!i)return!0;const r=i.toLowerCase();return e.otherUser.username.toLowerCase().includes(r)||(null==(n=e.otherUser.realName)?void 0:n.toLowerCase().includes(r))||(null==(t=null==(s=e.lastMessage)?void 0:s.text)?void 0:t.toLowerCase().includes(r))});return n.jsxs("div",{className:"svmessenger-conversation-list",children:[n.jsxs("div",{className:"svmessenger-conversation-header",children:[n.jsx("h3",{children:"SV Messenger"}),n.jsxs("div",{className:"svmessenger-conversation-actions",children:[n.jsx("button",{className:"svmessenger-search-btn",onClick:t,title:"–ù–æ–≤ —Ä–∞–∑–≥–æ–≤–æ—Ä",children:n.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"})})}),n.jsx("button",{className:"svmessenger-close-btn",onClick:s,title:"–ó–∞—Ç–≤–æ—Ä–∏",children:n.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]})]}),n.jsx("div",{className:"svmessenger-search-input",children:n.jsx("input",{type:"text",placeholder:"–¢—ä—Ä—Å–∏ –≤ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏—Ç–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∏...",value:i,onChange:e=>l(e.target.value)})}),n.jsx("div",{className:"svmessenger-conversations",children:a?n.jsxs("div",{className:"svmessenger-loading",children:[n.jsx("div",{className:"svmessenger-spinner"}),n.jsx("span",{children:"–ó–∞—Ä–µ–∂–¥–∞–Ω–µ..."})]}):0===c.length?n.jsx("div",{className:"svmessenger-empty",children:i?n.jsxs(n.Fragment,{children:[n.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"})}),n.jsx("p",{children:"–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∏"})]}):n.jsxs(n.Fragment,{children:[n.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"})}),n.jsx("p",{children:"–ù—è–º–∞ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∏"}),n.jsx("small",{children:"–ö–ª–∏–∫–Ω–µ—Ç–µ + –∑–∞ –¥–∞ –∑–∞–ø–æ—á–Ω–µ—Ç–µ –Ω–æ–≤ —Ä–∞–∑–≥–æ–≤–æ—Ä"})]})}):c.map(e=>n.jsx(Y,{conversation:e},e.id))})]})},X=({conversation:s,onClose:t,onMinimize:r,onOpenSearch:a,onCall:o,onOpenAudioSettings:i})=>{const[l,c]=e.useState(!1),d=e.useRef(null),{otherUser:m}=s;e.useEffect(()=>{const e=e=>{d.current&&!d.current.contains(e.target)&&c(!1)};return l&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[l]);return n.jsxs("div",{className:"svmessenger-chat-header",children:[n.jsxs("div",{className:"svmessenger-chat-user-info",children:[n.jsx("div",{className:"svmessenger-chat-avatar",children:m.imageUrl?n.jsx("img",{src:m.imageUrl,alt:m.realName||m.username}):n.jsx("div",{className:"svmessenger-chat-avatar-placeholder",children:(m.realName||m.username||"U").charAt(0).toUpperCase()})}),n.jsxs("div",{className:"svmessenger-chat-user-details",children:[n.jsx("div",{className:"svmessenger-chat-username",children:m.realName||m.username}),n.jsx("span",{className:"svmessenger-chat-status "+(m.isOnline?"online":"offline"),children:m.isOnline?"Online":"Offline"})]})]}),n.jsxs("div",{className:"svmessenger-chat-controls",children:[n.jsx("button",{className:"svmessenger-call-btn",onClick:o,title:"–ó–≤—ä–Ω–Ω–∏",style:{display:"flex",alignItems:"center",justifyContent:"center",width:"32px",height:"32px",border:"none",background:"none",color:"#9ca3af",borderRadius:"6px",cursor:"pointer",transition:"all 0.2s ease",marginLeft:"8px"},children:n.jsx("i",{className:"bi bi-telephone",style:{fontSize:"18px",color:"#ffffff"}})}),n.jsxs("div",{className:"svmessenger-chat-menu-container",ref:d,children:[n.jsx("button",{className:"svmessenger-chat-menu-btn",onClick:()=>c(!l),title:"–ü–æ–≤–µ—á–µ –æ–ø—Ü–∏–∏",children:n.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"})})}),l&&n.jsxs("div",{className:"svmessenger-chat-menu-dropdown",children:[n.jsxs("button",{onClick:()=>{c(!1),window.location.href=`/user/${m.username}`},className:"svmessenger-menu-item",children:[n.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"})}),"–ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞"]}),n.jsxs("button",{onClick:()=>{c(!1),a()},className:"svmessenger-menu-item",children:[n.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"})}),"–¢—ä—Ä—Å–∏ –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞..."]}),n.jsxs("button",{onClick:()=>{c(!1),i&&i()},className:"svmessenger-menu-item",children:[n.jsx("i",{className:"bi bi-gear-fill",style:{fontSize:"16px"}}),"–ù–∞—Å—Ç—Ä–æ–π–∫–∏"]}),n.jsxs("button",{onClick:()=>{c(!1),window.confirm("–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–æ–∑–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä?")},className:"svmessenger-menu-item svmessenger-menu-item-danger",children:[n.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"})}),"–ò–∑—Ç—Ä–∏–π —Ä–∞–∑–≥–æ–≤–æ—Ä–∞"]})]})]}),n.jsx("button",{className:"svmessenger-chat-close",onClick:t,title:"–ó–∞—Ç–≤–æ—Ä–∏",children:n.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]})]})},Z=({message:s,searchQuery:t=""})=>{const{currentUser:r}=W(),[a,o]=e.useState(!1),[i,d]=e.useState(s.translatedText||null),[m,u]=e.useState(null),h=e.useRef(null);if(e.useEffect(()=>{const e=e=>{h.current&&!h.current.contains(e.target)&&o(!1)};return a&&document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[a]),!s||!s.id||!s.text)return console.warn("SVMessageItem: Invalid message received",s),null;if(!r||!r.id)return null;const p=s.senderId===r.id,g=l(s.text),v=(e,n)=>{if(!n.trim())return c(e);const s=new RegExp(`(${n.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\\\$&")})`,"gi"),t=e.replace(s,'<mark class="search-highlight">$1</mark>');return c(t)};return n.jsxs("div",{className:"svmessenger-message-item "+(p?"own":"other"),children:[!p&&n.jsx("div",{className:"svmessenger-message-avatar",children:n.jsx("img",{src:s.senderImageUrl||"/images/default-avatar.png",alt:s.senderUsername,onError:e=>{e.target.src="/images/default-avatar.png"}})}),n.jsxs("div",{className:"svmessenger-message-content",children:[n.jsxs("div",{className:"svmessenger-message-bubble "+(g?"emoji-only":""),onClick:e=>{!p&&s.text&&s.text.length>0&&(o(!a),e.stopPropagation())},style:{cursor:"pointer",position:"relative"},children:[n.jsx("div",{className:"svmessenger-message-text",dangerouslySetInnerHTML:{__html:v(i||s.text,t)}}),m&&n.jsx("div",{style:{fontSize:"0.75em",color:"#9ca3af",marginTop:"4px",fontStyle:"italic"},children:"–ü—Ä–µ–≤–µ–∂–¥–∞ —Å–µ..."}),a&&n.jsxs("div",{ref:h,className:"svmessenger-translate-menu",style:{position:"absolute",top:"100%",left:p?"auto":"0",right:p?"0":"auto",marginTop:"4px",background:"#ffffff",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",zIndex:1e3,minWidth:"150px",overflow:"hidden"},onClick:e=>e.stopPropagation(),children:[n.jsx("div",{style:{padding:"8px 12px",fontSize:"0.75em",color:"#6b7280",borderBottom:"1px solid #e5e7eb",fontWeight:"500"},children:"üåê –ü—Ä–µ–≤–æ–¥"}),[{code:"bg",name:"–ë—ä–ª–≥–∞—Ä—Å–∫–∏"},{code:"en",name:"English"},{code:"de",name:"Deutsch"},{code:"el",name:"ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨"},{code:"tr",name:"T√ºrk√ße"}].map(e=>n.jsx("button",{onClick:()=>(async e=>{o(!1),u(e);try{const n=await U(s.id,e);n&&n.translatedText&&d(n.translatedText)}catch(n){console.error("Translation failed:",n)}finally{u(null)}})(e.code),style:{width:"100%",padding:"8px 12px",border:"none",background:"transparent",textAlign:"left",fontSize:"0.9em",cursor:"pointer",transition:"background 0.2s",color:"#374151"},onMouseEnter:e=>e.target.style.background="#f3f4f6",onMouseLeave:e=>e.target.style.background="transparent",children:e.name},e.code))]})]}),n.jsxs("div",{className:"svmessenger-message-meta",children:[n.jsxs("span",{className:"svmessenger-message-time-only",children:[new Date(s.sentAt).toLocaleDateString("bg-BG",{day:"2-digit",month:"2-digit"})," ",G(s.sentAt)]}),p&&n.jsx("div",{className:"svmessenger-message-read-status",children:p?s.isDelivered?s.isDelivered&&!s.isRead?n.jsxs("svg",{width:"18",height:"14",viewBox:"0 0 32 24",fill:"currentColor",className:"double-check-gray",children:[n.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"}),n.jsx("path",{d:"M17 16.17L12.83 12l-1.42 1.41L17 19 29 7l-1.41-1.41z"})]}):s.isDelivered&&s.isRead?n.jsxs("svg",{width:"18",height:"14",viewBox:"0 0 32 24",fill:"currentColor",className:"double-check-green",children:[n.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"}),n.jsx("path",{d:"M17 16.17L12.83 12l-1.42 1.41L17 19 29 7l-1.41-1.41z"})]}):null:n.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"currentColor",className:"single-check",children:n.jsx("path",{d:"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"})}):null})]})]})]})},ee=e=>{if(!e||e<0||isNaN(e))return"0:00";const n=Math.floor(e/3600),s=Math.floor(e%3600/60),t=e%60;return n>0?`${n}:${s.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`:`${s}:${t.toString().padStart(2,"0")}`},ne=e=>{const n=new Date(e),s=new Date,t=new Date(s.getFullYear(),s.getMonth(),s.getDate()),r=new Date(n.getFullYear(),n.getMonth(),n.getDate()),a=t.getTime()-r.getTime(),o=Math.floor(a/864e5);return 0===o?"–î–Ω–µ—Å":1===o?"–í—á–µ—Ä–∞":o<7?n.toLocaleDateString("bg-BG",{weekday:"long"}):n.toLocaleDateString("bg-BG",{day:"numeric",month:"short"})},se=({callHistory:e,currentUserId:s})=>{const t=e.callerId===s;let r,a;e.receiverId;let o="",i=!1,l=null;"ACCEPTED"===e.status?(e.durationSeconds&&e.durationSeconds>0?(o=ee(e.durationSeconds),r=`–†–∞–∑–≥–æ–≤–æ—Ä ${o}`):r="–†–∞–∑–≥–æ–≤–æ—Ä",a="#16a34a"):"REJECTED"===e.status?(r="–û—Ç–∫–∞–∑–∞–Ω–æ",a="#dc2626",i=!0,l=t?"right":"left"):t?(r="–ë–µ–∑ –æ—Ç–≥–æ–≤–æ—Ä",i=!0,l="right"):(r="–ü—Ä–æ–ø—É—Å–Ω–∞—Ç–æ",a="#ef4444",i=!0,l="left");const c=new Date(e.startTime).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit",hour12:!1}),d=ne(e.startTime);let m="",u="";if("ACCEPTED"===e.status&&e.endTime)try{const n=new Date(e.endTime);if(!isNaN(n.getTime())){const s=n.toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit",hour12:!1}),t=ne(e.endTime);s&&"Invalid Date"!==s&&!s.includes("Invalid")&&t&&"Invalid Date"!==t&&!t.includes("Invalid")&&(m=s,u=t)}}catch(g){m="",u=""}const h=()=>n.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:a,strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",style:{opacity:.7},children:n.jsx("path",{d:"M5 12h14M12 5l7 7-7 7"})}),p=()=>n.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:a,strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",style:{opacity:.7},children:n.jsx("path",{d:"M19 12H5M12 19l-7-7 7-7"})});return n.jsx("div",{className:"svmessenger-call-history-item",children:n.jsxs("div",{className:"svmessenger-call-history-content",children:[n.jsxs("div",{className:"svmessenger-call-history-row",children:[n.jsx("div",{className:"svmessenger-call-history-icon-container",children:e.isVideoCall?n.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:a,strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:n.jsx("path",{d:"M17 10l2-2v8l-2-2M14 6H4a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2z"})}):n.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:a,strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:n.jsx("path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.33L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.33-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"})})}),i&&l&&n.jsx("div",{className:"svmessenger-call-history-arrow-container",children:"right"===l?n.jsx(h,{}):n.jsx(p,{})}),n.jsx("span",{className:"svmessenger-call-history-type-text",style:{color:a},children:r}),n.jsxs("span",{className:"svmessenger-call-history-time-text",children:[" ‚Ä¢ ",d," ",c]})]}),"ACCEPTED"===e.status&&n.jsxs("div",{className:"svmessenger-call-history-accepted-details",children:[m&&u&&n.jsxs("div",{className:"svmessenger-call-history-detail-text",children:["–ü—Ä–∏–∫–ª—é—á–∏: ",u," ",m]}),e.durationSeconds&&e.durationSeconds>0&&n.jsxs("div",{className:"svmessenger-call-history-duration-text",children:["–ü—Ä–æ–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ—Å—Ç: ",ee(e.durationSeconds)]})]})]})})},te=({conversationId:e})=>{const{conversations:s,typingUsers:t}=W(),r=s.find(n=>n.id===e),a=t[e];if(!r||!a)return null;const o=r.otherUser;return n.jsxs("div",{className:"svmessenger-typing-indicator",children:[n.jsx("div",{className:"svmessenger-typing-avatar",children:n.jsx("img",{src:o.imageUrl||"/images/default-avatar.png",alt:o.username,onError:e=>{e.target.src="/images/default-avatar.png"}})}),n.jsxs("div",{className:"svmessenger-typing-content",children:[n.jsx("div",{className:"svmessenger-typing-bubble",children:n.jsxs("div",{className:"svmessenger-typing-dots",children:[n.jsx("span",{}),n.jsx("span",{}),n.jsx("span",{})]})}),n.jsxs("span",{className:"svmessenger-typing-text",children:[o.realName||o.username," –ø–∏—à–µ..."]})]})]})},re=({conversationId:s,searchQuery:t=""})=>{const{messagesByConversation:r,callHistoryByConversation:a,loadingMessages:o,loadingCallHistory:i,typingUsers:l,loadCallHistory:c,currentUser:u}=W(),p=Array.isArray(r[s])?r[s]:[],g=t.trim()?p.filter(e=>e.text&&e.text.toLowerCase().includes(t.toLowerCase())):p,x=Array.isArray(a[s])?a[s]:[],f=o[s]||!1,b=i[s]||!1,C=l[s],y=e.useRef(null),j=e.useRef(null);e.useEffect(()=>{s&&c(s)},[s,c]);e.useLayoutEffect(()=>{if(j.current&&(g.length>0||f)){const e=()=>{j.current&&(j.current.scrollTop=j.current.scrollHeight)};e(),setTimeout(e,10),setTimeout(e,50),setTimeout(e,100)}},[g.length,f]),console.log(`üìû [SVMessageThread] Processing: ${g.length} messages, ${x.length} call history entries`);const w=((e,n=[])=>{const s=[];if(e&&Array.isArray(e)&&e.forEach(e=>{e&&e.id&&e.sentAt&&s.push({type:"message",data:e,timestamp:e.sentAt})}),n&&Array.isArray(n)&&n.forEach(e=>{e&&e.id&&e.startTime&&s.push({type:"callHistory",data:e,timestamp:e.startTime})}),0===s.length)return[];s.sort((e,n)=>(e.timestamp?"string"==typeof e.timestamp?h(e.timestamp).getTime():new Date(e.timestamp).getTime():0)-(n.timestamp?"string"==typeof n.timestamp?h(n.timestamp).getTime():new Date(n.timestamp).getTime():0));const t=[];let r=null;return s.forEach(e=>{if(e&&e.timestamp)try{const n="string"==typeof e.timestamp?h(e.timestamp):new Date(e.timestamp),s=v(n,"yyyy-MM-dd");s!==r&&(t.push({type:"date",date:n,dateKey:s,formattedDate:K(n)}),r=s),"message"===e.type?t.push({type:"message",message:e.data}):"callHistory"===e.type&&t.push({type:"callHistory",callHistory:e.data})}catch(n){console.warn("Error processing item in groupMessagesByDate:",n,e)}}),t})(g,x);console.log(`üìû [SVMessageThread] Grouped items: ${w.length} total items (including date separators)`);const S=w.filter(e=>"callHistory"===e.type);return console.log(`üìû [SVMessageThread] Call history items in grouped: ${S.length}`),n.jsxs("div",{className:"svmessenger-message-thread",ref:j,children:[(f||b)&&n.jsx("div",{className:"svmessenger-loading-messages",children:n.jsx("div",{className:"svmessenger-spinner"})}),n.jsx("div",{className:"svmessenger-messages",children:w.map((e,s)=>{if("date"===e.type)return n.jsx("div",{className:"svmessenger-date-separator",children:n.jsx("span",{className:"svmessenger-date-separator-text",children:e.formattedDate})},`date-${e.dateKey}`);if("message"===e.type&&e.message&&e.message.id){w.length;return n.jsx("div",{ref:null,children:n.jsx(Z,{message:e.message,searchQuery:t})},`message-${e.message.id}`)}return"callHistory"===e.type&&e.callHistory&&e.callHistory.id?n.jsx("div",{children:n.jsx(se,{callHistory:e.callHistory,currentUserId:null==u?void 0:u.id})},`call-${e.callHistory.id}`):null})}),C&&n.jsx(te,{conversationId:s}),g.length>0&&!d(j.current)&&n.jsx("button",{className:"svmessenger-scroll-to-bottom",onClick:()=>m(j.current),title:"Scroll to bottom",children:n.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"})})}),n.jsx("div",{ref:y})]})},ae={search:"–¢—ä—Ä—Å–µ–Ω–µ",search_no_results_1:"–û, –Ω–µ!",search_no_results_2:"–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –µ–º–æ–¥–∂–∏—Ç–∞",pick:"–ò–∑–±–µ—Ä–∏ –µ–º–æ–¥–∂–∏",categories:{activity:"–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏",custom:"–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–∏",flags:"–ó–Ω–∞–º–µ–Ω–∞",foods:"–•—Ä–∞–Ω–∞ –∏ –Ω–∞–ø–∏—Ç–∫–∏",frequent:"–ß–µ—Å—Ç–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–∏",nature:"–ü—Ä–∏—Ä–æ–¥–∞",objects:"–û–±–µ–∫—Ç–∏",people:"–•–æ—Ä–∞",places:"–ú–µ—Å—Ç–∞",search:"–¢—ä—Ä—Å–µ–Ω–µ",smileys:"–£—Å–º–∏–≤–∫–∏",symbols:"–°–∏–º–≤–æ–ª–∏"},skins:{choose:"–ò–∑–±–µ—Ä–∏ —Ç–æ–Ω",1:"–°—Ç–∞–Ω–¥–∞—Ä—Ç–µ–Ω",2:"–°–≤–µ—Ç—ä–ª",3:"–°—Ä–µ–¥–Ω–æ —Å–≤–µ—Ç—ä–ª",4:"–°—Ä–µ–¥–µ–Ω",5:"–°—Ä–µ–¥–Ω–æ —Ç—ä–º–µ–Ω",6:"–¢—ä–º–µ–Ω"}},oe=({onEmojiSelect:t,onClose:r,show:a})=>{const o=e.useRef(null);return e.useEffect(()=>{const e=e=>{"Escape"===e.key&&a&&r()};if(a)return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[a,r]),a?n.jsxs("div",{className:"svmessenger-emoji-picker-wrapper",children:[n.jsx("div",{className:"svmessenger-emoji-picker-backdrop",onClick:r}),n.jsx("div",{className:"svmessenger-emoji-picker-container",children:n.jsx(s,{ref:o,data:f,onEmojiSelect:t,skinTonePosition:"search",previewPosition:"none",searchPosition:"bottom",theme:"light",i18n:ae,perLine:7,emojiSize:20,emojiButtonSize:28})})]}):null},ie=({conversationId:s})=>{const{sendMessage:t}=W(),[r,a]=e.useState(""),[o,i]=e.useState(!1),[l,c]=e.useState(!1),d=e.useRef(null),m=e.useRef(null),u=3e3,{handleTyping:h,stopTyping:p}=(()=>{const n=e.useRef(null),s=e.useRef(!1),t=()=>{n.current&&clearTimeout(n.current),s.current&&(s.current=!1)};return e.useEffect(()=>()=>{t()},[]),{handleTyping:()=>{s.current||(s.current=!0),n.current&&clearTimeout(n.current),n.current=setTimeout(()=>{s.current=!1},2e3)},stopTyping:t}})();e.useEffect(()=>{d.current&&d.current.focus()},[s]),e.useEffect(()=>{if(d.current){const e=d.current,n=40,s=120;e.style.height="auto";const t=Math.min(Math.max(e.scrollHeight,n),s);e.style.height=`${t}px`}},[r]);const g=e=>{e.preventDefault();const n=r.trim();if(n){if(n.length>u)return void alert("–°—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ –µ —Ç–≤—ä—Ä–¥–µ –¥—ä–ª–≥–æ (–º–∞–∫—Å–∏–º—É–º 3000 —Å–∏–º–≤–æ–ª–∞)");t(s,n),a(""),p(),d.current&&(d.current.style.height="40px")}};return n.jsxs("div",{className:"svmessenger-message-input",children:[n.jsxs("form",{onSubmit:g,className:"svmessenger-input-form",children:[n.jsxs("div",{className:"svmessenger-input-container",children:[n.jsx("button",{type:"button",className:"svmessenger-attach-btn",onClick:e=>{e.preventDefault()},title:"–ü—Ä–∏–∫–∞—á–∏ —Ñ–∞–π–ª",children:n.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"})})}),n.jsx("div",{className:"svmessenger-input-wrapper",children:n.jsx("textarea",{ref:d,className:"svmessenger-text-input",placeholder:"Aa",value:r,onChange:e=>{const n=e.target.value;a(n),n.trim()?h():p()},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),g(e))},onCompositionStart:()=>{i(!0)},onCompositionEnd:()=>{i(!1)},rows:1,maxLength:u})}),n.jsx("button",{ref:m,type:"button",className:"svmessenger-emoji-btn "+(l?"active":""),onClick:e=>{e.preventDefault(),c(!l)},title:"–ï–º–æ—Ç–∏–∫–æ–Ω–∏",children:n.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-3.5-9c.83 0 1.5-.67 1.5-1.5S9.33 8.5 8.5 8.5 7 9.17 7 10s.67 1.5 1.5 1.5zm7 0c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zm-3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"})})}),r.trim()?n.jsx("button",{type:"submit",className:"svmessenger-send-btn",title:"–ò–∑–ø—Ä–∞—Ç–∏ —Å—ä–æ–±—â–µ–Ω–∏–µ",children:n.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"})})}):n.jsx("button",{type:"button",className:"svmessenger-mic-btn",title:"–ì–ª–∞—Å–æ–≤–∞ –ø–æ—Ä—ä–∫–∞ (–ø–æ-–∫—ä—Å–Ω–æ)",disabled:!0,children:n.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"})})})]}),n.jsxs("div",{className:"svmessenger-input-helper",children:[n.jsx("span",{children:"–ù–∞—Ç–∏—Å–Ω–∏ Enter –∑–∞ –∏–∑–ø—Ä–∞—â–∞–Ω–µ ‚Ä¢ Shift+Enter –∑–∞ –Ω–æ–≤ —Ä–µ–¥"}),r.length>0&&n.jsxs("span",{className:"svmessenger-char-counter",style:{color:r.length>=2700?"#ef4444":r.length>=2500?"#f59e0b":"#6b7280"},children:[r.length,"/",u]})]})]}),n.jsx(oe,{show:l,onEmojiSelect:e=>{a(n=>n+e.native),c(!1),d.current&&d.current.focus()},onClose:()=>{c(!1)}})]})},le=({searchQuery:e,onSearchChange:s,onClose:t})=>n.jsxs("div",{className:"svmessenger-chat-search",children:[n.jsx("input",{type:"text",className:"svmessenger-chat-search-input",placeholder:"–¢—ä—Ä—Å–∏ –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞...",value:e,onChange:e=>s(e.target.value),autoFocus:!0}),n.jsx("button",{className:"svmessenger-chat-search-close",onClick:t,title:"–ó–∞—Ç–≤–æ—Ä–∏ —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ",children:"‚úï"})]}),ce=({chat:s})=>{const{closeChat:t,minimizeChat:r,bringToFront:a,updateChatPosition:o,markAsRead:i,messagesByConversation:l,currentUser:c,startCall:d,openAudioSettings:m}=W(),u=e.useRef(null),[h,p]=e.useState(!1),[g,v]=e.useState({x:0,y:0}),[x,f]=e.useState(!1),[b,C]=e.useState("");e.useEffect(()=>{s.isMinimized||a(s.conversation.id)},[]);const y=e.useCallback(()=>{if(!s.isMinimized){a(s.conversation.id);(l[s.conversation.id]||[]).some(e=>e.senderId!==c.id&&!e.isRead)&&i(s.conversation.id)}},[s.conversation.id,s.isMinimized,a,i,l,c]),j=e.useCallback(e=>{e.target.closest(".svmessenger-chat-header")&&(e.target.closest(".svmessenger-chat-controls")||(p(!0),v({x:e.clientX-s.position.x,y:e.clientY-s.position.y}),a(s.conversation.id)))},[s.position,s.conversation.id,a]);e.useEffect(()=>{if(!h)return;const e=e=>{const n=e.clientX-g.x,t=e.clientY-g.y,r=window.innerWidth-400,a=window.innerHeight-600,i=Math.max(0,Math.min(n,r)),l=Math.max(0,Math.min(t,a));o(s.conversation.id,{x:i,y:l})},n=()=>{p(!1)};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",n),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",n)}},[h,g,s.conversation.id,o]);const w={left:`${s.position.x}px`,top:`${s.position.y}px`,zIndex:s.zIndex,display:s.isMinimized?"none":"flex"};return n.jsxs("div",{ref:u,className:"svmessenger-chat-window "+(h?"dragging":""),style:w,onMouseDown:j,onClick:y,children:[n.jsx(X,{conversation:s.conversation,onClose:()=>{t(s.conversation.id)},onMinimize:()=>{r(s.conversation.id)},onOpenSearch:()=>{f(!0)},onCall:()=>{d(s.conversation.id,s.conversation.otherUser.id,s.conversation)},onOpenAudioSettings:()=>{console.log("üéµ Opening audio settings from chat menu"),m()}}),x&&n.jsx(le,{searchQuery:b,onSearchChange:e=>{C(e)},onClose:()=>{f(!1),C("")}}),n.jsx(re,{conversationId:s.conversation.id,searchQuery:b}),n.jsx(ie,{conversationId:s.conversation.id})]})},de=({onClose:s})=>{const{startConversation:t,openChat:r}=W(),[a,o]=e.useState(""),[i,l]=e.useState([]),[c,d]=e.useState([]),[m,h]=e.useState(!0),[p,g]=e.useState(!1),[v,x]=e.useState(!1);e.useEffect(()=>{(async()=>{h(!0);try{const e=await M("");l(e)}catch(e){console.error("Error loading following users:",e),l([])}finally{h(!1)}})()},[]);const f=e.useCallback(async e=>{const n=e.trim();if(!n||0===n.length)return x(!1),void d([]);if(n.length<2)return x(!1),void d([]);x(!0),g(!0);try{const e=await T(n);d(e)}catch(s){console.error("Search error:",s),d([])}finally{g(!1)}},[]),b=e.useCallback(u(e=>{f(e)},300),[f]),C=e.useCallback(async e=>{try{const n=await t(e.id);n&&n.id?(r(n.id,n),setTimeout(()=>{s()},100)):console.error("SVUserSearch: No conversation returned from startConversation")}catch(n){console.error("SVUserSearch: Failed to start conversation:",n)}},[t,r,s]);return n.jsxs("div",{className:"svmessenger-user-search",children:[n.jsxs("div",{className:"svmessenger-conversation-header",children:[n.jsx("h3",{children:"–ù–æ–≤ —Ä–∞–∑–≥–æ–≤–æ—Ä"}),n.jsx("button",{className:"svmessenger-close-btn",onClick:s,title:"–ó–∞—Ç–≤–æ—Ä–∏",children:n.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]}),n.jsxs("div",{className:"svmessenger-search-input",children:[n.jsx("input",{type:"text",placeholder:"–¢—ä—Ä—Å–∏ –≤—Å–∏—á–∫–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏...",value:a,onChange:e=>{const n=e.target.value;o(n),n.trim().length>=2?b(n):(x(!1),d([]))},autoFocus:!0}),p&&n.jsx("div",{className:"svmessenger-search-loading-indicator",children:n.jsx("div",{className:"svmessenger-spinner-small"})})]}),v&&n.jsxs("div",{className:"svmessenger-search-results-panel",style:{height:p?"120px":0===c.length?"150px":c.length<=6?72*c.length+70+"px":"502px",maxHeight:"502px"},children:[n.jsxs("div",{className:"svmessenger-search-section-header",children:[n.jsx("span",{children:"–†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç —Ç—ä—Ä—Å–µ–Ω–µ—Ç–æ"}),p&&n.jsx("span",{className:"svmessenger-search-count",children:"–¢—ä—Ä—Å–µ–Ω–µ..."}),!p&&c.length>0&&n.jsxs("span",{className:"svmessenger-search-count",children:[c.length," —Ä–µ–∑—É–ª—Ç–∞—Ç–∞"]})]}),p?n.jsxs("div",{className:"svmessenger-search-loading",children:[n.jsx("div",{className:"svmessenger-spinner"}),n.jsx("span",{children:"–¢—ä—Ä—Å–µ–Ω–µ..."})]}):0===c.length?n.jsxs("div",{className:"svmessenger-search-empty",children:[n.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"})}),n.jsx("p",{children:"–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏"})]}):n.jsx("div",{className:"svmessenger-search-list",children:c.map(e=>n.jsxs("div",{className:"svmessenger-search-user-item",onClick:()=>C(e),children:[n.jsxs("div",{className:"svmessenger-search-user-avatar",children:[n.jsx("img",{src:e.imageUrl||"/images/default-avatar.png",alt:e.username,onError:e=>{e.target.src="/images/default-avatar.png"}}),e.isOnline&&n.jsx("div",{className:"svmessenger-online-indicator"})]}),n.jsxs("div",{className:"svmessenger-search-user-info",children:[n.jsx("h4",{className:"svmessenger-search-user-name",children:e.realName||e.username}),n.jsxs("p",{className:"svmessenger-search-user-username",children:["@",e.username]})]}),n.jsx("div",{className:"svmessenger-search-user-action",children:n.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"})})})]},e.id))})]}),n.jsxs("div",{className:"svmessenger-following-users-panel",children:[n.jsxs("div",{className:"svmessenger-search-section-header",children:[n.jsx("span",{children:"–°–ª–µ–¥–≤–∞–Ω–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏"}),!m&&i.length>0&&n.jsx("span",{className:"svmessenger-search-count",children:i.length})]}),m?n.jsxs("div",{className:"svmessenger-search-loading",children:[n.jsx("div",{className:"svmessenger-spinner"}),n.jsx("span",{children:"–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å–ª–µ–¥–≤–∞–Ω–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏..."})]}):0===i.length?n.jsxs("div",{className:"svmessenger-search-empty",children:[n.jsx("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"})}),n.jsx("p",{children:"–ù—è–º–∞ —Å–ª–µ–¥–≤–∞–Ω–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏"})]}):n.jsx("div",{className:"svmessenger-search-list",children:i.map(e=>n.jsxs("div",{className:"svmessenger-search-user-item",onClick:()=>C(e),children:[n.jsxs("div",{className:"svmessenger-search-user-avatar",children:[n.jsx("img",{src:e.imageUrl||"/images/default-avatar.png",alt:e.username,onError:e=>{e.target.src="/images/default-avatar.png"}}),e.isOnline&&n.jsx("div",{className:"svmessenger-online-indicator"})]}),n.jsxs("div",{className:"svmessenger-search-user-info",children:[n.jsx("h4",{className:"svmessenger-search-user-name",children:e.realName||e.username}),n.jsxs("p",{className:"svmessenger-search-user-username",children:["@",e.username]})]}),n.jsx("div",{className:"svmessenger-search-user-action",children:n.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"})})})]},e.id))})]})]})},me=()=>{const{activeChats:s,conversations:t,restoreChat:r,closeChat:a}=W(),o=e.useMemo(()=>s.filter(e=>e.isMinimized).map(e=>({...e,conversation:t.find(n=>n.id===e.conversation.id)||e.conversation})),[s,t]);if(0===o.length)return null;const i=[...o].reverse();return n.jsx("div",{className:"svmessenger-taskbar",children:i.map(e=>n.jsxs("button",{className:"svmessenger-taskbar-button","data-chat-id":e.conversation.id,onClick:()=>r(e.conversation.id),title:`–í—ä–∑—Å—Ç–∞–Ω–æ–≤–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å ${e.conversation.otherUser.realName||e.conversation.otherUser.username}`,children:[n.jsxs("div",{className:"svmessenger-taskbar-avatar",children:[n.jsx("img",{src:e.conversation.otherUser.imageUrl||"/images/default-avatar.png",alt:e.conversation.otherUser.username,onError:e=>{e.target.src="/images/default-avatar.png"}}),e.conversation.otherUser.isOnline&&n.jsx("div",{className:"svmessenger-online-indicator"})]}),n.jsx("span",{className:"svmessenger-taskbar-name",children:e.conversation.otherUser.realName||e.conversation.otherUser.username}),e.conversation.unreadCount>0&&n.jsx("span",{className:"svmessenger-taskbar-badge",children:e.conversation.unreadCount>99?"99+":e.conversation.unreadCount}),n.jsx("button",{className:"svmessenger-taskbar-close",onClick:n=>{n.stopPropagation(),a(e.conversation.id)},title:"–ó–∞—Ç–≤–æ—Ä–∏ —á–∞—Ç",children:n.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]},e.conversation.id))})},ue=({callState:s,conversation:t,onAccept:r,onReject:a,onEnd:o})=>{const[i,l]=e.useState(0),[c,d]=e.useState(!1);e.useEffect(()=>{let e;return"connected"===s?e=setInterval(()=>{l(e=>e+1)},1e3):l(0),()=>{e&&clearInterval(e)}},[s]),e.useEffect(()=>{if("incoming"===s){const e=setTimeout(()=>{const e=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});document.dispatchEvent(e)},100);return()=>clearTimeout(e)}},[s]);if(!t||"idle"===s)return null;const{otherUser:m}=t,u=`svmessenger-call-modal svmessenger-call-${s}`;return n.jsx("div",{className:"svmessenger-call-modal-overlay",children:n.jsxs("div",{className:u,children:[n.jsx("div",{className:"svmessenger-call-avatar",children:m.imageUrl?n.jsx("img",{src:m.imageUrl,alt:m.realName||m.username}):n.jsx("div",{className:"svmessenger-call-avatar-placeholder",children:(m.realName||m.username||"U").charAt(0).toUpperCase()})}),n.jsxs("div",{className:"svmessenger-call-status",children:[n.jsxs("div",{className:"svmessenger-call-title",children:["incoming"===s&&"–í—Ö–æ–¥—è—â–æ –æ–±–∞–∂–¥–∞–Ω–µ","outgoing"===s&&"–û–±–∞–∂–¥–∞–Ω–µ...","connected"===s&&"–í —Ä–∞–∑–≥–æ–≤–æ—Ä"]}),n.jsx("div",{className:"svmessenger-call-subtitle",children:"connected"===s?(e=>{const n=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`})(i):m.realName||m.username}),("incoming"===s||"outgoing"===s)&&n.jsxs("div",{className:"svmessenger-call-calling-animation",children:[n.jsxs("div",{className:"svmessenger-call-ripple-container",children:[n.jsx("div",{className:"svmessenger-call-ripple ripple-1"}),n.jsx("div",{className:"svmessenger-call-ripple ripple-2"}),n.jsx("div",{className:"svmessenger-call-ripple ripple-3"}),n.jsx("div",{className:"svmessenger-call-ripple ripple-4"})]}),n.jsx("div",{className:"svmessenger-call-glow-core",children:n.jsx("div",{className:"svmessenger-call-glow-inner"})}),n.jsxs("div",{className:"svmessenger-call-particles",children:[n.jsx("div",{className:"particle particle-1"}),n.jsx("div",{className:"particle particle-2"}),n.jsx("div",{className:"particle particle-3"}),n.jsx("div",{className:"particle particle-4"}),n.jsx("div",{className:"particle particle-5"}),n.jsx("div",{className:"particle particle-6"})]})]})]}),n.jsxs("div",{className:"svmessenger-call-actions",children:["incoming"===s&&n.jsxs(n.Fragment,{children:[n.jsx("button",{className:"svmessenger-call-btn-accept",onClick:r,title:"–ü—Ä–∏–µ–º–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:n.jsx("i",{className:"bi bi-telephone accept-icon"})}),n.jsx("button",{className:"svmessenger-call-btn-reject",onClick:a,title:"–û—Ç–∫–∞–∂–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:n.jsx("i",{className:"bi bi-telephone reject-icon"})})]}),"outgoing"===s&&n.jsx("button",{className:"svmessenger-call-btn-end",onClick:o,title:"–û—Ç–º–µ–Ω–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:n.jsx("i",{className:"bi bi-telephone end-icon"})}),"connected"===s&&n.jsxs(n.Fragment,{children:[n.jsx("button",{className:"svmessenger-call-btn-mute "+(c?"muted":""),onClick:()=>{d(!c)},title:c?"–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞":"–ò–∑–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞",children:c?n.jsx("i",{className:"bi bi-mic-mute muted-icon"}):n.jsx("i",{className:"bi bi-mic active-icon"})}),n.jsx("button",{className:"svmessenger-call-btn-end",onClick:o,title:"–ó–∞—Ç–≤–æ—Ä–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:n.jsx("i",{className:"bi bi-telephone end-icon"})})]})]})]})})},he=({isOpen:s,onComplete:t,onCancel:r})=>{const{deviceSelectorMode:a}=W(),[i,l]=e.useState([]),[c,d]=e.useState([]),[m,u]=e.useState([]),[h,p]=e.useState(""),[g,v]=e.useState(""),[x,f]=e.useState(""),[b,C]=e.useState(75),[y,j]=e.useState(80),[w,S]=e.useState(!0),[N,k]=e.useState(!1),[I,E]=e.useState(!1),[T,M]=e.useState(null),[A,L]=e.useState(0),[R,U]=e.useState(null),[z,D]=e.useState("microphone"),[O,_]=e.useState(!1),[B,$]=e.useState({x:0,y:0}),[H,P]=e.useState({x:0,y:0}),F=e.useRef(null),V=e.useRef(null),q=e.useRef(null),J=e.useRef(null),K=e.useRef(null),G=e.useRef(null);e.useRef(null),e.useRef(null),e.useEffect(()=>{s&&setTimeout(()=>{if(F.current){F.current;const e=(window.innerWidth-400)/2,n=(window.innerHeight-500)/2;$({x:Math.max(0,e),y:Math.max(0,n)})}},0)},[s]);e.useEffect(()=>{if(!O)return;const e=e=>{if(!F.current)return;const n=F.current.offsetWidth,s=F.current.offsetHeight,t=e.clientX-H.x,r=e.clientY-H.y,a=window.innerWidth-n,o=window.innerHeight-s,i=Math.max(0,Math.min(t,a)),l=Math.max(0,Math.min(r,o));$({x:i,y:l})},n=()=>{_(!1)};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",n),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",n)}},[O,H]),e.useEffect(()=>{const e=localStorage.getItem("svmessenger-audio-settings");if(e)try{const n=JSON.parse(e);C(n.micVolume||75),j(n.speakerVolume||80),n.microphone&&(p(n.microphone),o.selectedMicrophone=n.microphone),n.speaker&&(v(n.speaker),o.selectedSpeaker=n.speaker)}catch(n){console.warn("Failed to load saved audio settings:",n)}},[]);const Y=e=>{try{try{localStorage.setItem("svmessenger-audio-video-settings",JSON.stringify(e));localStorage.getItem("svmessenger-audio-video-settings")}catch(n){}e.microphone&&(o.selectedMicrophone=e.microphone),e.speaker&&(o.selectedSpeaker=e.speaker),e.camera&&(o.selectedCamera=e.camera)}catch(s){console.warn("Failed to save audio/video settings:",s)}},Q=(e,n)=>{"mic"===e?(C(n),Y({micVolume:n,speakerVolume:y})):"speaker"===e&&(j(n),Y({micVolume:b,speakerVolume:n}))};e.useEffect(()=>(s?X():(ee(),se()),()=>{ee(),se()}),[s]);const X=async()=>{try{S(!0),M(null),L(0),await o.requestAudioPermissions();try{await o.requestCameraPermissions()}catch(e){console.warn("Camera permissions not granted, cameras may not be available:",e)}const s=await o.enumerateAudioDevices(),t=await o.getCameras();l(s.microphones),d(s.speakers),u(t);const r=localStorage.getItem("svmessenger-audio-video-settings");let a,i,c;if(r)try{const e=JSON.parse(r);a=e.microphone,i=e.speaker,c=e.camera}catch(n){console.warn("Error parsing saved settings:",n)}const m=a||(s.microphones.length>0?s.microphones[0].deviceId:"");p(m),v(i||(s.speakers.length>0?s.speakers[0].deviceId:"")),f(c||(t.length>0?t[0].deviceId:"")),m&&setTimeout(()=>{Z(m)},100)}catch(s){M(s.message||"Failed to access audio/video devices"),console.error("Audio/Video device initialization error:",s)}finally{S(!1)}},Z=async e=>{try{let s;ee(),V.current=new(window.AudioContext||window.webkitAudioContext),q.current=V.current.createAnalyser(),q.current.fftSize=2048,q.current.smoothingTimeConstant=.8;try{s=await navigator.mediaDevices.getUserMedia({audio:{deviceId:!e||{ideal:e},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})}catch(n){s=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})}G.current=s,J.current=V.current.createMediaStreamSource(s),J.current.connect(q.current);const t=new Float32Array(q.current.fftSize),r=()=>{if(!q.current)return;q.current.getFloatTimeDomainData(t);let e=0;for(let r=0;r<t.length;r++)e+=t[r]*t[r];const n=Math.sqrt(e/t.length);let s=0;n>0&&(s=Math.min(100,Math.max(0,300*n)),s<50&&(s*=1.5)),L(Math.min(100,s)),K.current=requestAnimationFrame(r)};r()}catch(s){console.error("Error starting audio visualization:",s),L(0)}},ee=()=>{K.current&&(cancelAnimationFrame(K.current),K.current=null),J.current&&(J.current.disconnect(),J.current=null),G.current&&(G.current.getTracks().forEach(e=>e.stop()),G.current=null),V.current&&"closed"!==V.current.state&&(V.current.close(),V.current=null),q.current=null,L(0)},ne=async()=>{try{k(!0),U(null);const n=new(window.AudioContext||window.webkitAudioContext),s=n.createOscillator(),t=n.createGain(),r=document.createElement("audio");if(g&&"setSinkId"in HTMLAudioElement.prototype)try{await r.setSinkId(g)}catch(e){}const a=n.createMediaStreamDestination();s.connect(t),t.connect(a),r.srcObject=a.stream,r.volume=y/100,s.frequency.setValueAtTime(440,n.currentTime),t.gain.setValueAtTime(1,n.currentTime),s.start(),await r.play(),t.gain.exponentialRampToValueAtTime(.01,n.currentTime+1),s.stop(n.currentTime+1),setTimeout(()=>{r.pause(),r.srcObject=null,n.close(),U({speakerWorking:!0}),k(!1)},1200)}catch(n){console.error("Speaker test failed:",n),U({speakerWorking:!1,error:n.message}),k(!1)}},se=()=>{k(!1),U(null)},te=({level:e,label:s})=>n.jsxs("div",{style:{padding:"8px",background:"#f3f4f6",borderRadius:"6px",marginTop:"6px"},children:[s&&n.jsx("div",{style:{display:"block",marginBottom:"6px",fontSize:"10px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:s}),n.jsx("div",{style:{position:"relative",height:"5px",background:"#d1d5db",borderRadius:"3px",overflow:"hidden"},children:n.jsx("div",{style:{position:"absolute",left:0,top:0,height:"100%",width:`${e}%`,background:e>70?"#22c55e":e>30?"#eab308":"#ef4444",transition:"width 0.1s ease",borderRadius:"3px"}})}),n.jsxs("div",{style:{marginTop:"3px",fontSize:"10px",fontWeight:"600",color:"#6b7280",textAlign:"right"},children:[Math.round(e),"%"]})]});return s?n.jsxs("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1e4,pointerEvents:"none"},children:[n.jsxs("div",{ref:F,style:{position:"absolute",left:`${B.x}px`,top:`${B.y}px`,background:"#ffffff",borderRadius:"12px",width:"400px",maxHeight:"500px",display:"flex",flexDirection:"column",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.25)",pointerEvents:"auto"},children:[n.jsxs("div",{className:"audio-device-header",style:{padding:"14px 20px",borderBottom:"1px solid #e5e7eb",textAlign:"center",position:"sticky",top:0,background:"#ffffff",zIndex:10,borderRadius:"12px 12px 0 0",cursor:O?"grabbing":"grab",userSelect:"none"},onMouseDown:e=>{const n=e.target.closest(".audio-device-header"),s=e.target.closest(".audio-device-close");if(n&&!s&&(_(!0),F.current)){const n=F.current.getBoundingClientRect();P({x:e.clientX-n.left,y:e.clientY-n.top})}},children:[n.jsx("button",{className:"audio-device-close",onClick:r,style:{position:"absolute",top:"12px",right:"12px",background:"none",border:"none",cursor:"pointer",padding:"4px",display:"flex",alignItems:"center",justifyContent:"center",color:"#6b7280",fontSize:"18px",lineHeight:"1",width:"24px",height:"24px",borderRadius:"4px",transition:"all 0.2s ease"},onMouseEnter:e=>{e.currentTarget.style.background="#f3f4f6",e.currentTarget.style.color="#111827"},onMouseLeave:e=>{e.currentTarget.style.background="none",e.currentTarget.style.color="#6b7280"},title:"–ó–∞—Ç–≤–æ—Ä–∏",children:n.jsx("i",{className:"bi bi-x",style:{fontSize:"20px",fontWeight:"300"}})}),n.jsx("div",{style:{width:"36px",height:"36px",background:"linear-gradient(135deg, #22c55e 0%, #16a34a 100%)",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 10px",boxShadow:"0 4px 12px rgba(34, 197, 94, 0.3)"},children:n.jsx("i",{className:"bi bi-gear-fill",style:{fontSize:"18px",color:"#ffffff"}})}),n.jsx("h2",{style:{margin:"0 0 4px 0",fontSize:"16px",fontWeight:"700",color:"#111827"},children:"–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ"}),n.jsx("p",{style:{margin:0,fontSize:"10px",color:"#6b7280"},children:"–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞–π—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ç–∞ —Å–∏ –∑–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω —Ä–∞–∑–≥–æ–≤–æ—Ä"})]}),w&&n.jsxs("div",{style:{padding:"32px 20px",textAlign:"center"},children:[n.jsx("div",{style:{width:"36px",height:"36px",border:"3px solid #e5e7eb",borderTop:"3px solid #22c55e",borderRadius:"50%",animation:"spin 1s linear infinite",margin:"0 auto 12px"}}),n.jsx("h4",{style:{margin:"0 0 6px 0",fontSize:"13px",fontWeight:"600",color:"#111827"},children:"–ò—Å–∫–∞–Ω–µ –Ω–∞ –¥–æ—Å—Ç—ä–ø –¥–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω"}),n.jsx("p",{style:{margin:0,fontSize:"11px",color:"#6b7280"},children:"–ú–æ–ª—è, –ø–æ–∑–≤–æ–ª–µ—Ç–µ –¥–æ—Å—Ç—ä–ø–∞ –≤ browser –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞"})]}),T&&n.jsxs("div",{style:{padding:"24px 20px",textAlign:"center"},children:[n.jsx("div",{style:{width:"40px",height:"40px",background:"#fee2e2",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 12px"},children:n.jsx("i",{className:"bi bi-exclamation-triangle-fill",style:{fontSize:"20px",color:"#ef4444"}})}),n.jsx("h4",{style:{margin:"0 0 6px 0",fontSize:"13px",fontWeight:"600",color:"#ef4444"},children:"–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—ä–ø –¥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"}),n.jsx("p",{style:{margin:"0 0 12px 0",fontSize:"11px",color:"#6b7280"},children:T}),n.jsx("button",{onClick:X,style:{background:"#ef4444",color:"#ffffff",border:"none",padding:"8px 18px",borderRadius:"6px",fontSize:"12px",fontWeight:"600",cursor:"pointer",boxShadow:"0 2px 6px rgba(239, 68, 68, 0.3)"},children:"–û–ø–∏—Ç–∞–π –æ—Ç–Ω–æ–≤–æ"})]}),!w&&!T&&n.jsxs("div",{style:{display:"flex",flexDirection:"column",flex:1,overflow:"hidden"},children:[n.jsxs("div",{style:{display:"flex",borderBottom:"1px solid #e5e7eb",background:"#ffffff",padding:"0 20px"},children:[n.jsxs("button",{onClick:()=>D("microphone"),style:{flex:1,padding:"12px 8px",background:"none",border:"none",borderBottom:"microphone"===z?"2px solid #22c55e":"2px solid transparent",color:"microphone"===z?"#22c55e":"#6b7280",fontSize:"12px",fontWeight:"microphone"===z?"600":"500",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px",transition:"all 0.2s ease"},children:[n.jsx("i",{className:"bi bi-mic-fill",style:{fontSize:"14px"}}),"–ú–∏–∫—Ä–æ—Ñ–æ–Ω"]}),n.jsxs("button",{onClick:()=>D("speaker"),style:{flex:1,padding:"12px 8px",background:"none",border:"none",borderBottom:"speaker"===z?"2px solid #22c55e":"2px solid transparent",color:"speaker"===z?"#22c55e":"#6b7280",fontSize:"12px",fontWeight:"speaker"===z?"600":"500",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px",transition:"all 0.2s ease"},children:[n.jsx("i",{className:"bi bi-headphones",style:{fontSize:"14px"}}),"–°–ª—É—à–∞–ª–∫–∏"]}),n.jsxs("button",{onClick:()=>D("camera"),style:{flex:1,padding:"12px 8px",background:"none",border:"none",borderBottom:"camera"===z?"2px solid #22c55e":"2px solid transparent",color:"camera"===z?"#22c55e":"#6b7280",fontSize:"12px",fontWeight:"camera"===z?"600":"500",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px",transition:"all 0.2s ease"},children:[n.jsx("i",{className:"bi bi-camera-video-fill",style:{fontSize:"14px"}}),"–ö–∞–º–µ—Ä–∞"]})]}),n.jsxs("div",{style:{padding:"20px",overflowY:"auto",flex:1,maxHeight:"calc(500px - 200px)"},children:["microphone"===z&&n.jsxs("div",{children:[n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("label",{style:{display:"block",marginBottom:"8px",fontSize:"11px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"}),n.jsx("select",{value:h,onChange:e=>(async e=>{try{await o.setMicrophone(e),p(e),ee(),await Z(e);const n={...JSON.parse(localStorage.getItem("svmessenger-audio-settings")||"{}"),microphone:e,micVolume:b};Y(n)}catch(n){console.error("Error changing microphone:",n)}})(e.target.value),style:{width:"100%",padding:"10px 12px",border:"1px solid #d1d5db",borderRadius:"8px",background:"#ffffff",color:"#111827",fontSize:"13px",cursor:"pointer",transition:"border-color 0.2s ease"},onFocus:e=>e.target.style.borderColor="#22c55e",onBlur:e=>e.target.style.borderColor="#d1d5db",children:i.map(e=>n.jsx("option",{value:e.deviceId,children:e.label||`–ú–∏–∫—Ä–æ—Ñ–æ–Ω ${e.deviceId.slice(0,8)}`},e.deviceId))})]}),n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("label",{style:{display:"block",marginBottom:"8px",fontSize:"11px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"–°–∏–ª–∞ –Ω–∞ –∑–≤—É–∫–∞"}),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",padding:"12px",background:"#f9fafb",borderRadius:"8px",border:"1px solid #e5e7eb"},children:[n.jsx("i",{className:"bi bi-volume-down-fill",style:{fontSize:"16px",color:"#22c55e"}}),n.jsx("input",{type:"range",min:"0",max:"100",value:b,onChange:e=>Q("mic",Number(e.target.value)),style:{flex:1,height:"6px",background:"#d1d5db",borderRadius:"3px",outline:"none",cursor:"pointer"}}),n.jsxs("span",{style:{fontSize:"13px",fontWeight:"600",color:"#111827",minWidth:"40px",textAlign:"right"},children:[b,"%"]})]})]}),n.jsx(te,{level:A})]}),"speaker"===z&&n.jsxs("div",{children:[n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("label",{style:{display:"block",marginBottom:"8px",fontSize:"11px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"}),n.jsx("select",{value:g,onChange:e=>(async e=>{try{await o.setSpeaker(e),v(e);const n={...JSON.parse(localStorage.getItem("svmessenger-audio-video-settings")||localStorage.getItem("svmessenger-audio-settings")||"{}"),speaker:e,speakerVolume:y};Y(n)}catch(n){console.error("Error changing speaker:",n)}})(e.target.value),style:{width:"100%",padding:"10px 12px",border:"1px solid #d1d5db",borderRadius:"8px",background:"#ffffff",color:"#111827",fontSize:"13px",cursor:"pointer",transition:"border-color 0.2s ease"},onFocus:e=>e.target.style.borderColor="#22c55e",onBlur:e=>e.target.style.borderColor="#d1d5db",children:c.map(e=>n.jsx("option",{value:e.deviceId,children:e.label||`–°–ª—É—à–∞–ª–∫–∏ ${e.deviceId.slice(0,8)}`},e.deviceId))})]}),n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("label",{style:{display:"block",marginBottom:"8px",fontSize:"11px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"–°–∏–ª–∞ –Ω–∞ –∑–≤—É–∫–∞"}),n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",padding:"12px",background:"#f9fafb",borderRadius:"8px",border:"1px solid #e5e7eb"},children:[n.jsx("i",{className:"bi bi-volume-up-fill",style:{fontSize:"16px",color:"#22c55e"}}),n.jsx("input",{type:"range",min:"0",max:"100",value:y,onChange:e=>Q("speaker",Number(e.target.value)),style:{flex:1,height:"6px",background:"#d1d5db",borderRadius:"3px",outline:"none",cursor:"pointer"}}),n.jsxs("span",{style:{fontSize:"13px",fontWeight:"600",color:"#111827",minWidth:"40px",textAlign:"right"},children:[y,"%"]})]})]}),n.jsxs("div",{style:{background:"#eaffe9",border:"1px solid #bbf7d0",borderRadius:"10px",padding:"14px",marginTop:"8px"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"10px"},children:[n.jsx("i",{className:"bi bi-info-circle-fill",style:{fontSize:"14px",color:"#22c55e"}}),n.jsx("span",{style:{fontSize:"12px",fontWeight:"600",color:"#166534"},children:"–¢–µ—Å—Ç –Ω–∞ —Å–ª—É—à–∞–ª–∫–∏"})]}),n.jsx("p",{style:{margin:"0 0 12px 0",fontSize:"11px",color:"#166534",lineHeight:"1.5"},children:"–ù–∞—Ç–∏—Å–Ω–µ—Ç–µ –±—É—Ç–æ–Ω–∞ –ø–æ-–¥–æ–ª—É, –∑–∞ –¥–∞ —á—É–µ—Ç–µ —Ç–µ—Å—Ç–æ–≤ —Å–∏–≥–Ω–∞–ª –∏ –¥–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç–µ –¥–∞–ª–∏ —Å–ª—É—à–∞–ª–∫–∏—Ç–µ —Ä–∞–±–æ—Ç—è—Ç –ø—Ä–∞–≤–∏–ª–Ω–æ."}),n.jsx("button",{onClick:()=>{N?se():ne()},disabled:0===c.length||N,style:{width:"100%",padding:"10px",background:N?"#6bb75f":"#22c55e",color:"#ffffff",border:"none",borderRadius:"8px",fontSize:"12px",fontWeight:"600",cursor:0===c.length||N?"not-allowed":"pointer",opacity:0===c.length||N?.6:1,display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",transition:"all 0.2s ease",boxShadow:0===c.length||N?"none":"0 2px 6px rgba(34, 197, 94, 0.3)"},onMouseEnter:e=>{c.length>0&&!N&&(e.currentTarget.style.background="#16a34a")},onMouseLeave:e=>{c.length>0&&!N&&(e.currentTarget.style.background="#22c55e")},children:N?n.jsxs(n.Fragment,{children:[n.jsx("div",{style:{width:"14px",height:"14px",border:"2px solid #ffffff",borderTop:"2px solid transparent",borderRadius:"50%",animation:"spin 0.8s linear infinite"}}),"–¢–µ—Å—Ç–≤–∞–Ω–µ..."]}):n.jsxs(n.Fragment,{children:[n.jsx("i",{className:"bi bi-play-circle-fill",style:{fontSize:"14px"}}),"–¢–µ—Å—Ç–≤–∞–π —Å–ª—É—à–∞–ª–∫–∏"]})}),R&&n.jsx("div",{style:{marginTop:"12px",padding:"10px",background:"#ffffff",borderRadius:"6px",border:"1px solid #bbf7d0"},children:n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[n.jsx("i",{className:"bi bi-"+(R.speakerWorking?"check-circle-fill":"x-circle-fill"),style:{fontSize:"16px",color:R.speakerWorking?"#22c55e":"#ef4444"}}),n.jsx("span",{style:{fontSize:"12px",color:"#166534",fontWeight:"500"},children:R.speakerWorking?"–°–ª—É—à–∞–ª–∫–∏—Ç–µ —Ä–∞–±–æ—Ç—è—Ç –ø—Ä–∞–≤–∏–ª–Ω–æ":"–ü—Ä–æ–±–ª–µ–º —Å—ä—Å —Å–ª—É—à–∞–ª–∫–∏—Ç–µ"})]})})]})]}),"camera"===z&&n.jsxs("div",{children:[n.jsxs("div",{style:{marginBottom:"16px"},children:[n.jsx("label",{style:{display:"block",marginBottom:"8px",fontSize:"11px",fontWeight:"600",color:"#374151",textTransform:"uppercase",letterSpacing:"0.5px"},children:"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"}),n.jsx("select",{value:x,onChange:e=>(async e=>{try{await o.setCamera(e),f(e);const n={...JSON.parse(localStorage.getItem("svmessenger-audio-video-settings")||localStorage.getItem("svmessenger-audio-settings")||"{}"),camera:e};Y(n)}catch(n){console.error("Error changing camera:",n)}})(e.target.value),style:{width:"100%",padding:"10px 12px",border:"1px solid #d1d5db",borderRadius:"8px",background:"#ffffff",color:"#111827",fontSize:"13px",cursor:0===m.length?"not-allowed":"pointer",opacity:0===m.length?.6:1,transition:"border-color 0.2s ease"},disabled:0===m.length,onFocus:e=>{m.length>0&&(e.target.style.borderColor="#3b82f6")},onBlur:e=>e.target.style.borderColor="#d1d5db",children:0===m.length?n.jsx("option",{children:"–ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ –∫–∞–º–µ—Ä–∏"}):m.map(e=>n.jsx("option",{value:e.deviceId,children:e.label||`–ö–∞–º–µ—Ä–∞ ${e.deviceId.slice(0,8)}`},e.deviceId))})]}),n.jsx("div",{style:{background:"#eff6ff",border:"1px solid #bfdbfe",borderRadius:"10px",padding:"14px",fontSize:"12px",color:"#1e40af",lineHeight:"1.5"},children:n.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:"8px"},children:[n.jsx("i",{className:"bi bi-info-circle-fill",style:{fontSize:"14px",marginTop:"2px",flexShrink:0}}),n.jsx("span",{children:"–ö–∞–º–µ—Ä–∞—Ç–∞ —â–µ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –≤–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ –≤–∏–¥–µ–æ –ø–æ –≤—Ä–µ–º–µ –Ω–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä."})]})})]})]})]}),n.jsxs("div",{style:{padding:"14px 20px",borderTop:"1px solid #e5e7eb",display:"flex",gap:"10px",justifyContent:"flex-end"},children:[n.jsx("button",{onClick:r,disabled:w,style:{padding:"8px 18px",background:"#ffffff",color:"#6b7280",border:"1px solid #d1d5db",borderRadius:"6px",fontSize:"12px",fontWeight:"600",cursor:w?"not-allowed":"pointer",opacity:w?.5:1},children:"–û—Ç–∫–∞–∑"}),n.jsx("button",{onClick:()=>{ee(),se();Y({microphone:h,speaker:g,camera:x,micVolume:b,speakerVolume:y}),t({microphone:h,speaker:g,camera:x,micVolume:b/100,speakerVolume:y/100})},disabled:w||T||0===i.length,style:{padding:"8px 18px",background:w||T||0===i.length?"#d1d5db":"#22c55e",color:"#ffffff",border:"none",borderRadius:"6px",fontSize:"12px",fontWeight:"600",cursor:w||T||0===i.length?"not-allowed":"pointer",boxShadow:w||T||0===i.length?"none":"0 2px 6px rgba(34, 197, 94, 0.3)"},children:"settings"===a?"–ó–∞–ø–∞–∑–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏":"–ó–∞–ø–æ—á–Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä"})]})]}),n.jsx("style",{children:"\n        @keyframes spin {\n          0% { transform: rotate(0deg); }\n          100% { transform: rotate(360deg); }\n        }\n      "})]}):null},pe=()=>{const{isDownloadModalOpen:s,closeDownloadModal:t}=W(),[r,a]=e.useState("mission"),[o,i]=e.useState(!1);if(!s)return null;return n.jsxs("div",{className:"svm-modal-overlay",onClick:t,children:[n.jsxs("div",{className:"svm-download-modal-compact",onClick:e=>e.stopPropagation(),children:[n.jsx("button",{className:"svm-modal-close-small",onClick:t,children:n.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:n.jsx("path",{d:"M18 6L6 18M6 6l12 12"})})}),n.jsxs("div",{className:"svm-modal-layout",children:[n.jsx("div",{className:"svm-modal-visuals",children:n.jsx("img",{src:"/svmessenger/img/svapp_promo_premium.jpg",alt:"SVMessenger",className:"svm-mockup-mini"})}),n.jsxs("div",{className:"svm-modal-main",children:[n.jsxs("header",{className:"svm-modal-header",children:[n.jsx("span",{className:"svm-brand-tag",children:"SV Messenger"}),n.jsx("h2",{className:"svm-compact-title",children:"–°–≤–æ–±–æ–¥–∞—Ç–∞ –¥–∞ –æ–±—â—É–≤–∞—à"})]}),n.jsxs("nav",{className:"svm-tabs-nav",children:[n.jsx("button",{className:"svm-tab-btn "+("mission"===r?"active":""),onClick:()=>a("mission"),children:"–ö–∞—É–∑–∞"}),n.jsx("button",{className:"svm-tab-btn "+("features"===r?"active":""),onClick:()=>a("features"),children:"–í—ä–∑–º–æ–∂–Ω–æ—Å—Ç–∏"}),n.jsx("button",{className:"svm-tab-btn "+("download"===r?"active":""),onClick:()=>a("download"),children:"–ò–∑—Ç–µ–≥–ª—è–Ω–µ"})]}),n.jsx("main",{className:"svm-tabs-content",children:(()=>{switch(r){case"mission":return n.jsxs("div",{className:"svm-tab-pane",children:[n.jsxs("p",{className:"svm-sincere-text",children:[n.jsx("strong",{children:"SVMessenger –Ω–µ –µ –ø—Ä–æ—Å—Ç–æ –ø–æ—Ä–µ–¥–Ω–æ—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ."})," –¢–æ –µ –Ω–∞—à–∏—è—Ç –æ—Ç–≥–æ–≤–æ—Ä –Ω–∞ –≤—Å–µ –ø–æ-–≥–æ–ª—è–º–∞—Ç–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç –æ—Ç —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω–∏—Ç–µ –≥–∏–≥–∞–Ω—Ç–∏."]}),n.jsx("p",{className:"svm-sincere-text",children:'–°—ä–∑–¥–∞–¥–æ—Ö–º–µ —Ç–æ–≤–∞ –º—è—Å—Ç–æ –∑–∞ —Ç–µ–± ‚Äì –Ω–∞–ø—ä–ª–Ω–æ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º–∏ –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–µ–Ω –Ω–∞—Ç–∏—Å–∫. –¢—É–∫ —Ç–∏ –Ω–µ —Å–∏ "–ø—Ä–æ–¥—É–∫—Ç", –∞ —Å–≤–æ–±–æ–¥–µ–Ω —á–æ–≤–µ–∫. –¢–æ–≤–∞ –µ –ø—Ä–æ–µ–∫—Ç –æ—Ç —Ö–æ—Ä–∞ –∑–∞ —Ö–æ—Ä–∞, –∫—ä–¥–µ—Ç–æ —á–µ—Å—Ç–Ω–æ—Å—Ç—Ç–∞ –∏ —Ç–∏—à–∏–Ω–∞—Ç–∞ –æ—Ç —Ä–µ–∫–ª–∞–º–∏ —Å–∞ –Ω–∞—à –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç.'}),n.jsx("div",{className:"svm-independence-badge",children:"100% –ù–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç"})]});case"features":return n.jsxs("div",{className:"svm-tab-pane",children:[n.jsx("p",{className:"svm-sincere-text",children:"–í—è—Ä–≤–∞–º–µ –≤ –∫–∞—á–µ—Å—Ç–≤–æ—Ç–æ –ø—Ä–µ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ—Ç–æ. –ó–∞—Ç–æ–≤–∞ —Å–µ —Ñ–æ–∫—É—Å–∏—Ä–∞–º–µ –≤—ä—Ä—Ö—É –±–µ–∑—É–ø—Ä–µ—á–Ω–∞—Ç–∞ —Ç–µ–∫—Å—Ç–æ–≤–∞ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—è."}),n.jsxs("div",{className:"svm-warning-box",children:[n.jsx("strong",{children:"–í–∞–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ:"}),n.jsx("p",{children:"–ê—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∏—Ç–µ —Å–∞ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è, –¥–æ—Å—Ç—ä–ø–Ω–∞ —Å–∞–º–æ –∑–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ —Å –≤–∏—Å–æ–∫ —Ä–µ–π—Ç–∏–Ω–≥. –¢–æ–≤–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–∞, —á–µ —Å—Ä–µ–¥–∞—Ç–∞ –Ω–∏ –æ—Å—Ç–∞–≤–∞ –∑–∞—â–∏—Ç–µ–Ω–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–∏ –∏ –∑–∞–ø–∞–∑–≤–∞–º–µ —Ä–µ—Å—É—Ä—Å–∏—Ç–µ —Å–∏ –∑–∞ –æ–Ω–µ–∑–∏, –∫–æ–∏—Ç–æ –Ω–∞–∏—Å—Ç–∏–Ω–∞ —Ü–µ–Ω—è—Ç –æ–±—â–Ω–æ—Å—Ç—Ç–∞ –Ω–∏."})]})]});case"download":return n.jsx("div",{className:"svm-tab-pane",children:window.innerWidth<=768?n.jsxs("div",{className:"svm-download-actions",children:[n.jsxs("a",{href:"/svmessenger.apk",className:"svm-btn-primary",download:!0,children:[n.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",style:{marginRight:"10px"},children:n.jsx("path",{d:"M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"})}),"–ò–∑—Ç–µ–≥–ª–∏ Android App"]}),n.jsx("p",{className:"svm-hint",children:"–í–µ—Ä—Å–∏—è 1.0.0 | ~25MB"})]}):n.jsxs("div",{className:"svm-qr-section-compact",children:[n.jsx("div",{className:"svm-qr-container",onClick:()=>i(!0),style:{cursor:"pointer"},title:"–ö–ª–∏–∫–Ω–∏ –∑–∞ –¥–∞ —É–≤–µ–ª–∏—á–∏—à",children:n.jsx("img",{src:`https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent("https://smolyanvote.com/svmessenger.apk")}`,alt:"QR Code",className:"svm-qr-code"})}),n.jsxs("div",{className:"svm-qr-text-compact",children:[n.jsx("strong",{children:"–°–∫–∞–Ω–∏—Ä–∞–π —Å –∫–∞–º–µ—Ä–∞—Ç–∞"}),n.jsx("p",{children:"–ö–ª–∏–∫–Ω–∏ –Ω–∞ QR –∫–æ–¥–∞ –∑–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ."})]})]})});default:return null}})()}),n.jsx("footer",{className:"svm-modal-footer",children:"download"!==r&&n.jsx("button",{className:"svm-btn-next",onClick:()=>a("mission"===r?"features":"download"),children:"–ü—Ä–æ–¥—ä–ª–∂–∏ –Ω–∞–ø—Ä–µ–¥ ‚Üí"})})]})]})]}),o&&n.jsx("div",{className:"svm-qr-overlay",onClick:()=>i(!1),children:n.jsxs("div",{className:"svm-qr-enlarged-container",onClick:e=>e.stopPropagation(),children:[n.jsx("img",{src:`https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${encodeURIComponent("https://smolyanvote.com/svmessenger.apk")}`,alt:"Scan to Download",className:"svm-qr-enlarged"}),n.jsxs("div",{className:"svm-qr-enlarged-footer",children:[n.jsx("span",{className:"svm-qr-pulse"}),n.jsx("p",{children:"–°–∫–∞–Ω–∏—Ä–∞–π, –∑–∞ –¥–∞ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞—à"})]})]})}),n.jsx("style",{dangerouslySetInnerHTML:{__html:"\n                .svm-modal-overlay {\n                    position: fixed;\n                    top: 0; left: 0; right: 0; bottom: 0;\n                    background: rgba(2, 44, 34, 0.7);\n                    backdrop-filter: blur(20px);\n                    -webkit-backdrop-filter: blur(20px);\n                    z-index: 1000000;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    padding: 16px;\n                    animation: svmFadeIn 0.3s ease-out;\n                    cursor: zoom-out;\n                }\n\n                @keyframes svmZoomInSpring {\n                    0% { opacity: 0; transform: scale(0.6) translateY(40px); }\n                    100% { opacity: 1; transform: scale(1) translateY(0); }\n                }\n\n                @keyframes svmPulse {\n                    0% { transform: scale(1); opacity: 0.5; }\n                    50% { transform: scale(1.5); opacity: 0; }\n                    100% { transform: scale(1); opacity: 0; }\n                }\n\n                .svm-qr-enlarged-container {\n                     background: white;\n                     padding: 32px;\n                     border-radius: 32px;\n                     box-shadow: 0 50px 100px -20px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.2) inset;\n                     animation: svmZoomInSpring 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);\n                     display: flex;\n                     flex-direction: column;\n                     align-items: center;\n                     max-width: 400px;\n                     width: 100%;\n                }\n\n                .svm-qr-enlarged {\n                    width: 100%;\n                    height: auto;\n                    border-radius: 12px;\n                    margin-bottom: 24px;\n                }\n\n                .svm-qr-enlarged-footer {\n                    display: flex;\n                    align-items: center;\n                    gap: 12px;\n                    color: #022c22;\n                    font-weight: 600;\n                }\n\n                .svm-qr-pulse {\n                    width: 8px;\n                    height: 8px;\n                    background: #16a34a;\n                    border-radius: 50%;\n                    position: relative;\n                }\n\n                .svm-qr-pulse::after {\n                     content: '';\n                     position: absolute;\n                     top: 0; left: 0; right: 0; bottom: 0;\n                     background: #16a34a;\n                     border-radius: 50%;\n                     animation: svmPulse 1.5s infinite;\n                }\n\n                .svm-download-modal-compact {\n                    background: #ffffff;\n                    width: 100%;\n                    max-width: 820px;\n                    border-radius: 28px;\n                    position: relative;\n                    overflow: hidden;\n                    box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 0.6);\n                    animation: svmPopIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.15);\n                }\n\n                .svm-modal-close-small {\n                    position: absolute;\n                    top: 16px; right: 16px;\n                    background: rgba(0,0,0,0.05);\n                    border: none;\n                    width: 32px; height: 32px;\n                    border-radius: 50%;\n                    display: flex;\n                    align-items: center; justify-content: center;\n                    cursor: pointer;\n                    color: #022c22;\n                    z-index: 100;\n                    transition: 0.2s;\n                }\n\n                .svm-modal-layout {\n                    display: flex;\n                }\n\n                .svm-modal-visuals {\n                    flex: 0 0 320px;\n                    background: #022c22;\n                    padding: 0;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    overflow: hidden;\n                }\n\n                .svm-mockup-mini {\n                    width: 100%;\n                    height: 100%;\n                    object-fit: cover;\n                }\n\n                .svm-modal-main {\n                    flex: 1;\n                    padding: 40px;\n                    display: flex;\n                    flex-direction: column;\n                    min-height: 480px;\n                }\n\n                .svm-brand-tag {\n                    font-size: 12px;\n                    font-weight: 800;\n                    text-transform: uppercase;\n                    letter-spacing: 2px;\n                    color: #16a34a;\n                    margin-bottom: 8px;\n                    display: block;\n                }\n\n                .svm-compact-title {\n                    font-size: 32px;\n                    font-weight: 800;\n                    color: #022c22;\n                    margin-bottom: 24px;\n                    letter-spacing: -0.5px;\n                }\n\n                .svm-tabs-nav {\n                    display: flex;\n                    gap: 8px;\n                    margin-bottom: 24px;\n                    background: #f3f4f6;\n                    padding: 4px;\n                    border-radius: 12px;\n                }\n\n                .svm-tab-btn {\n                    flex: 1;\n                    padding: 10px;\n                    border: none;\n                    background: transparent;\n                    border-radius: 8px;\n                    font-size: 14px;\n                    font-weight: 600;\n                    color: #6b7280;\n                    cursor: pointer;\n                    transition: 0.2s;\n                }\n\n                .svm-tab-btn.active {\n                    background: #ffffff;\n                    color: #022c22;\n                    box-shadow: 0 1px 2px rgba(0,0,0,0.1);\n                }\n\n                .svm-tabs-content {\n                    flex: 1;\n                    animation: svmFadeIn 0.3s ease;\n                }\n\n                .svm-sincere-text {\n                    font-size: 16px;\n                    line-height: 1.6;\n                    color: #4b5563;\n                    margin-bottom: 16px;\n                }\n\n                .svm-independence-badge {\n                    display: inline-block;\n                    padding: 6px 14px;\n                    background: #022c22;\n                    color: #fbbf24;\n                    border-radius: 100px;\n                    font-size: 13px;\n                    font-weight: 700;\n                }\n\n                .svm-warning-box {\n                    background: #fff8e1;\n                    border-left: 4px solid #fbbf24;\n                    padding: 16px;\n                    border-radius: 8px;\n                    margin-top: 20px;\n                }\n\n                .svm-warning-box strong {\n                    color: #92400e;\n                    display: block;\n                    margin-bottom: 4px;\n                }\n\n                .svm-warning-box p {\n                    font-size: 14px;\n                    color: #92400e;\n                    margin: 0;\n                    line-height: 1.4;\n                }\n\n                .svm-qr-section-compact {\n                    display: flex;\n                    align-items: center;\n                    gap: 16px;\n                    background: #f9fafb;\n                    padding: 16px;\n                    border-radius: 16px;\n                    border: 1px solid #e5e7eb;\n                }\n\n                .svm-qr-container {\n                    background: white;\n                    padding: 6px;\n                    border-radius: 8px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.05);\n                }\n\n                .svm-qr-text-compact strong {\n                    display: block;\n                    font-size: 14px;\n                    color: #022c22;\n                }\n\n                .svm-qr-text-compact p {\n                    font-size: 13px;\n                    color: #6b7280;\n                    margin: 0;\n                }\n\n                .svm-btn-next {\n                    background: #16a34a;\n                    color: white;\n                    border: none;\n                    padding: 12px 24px;\n                    border-radius: 12px;\n                    font-weight: 700;\n                    cursor: pointer;\n                    transition: 0.2s;\n                    margin-top: 20px;\n                }\n\n                .svm-btn-next:hover {\n                    background: #15803d;\n                    transform: translateX(4px);\n                }\n\n                .svm-btn-primary {\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    background: #16a34a;\n                    color: white;\n                    padding: 16px;\n                    border-radius: 14px;\n                    text-decoration: none;\n                    font-weight: 700;\n                    font-size: 16px;\n                }\n\n                @media (max-width: 768px) {\n                    .svm-modal-layout {\n                        flex-direction: column;\n                    }\n                    .svm-modal-visuals {\n                        flex: 0 0 200px;\n                    }\n                    .svm-modal-main {\n                        padding: 24px;\n                        min-height: auto;\n                    }\n                    .svm-compact-title {\n                        font-size: 26px;\n                    }\n                }\n\n                @keyframes svmFadeIn {\n                    from { opacity: 0; }\n                    to { opacity: 1; }\n                }\n\n                @keyframes svmPopIn {\n                    from { transform: scale(0.9) translateY(20px); opacity: 0; }\n                    to { transform: scale(1) translateY(0); opacity: 1; }\n                }\n            "}})]})},ge=()=>{var e,s,t,r,a;const{isChatListOpen:o,isSearchOpen:i,activeChats:l,totalUnreadCount:c,openChatList:d,closeChatList:m,openSearch:u,closeSearch:h,currentCall:p,callState:g,acceptCall:v,rejectCall:x,endCall:f,showDeviceSelector:b,handleDeviceSelectorComplete:C,handleDeviceSelectorCancel:y,callWindowRef:j,openDownloadModal:w}=W(),S=window.innerWidth<=768;return n.jsx("div",{className:"svmessenger-widget",children:(null==(e=window.SVMESSENGER_USER_DATA)?void 0:e.isAuthenticated)?n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"svmessenger-fab",onClick:()=>{S?w():d()},children:[n.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:n.jsx("path",{d:"M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"})}),c>0&&n.jsx("span",{className:"svmessenger-badge",children:c>99?"99+":c})]}),o&&n.jsx(Q,{onClose:m,onSearchClick:()=>{m(),u()}}),i&&n.jsx(de,{onClose:h}),l.map(e=>n.jsx(ce,{chat:e},e.conversation.id)),n.jsx(he,{isOpen:b,onComplete:C,onCancel:y}),"idle"!==g&&p&&p.conversation&&!j&&n.jsx(ue,{callState:g,conversation:p.conversation,onAccept:v,onReject:x,onEnd:f}),"idle"!==g&&p&&j&&n.jsx("div",{className:"svmessenger-call-indicator",children:n.jsxs("div",{className:"svmessenger-call-indicator-content",children:[n.jsx("div",{className:"svmessenger-call-indicator-icon",children:n.jsx("i",{className:"bi bi-headphones"})}),n.jsxs("div",{className:"svmessenger-call-indicator-text",children:[n.jsxs("div",{className:"svmessenger-call-indicator-title",children:["outgoing"===g&&"–û–±–∞–∂–¥–∞–Ω–µ...","incoming"===g&&"–í—Ö–æ–¥—è—â–æ –æ–±–∞–∂–¥–∞–Ω–µ","connected"===g&&"–í —Ä–∞–∑–≥–æ–≤–æ—Ä"]}),n.jsx("div",{className:"svmessenger-call-indicator-subtitle",children:(null==(t=null==(s=p.conversation)?void 0:s.otherUser)?void 0:t.realName)||(null==(a=null==(r=p.conversation)?void 0:r.otherUser)?void 0:a.username)||"–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª"})]}),n.jsx("button",{className:"svmessenger-call-indicator-close",onClick:f,title:"–ó–∞—Ç–≤–æ—Ä–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:n.jsx("i",{className:"bi bi-x"})})]})}),n.jsx(me,{}),n.jsx(pe,{})]}):n.jsx(pe,{})})};function ve(){const e=window.SVMESSENGER_USER_DATA||{isAuthenticated:!1};return n.jsx(q,{userData:e,children:n.jsx(ge,{})})}const xe=document.getElementById("svmessenger-root");xe?t.createRoot(xe).render(n.jsx(r.StrictMode,{children:n.jsx(ve,{})})):console.warn("SVMessenger: Root element #svmessenger-root not found");
