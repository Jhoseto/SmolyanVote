import{S as e,C as s}from"./svmessenger-vendor-websocket.js";const n=new class{constructor(){this.client=null,this.connected=!1,this.subscriptions=new Map,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=3e3}connect(n={}){const{onConnect:t=()=>{},onDisconnect:r=()=>{},onError:i=()=>{},onNewMessage:o=()=>{},onTypingStatus:c=()=>{},onReadReceipt:a=()=>{},onDeliveryReceipt:l=()=>{},onOnlineStatus:u=()=>{},onCallSignal:h=()=>{}}=n,p=new e("/ws-svmessenger");this.client=new s({webSocketFactory:()=>p,debug:e=>{},reconnectDelay:this.reconnectDelay,heartbeatIncoming:1e4,heartbeatOutgoing:1e4,onConnect:()=>{this.connected=!0,this.reconnectAttempts=0,this.subscribeToChannels({onNewMessage:o,onTypingStatus:c,onReadReceipt:a,onDeliveryReceipt:l,onOnlineStatus:u,onCallSignal:h}),t()},onStompError:e=>{console.error("STOMP error:",e),this.connected=!1,i(e),this.handleReconnect()},onWebSocketClose:()=>{this.connected=!1,r(),this.handleReconnect()}}),this.client.activate()}subscribeToChannels(e){const{onNewMessage:s,onTypingStatus:n,onReadReceipt:t,onDeliveryReceipt:r,onOnlineStatus:i,onCallSignal:o}=e,c=this.client.subscribe("/user/queue/svmessenger-messages",e=>{try{const n=JSON.parse(e.body);s(n)}catch(n){console.error("Error parsing message:",n)}});this.subscriptions.set("messages",c);const a=this.client.subscribe("/user/queue/svmessenger-read-receipts",e=>{try{const s=JSON.parse(e.body);t(s)}catch(s){console.error("Error parsing receipt:",s)}});this.subscriptions.set("receipts",a);const l=this.client.subscribe("/user/queue/svmessenger-delivery-receipts",e=>{try{const s=JSON.parse(e.body);r(s)}catch(s){console.error("Error parsing delivery receipt:",s)}});this.subscriptions.set("delivery",l);const u=this.client.subscribe("/topic/svmessenger-online-status",e=>{try{const s=JSON.parse(e.body);i(s)}catch(s){console.error("Error parsing status:",s)}});this.subscriptions.set("status",u);const h=this.client.subscribe("/user/queue/svmessenger-call-signals",e=>{try{const s=JSON.parse(e.body);o&&"function"==typeof o?o(s):console.error("onCallSignal is not a function:",typeof o)}catch(s){console.error("Error parsing call signal:",s)}});this.subscriptions.set("callSignals",h)}subscribeToTyping(e,s){if(!this.connected||!this.client)return console.warn("Cannot subscribe to typing - not connected"),null;const n=`/topic/svmessenger-typing/${e}`,t=this.client.subscribe(n,e=>{try{const n=JSON.parse(e.body);s(n)}catch(n){console.error("Error parsing typing status:",n)}}),r=`typing-${e}`;return this.subscriptions.set(r,t),t}unsubscribeFromTyping(e){const s=`typing-${e}`,n=this.subscriptions.get(s);n&&(n.unsubscribe(),this.subscriptions.delete(s))}sendMessage(e,s){if(!this.connected||!this.client)return console.warn("Cannot send message - not connected"),!1;try{return this.client.publish({destination:"/app/svmessenger/send",body:JSON.stringify({conversationId:e,text:s,messageType:"TEXT"})}),!0}catch(n){return console.error("Error sending message:",n),!1}}sendTypingStatus(e,s){if(!this.connected||!this.client)return!1;try{return this.client.publish({destination:"/app/svmessenger/typing",body:JSON.stringify({conversationId:e,isTyping:s})}),!0}catch(n){return console.error("Error sending typing status:",n),!1}}sendRead(e){if(!this.connected||!this.client)return console.warn("Cannot send mark-read - not connected"),!1;try{return this.client.publish({destination:"/app/svmessenger/mark-read",body:JSON.stringify({conversationId:e})}),!0}catch(s){return console.error("Error sending mark-read via WS:",s),!1}}handleReconnect(){this.reconnectAttempts>=this.maxReconnectAttempts?console.error("Max reconnect attempts reached"):this.reconnectAttempts++}disconnect(){this.client&&(this.subscriptions.forEach(e=>e.unsubscribe()),this.subscriptions.clear(),this.client.deactivate(),this.connected=!1)}isConnected(){return this.connected}sendCallSignal(e){if(!this.connected||!this.client)return console.warn("Cannot send call signal - not connected"),!1;try{return this.client.publish({destination:"/app/svmessenger/call-signal",body:JSON.stringify(e)}),!0}catch(s){return console.error("Error sending call signal:",s),!1}}};export{n as s};
