import{S as e,C as t}from"./svmessenger-vendor-websocket.js";const s=new class{constructor(){this.client=null,this.connected=!1,this.subscriptions=new Map,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=3e3}connect(s={}){const{onConnect:n=()=>{},onDisconnect:r=()=>{},onError:i=()=>{},onNewMessage:o=()=>{},onTypingStatus:c=()=>{},onReadReceipt:a=()=>{},onDeliveryReceipt:l=()=>{},onOnlineStatus:u=()=>{},onCallSignal:p=()=>{}}=s,h=new e("/ws-svmessenger");this.client=new t({webSocketFactory:()=>h,debug:e=>{},reconnectDelay:this.reconnectDelay,heartbeatIncoming:1e4,heartbeatOutgoing:1e4,onConnect:()=>{this.connected=!0,this.reconnectAttempts=0,this.subscribeToChannels({onNewMessage:o,onTypingStatus:c,onReadReceipt:a,onDeliveryReceipt:l,onOnlineStatus:u,onCallSignal:p}),n()},onStompError:e=>{console.error("STOMP error:",e),this.connected=!1,i(e),this.handleReconnect()},onWebSocketClose:()=>{this.connected=!1,r(),this.handleReconnect()}}),this.client.activate()}subscribeToChannels(e){const{onNewMessage:t,onTypingStatus:s,onReadReceipt:n,onDeliveryReceipt:r,onOnlineStatus:i,onCallSignal:o}=e,c=this.client.subscribe("/user/queue/svmessenger-messages",e=>{try{const s=JSON.parse(e.body);t(s)}catch(s){console.error("Error parsing message:",s)}});this.subscriptions.set("messages",c);const a=this.client.subscribe("/user/queue/svmessenger-read-receipts",e=>{try{const t=JSON.parse(e.body);n(t)}catch(t){console.error("Error parsing receipt:",t)}});this.subscriptions.set("receipts",a);const l=this.client.subscribe("/user/queue/svmessenger-delivery-receipts",e=>{try{const t=JSON.parse(e.body);r(t)}catch(t){console.error("Error parsing delivery receipt:",t)}});this.subscriptions.set("delivery",l);const u=this.client.subscribe("/topic/svmessenger-online-status",e=>{try{const t=JSON.parse(e.body);i(t)}catch(t){console.error("Error parsing status:",t)}});this.subscriptions.set("status",u);const p=this.client.subscribe("/user/queue/svmessenger-call-signals",e=>{try{const t=JSON.parse(e.body);o&&"function"==typeof o?o(t):console.error("onCallSignal is not a function:",typeof o)}catch(t){console.error("Error parsing call signal:",t)}});this.subscriptions.set("callSignals",p)}subscribeToTyping(e,t){if(!this.connected||!this.client)return console.warn("Cannot subscribe to typing - not connected"),null;const s=`/topic/svmessenger-typing/${e}`,n=this.client.subscribe(s,e=>{try{const s=JSON.parse(e.body);t(s)}catch(s){console.error("Error parsing typing status:",s)}}),r=`typing-${e}`;return this.subscriptions.set(r,n),n}unsubscribeFromTyping(e){const t=`typing-${e}`,s=this.subscriptions.get(t);s&&(s.unsubscribe(),this.subscriptions.delete(t))}sendMessage(e,t){if(!this.connected||!this.client)return console.warn("Cannot send message - not connected"),!1;try{return this.client.publish({destination:"/app/svmessenger/send",body:JSON.stringify({conversationId:e,text:t,messageType:"TEXT"})}),!0}catch(s){return console.error("Error sending message:",s),!1}}sendTypingStatus(e,t){if(!this.connected||!this.client)return!1;try{return this.client.publish({destination:"/app/svmessenger/typing",body:JSON.stringify({conversationId:e,isTyping:t})}),!0}catch(s){return console.error("Error sending typing status:",s),!1}}sendRead(e){if(!this.connected||!this.client)return console.warn("Cannot send mark-read - not connected"),!1;try{return this.client.publish({destination:"/app/svmessenger/mark-read",body:JSON.stringify({conversationId:e})}),!0}catch(t){return console.error("Error sending mark-read via WS:",t),!1}}handleReconnect(){this.reconnectAttempts>=this.maxReconnectAttempts?console.error("Max reconnect attempts reached"):this.reconnectAttempts++}disconnect(){this.client&&(this.subscriptions.forEach(e=>e.unsubscribe()),this.subscriptions.clear(),this.client.deactivate(),this.connected=!1)}isConnected(){return this.connected}sendCallSignal(e){if(!this.connected||!this.client)return console.warn("Cannot send call signal - not connected"),!1;try{return this.client.publish({destination:"/app/svmessenger/call-signal",body:JSON.stringify(e)}),!0}catch(t){return console.error("Error sending call signal:",t),!1}}},n=(e,t=100)=>e?e.length<=t?e:e.substring(0,t)+"...":"",r=(e,t=300)=>{let s;return function(...n){clearTimeout(s),s=setTimeout(()=>{clearTimeout(s),e(...n)},t)}},i=e=>{if(!e)return!1;return/^[\p{Emoji}\s]+$/u.test(e.trim())},o=e=>{if(!e)return"";return e.replace(/(https?:\/\/[^\s]+)/g,e=>`<a href="${e}" target="_blank" rel="noopener noreferrer">${e}</a>`)},c=e=>{if(!e)return"?";const t=e.trim();if(/^[\p{Emoji}\s]+$/u.test(t))return t.charAt(0).toUpperCase();const s=t.split(/\s+/).filter(e=>e.length>0);if(s.length>=2){const e=s[0].replace(/[\p{Emoji}]/gu,"").charAt(0),t=s[1].replace(/[\p{Emoji}]/gu,"").charAt(0);if(e&&t)return(e+t).toUpperCase();if(e)return e.toUpperCase();if(t)return t.toUpperCase()}const n=(s[0]||t).replace(/[\p{Emoji}]/gu,"").substring(0,2);return n.length>=2||1===n.length?n.toUpperCase():t.charAt(0).toUpperCase()},a=e=>{const t=["#0084ff","#00a8ff","#0066cc","#4a90e2","#7b68ee","#9b59b6","#e74c3c","#e67e22","#f39c12","#16a085","#27ae60","#2ecc71"];return t[e%t.length]},l=(e,t=!0)=>{e&&e.scrollTo({top:e.scrollHeight,behavior:t?"smooth":"auto"})},u=(e,t=50)=>{if(!e)return!0;const{scrollTop:s,scrollHeight:n,clientHeight:r}=e;return n-s-r<t};export{u as a,l as b,c,r as d,a as g,i,o as l,s,n as t};
