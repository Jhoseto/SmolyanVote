import{R as e,a as t,L as o,b as i}from"./svmessenger-vendor-livekit.js";import{S as a,C as s}from"./svmessenger-vendor-websocket.js";const n=new class{constructor(){this.client=null,this.connected=!1,this.subscriptions=new Map,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=3e3}connect(e={}){const{onConnect:t=()=>{},onDisconnect:o=()=>{},onError:i=()=>{},onNewMessage:n=()=>{},onTypingStatus:r=()=>{},onReadReceipt:c=()=>{},onDeliveryReceipt:l=()=>{},onOnlineStatus:d=()=>{},onCallSignal:h=()=>{}}=e,u=new a("/ws-svmessenger");this.client=new s({webSocketFactory:()=>u,debug:e=>{},reconnectDelay:this.reconnectDelay,heartbeatIncoming:1e4,heartbeatOutgoing:1e4,onConnect:()=>{this.connected=!0,this.reconnectAttempts=0,this.subscribeToChannels({onNewMessage:n,onTypingStatus:r,onReadReceipt:c,onDeliveryReceipt:l,onOnlineStatus:d,onCallSignal:h}),t()},onStompError:e=>{console.error("STOMP error:",e),this.connected=!1,i(e),this.handleReconnect()},onWebSocketClose:()=>{this.connected=!1,o(),this.handleReconnect()}}),this.client.activate()}subscribeToChannels(e){const{onNewMessage:t,onTypingStatus:o,onReadReceipt:i,onDeliveryReceipt:a,onOnlineStatus:s,onCallSignal:n}=e,r=this.client.subscribe("/user/queue/svmessenger-messages",e=>{try{const o=JSON.parse(e.body);t(o)}catch(o){console.error("Error parsing message:",o)}});this.subscriptions.set("messages",r);const c=this.client.subscribe("/user/queue/svmessenger-read-receipts",e=>{try{const t=JSON.parse(e.body);i(t)}catch(t){console.error("Error parsing receipt:",t)}});this.subscriptions.set("receipts",c);const l=this.client.subscribe("/user/queue/svmessenger-delivery-receipts",e=>{try{const t=JSON.parse(e.body);a(t)}catch(t){console.error("Error parsing delivery receipt:",t)}});this.subscriptions.set("delivery",l);const d=this.client.subscribe("/topic/svmessenger-online-status",e=>{try{const t=JSON.parse(e.body);s(t)}catch(t){console.error("Error parsing status:",t)}});this.subscriptions.set("status",d);const h=this.client.subscribe("/user/queue/svmessenger-call-signals",e=>{try{const t=JSON.parse(e.body);n&&"function"==typeof n?n(t):console.error("onCallSignal is not a function:",typeof n)}catch(t){console.error("Error parsing call signal:",t)}});this.subscriptions.set("callSignals",h)}subscribeToTyping(e,t){if(!this.connected||!this.client)return console.warn("Cannot subscribe to typing - not connected"),null;const o=`/topic/svmessenger-typing/${e}`,i=this.client.subscribe(o,e=>{try{const o=JSON.parse(e.body);t(o)}catch(o){console.error("Error parsing typing status:",o)}}),a=`typing-${e}`;return this.subscriptions.set(a,i),i}unsubscribeFromTyping(e){const t=`typing-${e}`,o=this.subscriptions.get(t);o&&(o.unsubscribe(),this.subscriptions.delete(t))}sendMessage(e,t){if(!this.connected||!this.client)return console.warn("Cannot send message - not connected"),!1;try{return this.client.publish({destination:"/app/svmessenger/send",body:JSON.stringify({conversationId:e,text:t,messageType:"TEXT"})}),!0}catch(o){return console.error("Error sending message:",o),!1}}sendTypingStatus(e,t){if(!this.connected||!this.client)return!1;try{return this.client.publish({destination:"/app/svmessenger/typing",body:JSON.stringify({conversationId:e,isTyping:t})}),!0}catch(o){return console.error("Error sending typing status:",o),!1}}sendRead(e){if(!this.connected||!this.client)return console.warn("Cannot send mark-read - not connected"),!1;try{return this.client.publish({destination:"/app/svmessenger/mark-read",body:JSON.stringify({conversationId:e})}),!0}catch(t){return console.error("Error sending mark-read via WS:",t),!1}}handleReconnect(){this.reconnectAttempts>=this.maxReconnectAttempts?console.error("Max reconnect attempts reached"):this.reconnectAttempts++}disconnect(){this.client&&(this.subscriptions.forEach(e=>e.unsubscribe()),this.subscriptions.clear(),this.client.deactivate(),this.connected=!1)}isConnected(){return this.connected}sendCallSignal(e){if(!this.connected||!this.client)return console.warn("Cannot send call signal - not connected"),!1;try{return this.client.publish({destination:"/app/svmessenger/call-signal",body:JSON.stringify(e)}),!0}catch(t){return console.error("Error sending call signal:",t),!1}}};const r=new class{constructor(){this.room=null,this.isConnected=!1,this.currentRoomName=null,this.selectedMicrophone=null,this.selectedSpeaker=null,this.audioStream=null,this.remoteAudioElements=new Map,this.selectedCamera=null,this.videoStream=null,this.localVideoTrack=null,this.remoteVideoElements=new Map,this.isVideoEnabled=!1,this.connectionQuality="excellent",this.currentVideoQuality="high",this.videoQualityPresets={high:{width:1920,height:1080,frameRate:30,bitrate:5e6,label:"Full HD (1080p)"},medium:{width:1280,height:720,frameRate:30,bitrate:3e6,label:"HD (720p)"},low:{width:854,height:480,frameRate:24,bitrate:15e5,label:"SD (480p)"}},this.onConnected=null,this.onDisconnected=null,this.onParticipantConnected=null,this.onParticipantDisconnected=null,this.onTrackSubscribed=null,this.onTrackUnsubscribed=null,this.onConnectionQualityChanged=null}async connect(i,a){try{if(this.room&&this.isConnected&&await this.disconnect(),this.room=new e,this.currentRoomName=a,this.room.on(t.Connected,()=>{this.isConnected=!0,this.onConnected&&this.onConnected()}),this.room.on(t.Disconnected,()=>{this.isConnected=!1,this.onDisconnected&&this.onDisconnected()}),this.room.on(t.ParticipantConnected,e=>{e.audioTrackPublications.forEach(t=>{t.track&&this.attachRemoteAudioTrack(t.track,e.identity)}),this.onParticipantConnected&&this.onParticipantConnected(e)}),this.room.on(t.ParticipantDisconnected,e=>{this.onParticipantDisconnected&&this.onParticipantDisconnected(e)}),this.room.on(t.TrackSubscribed,(e,t,o)=>{"audio"===e.kind&&this.attachRemoteAudioTrack(e,o.identity),"video"===e.kind&&this.attachRemoteVideoTrack(e,o.identity),this.onTrackSubscribed&&this.onTrackSubscribed(e,t,o)}),this.room.on(t.TrackUnsubscribed,(e,t,o)=>{"audio"===e.kind&&this.detachRemoteAudioTrack(o.identity),"video"===e.kind&&this.detachRemoteVideoTrack(o.identity),this.onTrackUnsubscribed&&this.onTrackUnsubscribed(e,t,o)}),this.room.on(t.ConnectionQualityChanged,(e,t)=>{t&&t!==this.room.localParticipant||this.handleConnectionQualityChanged(e)}),await this.room.connect("wss://smolyanvote-nq17fbx3.livekit.cloud",i),await new Promise(e=>setTimeout(e,300)),this.selectedMicrophone&&this.audioStream)try{const e=Array.from(this.room.localParticipant.audioTrackPublications.values());for(const o of e)o.track&&await this.room.localParticipant.unpublishTrack(o.track);const t=this.audioStream.getAudioTracks();if(t.length>0){const e=t[0],i=new o(e);await this.room.localParticipant.publishTrack(i,{source:"microphone"})}}catch(s){try{await this.room.localParticipant.setMicrophoneEnabled(!0)}catch(n){console.error("Failed to enable default microphone:",n)}}else if(this.selectedMicrophone)try{await this.room.localParticipant.setMicrophoneEnabled(!0)}catch(r){console.error("Failed to enable default microphone:",r)}else try{await this.room.localParticipant.setMicrophoneEnabled(!0)}catch(r){console.error("Failed to enable default microphone:",r)}return!0}catch(r){throw console.error("Failed to connect to LiveKit room:",r),this.isConnected=!1,r}}async disconnect(){try{this.remoteAudioElements.forEach((e,t)=>{this.detachRemoteAudioTrack(t)}),this.remoteAudioElements.clear(),this.remoteVideoElements.forEach((e,t)=>{this.detachRemoteVideoTrack(t)}),this.remoteVideoElements.clear(),this.stopVideoStream(),this.isVideoEnabled=!1,this.localVideoTrack=null,this.room&&(await this.room.disconnect(),this.room=null,this.isConnected=!1,this.currentRoomName=null)}catch(e){console.error("Error disconnecting from LiveKit:",e)}}async toggleMicrophone(e){try{if(!this.room||!this.isConnected)throw new Error("Not connected to room");const t=this.room.localParticipant;return e?await t.setMicrophoneEnabled(!0):await t.setMicrophoneEnabled(!1),e}catch(t){throw console.error("Error toggling microphone:",t),t}}isMicrophoneEnabled(){return!(!this.room||!this.isConnected)&&this.room.localParticipant.isMicrophoneEnabled}getParticipants(){return this.room?Array.from(this.room.participants.values()):[]}async requestAudioPermissions(){try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:48e3}});return this.audioStream=e,await this.enumerateAudioDevices(),!0}catch(e){throw console.error("âŒ Audio permissions denied:",e),e}}async enumerateAudioDevices(){try{const e=await navigator.mediaDevices.enumerateDevices(),t=e.filter(e=>"audioinput"===e.kind),o=e.filter(e=>"audiooutput"===e.kind);return t.length>0&&!this.selectedMicrophone&&(this.selectedMicrophone=t[0].deviceId),o.length>0&&!this.selectedSpeaker&&(this.selectedSpeaker=o[0].deviceId),{microphones:t,speakers:o}}catch(e){throw console.error("âŒ Error enumerating devices:",e),e}}async setMicrophone(e){try{let s;this.selectedMicrophone=e,this.audioStream&&(this.audioStream.getTracks().forEach(e=>e.stop()),this.audioStream=null);try{s=await navigator.mediaDevices.getUserMedia({audio:{deviceId:!e||{ideal:e},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})}catch(t){s=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})}if(this.audioStream=s,this.room&&this.isConnected)try{await this.room.localParticipant.setMicrophoneEnabled(!1);const e=Array.from(this.room.localParticipant.audioTrackPublications.values());for(const o of e)o.track&&await this.room.localParticipant.unpublishTrack(o.track);const t=s.getAudioTracks();if(0===t.length)throw new Error("No audio track found in stream");const i=t[0],a=new o(i);await this.room.localParticipant.publishTrack(a,{source:"microphone"})}catch(i){try{await this.room.localParticipant.setMicrophoneEnabled(!0)}catch(a){console.error("Failed to enable default microphone:",a)}}}catch(s){try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});this.audioStream=e}catch(a){throw console.error("Failed to get any microphone:",a),a}}}attachRemoteAudioTrack(e,t){try{this.detachRemoteAudioTrack(t);const o=document.createElement("audio");o.autoplay=!0,o.playsInline=!0,o.volume=1,this.selectedSpeaker&&"setSinkId"in HTMLAudioElement.prototype&&o.setSinkId(this.selectedSpeaker).catch(()=>{}),e.attach(o),this.remoteAudioElements.set(t,o),o.addEventListener("error",e=>{console.error("Remote audio error for:",t,e)});const i=o.play();void 0!==i&&i.catch(()=>{document.addEventListener("click",()=>{o.play().catch(()=>{})},{once:!0})})}catch(o){console.error("Error attaching remote audio track:",o)}}detachRemoteAudioTrack(e){const t=this.remoteAudioElements.get(e);t&&(t.pause(),t.srcObject=null,t.remove(),this.remoteAudioElements.delete(e))}async setSpeaker(e){try{this.selectedSpeaker=e,"setSinkId"in HTMLAudioElement.prototype&&this.remoteAudioElements.forEach(t=>{t.setSinkId(e).catch(()=>{})})}catch(t){throw console.error("Error setting speaker:",t),t}}getSelectedDevices(){return{microphone:this.selectedMicrophone,speaker:this.selectedSpeaker,camera:this.selectedCamera}}async toggleCamera(e){if(console.log("ðŸŽ¥ [toggleCamera] START",{enabled:e,hasRoom:!!this.room,isConnected:this.isConnected}),!this.room||!this.isConnected)return console.warn("âš ï¸ [toggleCamera] Cannot toggle camera - not in a call",{hasRoom:!!this.room,isConnected:this.isConnected}),!1;try{if(e){console.log("ðŸŽ¥ [toggleCamera] ENABLING camera...");const e="excellent"===this.connectionQuality||"good"===this.connectionQuality?"high":"poor"===this.connectionQuality?"medium":"low",t=this.videoQualityPresets[e];console.log("ðŸŽ¥ [toggleCamera] Video quality:",{initialQuality:e,preset:t,connectionQuality:this.connectionQuality});const o=Array.from(this.room.localParticipant.videoTrackPublications.values());console.log("ðŸŽ¥ [toggleCamera] Existing video tracks:",o.length);for(const i of o)i.track&&(console.log("ðŸŽ¥ [toggleCamera] Unpublishing existing track:",i.trackSid),await this.room.localParticipant.unpublishTrack(i.track),i.track.stop());this.videoStream&&(console.log("ðŸŽ¥ [toggleCamera] Stopping existing video stream"),this.videoStream.getTracks().forEach(e=>e.stop()),this.videoStream=null),this.localVideoTrack&&(console.log("ðŸŽ¥ [toggleCamera] Stopping existing local video track"),this.localVideoTrack.stop(),this.localVideoTrack=null);const a={width:{ideal:t.width},height:{ideal:t.height},frameRate:{ideal:t.frameRate}};this.selectedCamera?(a.deviceId={exact:this.selectedCamera},console.log("ðŸŽ¥ [toggleCamera] Using selected camera:",this.selectedCamera)):console.log("ðŸŽ¥ [toggleCamera] No camera selected, using default"),console.log("ðŸŽ¥ [toggleCamera] Requesting getUserMedia with constraints:",a);const s=await navigator.mediaDevices.getUserMedia({video:a});console.log("ðŸŽ¥ [toggleCamera] getUserMedia success, stream:",{id:s.id,active:s.active,tracks:s.getTracks().length}),this.videoStream=s;const n=s.getVideoTracks();if(console.log("ðŸŽ¥ [toggleCamera] Video tracks in stream:",n.length),0===n.length)throw new Error("No video track in stream");const r=n[0];console.log("ðŸŽ¥ [toggleCamera] MediaStreamTrack:",{id:r.id,kind:r.kind,label:r.label,enabled:r.enabled,readyState:r.readyState}),console.log("ðŸŽ¥ [toggleCamera] Creating LocalVideoTrack...");const c=new i(r);console.log("ðŸŽ¥ [toggleCamera] LocalVideoTrack created:",{sid:c.sid,kind:c.kind,isMuted:c.isMuted,isEnabled:c.isEnabled}),console.log("ðŸŽ¥ [toggleCamera] Publishing video track..."),await this.room.localParticipant.publishTrack(c,{source:"camera"}),console.log("ðŸŽ¥ [toggleCamera] Video track published successfully"),this.localVideoTrack=c,this.isVideoEnabled=!0,this.currentVideoQuality=e;const l=Array.from(this.room.localParticipant.videoTrackPublications.values());console.log(`âœ… [toggleCamera] Camera enabled with ${t.label}${this.selectedCamera?` (device: ${this.selectedCamera})`:""} - VIDEO TRACK PUBLISHED - now billing as video call`),console.log("ðŸŽ¥ [toggleCamera] Published tracks count:",l.length),l.forEach((e,t)=>{var o;console.log(`  Track ${t+1}:`,{trackSid:e.trackSid,source:e.source,hasTrack:!!e.track,trackId:null==(o=e.track)?void 0:o.id})})}else{console.log("ðŸŽ¥ [toggleCamera] DISABLING camera...");const e=Array.from(this.room.localParticipant.videoTrackPublications.values());console.log("ðŸŽ¥ [toggleCamera] Unpublishing",e.length,"video tracks");for(const t of e)t.track&&(console.log("ðŸŽ¥ [toggleCamera] Unpublishing track:",t.trackSid),await this.room.localParticipant.unpublishTrack(t.track),t.track.stop());this.localVideoTrack&&(console.log("ðŸŽ¥ [toggleCamera] Stopping local video track"),this.localVideoTrack.stop(),this.localVideoTrack=null),this.videoStream&&(console.log("ðŸŽ¥ [toggleCamera] Stopping video stream"),this.videoStream.getTracks().forEach(e=>e.stop()),this.videoStream=null),this.isVideoEnabled=!1,console.log("âœ… [toggleCamera] Camera disabled - now billing as audio-only call")}return!0}catch(t){return console.error("âŒ [toggleCamera] Failed to toggle camera:",t),console.error("âŒ [toggleCamera] Error details:",{name:t.name,message:t.message,stack:t.stack}),!1}}async setCamera(e){if(this.selectedCamera=e,this.room&&this.isConnected&&this.isVideoEnabled)try{await this.switchCamera(e),console.log("âœ… Camera switched during call:",e)}catch(t){console.error("âŒ Failed to switch camera during call:",t)}}isCameraEnabled(){return this.room&&this.isConnected&&this.room.localParticipant.isCameraEnabled||!1}async getCameras(){try{const e=(await navigator.mediaDevices.enumerateDevices()).filter(e=>"videoinput"===e.kind);return e.length>0&&!this.selectedCamera&&(this.selectedCamera=e[0].deviceId),e}catch(e){return console.error("âŒ Failed to enumerate cameras:",e),[]}}async switchCamera(e){if(!this.room||!this.isConnected)return this.selectedCamera=e,!1;try{return await this.room.localParticipant.switchActiveDevice("videoinput",e),this.selectedCamera=e,console.log("âœ… Switched to camera:",e),!0}catch(t){return console.error("âŒ Failed to switch camera:",t),!1}}attachRemoteVideoTrack(e,t){try{this.detachRemoteVideoTrack(t);const o=document.createElement("video");return o.autoplay=!0,o.playsInline=!0,o.muted=!1,o.style.width="100%",o.style.height="100%",o.style.objectFit="cover",o.style.backgroundColor="#000",e.attach(o),this.remoteVideoElements.set(t,{element:o,track:e}),console.log("âœ… Remote video attached for:",t),o}catch(o){return console.error("âŒ Error attaching remote video track:",o),null}}detachRemoteVideoTrack(e){const t=this.remoteVideoElements.get(e);t&&(t.track.detach(t.element),t.element.remove(),this.remoteVideoElements.delete(e),console.log("âœ… Remote video detached for:",e))}async requestCameraPermissions(){try{const e=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1920,min:1280},height:{ideal:1080,min:720},frameRate:{ideal:30,min:24},aspectRatio:{ideal:16/9}}});return this.videoStream=e,await this.getCameras(),!0}catch(e){throw console.error("âŒ Camera permissions denied:",e),e}}stopVideoStream(){this.videoStream&&(this.videoStream.getTracks().forEach(e=>e.stop()),this.videoStream=null)}async handleConnectionQualityChanged(e){const t=this.connectionQuality;let o;this.connectionQuality=e,console.log(`ðŸ“¡ Connection quality changed: ${t} â†’ ${e}`),o="excellent"===e||"good"===e?"high":"poor"===e?"medium":"low",this.isVideoEnabled&&o!==this.currentVideoQuality&&(console.log(`ðŸŽ¥ Adjusting video quality: ${this.currentVideoQuality} â†’ ${o}`),await this.adjustVideoQuality(o)),this.onConnectionQualityChanged&&this.onConnectionQualityChanged(e,o)}async adjustVideoQuality(e){if(!this.room||!this.isConnected||!this.isVideoEnabled)return console.warn("âš ï¸ Cannot adjust video quality - not in video call"),!1;if(!this.videoQualityPresets[e])return console.error("âŒ Invalid video quality preset:",e),!1;try{const t=this.videoQualityPresets[e],o=this.room.localParticipant,i=Array.from(o.videoTrackPublications.values());if(0===i.length)return console.warn("âš ï¸ No video track to adjust"),!1;const a=i[0];return a.track?(await a.track.setVideoQuality({width:t.width,height:t.height,frameRate:t.frameRate,maxBitrate:t.bitrate}),this.currentVideoQuality=e,console.log(`âœ… Video quality adjusted to ${t.label}`),!0):(console.warn("âš ï¸ Video track not available"),!1)}catch(t){return console.error("âŒ Failed to adjust video quality:",t),!1}}getVideoQualityInfo(){const e=this.videoQualityPresets[this.currentVideoQuality];return{connectionQuality:this.connectionQuality,videoQuality:this.currentVideoQuality,preset:e,isVideoEnabled:this.isVideoEnabled}}async setVideoQuality(e){return this.videoQualityPresets[e]?(console.log(`ðŸŽ¬ Manually setting video quality to ${e}`),await this.adjustVideoQuality(e)):(console.error("âŒ Invalid video quality:",e),!1)}};window.svLiveKitService=r,window.svWebSocketService=n;const c=(e,t=100)=>e?e.length<=t?e:e.substring(0,t)+"...":"",l=(e,t=300)=>{let o;return function(...i){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),e(...i)},t)}},d=e=>{if(!e)return!1;return/^[\p{Emoji}\s]+$/u.test(e.trim())},h=e=>{if(!e)return"";return e.replace(/(https?:\/\/[^\s]+)/g,e=>`<a href="${e}" target="_blank" rel="noopener noreferrer">${e}</a>`)},u=e=>{if(!e)return"?";const t=e.trim();if(/^[\p{Emoji}\s]+$/u.test(t))return t.charAt(0).toUpperCase();const o=t.split(/\s+/).filter(e=>e.length>0);if(o.length>=2){const e=o[0].replace(/[\p{Emoji}]/gu,"").charAt(0),t=o[1].replace(/[\p{Emoji}]/gu,"").charAt(0);if(e&&t)return(e+t).toUpperCase();if(e)return e.toUpperCase();if(t)return t.toUpperCase()}const i=(o[0]||t).replace(/[\p{Emoji}]/gu,"").substring(0,2);return i.length>=2||1===i.length?i.toUpperCase():t.charAt(0).toUpperCase()},m=e=>{const t=["#0084ff","#00a8ff","#0066cc","#4a90e2","#7b68ee","#9b59b6","#e74c3c","#e67e22","#f39c12","#16a085","#27ae60","#2ecc71"];return t[e%t.length]},g=(e,t=!0)=>{e&&e.scrollTo({top:e.scrollHeight,behavior:t?"smooth":"auto"})},p=(e,t=50)=>{if(!e)return!0;const{scrollTop:o,scrollHeight:i,clientHeight:a}=e;return i-o-a<t};export{r as a,p as b,g as c,l as d,u as e,m as g,d as i,h as l,n as s,c as t};
