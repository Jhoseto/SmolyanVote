import{c as t,u as e,i as n,g as i}from"./svmessenger-vendor.js";var s={exports:{}},r={};t.crypto&&t.crypto.getRandomValues?r.randomBytes=function(e){var n=new Uint8Array(e);return t.crypto.getRandomValues(n),n}:r.randomBytes=function(t){for(var e=new Array(t),n=0;n<t;n++)e[n]=Math.floor(256*Math.random());return e};var o=r,a="abcdefghijklmnopqrstuvwxyz012345",c={string:function(t){for(var e=o.randomBytes(t),n=[],i=0;i<t;i++)n.push(a.substr(e[i]%32,1));return n.join("")},number:function(t){return Math.floor(Math.random()*t)},numberString:function(t){var e=(""+(t-1)).length;return(new Array(e+1).join("0")+this.number(t)).slice(-e)}};!function(e){var n=c,i={},s=!1,r=t.chrome&&t.chrome.app&&t.chrome.app.runtime;e.exports={attachEvent:function(e,n){void 0!==t.addEventListener?t.addEventListener(e,n,!1):t.document&&t.attachEvent&&(t.document.attachEvent("on"+e,n),t.attachEvent("on"+e,n))},detachEvent:function(e,n){void 0!==t.addEventListener?t.removeEventListener(e,n,!1):t.document&&t.detachEvent&&(t.document.detachEvent("on"+e,n),t.detachEvent("on"+e,n))},unloadAdd:function(t){if(r)return null;var e=n.string(8);return i[e]=t,s&&setTimeout(this.triggerUnloadCallbacks,0),e},unloadDel:function(t){t in i&&delete i[t]},triggerUnloadCallbacks:function(){for(var t in i)i[t](),delete i[t]}};r||e.exports.attachEvent("unload",function(){s||(s=!0,e.exports.triggerUnloadCallbacks())})}(s);var h=s.exports,l=e,d={getOrigin:function(t){if(!t)return null;var e=new l(t);if("file:"===e.protocol)return null;var n=e.port;return n||(n="https:"===e.protocol?"443":"80"),e.protocol+"//"+e.hostname+":"+n},isOriginEqual:function(t,e){return this.getOrigin(t)===this.getOrigin(e)},isSchemeEqual:function(t,e){return t.split(":")[0]===e.split(":")[0]},addPath:function(t,e){var n=t.split("?");return n[0]+e+(n[1]?"?"+n[1]:"")},addQuery:function(t,e){return t+(-1===t.indexOf("?")?"?"+e:"&"+e)},isLoopbackAddr:function(t){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(t)||/^\[::1\]$/.test(t)}},u={};function p(){this._listeners={}}p.prototype.addEventListener=function(t,e){t in this._listeners||(this._listeners[t]=[]);var n=this._listeners[t];-1===n.indexOf(e)&&(n=n.concat([e])),this._listeners[t]=n},p.prototype.removeEventListener=function(t,e){var n=this._listeners[t];if(n){var i=n.indexOf(e);-1===i||(n.length>1?this._listeners[t]=n.slice(0,i).concat(n.slice(i+1)):delete this._listeners[t])}},p.prototype.dispatchEvent=function(){var t=arguments[0],e=t.type,n=1===arguments.length?[t]:Array.apply(null,arguments);if(this["on"+e]&&this["on"+e].apply(this,n),e in this._listeners)for(var i=this._listeners[e],s=0;s<i.length;s++)i[s].apply(this,n)};var f=p,m=f;function b(){m.call(this)}n(b,m),b.prototype.removeAllListeners=function(t){t?delete this._listeners[t]:this._listeners={}},b.prototype.once=function(t,e){var n=this,i=!1;this.on(t,function s(){n.removeListener(t,s),i||(i=!0,e.apply(this,arguments))})},b.prototype.emit=function(){var t=arguments[0],e=this._listeners[t];if(e){for(var n=arguments.length,i=new Array(n-1),s=1;s<n;s++)i[s-1]=arguments[s];for(var r=0;r<e.length;r++)e[r].apply(this,i)}},b.prototype.on=b.prototype.addListener=m.prototype.addEventListener,b.prototype.removeListener=m.prototype.removeEventListener,u.EventEmitter=b;var _={exports:{}},y=t.WebSocket||t.MozWebSocket;_.exports=y?function(t){return new y(t)}:void 0;var g=_.exports,v=h,w=d,E=n,S=u.EventEmitter,k=g;function T(t,e,n){if(!T.enabled())throw new Error("Transport created when disabled");S.call(this);var i=this,s=w.addPath(t,"/websocket");s="https"===s.slice(0,5)?"wss"+s.slice(5):"ws"+s.slice(4),this.url=s,this.ws=new k(this.url,[],n),this.ws.onmessage=function(t){t.data,i.emit("message",t.data)},this.unloadRef=v.unloadAdd(function(){i.ws.close()}),this.ws.onclose=function(t){t.code,t.reason,i.emit("close",t.code,t.reason),i._cleanup()},this.ws.onerror=function(t){i.emit("close",1006,"WebSocket connection broken"),i._cleanup()}}E(T,S),T.prototype.send=function(t){var e="["+t+"]";this.ws.send(e)},T.prototype.close=function(){var t=this.ws;this._cleanup(),t&&t.close()},T.prototype._cleanup=function(){var t=this.ws;t&&(t.onmessage=t.onclose=t.onerror=null),v.unloadDel(this.unloadRef),this.unloadRef=this.ws=null,this.removeAllListeners()},T.enabled=function(){return!!k},T.transportName="websocket",T.roundTrips=2;var C=T,x=n,O=u.EventEmitter;function N(t,e){O.call(this),this.sendBuffer=[],this.sender=e,this.url=t}x(N,O),N.prototype.send=function(t){this.sendBuffer.push(t),this.sendStop||this.sendSchedule()},N.prototype.sendScheduleWait=function(){var t,e=this;this.sendStop=function(){e.sendStop=null,clearTimeout(t)},t=setTimeout(function(){e.sendStop=null,e.sendSchedule()},25)},N.prototype.sendSchedule=function(){this.sendBuffer.length;var t=this;if(this.sendBuffer.length>0){var e="["+this.sendBuffer.join(",")+"]";this.sendStop=this.sender(this.url,e,function(e){t.sendStop=null,e?(t.emit("close",e.code||1006,"Sending error: "+e),t.close()):t.sendScheduleWait()}),this.sendBuffer=[]}},N.prototype._cleanup=function(){this.removeAllListeners()},N.prototype.close=function(){this._cleanup(),this.sendStop&&(this.sendStop(),this.sendStop=null)};var I=N,A=n,R=u.EventEmitter;function H(t,e,n){R.call(this),this.Receiver=t,this.receiveUrl=e,this.AjaxObject=n,this._scheduleReceiver()}A(H,R),H.prototype._scheduleReceiver=function(){var t=this,e=this.poll=new this.Receiver(this.receiveUrl,this.AjaxObject);e.on("message",function(e){t.emit("message",e)}),e.once("close",function(n,i){t.pollIsClosing,t.poll=e=null,t.pollIsClosing||("network"===i?t._scheduleReceiver():(t.emit("close",n||1006,i),t.removeAllListeners()))})},H.prototype.abort=function(){this.removeAllListeners(),this.pollIsClosing=!0,this.poll&&this.poll.abort()};var W=d,L=I,B=H;function D(t,e,n,i,s){var r=W.addPath(t,e),o=this;L.call(this,t,n),this.poll=new B(i,r,s),this.poll.on("message",function(t){o.emit("message",t)}),this.poll.once("close",function(t,e){o.poll=null,o.emit("close",t,e),o.close()})}n(D,L),D.prototype.close=function(){L.prototype.close.call(this),this.removeAllListeners(),this.poll&&(this.poll.abort(),this.poll=null)};var U=D,j=d,P=U;function V(t,e,n,i){P.call(this,t,e,function(t){return function(e,n,i){var s={};"string"==typeof n&&(s.headers={"Content-type":"text/plain"});var r=j.addPath(e,"/xhr_send"),o=new t("POST",r,n,s);return o.once("finish",function(t){if(o=null,200!==t&&204!==t)return i(new Error("http status "+t));i()}),function(){o.close(),o=null;var t=new Error("Aborted");t.code=1e3,i(t)}}}(i),n,i)}n(V,P);var M=V,F=n,G=u.EventEmitter;function $(t,e){G.call(this);var n=this;this.bufferPosition=0,this.xo=new e("POST",t,null),this.xo.on("chunk",this._chunkHandler.bind(this)),this.xo.once("finish",function(t,e){n._chunkHandler(t,e),n.xo=null;var i=200===t?"network":"permanent";n.emit("close",null,i),n._cleanup()})}F($,G),$.prototype._chunkHandler=function(t,e){if(200===t&&e)for(var n=-1;;this.bufferPosition+=n+1){var i=e.slice(this.bufferPosition);if(-1===(n=i.indexOf("\n")))break;var s=i.slice(0,n);s&&this.emit("message",s)}},$.prototype._cleanup=function(){this.removeAllListeners()},$.prototype.abort=function(){this.xo&&(this.xo.close(),this.emit("close",null,"user"),this.xo=null),this._cleanup()};var J=$,q=u.EventEmitter,z=n,X=h,K=d,Q=t.XMLHttpRequest;function Y(t,e,n,i){var s=this;q.call(this),setTimeout(function(){s._start(t,e,n,i)},0)}z(Y,q),Y.prototype._start=function(t,e,n,i){var s=this;try{this.xhr=new Q}catch(o){}if(!this.xhr)return this.emit("finish",0,"no xhr support"),void this._cleanup();e=K.addQuery(e,"t="+ +new Date),this.unloadRef=X.unloadAdd(function(){s._cleanup(!0)});try{this.xhr.open(t,e,!0),this.timeout&&"timeout"in this.xhr&&(this.xhr.timeout=this.timeout,this.xhr.ontimeout=function(){s.emit("finish",0,""),s._cleanup(!1)})}catch(a){return this.emit("finish",0,""),void this._cleanup(!1)}if(i&&i.noCredentials||!Y.supportsCORS||(this.xhr.withCredentials=!0),i&&i.headers)for(var r in i.headers)this.xhr.setRequestHeader(r,i.headers[r]);this.xhr.onreadystatechange=function(){if(s.xhr){var t,e,n=s.xhr;switch(n.readyState,n.readyState){case 3:try{e=n.status,t=n.responseText}catch(a){}1223===e&&(e=204),200===e&&t&&t.length>0&&s.emit("chunk",e,t);break;case 4:1223===(e=n.status)&&(e=204),12005!==e&&12029!==e||(e=0),n.responseText,s.emit("finish",e,n.responseText),s._cleanup(!1)}}};try{s.xhr.send(n)}catch(a){s.emit("finish",0,""),s._cleanup(!1)}},Y.prototype._cleanup=function(t){if(this.xhr){if(this.removeAllListeners(),X.unloadDel(this.unloadRef),this.xhr.onreadystatechange=function(){},this.xhr.ontimeout&&(this.xhr.ontimeout=null),t)try{this.xhr.abort()}catch(e){}this.unloadRef=this.xhr=null}},Y.prototype.close=function(){this._cleanup(!0)},Y.enabled=!!Q;var Z=["Active"].concat("Object").join("X");!Y.enabled&&Z in t&&(Q=function(){try{return new t[Z]("Microsoft.XMLHTTP")}catch(e){return null}},Y.enabled=!!new Q);var tt=!1;try{tt="withCredentials"in new Q}catch(zi){}Y.supportsCORS=tt;var et=Y,nt=et;function it(t,e,n,i){nt.call(this,t,e,n,i)}n(it,nt),it.enabled=nt.enabled&&nt.supportsCORS;var st=it,rt=et;function ot(t,e,n){rt.call(this,t,e,n,{noCredentials:!0})}n(ot,rt),ot.enabled=rt.enabled;var at=ot,ct={isOpera:function(){return t.navigator&&/opera/i.test(t.navigator.userAgent)},isKonqueror:function(){return t.navigator&&/konqueror/i.test(t.navigator.userAgent)},hasDomain:function(){if(!t.document)return!0;try{return!!t.document.domain}catch(e){return!1}}},ht=M,lt=J,dt=st,ut=at,pt=ct;function ft(t){if(!ut.enabled&&!dt.enabled)throw new Error("Transport created when disabled");ht.call(this,t,"/xhr_streaming",lt,dt)}n(ft,ht),ft.enabled=function(t){return!t.nullOrigin&&(!pt.isOpera()&&dt.enabled)},ft.transportName="xhr-streaming",ft.roundTrips=2,ft.needBody=!!t.document;var mt=ft,bt=u.EventEmitter,_t=h,yt=ct,gt=d;function vt(t,e,n){var i=this;bt.call(this),setTimeout(function(){i._start(t,e,n)},0)}n(vt,bt),vt.prototype._start=function(e,n,i){var s=this,r=new t.XDomainRequest;n=gt.addQuery(n,"t="+ +new Date),r.onerror=function(){s._error()},r.ontimeout=function(){s._error()},r.onprogress=function(){r.responseText,s.emit("chunk",200,r.responseText)},r.onload=function(){s.emit("finish",200,r.responseText),s._cleanup(!1)},this.xdr=r,this.unloadRef=_t.unloadAdd(function(){s._cleanup(!0)});try{this.xdr.open(e,n),this.timeout&&(this.xdr.timeout=this.timeout),this.xdr.send(i)}catch(o){this._error()}},vt.prototype._error=function(){this.emit("finish",0,""),this._cleanup(!1)},vt.prototype._cleanup=function(t){if(this.xdr){if(this.removeAllListeners(),_t.unloadDel(this.unloadRef),this.xdr.ontimeout=this.xdr.onerror=this.xdr.onprogress=this.xdr.onload=null,t)try{this.xdr.abort()}catch(e){}this.unloadRef=this.xdr=null}},vt.prototype.close=function(){this._cleanup(!0)},vt.enabled=!(!t.XDomainRequest||!yt.hasDomain());var wt=vt,Et=M,St=J,kt=wt;function Tt(t){if(!kt.enabled)throw new Error("Transport created when disabled");Et.call(this,t,"/xhr_streaming",St,kt)}n(Tt,Et),Tt.enabled=function(t){return!t.cookie_needed&&!t.nullOrigin&&(kt.enabled&&t.sameScheme)},Tt.transportName="xdr-streaming",Tt.roundTrips=2;var Ct=Tt,xt=t.EventSource,Ot=n,Nt=u.EventEmitter,It=xt;function At(t){Nt.call(this);var e=this,n=this.es=new It(t);n.onmessage=function(t){t.data,e.emit("message",decodeURI(t.data))},n.onerror=function(t){n.readyState;var i=2!==n.readyState?"network":"permanent";e._cleanup(),e._close(i)}}Ot(At,Nt),At.prototype.abort=function(){this._cleanup(),this._close("user")},At.prototype._cleanup=function(){var t=this.es;t&&(t.onmessage=t.onerror=null,t.close(),this.es=null)},At.prototype._close=function(t){var e=this;setTimeout(function(){e.emit("close",null,t),e.removeAllListeners()},200)};var Rt=M,Ht=At,Wt=st,Lt=xt;function Bt(t){if(!Bt.enabled())throw new Error("Transport created when disabled");Rt.call(this,t,"/eventsource",Ht,Wt)}n(Bt,Rt),Bt.enabled=function(){return!!Lt},Bt.transportName="eventsource",Bt.roundTrips=2;var Dt,Ut,jt=Bt;function Pt(){return Ut?Dt:(Ut=1,Dt="1.6.1")}var Vt,Mt,Ft,Gt={exports:{}};Mt=h,Ft=ct,(Vt=Gt).exports={WPrefix:"_jp",currentWindowId:null,polluteGlobalNamespace:function(){Vt.exports.WPrefix in t||(t[Vt.exports.WPrefix]={})},postMessage:function(e,n){t.parent!==t&&t.parent.postMessage(JSON.stringify({windowId:Vt.exports.currentWindowId,type:e,data:n||""}),"*")},createIframe:function(e,n){var i,s,r=t.document.createElement("iframe"),o=function(){clearTimeout(i);try{r.onload=null}catch(t){}r.onerror=null},a=function(){r&&(o(),setTimeout(function(){r&&r.parentNode.removeChild(r),r=null},0),Mt.unloadDel(s))},c=function(t){r&&(a(),n(t))};return r.src=e,r.style.display="none",r.style.position="absolute",r.onerror=function(){c("onerror")},r.onload=function(){clearTimeout(i),i=setTimeout(function(){c("onload timeout")},2e3)},t.document.body.appendChild(r),i=setTimeout(function(){c("timeout")},15e3),s=Mt.unloadAdd(a),{post:function(t,e){setTimeout(function(){try{r&&r.contentWindow&&r.contentWindow.postMessage(t,e)}catch(n){}},0)},cleanup:a,loaded:o}},createHtmlfile:function(e,n){var i,s,r,o=["Active"].concat("Object").join("X"),a=new t[o]("htmlfile"),c=function(){clearTimeout(i),r.onerror=null},h=function(){a&&(c(),Mt.unloadDel(s),r.parentNode.removeChild(r),r=a=null,CollectGarbage())},l=function(t){a&&(h(),n(t))};a.open(),a.write('<html><script>document.domain="'+t.document.domain+'";<\/script></html>'),a.close(),a.parentWindow[Vt.exports.WPrefix]=t[Vt.exports.WPrefix];var d=a.createElement("div");return a.body.appendChild(d),r=a.createElement("iframe"),d.appendChild(r),r.src=e,r.onerror=function(){l("onerror")},i=setTimeout(function(){l("timeout")},15e3),s=Mt.unloadAdd(h),{post:function(t,e){try{setTimeout(function(){r&&r.contentWindow&&r.contentWindow.postMessage(t,e)},0)}catch(n){}},cleanup:h,loaded:c}}},Vt.exports.iframeEnabled=!1,t.document&&(Vt.exports.iframeEnabled=("function"==typeof t.postMessage||"object"==typeof t.postMessage)&&!Ft.isKonqueror());var $t=Gt.exports,Jt=n,qt=u.EventEmitter,zt=Pt(),Xt=d,Kt=$t,Qt=h,Yt=c;function Zt(t,e,n){if(!Zt.enabled())throw new Error("Transport created when disabled");qt.call(this);var i=this;this.origin=Xt.getOrigin(n),this.baseUrl=n,this.transUrl=e,this.transport=t,this.windowId=Yt.string(8);var s=Xt.addPath(n,"/iframe.html")+"#"+this.windowId;this.iframeObj=Kt.createIframe(s,function(t){i.emit("close",1006,"Unable to load an iframe ("+t+")"),i.close()}),this.onmessageCallback=this._message.bind(this),Qt.attachEvent("message",this.onmessageCallback)}Jt(Zt,qt),Zt.prototype.close=function(){if(this.removeAllListeners(),this.iframeObj){Qt.detachEvent("message",this.onmessageCallback);try{this.postMessage("c")}catch(t){}this.iframeObj.cleanup(),this.iframeObj=null,this.onmessageCallback=this.iframeObj=null}},Zt.prototype._message=function(t){if(t.data,!Xt.isOriginEqual(t.origin,this.origin))return t.origin,void this.origin;var e;try{e=JSON.parse(t.data)}catch(zi){return void t.data}if(e.windowId!==this.windowId)return e.windowId,void this.windowId;switch(e.type){case"s":this.iframeObj.loaded(),this.postMessage("s",JSON.stringify([zt,this.transport,this.transUrl,this.baseUrl]));break;case"t":this.emit("message",e.data);break;case"c":var n;try{n=JSON.parse(e.data)}catch(zi){return void e.data}this.emit("close",n[0],n[1]),this.close()}},Zt.prototype.postMessage=function(t,e){this.iframeObj.post(JSON.stringify({windowId:this.windowId,type:t,data:e||""}),this.origin)},Zt.prototype.send=function(t){this.postMessage("m",t)},Zt.enabled=function(){return Kt.iframeEnabled},Zt.transportName="iframe",Zt.roundTrips=2;var te=Zt,ee={isObject:function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},extend:function(t){if(!this.isObject(t))return t;for(var e,n,i=1,s=arguments.length;i<s;i++)for(n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}},ne=n,ie=te,se=ee,re=function(e){function n(t,n){ie.call(this,e.transportName,t,n)}return ne(n,ie),n.enabled=function(n,i){if(!t.document)return!1;var s=se.extend({},i);return s.sameOrigin=!0,e.enabled(s)&&ie.enabled()},n.transportName="iframe-"+e.transportName,n.needBody=!0,n.roundTrips=ie.roundTrips+e.roundTrips-1,n.facadeTransport=e,n},oe=n,ae=$t,ce=d,he=u.EventEmitter,le=c;function de(e){he.call(this);var n=this;ae.polluteGlobalNamespace(),this.id="a"+le.string(6),e=ce.addQuery(e,"c="+decodeURIComponent(ae.WPrefix+"."+this.id)),de.htmlfileEnabled;var i=de.htmlfileEnabled?ae.createHtmlfile:ae.createIframe;t[ae.WPrefix][this.id]={start:function(){n.iframeObj.loaded()},message:function(t){n.emit("message",t)},stop:function(){n._cleanup(),n._close("network")}},this.iframeObj=i(e,function(){n._cleanup(),n._close("permanent")})}oe(de,he),de.prototype.abort=function(){this._cleanup(),this._close("user")},de.prototype._cleanup=function(){this.iframeObj&&(this.iframeObj.cleanup(),this.iframeObj=null),delete t[ae.WPrefix][this.id]},de.prototype._close=function(t){this.emit("close",null,t),this.removeAllListeners()},de.htmlfileEnabled=!1;var ue=["Active"].concat("Object").join("X");if(ue in t)try{de.htmlfileEnabled=!!new t[ue]("htmlfile")}catch(Xi){}de.enabled=de.htmlfileEnabled||ae.iframeEnabled;var pe=de,fe=at,me=M;function be(t){if(!pe.enabled)throw new Error("Transport created when disabled");me.call(this,t,"/htmlfile",pe,fe)}n(be,me),be.enabled=function(t){return pe.enabled&&t.sameOrigin},be.transportName="htmlfile",be.roundTrips=2;var _e=be,ye=M,ge=J,ve=st,we=at;function Ee(t){if(!we.enabled&&!ve.enabled)throw new Error("Transport created when disabled");ye.call(this,t,"/xhr",ge,ve)}n(Ee,ye),Ee.enabled=function(t){return!t.nullOrigin&&(!(!we.enabled||!t.sameOrigin)||ve.enabled)},Ee.transportName="xhr-polling",Ee.roundTrips=2;var Se=Ee,ke=M,Te=Ct,Ce=J,xe=wt;function Oe(t){if(!xe.enabled)throw new Error("Transport created when disabled");ke.call(this,t,"/xhr",Ce,xe)}n(Oe,ke),Oe.enabled=Te.enabled,Oe.transportName="xdr-polling",Oe.roundTrips=2;var Ne=Oe,Ie=$t,Ae=c,Re=ct,He=d,We=n,Le=u.EventEmitter;function Be(e){var n=this;Le.call(this),Ie.polluteGlobalNamespace(),this.id="a"+Ae.string(6);var i=He.addQuery(e,"c="+encodeURIComponent(Ie.WPrefix+"."+this.id));t[Ie.WPrefix][this.id]=this._callback.bind(this),this._createScript(i),this.timeoutId=setTimeout(function(){n._abort(new Error("JSONP script loaded abnormally (timeout)"))},Be.timeout)}We(Be,Le),Be.prototype.abort=function(){if(t[Ie.WPrefix][this.id]){var e=new Error("JSONP user aborted read");e.code=1e3,this._abort(e)}},Be.timeout=35e3,Be.scriptErrorTimeout=1e3,Be.prototype._callback=function(t){this._cleanup(),this.aborting||(t&&this.emit("message",t),this.emit("close",null,"network"),this.removeAllListeners())},Be.prototype._abort=function(t){this._cleanup(),this.aborting=!0,this.emit("close",t.code,t.message),this.removeAllListeners()},Be.prototype._cleanup=function(){if(clearTimeout(this.timeoutId),this.script2&&(this.script2.parentNode.removeChild(this.script2),this.script2=null),this.script){var e=this.script;e.parentNode.removeChild(e),e.onreadystatechange=e.onerror=e.onload=e.onclick=null,this.script=null}delete t[Ie.WPrefix][this.id]},Be.prototype._scriptError=function(){var t=this;this.errorTimer||(this.errorTimer=setTimeout(function(){t.loadedOkay||t._abort(new Error("JSONP script loaded abnormally (onerror)"))},Be.scriptErrorTimeout))},Be.prototype._createScript=function(e){var n,i=this,s=this.script=t.document.createElement("script");if(s.id="a"+Ae.string(8),s.src=e,s.type="text/javascript",s.charset="UTF-8",s.onerror=this._scriptError.bind(this),s.onload=function(){i._abort(new Error("JSONP script loaded abnormally (onload)"))},s.onreadystatechange=function(){if(s.readyState,/loaded|closed/.test(s.readyState)){if(s&&s.htmlFor&&s.onclick){i.loadedOkay=!0;try{s.onclick()}catch(Xi){}}s&&i._abort(new Error("JSONP script loaded abnormally (onreadystatechange)"))}},void 0===s.async&&t.document.attachEvent)if(Re.isOpera())(n=this.script2=t.document.createElement("script")).text="try{var a = document.getElementById('"+s.id+"'); if(a)a.onerror();}catch(x){};",s.async=n.async=!1;else{try{s.htmlFor=s.id,s.event="onclick"}catch(Xi){}s.async=!0}void 0!==s.async&&(s.async=!0);var r=t.document.getElementsByTagName("head")[0];r.insertBefore(s,r.firstChild),n&&r.insertBefore(n,r.firstChild)};var De,Ue,je=c,Pe=d;var Ve=U,Me=Be,Fe=function(e,n,i){De||((De=t.document.createElement("form")).style.display="none",De.style.position="absolute",De.method="POST",De.enctype="application/x-www-form-urlencoded",De.acceptCharset="UTF-8",(Ue=t.document.createElement("textarea")).name="d",De.appendChild(Ue),t.document.body.appendChild(De));var s="a"+je.string(8);De.target=s,De.action=Pe.addQuery(Pe.addPath(e,"/jsonp_send"),"i="+s);var r=function(e){try{return t.document.createElement('<iframe name="'+e+'">')}catch(Xi){var n=t.document.createElement("iframe");return n.name=e,n}}(s);r.id=s,r.style.display="none",De.appendChild(r);try{Ue.value=n}catch(a){}De.submit();var o=function(t){r.onerror&&(r.onreadystatechange=r.onerror=r.onload=null,setTimeout(function(){r.parentNode.removeChild(r),r=null},500),Ue.value="",i(t))};return r.onerror=function(){o()},r.onload=function(){o()},r.onreadystatechange=function(t){r.readyState,"complete"===r.readyState&&o()},function(){o(new Error("Aborted"))}};function Ge(t){if(!Ge.enabled())throw new Error("Transport created when disabled");Ve.call(this,t,"/jsonp",Fe,Me)}n(Ge,Ve),Ge.enabled=function(){return!!t.document},Ge.transportName="jsonp-polling",Ge.roundTrips=1,Ge.needBody=!0;var $e,Je=Ge,qe=[C,mt,Ct,jt,re(jt),_e,re(_e),Se,Ne,re(Se),Je],ze=Array.prototype,Xe=Object.prototype,Ke=Function.prototype,Qe=String.prototype,Ye=ze.slice,Ze=Xe.toString,tn=function(t){return"[object Function]"===Xe.toString.call(t)},en=function(t){return"[object String]"===Ze.call(t)},nn=Object.defineProperty&&function(){try{return Object.defineProperty({},"x",{}),!0}catch(t){return!1}}();$e=nn?function(t,e,n,i){!i&&e in t||Object.defineProperty(t,e,{configurable:!0,enumerable:!1,writable:!0,value:n})}:function(t,e,n,i){!i&&e in t||(t[e]=n)};var sn=function(t,e,n){for(var i in e)Xe.hasOwnProperty.call(e,i)&&$e(t,i,e[i],n)},rn=function(t){if(null==t)throw new TypeError("can't convert "+t+" to object");return Object(t)};function on(){}sn(Ke,{bind:function(t){var e=this;if(!tn(e))throw new TypeError("Function.prototype.bind called on incompatible "+e);for(var n=Ye.call(arguments,1),i=Math.max(0,e.length-n.length),s=[],r=0;r<i;r++)s.push("$"+r);var o=Function("binder","return function ("+s.join(",")+"){ return binder.apply(this, arguments); }")(function(){if(this instanceof o){var i=e.apply(this,n.concat(Ye.call(arguments)));return Object(i)===i?i:this}return e.apply(t,n.concat(Ye.call(arguments)))});return e.prototype&&(on.prototype=e.prototype,o.prototype=new on,on.prototype=null),o}}),sn(Array,{isArray:function(t){return"[object Array]"===Ze.call(t)}});var an,cn,hn,ln=Object("a"),dn="a"!==ln[0]||!(0 in ln);sn(ze,{forEach:function(t){var e=rn(this),n=dn&&en(this)?this.split(""):e,i=arguments[1],s=-1,r=n.length>>>0;if(!tn(t))throw new TypeError;for(;++s<r;)s in n&&t.call(i,n[s],s,e)}},(an=ze.forEach,cn=!0,hn=!0,an&&(an.call("foo",function(t,e,n){"object"!=typeof n&&(cn=!1)}),an.call([1],function(){hn="string"==typeof this},"x")),!(an&&cn&&hn)));var un=Array.prototype.indexOf&&-1!==[0,1].indexOf(1,2);sn(ze,{indexOf:function(t){var e=dn&&en(this)?this.split(""):rn(this),n=e.length>>>0;if(!n)return-1;var i,s=0;for(arguments.length>1&&((i=+arguments[1])!=i?i=0:0!==i&&i!==1/0&&i!==-1/0&&(i=(i>0||-1)*Math.floor(Math.abs(i))),s=i),s=s>=0?s:Math.max(0,n+s);s<n;s++)if(s in e&&e[s]===t)return s;return-1}},un);var pn,fn=Qe.split;2!=="ab".split(/(?:ab)*/).length||4!==".".split(/(.?)(.?)/).length||"t"==="tesst".split(/(s)*/)[1]||4!=="test".split(/(?:)/,-1).length||"".split(/.?/).length||".".split(/()()/).length>1?(pn=void 0===/()??/.exec("")[1],Qe.split=function(t,e){var n=this;if(void 0===t&&0===e)return[];if("[object RegExp]"!==Ze.call(t))return fn.call(this,t,e);var i,s,r,o,a=[],c=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.extended?"x":"")+(t.sticky?"y":""),h=0;for(t=new RegExp(t.source,c+"g"),n+="",pn||(i=new RegExp("^"+t.source+"$(?!\\s)",c)),e=void 0===e?-1>>>0:e>>>0;(s=t.exec(n))&&!((r=s.index+s[0].length)>h&&(a.push(n.slice(h,s.index)),!pn&&s.length>1&&s[0].replace(i,function(){for(var t=1;t<arguments.length-2;t++)void 0===arguments[t]&&(s[t]=void 0)}),s.length>1&&s.index<n.length&&ze.push.apply(a,s.slice(1)),o=s[0].length,h=r,a.length>=e));)t.lastIndex===s.index&&t.lastIndex++;return h===n.length?!o&&t.test("")||a.push(""):a.push(n.slice(h)),a.length>e?a.slice(0,e):a}):"0".split(void 0,0).length&&(Qe.split=function(t,e){return void 0===t&&0===e?[]:fn.call(this,t,e)});var mn=Qe.substr,bn="".substr&&"b"!=="0b".substr(-1);sn(Qe,{substr:function(t,e){return mn.call(this,t<0&&(t=this.length+t)<0?0:t,e)}},bn);var _n,yn=/[\x00-\x1f\ud800-\udfff\ufffe\uffff\u0300-\u0333\u033d-\u0346\u034a-\u034c\u0350-\u0352\u0357-\u0358\u035c-\u0362\u0374\u037e\u0387\u0591-\u05af\u05c4\u0610-\u0617\u0653-\u0654\u0657-\u065b\u065d-\u065e\u06df-\u06e2\u06eb-\u06ec\u0730\u0732-\u0733\u0735-\u0736\u073a\u073d\u073f-\u0741\u0743\u0745\u0747\u07eb-\u07f1\u0951\u0958-\u095f\u09dc-\u09dd\u09df\u0a33\u0a36\u0a59-\u0a5b\u0a5e\u0b5c-\u0b5d\u0e38-\u0e39\u0f43\u0f4d\u0f52\u0f57\u0f5c\u0f69\u0f72-\u0f76\u0f78\u0f80-\u0f83\u0f93\u0f9d\u0fa2\u0fa7\u0fac\u0fb9\u1939-\u193a\u1a17\u1b6b\u1cda-\u1cdb\u1dc0-\u1dcf\u1dfc\u1dfe\u1f71\u1f73\u1f75\u1f77\u1f79\u1f7b\u1f7d\u1fbb\u1fbe\u1fc9\u1fcb\u1fd3\u1fdb\u1fe3\u1feb\u1fee-\u1fef\u1ff9\u1ffb\u1ffd\u2000-\u2001\u20d0-\u20d1\u20d4-\u20d7\u20e7-\u20e9\u2126\u212a-\u212b\u2329-\u232a\u2adc\u302b-\u302c\uaab2-\uaab3\uf900-\ufa0d\ufa10\ufa12\ufa15-\ufa1e\ufa20\ufa22\ufa25-\ufa26\ufa2a-\ufa2d\ufa30-\ufa6d\ufa70-\ufad9\ufb1d\ufb1f\ufb2a-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufb4e\ufff0-\uffff]/g,gn={quote:function(t){var e=JSON.stringify(t);return yn.lastIndex=0,yn.test(e)?(_n||(_n=function(t){var e,n={},i=[];for(e=0;e<65536;e++)i.push(String.fromCharCode(e));return t.lastIndex=0,i.join("").replace(t,function(t){return n[t]="\\u"+("0000"+t.charCodeAt(0).toString(16)).slice(-4),""}),t.lastIndex=0,n}(yn)),e.replace(yn,function(t){return _n[t]})):e}},vn={};["log","debug","warn"].forEach(function(e){var n;try{n=t.console&&t.console[e]&&t.console[e].apply}catch(i){}vn[e]=n?function(){return t.console[e].apply(t.console,arguments)}:"log"===e?function(){}:vn.log});var wn=vn;function En(t){this.type=t}En.prototype.initEvent=function(t,e,n){return this.type=t,this.bubbles=e,this.cancelable=n,this.timeStamp=+new Date,this},En.prototype.stopPropagation=function(){},En.prototype.preventDefault=function(){},En.CAPTURING_PHASE=1,En.AT_TARGET=2,En.BUBBLING_PHASE=3;var Sn=En,kn=t.location||{protocol:"http:",href:"http://localhost/",hash:""},Tn=Sn;function Cn(){Tn.call(this),this.initEvent("close",!1,!1),this.wasClean=!1,this.code=0,this.reason=""}n(Cn,Tn);var xn=Cn,On=Sn;function Nn(t){On.call(this),this.initEvent("message",!1,!1),this.data=t}n(Nn,On);var In=Nn,An=u.EventEmitter;function Rn(){var t=this;An.call(this),this.to=setTimeout(function(){t.emit("finish",200,"{}")},Rn.timeout)}n(Rn,An),Rn.prototype.close=function(){clearTimeout(this.to)},Rn.timeout=2e3;var Hn=Rn,Wn=u.EventEmitter,Ln=ee;function Bn(t,e){Wn.call(this);var n=this,i=+new Date;this.xo=new e("GET",t),this.xo.once("finish",function(t,e){var s,r;if(200===t){if(r=+new Date-i,e)try{s=JSON.parse(e)}catch(o){}Ln.isObject(s)||(s={})}n.emit("finish",s,r),n.removeAllListeners()})}n(Bn,Wn),Bn.prototype.close=function(){this.removeAllListeners(),this.xo.close()};var Dn=Bn,Un=n,jn=u.EventEmitter,Pn=at,Vn=Dn;function Mn(t){var e=this;jn.call(this),this.ir=new Vn(t,Pn),this.ir.once("finish",function(t,n){e.ir=null,e.emit("message",JSON.stringify([t,n]))})}Un(Mn,jn),Mn.transportName="iframe-info-receiver",Mn.prototype.close=function(){this.ir&&(this.ir.close(),this.ir=null),this.removeAllListeners()};var Fn=Mn,Gn=u.EventEmitter,$n=h,Jn=te,qn=Fn;function zn(e,n){var i=this;Gn.call(this);var s=function(){var t=i.ifr=new Jn(qn.transportName,n,e);t.once("message",function(t){if(t){var e;try{e=JSON.parse(t)}catch(r){return i.emit("finish"),void i.close()}var n=e[0],s=e[1];i.emit("finish",n,s)}i.close()}),t.once("close",function(){i.emit("finish"),i.close()})};t.document.body?s():$n.attachEvent("load",s)}n(zn,Gn),zn.enabled=function(){return Jn.enabled()},zn.prototype.close=function(){this.ifr&&this.ifr.close(),this.removeAllListeners(),this.ifr=null};var Xn,Kn,Qn,Yn,Zn=zn,ti=u.EventEmitter,ei=d,ni=wt,ii=st,si=at,ri=Hn,oi=Zn,ai=Dn;function ci(t,e){var n=this;ti.call(this),setTimeout(function(){n.doXhr(t,e)},0)}function hi(){if(Yn)return Qn;Yn=1;var t=d,e=h,n=function(){if(Kn)return Xn;Kn=1;var t=$t;function e(t){this._transport=t,t.on("message",this._transportMessage.bind(this)),t.on("close",this._transportClose.bind(this))}return e.prototype._transportClose=function(e,n){t.postMessage("c",JSON.stringify([e,n]))},e.prototype._transportMessage=function(e){t.postMessage("t",e)},e.prototype._send=function(t){this._transport.send(t)},e.prototype._close=function(){this._transport.close(),this._transport.removeAllListeners()},Xn=e}(),i=Fn,s=$t,r=kn;return Qn=function(o,a){var c,h={};a.forEach(function(t){t.facadeTransport&&(h[t.facadeTransport.transportName]=t.facadeTransport)}),h[i.transportName]=i,o.bootstrap_iframe=function(){var i;s.currentWindowId=r.hash.slice(1);e.attachEvent("message",function(e){if(e.source===parent&&(void 0===c&&(c=e.origin),e.origin===c)){var a;try{a=JSON.parse(e.data)}catch(zi){return void e.data}if(a.windowId===s.currentWindowId)switch(a.type){case"s":var l;try{l=JSON.parse(a.data)}catch(zi){a.data;break}var d=l[0],u=l[1],p=l[2],f=l[3];if(d!==o.version)throw new Error('Incompatible SockJS! Main site uses: "'+d+'", the iframe: "'+o.version+'".');if(!t.isOriginEqual(p,r.href)||!t.isOriginEqual(f,r.href))throw new Error("Can't connect to different domain from within an iframe. ("+r.href+", "+p+", "+f+")");i=new n(new h[u](p,f));break;case"m":i._send(a.data);break;case"c":i&&i._close(),i=null}}}),s.postMessage("s")}}}n(ci,ti),ci._getReceiver=function(t,e,n){return n.sameOrigin?new ai(e,si):ii.enabled?new ai(e,ii):ni.enabled&&n.sameScheme?new ai(e,ni):oi.enabled()?new oi(t,e):new ai(e,ri)},ci.prototype.doXhr=function(t,e){var n=this,i=ei.addPath(t,"/info");this.xo=ci._getReceiver(t,i,e),this.timeoutRef=setTimeout(function(){n._cleanup(!1),n.emit("finish")},ci.timeout),this.xo.once("finish",function(t,e){n._cleanup(!0),n.emit("finish",t,e)})},ci.prototype._cleanup=function(t){clearTimeout(this.timeoutRef),this.timeoutRef=null,!t&&this.xo&&this.xo.close(),this.xo=null},ci.prototype.close=function(){this.removeAllListeners(),this._cleanup(!1)},ci.timeout=8e3;var li,di=e,ui=c,pi=gn,fi=d,mi=h,bi=function(t){return{filterToEnabled:function(e,n){var i={main:[],facade:[]};return e?"string"==typeof e&&(e=[e]):e=[],t.forEach(function(t){t&&("websocket"===t.transportName&&!1===n.websocket||(e.length&&-1===e.indexOf(t.transportName)?t.transportName:t.enabled(n)?(t.transportName,i.main.push(t),t.facadeTransport&&i.facade.push(t.facadeTransport)):t.transportName))}),i}}},_i=ee,yi=ct,gi=wn,vi=Sn,wi=f,Ei=kn,Si=xn,ki=In,Ti=ci,Ci=function(){};function xi(t,e,n){if(!(this instanceof xi))return new xi(t,e,n);if(arguments.length<1)throw new TypeError("Failed to construct 'SockJS: 1 argument required, but only 0 present");wi.call(this),this.readyState=xi.CONNECTING,this.extensions="",this.protocol="",(n=n||{}).protocols_whitelist&&gi.warn("'protocols_whitelist' is DEPRECATED. Use 'transports' instead."),this._transportsWhitelist=n.transports,this._transportOptions=n.transportOptions||{},this._timeout=n.timeout||0;var i=n.sessionId||8;if("function"==typeof i)this._generateSessionId=i;else{if("number"!=typeof i)throw new TypeError("If sessionId is used in the options, it needs to be a number or a function.");this._generateSessionId=function(){return ui.string(i)}}this._server=n.server||ui.numberString(1e3);var s=new di(t);if(!s.host||!s.protocol)throw new SyntaxError("The URL '"+t+"' is invalid");if(s.hash)throw new SyntaxError("The URL must not contain a fragment");if("http:"!==s.protocol&&"https:"!==s.protocol)throw new SyntaxError("The URL's scheme must be either 'http:' or 'https:'. '"+s.protocol+"' is not allowed.");var r="https:"===s.protocol;if("https:"===Ei.protocol&&!r&&!fi.isLoopbackAddr(s.hostname))throw new Error("SecurityError: An insecure SockJS connection may not be initiated from a page loaded over HTTPS");e?Array.isArray(e)||(e=[e]):e=[];var o=e.sort();o.forEach(function(t,e){if(!t)throw new SyntaxError("The protocols entry '"+t+"' is invalid.");if(e<o.length-1&&t===o[e+1])throw new SyntaxError("The protocols entry '"+t+"' is duplicated.")});var a=fi.getOrigin(Ei.href);this._origin=a?a.toLowerCase():null,s.set("pathname",s.pathname.replace(/\/+$/,"")),this.url=s.href,this.url,this._urlInfo={nullOrigin:!yi.hasDomain(),sameOrigin:fi.isOriginEqual(this.url,Ei.href),sameScheme:fi.isSchemeEqual(this.url,Ei.href)},this._ir=new Ti(this.url,this._urlInfo),this._ir.once("finish",this._receiveInfo.bind(this))}function Oi(t){return 1e3===t||t>=3e3&&t<=4999}n(xi,wi),xi.prototype.close=function(t,e){if(t&&!Oi(t))throw new Error("InvalidAccessError: Invalid code");if(e&&e.length>123)throw new SyntaxError("reason argument has an invalid length");if(this.readyState!==xi.CLOSING&&this.readyState!==xi.CLOSED){this._close(t||1e3,e||"Normal closure",!0)}},xi.prototype.send=function(t){if("string"!=typeof t&&(t=""+t),this.readyState===xi.CONNECTING)throw new Error("InvalidStateError: The connection has not been established yet");this.readyState===xi.OPEN&&this._transport.send(pi.quote(t))},xi.version=Pt(),xi.CONNECTING=0,xi.OPEN=1,xi.CLOSING=2,xi.CLOSED=3,xi.prototype._receiveInfo=function(t,e){if(this._ir=null,t){this._rto=this.countRTO(e),this._transUrl=t.base_url?t.base_url:this.url,t=_i.extend(t,this._urlInfo);var n=li.filterToEnabled(this._transportsWhitelist,t);this._transports=n.main,this._transports.length,this._connect()}else this._close(1002,"Cannot connect to server")},xi.prototype._connect=function(){for(var e=this._transports.shift();e;e=this._transports.shift()){if(Ci(e.transportName),e.needBody&&(!t.document.body||void 0!==t.document.readyState&&"complete"!==t.document.readyState&&"interactive"!==t.document.readyState))return this._transports.unshift(e),void mi.attachEvent("load",this._connect.bind(this));var n=Math.max(this._timeout,this._rto*e.roundTrips||5e3);this._transportTimeoutId=setTimeout(this._transportTimeout.bind(this),n);var i=fi.addPath(this._transUrl,"/"+this._server+"/"+this._generateSessionId()),s=this._transportOptions[e.transportName],r=new e(i,this._transUrl,s);return r.on("message",this._transportMessage.bind(this)),r.once("close",this._transportClose.bind(this)),r.transportName=e.transportName,void(this._transport=r)}this._close(2e3,"All transports failed",!1)},xi.prototype._transportTimeout=function(){this.readyState===xi.CONNECTING&&(this._transport&&this._transport.close(),this._transportClose(2007,"Transport timed out"))},xi.prototype._transportMessage=function(t){var e,n=this,i=t.slice(0,1),s=t.slice(1);switch(i){case"o":return void this._open();case"h":return this.dispatchEvent(new vi("heartbeat")),void this.transport}if(s)try{e=JSON.parse(s)}catch(r){}if(void 0!==e)switch(i){case"a":Array.isArray(e)&&e.forEach(function(t){n.transport,n.dispatchEvent(new ki(t))});break;case"m":this.transport,this.dispatchEvent(new ki(e));break;case"c":Array.isArray(e)&&2===e.length&&this._close(e[0],e[1],!0)}},xi.prototype._transportClose=function(t,e){this.transport,this._transport&&(this._transport.removeAllListeners(),this._transport=null,this.transport=null),Oi(t)||2e3===t||this.readyState!==xi.CONNECTING?this._close(t,e):this._connect()},xi.prototype._open=function(){this._transport&&this._transport.transportName,this.readyState,this.readyState===xi.CONNECTING?(this._transportTimeoutId&&(clearTimeout(this._transportTimeoutId),this._transportTimeoutId=null),this.readyState=xi.OPEN,this.transport=this._transport.transportName,this.dispatchEvent(new vi("open")),this.transport):this._close(1006,"Server lost session")},xi.prototype._close=function(t,e,n){this.transport,this.readyState;var i=!1;if(this._ir&&(i=!0,this._ir.close(),this._ir=null),this._transport&&(this._transport.close(),this._transport=null,this.transport=null),this.readyState===xi.CLOSED)throw new Error("InvalidStateError: SockJS has already been closed");this.readyState=xi.CLOSING,setTimeout(function(){this.readyState=xi.CLOSED,i&&this.dispatchEvent(new vi("error"));var s=new Si;s.wasClean=n||!1,s.code=t||1e3,s.reason=e,this.dispatchEvent(s),this.onmessage=this.onclose=this.onerror=null}.bind(this),0)},xi.prototype.countRTO=function(t){return t>100?4*t:300+t};var Ni,Ii=(li=bi(Ni=qe),hi()(xi,Ni),xi);"_sockjs_onload"in t&&setTimeout(t._sockjs_onload,1);const Ai=i(Ii);const Ri="\n",Hi="\0";class Wi{get body(){return!this._body&&this.isBinaryBody&&(this._body=(new TextDecoder).decode(this._binaryBody)),this._body||""}get binaryBody(){return this._binaryBody||this.isBinaryBody||(this._binaryBody=(new TextEncoder).encode(this._body)),this._binaryBody}constructor(t){const{command:e,headers:n,body:i,binaryBody:s,escapeHeaderValues:r,skipContentLengthHeader:o}=t;this.command=e,this.headers=Object.assign({},n||{}),s?(this._binaryBody=s,this.isBinaryBody=!0):(this._body=i||"",this.isBinaryBody=!1),this.escapeHeaderValues=r||!1,this.skipContentLengthHeader=o||!1}static fromRawFrame(t,e){const n={},i=t=>t.replace(/^\s+|\s+$/g,"");for(const s of t.headers.reverse()){s.indexOf(":");const r=i(s[0]);let o=i(s[1]);e&&"CONNECT"!==t.command&&"CONNECTED"!==t.command&&(o=Wi.hdrValueUnEscape(o)),n[r]=o}return new Wi({command:t.command,headers:n,binaryBody:t.binaryBody,escapeHeaderValues:e})}toString(){return this.serializeCmdAndHeaders()}serialize(){const t=this.serializeCmdAndHeaders();return this.isBinaryBody?Wi.toUnit8Array(t,this._binaryBody).buffer:t+this._body+Hi}serializeCmdAndHeaders(){const t=[this.command];this.skipContentLengthHeader&&delete this.headers["content-length"];for(const e of Object.keys(this.headers||{})){const n=this.headers[e];this.escapeHeaderValues&&"CONNECT"!==this.command&&"CONNECTED"!==this.command?t.push(`${e}:${Wi.hdrValueEscape(`${n}`)}`):t.push(`${e}:${n}`)}return(this.isBinaryBody||!this.isBodyEmpty()&&!this.skipContentLengthHeader)&&t.push(`content-length:${this.bodyLength()}`),t.join(Ri)+Ri+Ri}isBodyEmpty(){return 0===this.bodyLength()}bodyLength(){const t=this.binaryBody;return t?t.length:0}static sizeOfUTF8(t){return t?(new TextEncoder).encode(t).length:0}static toUnit8Array(t,e){const n=(new TextEncoder).encode(t),i=new Uint8Array([0]),s=new Uint8Array(n.length+e.length+i.length);return s.set(n),s.set(e,n.length),s.set(i,n.length+e.length),s}static marshall(t){return new Wi(t).serialize()}static hdrValueEscape(t){return t.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/:/g,"\\c")}static hdrValueUnEscape(t){return t.replace(/\\r/g,"\r").replace(/\\n/g,"\n").replace(/\\c/g,":").replace(/\\\\/g,"\\")}}class Li{constructor(t,e){this.onFrame=t,this.onIncomingPing=e,this._encoder=new TextEncoder,this._decoder=new TextDecoder,this._token=[],this._initState()}parseChunk(t,e=!1){let n;if(n="string"==typeof t?this._encoder.encode(t):new Uint8Array(t),e&&0!==n[n.length-1]){const t=new Uint8Array(n.length+1);t.set(n,0),t[n.length]=0,n=t}for(let i=0;i<n.length;i++){const t=n[i];this._onByte(t)}}_collectFrame(t){0!==t&&13!==t&&(10!==t?(this._onByte=this._collectCommand,this._reinjectByte(t)):this.onIncomingPing())}_collectCommand(t){if(13!==t)return 10===t?(this._results.command=this._consumeTokenAsUTF8(),void(this._onByte=this._collectHeaders)):void this._consumeByte(t)}_collectHeaders(t){13!==t&&(10!==t?(this._onByte=this._collectHeaderKey,this._reinjectByte(t)):this._setupCollectBody())}_reinjectByte(t){this._onByte(t)}_collectHeaderKey(t){if(58===t)return this._headerKey=this._consumeTokenAsUTF8(),void(this._onByte=this._collectHeaderValue);this._consumeByte(t)}_collectHeaderValue(t){if(13!==t)return 10===t?(this._results.headers.push([this._headerKey,this._consumeTokenAsUTF8()]),this._headerKey=void 0,void(this._onByte=this._collectHeaders)):void this._consumeByte(t)}_setupCollectBody(){const t=this._results.headers.filter(t=>"content-length"===t[0])[0];t?(this._bodyBytesRemaining=parseInt(t[1],10),this._onByte=this._collectBodyFixedSize):this._onByte=this._collectBodyNullTerminated}_collectBodyNullTerminated(t){0!==t?this._consumeByte(t):this._retrievedBody()}_collectBodyFixedSize(t){0!==this._bodyBytesRemaining--?this._consumeByte(t):this._retrievedBody()}_retrievedBody(){this._results.binaryBody=this._consumeTokenAsRaw();try{this.onFrame(this._results)}catch(t){console.log("Ignoring an exception thrown by a frame handler. Original exception: ",t)}this._initState()}_consumeByte(t){this._token.push(t)}_consumeTokenAsUTF8(){return this._decoder.decode(this._consumeTokenAsRaw())}_consumeTokenAsRaw(){const t=new Uint8Array(this._token);return this._token=[],t}_initState(){this._results={command:void 0,headers:[],binaryBody:void 0},this._token=[],this._headerKey=void 0,this._onByte=this._collectFrame}}var Bi,Di,Ui,ji,Pi,Vi,Mi,Fi;(Di=Bi||(Bi={}))[Di.CONNECTING=0]="CONNECTING",Di[Di.OPEN=1]="OPEN",Di[Di.CLOSING=2]="CLOSING",Di[Di.CLOSED=3]="CLOSED",(ji=Ui||(Ui={}))[ji.ACTIVE=0]="ACTIVE",ji[ji.DEACTIVATING=1]="DEACTIVATING",ji[ji.INACTIVE=2]="INACTIVE",(Vi=Pi||(Pi={}))[Vi.LINEAR=0]="LINEAR",Vi[Vi.EXPONENTIAL=1]="EXPONENTIAL",(Fi=Mi||(Mi={})).Interval="interval",Fi.Worker="worker";class Gi{constructor(t,e=Mi.Interval,n){this._interval=t,this._strategy=e,this._debug=n,this._workerScript=`\n    var startTime = Date.now();\n    setInterval(function() {\n        self.postMessage(Date.now() - startTime);\n    }, ${this._interval});\n  `}start(t){this.stop(),this.shouldUseWorker()?this.runWorker(t):this.runInterval(t)}stop(){this.disposeWorker(),this.disposeInterval()}shouldUseWorker(){return"undefined"!=typeof Worker&&this._strategy===Mi.Worker}runWorker(t){this._debug("Using runWorker for outgoing pings"),this._worker||(this._worker=new Worker(URL.createObjectURL(new Blob([this._workerScript],{type:"text/javascript"}))),this._worker.onmessage=e=>t(e.data))}runInterval(t){if(this._debug("Using runInterval for outgoing pings"),!this._timer){const e=Date.now();this._timer=setInterval(()=>{t(Date.now()-e)},this._interval)}}disposeWorker(){this._worker&&(this._worker.terminate(),delete this._worker,this._debug("Outgoing ping disposeWorker"))}disposeInterval(){this._timer&&(clearInterval(this._timer),delete this._timer,this._debug("Outgoing ping disposeInterval"))}}class $i{constructor(t){this.versions=t}supportedVersions(){return this.versions.join(",")}protocolVersions(){return this.versions.map(t=>`v${t.replace(".","")}.stomp`)}}$i.V1_0="1.0",$i.V1_1="1.1",$i.V1_2="1.2",$i.default=new $i([$i.V1_2,$i.V1_1,$i.V1_0]);class Ji{get connectedVersion(){return this._connectedVersion}get connected(){return this._connected}constructor(t,e,n){this._client=t,this._webSocket=e,this._connected=!1,this._serverFrameHandlers={CONNECTED:t=>{this.debug(`connected to server ${t.headers.server}`),this._connected=!0,this._connectedVersion=t.headers.version,this._connectedVersion===$i.V1_2&&(this._escapeHeaderValues=!0),this._setupHeartbeat(t.headers),this.onConnect(t)},MESSAGE:t=>{const e=t.headers.subscription,n=this._subscriptions[e]||this.onUnhandledMessage,i=t,s=this,r=this._connectedVersion===$i.V1_2?i.headers.ack:i.headers["message-id"];i.ack=(t={})=>s.ack(r,e,t),i.nack=(t={})=>s.nack(r,e,t),n(i)},RECEIPT:t=>{const e=this._receiptWatchers[t.headers["receipt-id"]];e?(e(t),delete this._receiptWatchers[t.headers["receipt-id"]]):this.onUnhandledReceipt(t)},ERROR:t=>{this.onStompError(t)}},this._counter=0,this._subscriptions={},this._receiptWatchers={},this._partialData="",this._escapeHeaderValues=!1,this._lastServerActivityTS=Date.now(),this.debug=n.debug,this.stompVersions=n.stompVersions,this.connectHeaders=n.connectHeaders,this.disconnectHeaders=n.disconnectHeaders,this.heartbeatIncoming=n.heartbeatIncoming,this.heartbeatToleranceMultiplier=n.heartbeatGracePeriods,this.heartbeatOutgoing=n.heartbeatOutgoing,this.splitLargeFrames=n.splitLargeFrames,this.maxWebSocketChunkSize=n.maxWebSocketChunkSize,this.forceBinaryWSFrames=n.forceBinaryWSFrames,this.logRawCommunication=n.logRawCommunication,this.appendMissingNULLonIncoming=n.appendMissingNULLonIncoming,this.discardWebsocketOnCommFailure=n.discardWebsocketOnCommFailure,this.onConnect=n.onConnect,this.onDisconnect=n.onDisconnect,this.onStompError=n.onStompError,this.onWebSocketClose=n.onWebSocketClose,this.onWebSocketError=n.onWebSocketError,this.onUnhandledMessage=n.onUnhandledMessage,this.onUnhandledReceipt=n.onUnhandledReceipt,this.onUnhandledFrame=n.onUnhandledFrame,this.onHeartbeatReceived=n.onHeartbeatReceived,this.onHeartbeatLost=n.onHeartbeatLost}start(){const t=new Li(t=>{const e=Wi.fromRawFrame(t,this._escapeHeaderValues);this.logRawCommunication||this.debug(`<<< ${e}`);(this._serverFrameHandlers[e.command]||this.onUnhandledFrame)(e)},()=>{this.debug("<<< PONG"),this.onHeartbeatReceived()});this._webSocket.onmessage=e=>{if(this.debug("Received data"),this._lastServerActivityTS=Date.now(),this.logRawCommunication){const t=e.data instanceof ArrayBuffer?(new TextDecoder).decode(e.data):e.data;this.debug(`<<< ${t}`)}t.parseChunk(e.data,this.appendMissingNULLonIncoming)},this._webSocket.onclose=t=>{this.debug(`Connection closed to ${this._webSocket.url}`),this._cleanUp(),this.onWebSocketClose(t)},this._webSocket.onerror=t=>{this.onWebSocketError(t)},this._webSocket.onopen=()=>{const t=Object.assign({},this.connectHeaders);this.debug("Web Socket Opened..."),t["accept-version"]=this.stompVersions.supportedVersions(),t["heart-beat"]=[this.heartbeatOutgoing,this.heartbeatIncoming].join(","),this._transmit({command:"CONNECT",headers:t})}}_setupHeartbeat(t){if(t.version!==$i.V1_1&&t.version!==$i.V1_2)return;if(!t["heart-beat"])return;const[e,n]=t["heart-beat"].split(",").map(t=>parseInt(t,10));if(0!==this.heartbeatOutgoing&&0!==n){const t=Math.max(this.heartbeatOutgoing,n);this.debug(`send PING every ${t}ms`),this._pinger=new Gi(t,this._client.heartbeatStrategy,this.debug),this._pinger.start(()=>{this._webSocket.readyState===Bi.OPEN&&(this._webSocket.send(Ri),this.debug(">>> PING"))})}if(0!==this.heartbeatIncoming&&0!==e){const t=Math.max(this.heartbeatIncoming,e);this.debug(`check PONG every ${t}ms`),this._ponger=setInterval(()=>{const e=Date.now()-this._lastServerActivityTS;e>t*this.heartbeatToleranceMultiplier&&(this.debug(`did not receive server activity for the last ${e}ms`),this.onHeartbeatLost(),this._closeOrDiscardWebsocket())},t)}}_closeOrDiscardWebsocket(){this.discardWebsocketOnCommFailure?(this.debug("Discarding websocket, the underlying socket may linger for a while"),this.discardWebsocket()):(this.debug("Issuing close on the websocket"),this._closeWebsocket())}forceDisconnect(){this._webSocket&&(this._webSocket.readyState!==Bi.CONNECTING&&this._webSocket.readyState!==Bi.OPEN||this._closeOrDiscardWebsocket())}_closeWebsocket(){this._webSocket.onmessage=()=>{},this._webSocket.close()}discardWebsocket(){var t,e;"function"!=typeof this._webSocket.terminate&&(t=this._webSocket,e=t=>this.debug(t),t.terminate=function(){const n=()=>{};this.onerror=n,this.onmessage=n,this.onopen=n;const i=new Date,s=Math.random().toString().substring(2,8),r=this.onclose;this.onclose=t=>{const n=(new Date).getTime()-i.getTime();e(`Discarded socket (#${s})  closed after ${n}ms, with code/reason: ${t.code}/${t.reason}`)},this.close(),null==r||r.call(t,{code:4001,reason:`Quick discarding socket (#${s}) without waiting for the shutdown sequence.`,wasClean:!1})}),this._webSocket.terminate()}_transmit(t){const{command:e,headers:n,body:i,binaryBody:s,skipContentLengthHeader:r}=t,o=new Wi({command:e,headers:n,body:i,binaryBody:s,escapeHeaderValues:this._escapeHeaderValues,skipContentLengthHeader:r});let a=o.serialize();if(this.logRawCommunication?this.debug(`>>> ${a}`):this.debug(`>>> ${o}`),this.forceBinaryWSFrames&&"string"==typeof a&&(a=(new TextEncoder).encode(a)),"string"==typeof a&&this.splitLargeFrames){let t=a;for(;t.length>0;){const e=t.substring(0,this.maxWebSocketChunkSize);t=t.substring(this.maxWebSocketChunkSize),this._webSocket.send(e),this.debug(`chunk sent = ${e.length}, remaining = ${t.length}`)}}else this._webSocket.send(a)}dispose(){if(this.connected)try{const t=Object.assign({},this.disconnectHeaders);t.receipt||(t.receipt="close-"+this._counter++),this.watchForReceipt(t.receipt,t=>{this._closeWebsocket(),this._cleanUp(),this.onDisconnect(t)}),this._transmit({command:"DISCONNECT",headers:t})}catch(t){this.debug(`Ignoring error during disconnect ${t}`)}else this._webSocket.readyState!==Bi.CONNECTING&&this._webSocket.readyState!==Bi.OPEN||this._closeWebsocket()}_cleanUp(){this._connected=!1,this._pinger&&(this._pinger.stop(),this._pinger=void 0),this._ponger&&(clearInterval(this._ponger),this._ponger=void 0)}publish(t){const{destination:e,headers:n,body:i,binaryBody:s,skipContentLengthHeader:r}=t,o=Object.assign({destination:e},n);this._transmit({command:"SEND",headers:o,body:i,binaryBody:s,skipContentLengthHeader:r})}watchForReceipt(t,e){this._receiptWatchers[t]=e}subscribe(t,e,n={}){(n=Object.assign({},n)).id||(n.id="sub-"+this._counter++),n.destination=t,this._subscriptions[n.id]=e,this._transmit({command:"SUBSCRIBE",headers:n});const i=this;return{id:n.id,unsubscribe:t=>i.unsubscribe(n.id,t)}}unsubscribe(t,e={}){e=Object.assign({},e),delete this._subscriptions[t],e.id=t,this._transmit({command:"UNSUBSCRIBE",headers:e})}begin(t){const e=t||"tx-"+this._counter++;this._transmit({command:"BEGIN",headers:{transaction:e}});const n=this;return{id:e,commit(){n.commit(e)},abort(){n.abort(e)}}}commit(t){this._transmit({command:"COMMIT",headers:{transaction:t}})}abort(t){this._transmit({command:"ABORT",headers:{transaction:t}})}ack(t,e,n={}){n=Object.assign({},n),this._connectedVersion===$i.V1_2?n.id=t:n["message-id"]=t,n.subscription=e,this._transmit({command:"ACK",headers:n})}nack(t,e,n={}){return n=Object.assign({},n),this._connectedVersion===$i.V1_2?n.id=t:n["message-id"]=t,n.subscription=e,this._transmit({command:"NACK",headers:n})}}class qi{get webSocket(){var t;return null==(t=this._stompHandler)?void 0:t._webSocket}get disconnectHeaders(){return this._disconnectHeaders}set disconnectHeaders(t){this._disconnectHeaders=t,this._stompHandler&&(this._stompHandler.disconnectHeaders=this._disconnectHeaders)}get connected(){return!!this._stompHandler&&this._stompHandler.connected}get connectedVersion(){return this._stompHandler?this._stompHandler.connectedVersion:void 0}get active(){return this.state===Ui.ACTIVE}_changeState(t){this.state=t,this.onChangeState(t)}constructor(t={}){this.stompVersions=$i.default,this.connectionTimeout=0,this.reconnectDelay=5e3,this._nextReconnectDelay=0,this.maxReconnectDelay=9e5,this.reconnectTimeMode=Pi.LINEAR,this.heartbeatIncoming=1e4,this.heartbeatToleranceMultiplier=2,this.heartbeatOutgoing=1e4,this.heartbeatStrategy=Mi.Interval,this.splitLargeFrames=!1,this.maxWebSocketChunkSize=8192,this.forceBinaryWSFrames=!1,this.appendMissingNULLonIncoming=!1,this.discardWebsocketOnCommFailure=!1,this.state=Ui.INACTIVE;const e=()=>{};this.debug=e,this.beforeConnect=e,this.onConnect=e,this.onDisconnect=e,this.onUnhandledMessage=e,this.onUnhandledReceipt=e,this.onUnhandledFrame=e,this.onHeartbeatReceived=e,this.onHeartbeatLost=e,this.onStompError=e,this.onWebSocketClose=e,this.onWebSocketError=e,this.logRawCommunication=!1,this.onChangeState=e,this.connectHeaders={},this._disconnectHeaders={},this.configure(t)}configure(t){Object.assign(this,t),this.maxReconnectDelay>0&&this.maxReconnectDelay<this.reconnectDelay&&(this.debug(`Warning: maxReconnectDelay (${this.maxReconnectDelay}ms) is less than reconnectDelay (${this.reconnectDelay}ms). Using reconnectDelay as the maxReconnectDelay delay.`),this.maxReconnectDelay=this.reconnectDelay)}activate(){const t=()=>{this.active?this.debug("Already ACTIVE, ignoring request to activate"):(this._changeState(Ui.ACTIVE),this._nextReconnectDelay=this.reconnectDelay,this._connect())};this.state===Ui.DEACTIVATING?(this.debug("Waiting for deactivation to finish before activating"),this.deactivate().then(()=>{t()})):t()}async _connect(){if(await this.beforeConnect(this),this._stompHandler)return void this.debug("There is already a stompHandler, skipping the call to connect");if(!this.active)return void this.debug("Client has been marked inactive, will not attempt to connect");this.connectionTimeout>0&&(this._connectionWatcher&&clearTimeout(this._connectionWatcher),this._connectionWatcher=setTimeout(()=>{this.connected||(this.debug(`Connection not established in ${this.connectionTimeout}ms, closing socket`),this.forceDisconnect())},this.connectionTimeout)),this.debug("Opening Web Socket...");const t=this._createWebSocket();this._stompHandler=new Ji(this,t,{debug:this.debug,stompVersions:this.stompVersions,connectHeaders:this.connectHeaders,disconnectHeaders:this._disconnectHeaders,heartbeatIncoming:this.heartbeatIncoming,heartbeatGracePeriods:this.heartbeatToleranceMultiplier,heartbeatOutgoing:this.heartbeatOutgoing,heartbeatStrategy:this.heartbeatStrategy,splitLargeFrames:this.splitLargeFrames,maxWebSocketChunkSize:this.maxWebSocketChunkSize,forceBinaryWSFrames:this.forceBinaryWSFrames,logRawCommunication:this.logRawCommunication,appendMissingNULLonIncoming:this.appendMissingNULLonIncoming,discardWebsocketOnCommFailure:this.discardWebsocketOnCommFailure,onConnect:t=>{if(this._connectionWatcher&&(clearTimeout(this._connectionWatcher),this._connectionWatcher=void 0),this._nextReconnectDelay=this.reconnectDelay,!this.active)return this.debug("STOMP got connected while deactivate was issued, will disconnect now"),void this._disposeStompHandler();this.onConnect(t)},onDisconnect:t=>{this.onDisconnect(t)},onStompError:t=>{this.onStompError(t)},onWebSocketClose:t=>{this._stompHandler=void 0,this.state===Ui.DEACTIVATING&&this._changeState(Ui.INACTIVE),this.onWebSocketClose(t),this.active&&this._schedule_reconnect()},onWebSocketError:t=>{this.onWebSocketError(t)},onUnhandledMessage:t=>{this.onUnhandledMessage(t)},onUnhandledReceipt:t=>{this.onUnhandledReceipt(t)},onUnhandledFrame:t=>{this.onUnhandledFrame(t)},onHeartbeatReceived:()=>{this.onHeartbeatReceived()},onHeartbeatLost:()=>{this.onHeartbeatLost()}}),this._stompHandler.start()}_createWebSocket(){let t;if(this.webSocketFactory)t=this.webSocketFactory();else{if(!this.brokerURL)throw new Error("Either brokerURL or webSocketFactory must be provided");t=new WebSocket(this.brokerURL,this.stompVersions.protocolVersions())}return t.binaryType="arraybuffer",t}_schedule_reconnect(){this._nextReconnectDelay>0&&(this.debug(`STOMP: scheduling reconnection in ${this._nextReconnectDelay}ms`),this._reconnector=setTimeout(()=>{this.reconnectTimeMode===Pi.EXPONENTIAL&&(this._nextReconnectDelay=2*this._nextReconnectDelay,0!==this.maxReconnectDelay&&(this._nextReconnectDelay=Math.min(this._nextReconnectDelay,this.maxReconnectDelay))),this._connect()},this._nextReconnectDelay))}async deactivate(t={}){var e;const n=t.force||!1,i=this.active;let s;if(this.state===Ui.INACTIVE)return this.debug("Already INACTIVE, nothing more to do"),Promise.resolve();if(this._changeState(Ui.DEACTIVATING),this._nextReconnectDelay=0,this._reconnector&&(clearTimeout(this._reconnector),this._reconnector=void 0),!this._stompHandler||this.webSocket.readyState===Bi.CLOSED)return this._changeState(Ui.INACTIVE),Promise.resolve();{const t=this._stompHandler.onWebSocketClose;s=new Promise((e,n)=>{this._stompHandler.onWebSocketClose=n=>{t(n),e()}})}return n?null==(e=this._stompHandler)||e.discardWebsocket():i&&this._disposeStompHandler(),s}forceDisconnect(){this._stompHandler&&this._stompHandler.forceDisconnect()}_disposeStompHandler(){this._stompHandler&&this._stompHandler.dispose()}publish(t){this._checkConnection(),this._stompHandler.publish(t)}_checkConnection(){if(!this.connected)throw new TypeError("There is no underlying STOMP connection")}watchForReceipt(t,e){this._checkConnection(),this._stompHandler.watchForReceipt(t,e)}subscribe(t,e,n={}){return this._checkConnection(),this._stompHandler.subscribe(t,e,n)}unsubscribe(t,e={}){this._checkConnection(),this._stompHandler.unsubscribe(t,e)}begin(t){return this._checkConnection(),this._stompHandler.begin(t)}commit(t){this._checkConnection(),this._stompHandler.commit(t)}abort(t){this._checkConnection(),this._stompHandler.abort(t)}ack(t,e,n={}){this._checkConnection(),this._stompHandler.ack(t,e,n)}nack(t,e,n={}){this._checkConnection(),this._stompHandler.nack(t,e,n)}}export{qi as C,Ai as S};
