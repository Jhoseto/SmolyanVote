var e;import{R as o,j as a,r as t,a as r}from"./svmessenger-vendor-react.js";import{R as n,a as c,L as l,b as i}from"./svmessenger-vendor-livekit.js";import{g as s,e as d,s as u,a as g}from"./svmessenger-svHelpers.js";import"./svmessenger-vendor.js";import"./svmessenger-vendor-websocket.js";const m=({callState:e,callDuration:t,formatDuration:r,isMuted:n,isConnected:c,otherUserName:l,otherUserAvatar:i,onMuteToggle:u,onEndCall:g,isVideoEnabled:m,remoteVideoVisible:p,localVideoRef:h,remoteVideoRef:v,onCameraToggle:k,cameraPermissionDenied:f})=>{const b=o.useMemo(()=>{if(!l)return"–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª";try{return decodeURIComponent(l)}catch(e){return l}},[l]),w=o.useMemo(()=>{if(!i)return null;try{return decodeURIComponent(i)}catch(e){return i}},[i]),y=e=>{if(!e||""===e.trim())return!1;return!["/default-avatar","default-avatar.png","default-avatar.jpg"].some(o=>e.includes(o))},C=o.useMemo(()=>s(b.charCodeAt(0)||0),[b]),T=o.useMemo(()=>d(b),[b]);return a.jsxs("div",{className:"call-window-container",children:[a.jsxs("div",{className:"call-window-background",children:[a.jsx("div",{className:"call-window-bg-shape shape-1"}),a.jsx("div",{className:"call-window-bg-shape shape-2"}),a.jsx("div",{className:"call-window-bg-shape shape-3"}),a.jsx("div",{className:"call-window-bg-shape shape-4"})]}),"connected"===e?a.jsxs("div",{className:"call-window-video-layout",children:[a.jsx("div",{ref:v,className:"call-window-remote-video "+(p?"video-active":""),children:!p&&a.jsxs("div",{className:"call-window-avatar-fallback",children:[w&&y(w)?a.jsx("img",{src:w,alt:b,onError:e=>{e.target.style.display="none";const o=e.target.nextElementSibling;o&&(o.style.display="flex")}}):null,a.jsx("div",{className:"call-window-avatar-placeholder",style:{display:w&&y(w)?"none":"flex",backgroundColor:C,width:"120px",height:"120px",fontSize:"48px",borderRadius:"50%",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600"},children:T}),a.jsx("p",{className:"call-window-name",children:b}),a.jsx("p",{className:"call-window-status",children:c?"–°–≤—ä—Ä–∑–∞–Ω":"–°–≤—ä—Ä–∑–≤–∞–Ω–µ..."})]})}),m&&a.jsxs("div",{className:"call-window-local-video-pip",children:[a.jsx("video",{ref:h,autoPlay:!0,playsInline:!0,muted:!0,className:"local-video-element"}),a.jsx("div",{className:"pip-label",children:"–í–∏–µ"})]}),a.jsxs("div",{className:"call-window-info",children:[a.jsx("span",{className:"call-duration",children:r(t)}),m&&a.jsx("span",{className:"video-indicator",children:"Video"})]}),a.jsxs("div",{className:"call-window-controls",children:[a.jsx("button",{className:"call-control-btn "+(n?"active":""),onClick:u,title:n?"–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω":"–ò–∑–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω",children:a.jsx("i",{className:`bi bi-mic${n?"-mute":""}-fill`})}),a.jsx("button",{className:"call-control-btn "+(m?"":"inactive"),onClick:k,title:m?"–ò–∑–∫–ª—é—á–∏ –∫–∞–º–µ—Ä–∞":"–í–∫–ª—é—á–∏ –∫–∞–º–µ—Ä–∞",disabled:f,children:a.jsx("i",{className:`bi bi-camera-video${m?"":"-off"}-fill`})}),a.jsx("button",{className:"call-control-btn call-end-btn",onClick:g,title:"–ü—Ä–µ–∫—Ä–∞—Ç–∏",children:a.jsx("i",{className:"bi bi-telephone-x-fill"})})]})]}):a.jsxs("div",{className:"call-window-modal",children:[a.jsxs("div",{className:`call-window-avatar ${"connected"===e?"connected":""} ${"outgoing"===e||"incoming"===e?"pulsing":""}`,children:[w&&y(w)?a.jsx("img",{src:w,alt:b,onError:e=>{e.target.style.display="none";const o=e.target.nextElementSibling;o&&(o.style.display="flex")}}):null,a.jsx("div",{className:"call-window-avatar-placeholder",style:{display:w&&y(w)?"none":"flex",backgroundColor:C},children:T}),"connected"===e&&c&&a.jsx("div",{className:"call-window-avatar-ring"})]}),a.jsxs("div",{className:"call-window-status",children:[a.jsxs("div",{className:"call-window-title",children:["outgoing"===e&&"–û–±–∞–∂–¥–∞–Ω–µ...","incoming"===e&&"–í—Ö–æ–¥—è—â–æ –æ–±–∞–∂–¥–∞–Ω–µ","connected"===e&&a.jsxs(a.Fragment,{children:["–í —Ä–∞–∑–≥–æ–≤–æ—Ä ",b&&`—Å ${b}`]}),"rejected"===e&&"–û–±–∞–∂–¥–∞–Ω–µ—Ç–æ –µ –æ—Ç—Ö–≤—ä—Ä–ª–µ–Ω–æ"]}),a.jsx("div",{className:"call-window-subtitle",children:"connected"===e&&c?r(t):"rejected"===e?"–ó–∞—Ç–≤–∞—Ä—è–Ω–µ...":b}),("incoming"===e||"outgoing"===e)&&a.jsxs("div",{className:"call-window-calling-animation",children:[a.jsxs("div",{className:"call-window-ripple-container",children:[a.jsx("div",{className:"call-window-ripple ripple-1"}),a.jsx("div",{className:"call-window-ripple ripple-2"}),a.jsx("div",{className:"call-window-ripple ripple-3"}),a.jsx("div",{className:"call-window-ripple ripple-4"})]}),a.jsx("div",{className:"call-window-glow-core",children:a.jsx("div",{className:"call-window-glow-inner"})}),a.jsxs("div",{className:"call-window-particles",children:[a.jsx("div",{className:"particle particle-1"}),a.jsx("div",{className:"particle particle-2"}),a.jsx("div",{className:"particle particle-3"}),a.jsx("div",{className:"particle particle-4"}),a.jsx("div",{className:"particle particle-5"}),a.jsx("div",{className:"particle particle-6"})]})]}),"rejected"===e&&a.jsxs("div",{className:"call-window-calling-animation call-window-rejection-animation",children:[a.jsxs("div",{className:"call-window-ripple-container",children:[a.jsx("div",{className:"call-window-ripple ripple-1 rejection-ripple"}),a.jsx("div",{className:"call-window-ripple ripple-2 rejection-ripple"}),a.jsx("div",{className:"call-window-ripple ripple-3 rejection-ripple"}),a.jsx("div",{className:"call-window-ripple ripple-4 rejection-ripple"})]}),a.jsx("div",{className:"call-window-glow-core rejection-glow",children:a.jsx("div",{className:"call-window-glow-inner rejection-glow-inner"})}),a.jsxs("div",{className:"call-window-particles rejection-particles",children:[a.jsx("div",{className:"particle particle-1 rejection-particle"}),a.jsx("div",{className:"particle particle-2 rejection-particle"}),a.jsx("div",{className:"particle particle-3 rejection-particle"}),a.jsx("div",{className:"particle particle-4 rejection-particle"}),a.jsx("div",{className:"particle particle-5 rejection-particle"}),a.jsx("div",{className:"particle particle-6 rejection-particle"})]})]}),"connected"===e&&!c&&a.jsx("div",{className:"call-window-connecting",children:"–°–≤—ä—Ä–∑–≤–∞–Ω–µ..."})]}),a.jsxs("div",{className:"call-window-actions",children:["connected"===e&&a.jsxs(a.Fragment,{children:[a.jsx("button",{className:"call-window-btn-mute "+(n?"muted":""),onClick:u,title:n?"–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞":"–ò–∑–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞",children:n?a.jsx("i",{className:"bi bi-mic-mute muted-icon"}):a.jsx("i",{className:"bi bi-mic active-icon"})}),a.jsx("button",{className:"call-window-btn-end",onClick:g,title:"–ó–∞—Ç–≤–æ—Ä–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:a.jsx("i",{className:"bi bi-telephone end-icon"})})]}),("outgoing"===e||"incoming"===e)&&a.jsx("button",{className:"call-window-btn-end",onClick:g,title:"outgoing"===e?"–û—Ç–º–µ–Ω–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ":"–û—Ç–∫–∞–∂–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:a.jsx("i",{className:"bi bi-telephone end-icon"})}),"rejected"===e&&a.jsx("div",{className:"call-window-actions"})]})]})]})},p=({callData:e})=>{t.useEffect(()=>{console.log("üé¨ CallWindowApp component mounted with callState:",e.callState)},[]);const[o,r]=t.useState(e.callState),[s,d]=t.useState(0),[p,h]=t.useState(!1),[v,k]=t.useState(!1),[f,b]=t.useState(!1),[w,y]=t.useState(!1),[C,T]=t.useState(!1),E=t.useRef(null),S=t.useRef(null),N=t.useRef(new Map),j=t.useRef(null),R=t.useRef(null),x=t.useRef(null),P=t.useRef(null),L=t.useRef(null),I=t.useRef(!1),A=t.useRef(null),M=t.useRef(null),D=t.useRef(new Map);t.useEffect(()=>{try{const e=localStorage.getItem("svmessenger-audio-settings");if(e){const o=JSON.parse(e);o.microphone&&(j.current=o.microphone),o.speaker&&(R.current=o.speaker)}}catch(e){}},[]);const O=t.useCallback(async()=>{var o,a,t,i;try{E.current&&E.current.isConnected&&await z();const m=new n;if(E.current=m,m.on(c.Connected,()=>{var e;console.log("‚úÖ Room connected event fired"),k(!0),r("connected"),console.log("Room connected, participants:",(null==(e=m.participants)?void 0:e.size)||0),console.log("Local participant identity:",m.localParticipant.identity),m.participants&&m.participants.size>0?(console.log("Found existing participants:",m.participants.size),m.participants.forEach((e,o)=>{e.audioTrackPublications.forEach(e=>{e.track&&(console.log("  - ‚úÖ Attaching existing track for:",o),U(e.track,o))})})):console.log("No existing participants in room - we are the first")}),m.on(c.Disconnected,e=>{console.log("Room disconnected event:",e),console.log("  - isDisconnectingRef:",I.current),k(!1),I.current||"CLIENT_REQUESTED"===e||console.log("  - Unexpected disconnect, but not closing popup automatically")}),m.on(c.ParticipantConnected,e=>{console.log("üë§ Participant connected:",e.identity),console.log("  - Audio track publications:",e.audioTrackPublications.size),console.log("  - Video track publications:",e.videoTrackPublications.size),e.audioTrackPublications.forEach((o,a)=>{if(console.log("  - Processing audio publication:",a,{hasTrack:!!o.track,isSubscribed:o.isSubscribed,trackSid:o.trackSid,source:o.source}),o.track)console.log("  - ‚úÖ Attaching existing audio track for participant:",e.identity),U(o.track,e.identity);else{console.log("  - ‚è≥ Audio track not available yet, subscribing...");try{m.localParticipant.setSubscribed(o,!0),console.log("  - ‚úÖ Successfully requested audio subscription, waiting for TrackSubscribed event")}catch(t){console.error("  - ‚ùå Failed to subscribe to audio track:",t)}}}),e.videoTrackPublications.forEach((o,a)=>{if(console.log("  - Processing video publication:",a,{hasTrack:!!o.track,isSubscribed:o.isSubscribed,trackSid:o.trackSid,source:o.source}),o.track)console.log("  - ‚úÖ Attaching existing video track for participant:",e.identity),V(o.track,e.identity);else{console.log("  - ‚è≥ Video track not available yet, subscribing...");try{m.localParticipant.setSubscribed(o,!0),console.log("  - ‚úÖ Successfully requested video subscription, waiting for TrackSubscribed event")}catch(t){console.error("  - ‚ùå Failed to subscribe to video track:",t)}}})}),m.on(c.ParticipantDisconnected,o=>{var a,t,r;if(console.log("Participant disconnected:",o.identity),console.log("  - Local participant identity:",null==(a=m.localParticipant)?void 0:a.identity),console.log("  - Disconnected participant identity:",o.identity),console.log("  - Are they the same?",o.identity===(null==(t=m.localParticipant)?void 0:t.identity)),console.log("  - isDisconnectingRef:",I.current),I.current)return void console.log("  - Already disconnecting, ignoring ParticipantDisconnected event");F(o.identity),_(o.identity);const n=null==(r=m.localParticipant)?void 0:r.identity;n&&o.identity!==n?(console.log("‚ö†Ô∏è Other party disconnected, waiting before ending call..."),setTimeout(()=>{if(E.current&&E.current.isConnected&&!I.current){if(Array.from(E.current.participants.values()).some(e=>e.identity===o.identity))console.log("Participant reconnected, not ending call");else{console.log("‚úÖ Participant still disconnected after delay, ending call");try{const o={eventType:"CALL_END",conversationId:e.conversationId,callerId:e.currentUserId,receiverId:e.otherUserId,roomName:e.roomName,timestamp:(new Date).toISOString()};u.sendCallSignal(o)}catch(a){console.error("Failed to send CALL_END on participant disconnect:",a)}B()}}},5e3)):console.log("Local participant disconnected or identity mismatch - not ending call")}),m.on(c.TrackSubscribed,(e,o,a)=>{if(e&&"audio"===e.kind)console.log("üéµ Track subscribed event:",{kind:e.kind,participant:a.identity,trackSid:e.sid,publicationSid:o.trackSid,isMuted:e.isMuted}),U(e,a.identity);else if(e&&"video"===e.kind)if(console.log("üé¨ [TrackSubscribed] Video track subscribed:",{participant:a.identity,trackSid:e.sid,isLocal:a===m.localParticipant}),a===m.localParticipant)if(console.log("üé¨ [TrackSubscribed] This is LOCAL video track"),A.current&&e)try{console.log("üé¨ [TrackSubscribed] Attaching local track to localVideoRef..."),e.attach(A.current),console.log("‚úÖ [TrackSubscribed] Local video preview attached from TrackSubscribed event")}catch(t){console.error("‚ùå [TrackSubscribed] Error attaching local video:",t)}else console.warn("‚ö†Ô∏è [TrackSubscribed] Missing localVideoRef or track:",{hasRef:!!A.current,hasTrack:!!e});else console.log("üé¨ [TrackSubscribed] This is REMOTE video track"),V(e,a.identity);else console.log("üé¨ [TrackSubscribed] Track subscribed but unknown kind:",null==e?void 0:e.kind)}),m.on(c.LocalTrackPublished,(e,o)=>{var a;if(console.log("üé¨ [LocalTrackPublished] Event fired:",{hasTrack:!!e.track,trackKind:null==(a=e.track)?void 0:a.kind,trackSid:e.trackSid,source:e.source,participantIdentity:null==o?void 0:o.identity}),e.track&&"video"===e.track.kind)if(console.log("üé¨ [LocalTrackPublished] Video track detected:",{trackSid:e.trackSid,source:e.source,trackId:e.track.id,trackEnabled:e.track.isEnabled}),A.current&&e.track)try{console.log("üé¨ [LocalTrackPublished] Attaching to localVideoRef..."),e.track.attach(A.current),console.log("‚úÖ [LocalTrackPublished] Local video preview attached from event"),console.log("üé¨ [LocalTrackPublished] Video element after attach:",{srcObject:!!A.current.srcObject,videoWidth:A.current.videoWidth,videoHeight:A.current.videoHeight})}catch(t){console.error("‚ùå [LocalTrackPublished] Error attaching:",t)}else console.warn("‚ö†Ô∏è [LocalTrackPublished] Missing localVideoRef or track:",{hasRef:!!A.current,hasTrack:!!e.track});else console.log("üé¨ [LocalTrackPublished] Not a video track, ignoring")}),m.on(c.TrackPublished,(e,o)=>{var a;if(o!==m.localParticipant&&"video"===(null==(a=e.track)?void 0:a.kind))if(console.log("üé¨ [TrackPublished] Remote participant published video track:",{participant:o.identity,trackSid:e.trackSid,source:e.source,hasTrack:!!e.track,isSubscribed:e.isSubscribed}),e.isSubscribed)e.track&&(console.log("üé¨ [TrackPublished] Track already subscribed, attaching immediately..."),V(e.track,o.identity));else try{console.log("üé¨ [TrackPublished] Subscribing to remote video track..."),m.localParticipant.setSubscribed(e,!0),console.log("‚úÖ [TrackPublished] Successfully requested subscription to remote video track")}catch(t){console.error("‚ùå [TrackPublished] Failed to subscribe to remote video track:",t)}}),m.on(c.TrackUnsubscribed,(e,o,a)=>{"audio"===e.kind?F(a.identity):"video"===e.kind&&_(a.identity)}),console.log("üîå Connecting to LiveKit room:",e.roomName,"with token length:",(null==(o=e.token)?void 0:o.length)||0),console.log("üîå Token preview:",(null==(a=e.token)?void 0:a.substring(0,50))+"..."),await m.connect("wss://smolyanvote-nq17fbx3.livekit.cloud",e.token),console.log("‚úÖ Successfully connected to LiveKit room"),console.log("‚úÖ Room state:",{isConnected:m.isConnected,name:m.name,localParticipant:null==(t=m.localParticipant)?void 0:t.identity,participants:(null==(i=m.participants)?void 0:i.size)||0}),await new Promise(e=>setTimeout(e,300)),j.current&&S.current)try{const e=Array.from(m.localParticipant.audioTrackPublications.values());for(const a of e)a.track&&await m.localParticipant.unpublishTrack(a.track);const o=S.current.getAudioTracks();if(o.length>0){const e=o[0],a=new l(e);await m.localParticipant.publishTrack(a,{source:"microphone"}),console.log("‚úÖ Microphone published successfully from existing stream")}}catch(s){console.error("Failed to publish microphone from stream:",s);try{await m.localParticipant.setMicrophoneEnabled(!0),console.log("‚úÖ Enabled default microphone as fallback")}catch(d){console.error("Failed to enable default microphone:",d)}}else if(j.current)try{const e=j.current,o={audio:!e||{deviceId:{ideal:e}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},a=await navigator.mediaDevices.getUserMedia(o);S.current=a;const t=a.getAudioTracks();if(t.length>0){const e=t[0],o=new l(e);await m.localParticipant.publishTrack(o,{source:"microphone"}),console.log("‚úÖ Microphone published successfully from new stream")}}catch(g){console.error("Failed to get and publish microphone:",g);try{await m.localParticipant.setMicrophoneEnabled(!0),console.log("‚úÖ Enabled default microphone as fallback")}catch(d){console.error("Failed to enable default microphone:",d)}}else try{await m.localParticipant.setMicrophoneEnabled(!0),console.log("‚úÖ Enabled default microphone (no selection)")}catch(g){console.error("Failed to enable default microphone:",g)}}catch(g){if(console.error("Failed to connect to LiveKit:",g),k(!1),r("connected"),E.current){try{await E.current.disconnect()}catch(m){console.error("Failed to disconnect on error:",m)}E.current=null}}},[e.token]);t.useCallback(async()=>{var e,o;if(console.log("üé§ publishMicrophone called"),console.log("  - roomRef.current:",!!E.current),console.log("  - isConnected:",null==(e=E.current)?void 0:e.isConnected),console.log("  - room name:",null==(o=E.current)?void 0:o.name),E.current)if(E.current.isConnected)try{const e=Array.from(E.current.localParticipant.audioTrackPublications.values());for(const a of e)a.track&&await E.current.localParticipant.unpublishTrack(a.track);const o=j.current,n={audio:!o||{deviceId:{ideal:o}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0};let c;try{c=await navigator.mediaDevices.getUserMedia(n),console.log("Got user media stream with",c.getAudioTracks().length,"audio tracks")}catch(a){console.warn("Failed to get user media with device:",a);try{c=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),console.log("Got fallback user media stream")}catch(t){console.error("Failed to get fallback user media:",t);try{await E.current.localParticipant.setMicrophoneEnabled(!0),console.log("Enabled default microphone via setMicrophoneEnabled")}catch(r){console.error("Failed to enable default microphone:",r)}return}}S.current=c;const i=c.getAudioTracks();if(i.length>0){const e=i[0];console.log("Creating LocalAudioTrack from MediaStreamTrack:",e.id);const o=new l(e);await E.current.localParticipant.publishTrack(o,{source:"microphone"}),console.log("‚úÖ Microphone published successfully!"),console.log("  - Track SID:",o.sid),console.log("  - Track kind:",o.kind),console.log("  - Track enabled:",o.isEnabled),console.log("  - Track muted:",o.isMuted),console.log("  - Local participant publications:",E.current.localParticipant.audioTrackPublications.size)}else{console.error("No audio tracks in stream");try{await E.current.localParticipant.setMicrophoneEnabled(!0),console.log("Enabled default microphone as fallback")}catch(t){console.error("Failed to enable default microphone:",t)}}}catch(a){console.error("Failed to publish microphone:",a);try{await E.current.localParticipant.setMicrophoneEnabled(!0),console.log("Enabled default microphone after error")}catch(t){console.error("Failed to enable default microphone:",t)}}else console.error("‚ùå Cannot publish microphone: room not connected",{isConnected:E.current.isConnected,roomName:E.current.name});else console.error("‚ùå Cannot publish microphone: roomRef.current is null")},[]);const U=t.useCallback((e,o)=>{try{console.log("üîä Attaching remote audio track:",{participant:o,trackSid:e.sid,trackKind:e.kind,isMuted:e.isMuted,isEnabled:e.isEnabled});const t=N.current.get(o);if(t){console.log("Removing existing audio element for:",o);try{e.detach(t)}catch(a){console.warn("Error detaching old track:",a)}t.pause(),t.srcObject=null,t.remove()}const r=document.createElement("audio");r.autoplay=!0,r.playsInline=!0,r.volume=1,R.current&&"setSinkId"in HTMLAudioElement.prototype?r.setSinkId(R.current).then(()=>{console.log("Speaker set to:",R.current)}).catch(e=>{console.warn("Failed to set speaker:",e)}):console.log("Using default speaker (setSinkId not available or no speaker selected)"),e.attach(r),N.current.set(o,r),console.log("‚úÖ Remote audio track attached for participant:",o),console.log("Audio element properties:",{autoplay:r.autoplay,volume:r.volume,paused:r.paused,readyState:r.readyState,src:r.src}),r.addEventListener("error",e=>{console.error("‚ùå Remote audio error:",e,{error:r.error,networkState:r.networkState,readyState:r.readyState})}),r.addEventListener("loadedmetadata",()=>{console.log("üìä Remote audio metadata loaded for:",o,{duration:r.duration,readyState:r.readyState})}),r.addEventListener("canplay",()=>{console.log("‚ñ∂Ô∏è Remote audio can play for:",o)}),r.addEventListener("playing",()=>{console.log("üéµ Remote audio is playing for:",o)});const n=r.play();void 0!==n&&n.then(()=>{console.log("‚úÖ Remote audio playing for:",o)}).catch(e=>{console.warn("‚ö†Ô∏è Autoplay prevented for remote audio:",e);const o=()=>{r.play().then(()=>{console.log("‚úÖ Remote audio started after user interaction")}).catch(e=>{console.error("‚ùå Failed to play after user interaction:",e)})};document.addEventListener("click",o,{once:!0}),document.addEventListener("touchstart",o,{once:!0})})}catch(t){console.error("‚ùå Error attaching remote audio track:",t)}},[]),F=t.useCallback(e=>{const o=N.current.get(e);o&&(o.pause(),o.srcObject=null,o.remove(),N.current.delete(e))},[]),V=t.useCallback((e,o)=>{var a,t;try{console.log("üìπ Attaching remote video track:",{participant:o,trackSid:e.sid}),D.current||(D.current=new Map);const l=D.current.get(o);if(l&&l.element)try{null==(a=l.track)||a.detach(l.element)}catch(r){console.warn("Error detaching existing track:",r)}const i=document.createElement("video");if(i.autoplay=!0,i.playsInline=!0,i.muted=!1,i.style.width="100%",i.style.height="100%",i.style.objectFit="cover",i.style.backgroundColor="#000",e.attach(i),D.current.set(o,{element:i,track:e}),M.current){const e=null==(t=D.current.get(o))?void 0:t.element;if(e&&e.parentNode===M.current)try{M.current.contains(e)&&M.current.removeChild(e)}catch(r){console.warn("‚ö†Ô∏è Error removing existing video element (non-critical):",r.message);try{const e=Array.from(M.current.children);for(const o of e)M.current.contains(o)&&M.current.removeChild(o)}catch(n){console.warn("‚ö†Ô∏è Error clearing container (non-critical):",n.message);try{M.current.innerHTML=""}catch(c){console.error("‚ùå Failed to clear container:",c)}}}else try{const e=[];let o=M.current.firstChild;for(;o;)M.current.contains(o)&&e.push(o),o=o.nextSibling;e.forEach(e=>{try{M.current.contains(e)&&M.current.removeChild(e)}catch(r){console.warn("‚ö†Ô∏è Error removing child (non-critical):",r.message)}})}catch(r){console.warn("‚ö†Ô∏è Error clearing container (non-critical):",r.message);try{M.current.innerHTML=""}catch(n){console.error("‚ùå Failed to clear container:",n)}}try{M.current.appendChild(i),y(!0),console.log("‚úÖ Remote video displayed in UI")}catch(r){throw console.error("‚ùå Error appending video element:",r),r}}}catch(l){console.error("‚ùå Error attaching remote video track:",l)}},[]),_=t.useCallback(e=>{if(console.log("üìπ Detaching remote video track for:",e),D.current){const a=D.current.get(e);if(a){try{a.track&&a.element&&a.track.detach(a.element),a.element&&a.element.parentNode&&(a.element.parentNode.contains(a.element)?a.element.parentNode.removeChild(a.element):console.warn("‚ö†Ô∏è Element is not a child of parent, skipping removeChild"))}catch(o){console.warn("‚ö†Ô∏è Error detaching track (non-critical):",o.message)}D.current.delete(e)}}try{g.detachRemoteVideoTrack(e)}catch(o){console.warn("‚ö†Ô∏è Error in service detach (non-critical):",o.message)}if(y(!1),M.current&&(!D.current||0===D.current.size))try{for(;M.current.firstChild;)M.current.removeChild(M.current.firstChild)}catch(o){console.warn("‚ö†Ô∏è Error clearing container (non-critical):",o.message)}},[]),G=t.useCallback(async(e,o,a)=>{if(!e||!v)return console.warn("‚ö†Ô∏è [toggleCameraOnRoom] Cannot toggle camera - not connected"),!1;try{if(o){console.log("üé• [toggleCameraOnRoom] ENABLING camera...");const o=Array.from(e.localParticipant.videoTrackPublications.values());console.log("üé• [toggleCameraOnRoom] Existing video tracks:",o.length);for(const a of o)a.track&&(console.log("üé• [toggleCameraOnRoom] Unpublishing existing track:",a.trackSid),await e.localParticipant.unpublishTrack(a.track),a.track.stop());const r={width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}};a?(r.deviceId={exact:a},console.log("üé• [toggleCameraOnRoom] Using selected camera:",a)):console.log("üé• [toggleCameraOnRoom] No camera selected, using default"),console.log("üé• [toggleCameraOnRoom] Requesting getUserMedia with constraints:",r);const n=await navigator.mediaDevices.getUserMedia({video:r});console.log("üé• [toggleCameraOnRoom] getUserMedia success, stream:",{id:n.id,active:n.active,tracks:n.getVideoTracks().length});const c=n.getVideoTracks();if(console.log("üé• [toggleCameraOnRoom] Video tracks in stream:",c.length),0===c.length)throw new Error("No video track in stream");const l=c[0];console.log("üé• [toggleCameraOnRoom] MediaStreamTrack:",{id:l.id,kind:l.kind,label:l.label,enabled:l.enabled,readyState:l.readyState}),console.log("üé• [toggleCameraOnRoom] Creating LocalVideoTrack...");const s=new i(l);console.log("üé• [toggleCameraOnRoom] LocalVideoTrack created:",{sid:s.sid,kind:s.kind,isMuted:s.isMuted,isEnabled:s.isEnabled}),console.log("üé• [toggleCameraOnRoom] Publishing video track...");try{await e.localParticipant.publishTrack(s,{source:"camera"}),console.log("üé• [toggleCameraOnRoom] Video track published successfully")}catch(t){throw console.error("‚ùå [toggleCameraOnRoom] Error publishing video track:",t),s.stop(),t}const d=Array.from(e.localParticipant.videoTrackPublications.values());return console.log("üé• [toggleCameraOnRoom] Published tracks count:",d.length),d.forEach((e,o)=>{var a;console.log(`  Track ${o+1}:`,{trackSid:e.trackSid,source:e.source,hasTrack:!!e.track,trackId:null==(a=e.track)?void 0:a.id})}),!0}{console.log("üé• [toggleCameraOnRoom] DISABLING camera...");const o=Array.from(e.localParticipant.videoTrackPublications.values());console.log("üé• [toggleCameraOnRoom] Unpublishing",o.length,"video tracks");for(const a of o)a.track&&(console.log("üé• [toggleCameraOnRoom] Unpublishing track:",a.trackSid),await e.localParticipant.unpublishTrack(a.track),a.track.stop());return console.log("‚úÖ [toggleCameraOnRoom] Camera disabled - now billing as audio-only call"),!0}}catch(r){const e={name:r.name,message:r.message,stack:r.stack,timestamp:(new Date).toISOString(),location:"toggleCameraOnRoom"};if(console.error("‚ùå [toggleCameraOnRoom] Failed to toggle camera:",r),console.error("‚ùå [toggleCameraOnRoom] Error details:",e),x.current)try{x.current.postMessage({type:"CAMERA_ERROR",data:e})}catch(n){console.error("Failed to send error via BroadcastChannel:",n)}try{const o=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");o.push(e),o.length>10&&o.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(o))}catch(c){console.error("Failed to save error to localStorage:",c)}return!1}},[v]),J=t.useCallback(async()=>{var e,o,a,t,r,n,c,l,i,s,d,u;if(console.log("üé¨ [handleCameraToggle] START",{hasRoom:!!E.current,isConnectedState:v,roomIsConnected:null==(e=E.current)?void 0:e.isConnected,currentState:f,cameraPermissionDenied:C}),!E.current||!v&&!E.current.isConnected)return void console.warn("‚ö†Ô∏è [handleCameraToggle] Cannot toggle camera - not connected",{hasRoom:!!E.current,isConnectedState:v,roomIsConnected:null==(o=E.current)?void 0:o.isConnected});const m=!f;console.log(`üé¨ [handleCameraToggle] Toggling camera: ${f} ‚Üí ${m}`);try{if(m&&!C){console.log("üé¨ [handleCameraToggle] Requesting camera permission...");try{const e=g.selectedCamera?{video:{deviceId:{exact:g.selectedCamera}}}:{video:!0};console.log("üé¨ [handleCameraToggle] Permission constraints:",e);const o=await navigator.mediaDevices.getUserMedia(e);console.log("üé¨ [handleCameraToggle] Permission granted, stream:",{id:o.id,active:o.active,tracks:o.getTracks().length}),o.getTracks().forEach(e=>{console.log("üé¨ [handleCameraToggle] Stopping test track:",e.id),e.stop()})}catch(p){return console.error("‚ùå [handleCameraToggle] Camera permission denied:",p),T(!0),void alert("–ú–æ–ª—è —Ä–∞–∑—Ä–µ—à–µ—Ç–µ –¥–æ—Å—Ç—ä–ø –¥–æ –∫–∞–º–µ—Ä–∞—Ç–∞ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä–∞.")}}console.log("üé¨ [handleCameraToggle] Toggling camera directly on room..."),console.log("üé¨ [handleCameraToggle] Selected camera:",g.selectedCamera),console.log("üé¨ [handleCameraToggle] Room state:",{hasRoom:!!E.current,isConnected:v,hasLocalParticipant:!!(null==(a=E.current)?void 0:a.localParticipant)});const e=await G(E.current,m,g.selectedCamera);if(console.log("üé¨ [handleCameraToggle] toggleCamera result:",e),e){if(console.log("üé¨ [handleCameraToggle] toggleCamera succeeded, updating state..."),b(m),console.log("üé¨ [handleCameraToggle] isVideoEnabled state updated to:",m),console.log("üé¨ [handleCameraToggle] localVideoRef.current:",{exists:!!A.current,tagName:null==(t=A.current)?void 0:t.tagName,className:null==(r=A.current)?void 0:r.className,id:null==(n=A.current)?void 0:n.id}),m){if(console.log("üé¨ [handleCameraToggle] Attempting to attach local video preview..."),E.current&&E.current.localParticipant){const e=Array.from(E.current.localParticipant.videoTrackPublications.values());if(console.log("üé¨ [handleCameraToggle] Found video track publications:",e.length),e.length>0){const o=e[0];if(console.log("üé¨ [handleCameraToggle] Publication details:",{hasTrack:!!o.track,trackSid:o.trackSid,source:o.source,trackId:null==(c=o.track)?void 0:c.id,trackKind:null==(l=o.track)?void 0:l.kind,trackEnabled:null==(i=o.track)?void 0:i.isEnabled}),o.track&&A.current)try{console.log("üé¨ [handleCameraToggle] Attaching track to video element..."),o.track.attach(A.current),console.log("‚úÖ [handleCameraToggle] Local video preview attached immediately"),console.log("üé¨ [handleCameraToggle] Video element after attach:",{srcObject:!!A.current.srcObject,videoWidth:A.current.videoWidth,videoHeight:A.current.videoHeight,readyState:A.current.readyState})}catch(h){console.error("‚ùå [handleCameraToggle] Error attaching local video:",h),console.error("‚ùå [handleCameraToggle] Error details:",{name:h.name,message:h.message,stack:h.stack})}else console.warn("‚ö†Ô∏è [handleCameraToggle] Missing track or localVideoRef:",{hasTrack:!!o.track,hasRef:!!A.current,trackId:null==(s=o.track)?void 0:s.id,refTagName:null==(d=A.current)?void 0:d.tagName})}else console.log("‚è≥ [handleCameraToggle] No video tracks yet, waiting for LocalTrackPublished event...")}else console.warn("‚ö†Ô∏è [handleCameraToggle] Missing room or localParticipant:",{hasRoom:!!E.current,hasLocalParticipant:!!(null==(u=E.current)?void 0:u.localParticipant)});setTimeout(()=>{if(console.log("üé¨ [handleCameraToggle] Delayed fallback attempt (500ms)..."),E.current&&E.current.localParticipant&&A.current){const e=Array.from(E.current.localParticipant.videoTrackPublications.values());if(console.log("üé¨ [handleCameraToggle] Delayed check - video tracks:",e.length),e.length>0){const o=e[0];if(o.track)try{console.log("üé¨ [handleCameraToggle] Delayed attach attempt..."),o.track.attach(A.current),console.log("‚úÖ [handleCameraToggle] Local video preview attached (delayed fallback)")}catch(h){console.error("‚ùå [handleCameraToggle] Error in delayed attach:",h)}else console.warn("‚ö†Ô∏è [handleCameraToggle] Delayed check - publication has no track")}else console.warn("‚ö†Ô∏è [handleCameraToggle] Delayed check - no video tracks found")}else console.warn("‚ö†Ô∏è [handleCameraToggle] Delayed check - missing room/participant/ref")},500)}else A.current&&(console.log("üé¨ [handleCameraToggle] Clearing local video preview"),A.current.srcObject=null,console.log("üé¨ [handleCameraToggle] Local video preview cleared"));x.current&&x.current.postMessage({type:"CAMERA_TOGGLED",data:{enabled:m}})}else console.log("üé¨ [handleCameraToggle] toggleCamera failed, state NOT updated"),alert("–ù–µ—É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–≤–∞–Ω–µ/–∏–∑–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ –∫–∞–º–µ—Ä–∞—Ç–∞. –ú–æ–ª—è –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.")}catch(k){const e={name:k.name,message:k.message,stack:k.stack,timestamp:(new Date).toISOString(),location:"handleCameraToggle"};if(console.error("‚ùå [handleCameraToggle] Failed to toggle camera:",k),console.error("‚ùå [handleCameraToggle] Error details:",e),console.log("üé¨ [handleCameraToggle] Error occurred, state NOT updated"),x.current)try{x.current.postMessage({type:"CAMERA_ERROR",data:e})}catch(w){console.error("Failed to send error via BroadcastChannel:",w)}try{const o=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");o.push(e),o.length>10&&o.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(o))}catch(y){console.error("Failed to save error to localStorage:",y)}alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤–∫–ª—é—á–≤–∞–Ω–µ/–∏–∑–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ –∫–∞–º–µ—Ä–∞—Ç–∞. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –∫–æ–Ω–∑–æ–ª–∞—Ç–∞ –∑–∞ –¥–µ—Ç–∞–π–ª–∏.")}},[f,C,v,G]),H=t.useCallback(async e=>{j.current=e,S.current&&(S.current.getTracks().forEach(e=>e.stop()),S.current=null);try{const o=await navigator.mediaDevices.getUserMedia({audio:!e||{deviceId:{ideal:e}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0});if(S.current=o,E.current&&E.current.isConnected){const e=Array.from(E.current.localParticipant.audioTrackPublications.values());for(const o of e)o.track&&await E.current.localParticipant.unpublishTrack(o.track);const a=o.getAudioTracks();if(a.length>0){const e=a[0],o=new l(e);await E.current.localParticipant.publishTrack(o,{source:"microphone"})}}}catch(o){console.error("Failed to set microphone:",o)}},[]),$=t.useCallback(async e=>{R.current=e,"setSinkId"in HTMLAudioElement.prototype&&N.current.forEach(o=>{o.setSinkId(e).catch(()=>{})})},[]),z=t.useCallback(async()=>{S.current&&(S.current.getTracks().forEach(e=>e.stop()),S.current=null),N.current.forEach(e=>{e.pause(),e.srcObject=null,e.remove()}),N.current.clear(),E.current&&(await E.current.disconnect(),E.current=null),k(!1)},[]),B=t.useCallback(async()=>{if(I.current)console.log("üìû handleEndCall already in progress, ignoring");else{I.current=!0,console.log("üìû handleEndCall called"),console.log("  - Current callState:",o),console.log("  - Current isConnected:",v),console.log("  - Conversation ID:",e.conversationId),L.current&&(L.current.pause(),L.current.currentTime=0,L.current=null);try{const o={eventType:"CALL_END",conversationId:e.conversationId,callerId:e.currentUserId,receiverId:e.otherUserId,roomName:e.roomName,timestamp:(new Date).toISOString()};console.log("üì§ Sending CALL_END signal:",o),u.sendCallSignal(o),console.log("‚úÖ CALL_END signal sent from popup")}catch(a){console.error("‚ùå Failed to send CALL_END signal:",a)}await z(),x.current&&x.current.postMessage({type:"CALL_ENDED_FROM_POPUP",data:{conversationId:e.conversationId}}),console.log("üö™ Closing popup window"),window.close()}},[e,z,o,v]),K=t.useCallback(async()=>{const e=!p;if(h(e),E.current&&E.current.isConnected)try{const o=Array.from(E.current.localParticipant.audioTrackPublications.values());if(e){for(const e of o)e.track&&e.track.setEnabled(!1);await E.current.localParticipant.setMicrophoneEnabled(!1),console.log("üîá Microphone muted")}else{for(const e of o)e.track&&e.track.setEnabled(!0);await E.current.localParticipant.setMicrophoneEnabled(!0),console.log("üîä Microphone unmuted")}}catch(o){console.error("‚ùå Error toggling microphone:",o)}x.current&&x.current.postMessage({type:"MUTE_TOGGLED",data:{isMuted:e}})},[p]);t.useEffect(()=>{const e=async e=>{try{const o=new Audio(e);o.loop=!0,o.volume=.7,o.preload="auto";let a=o.play();void 0!==a&&(await a,L.current=o,console.log("‚úÖ Call sound started:",e))}catch(a){if(console.warn("‚ö†Ô∏è Failed to play call sound (autoplay blocked?):",a),"incoming"===o){const o=async()=>{try{const a=new Audio(e);a.loop=!0,a.volume=.7,await a.play(),L.current=a,console.log("‚úÖ Call sound started after user interaction"),document.removeEventListener("click",o),document.removeEventListener("touchstart",o),window.removeEventListener("focus",o)}catch(a){console.error("‚ùå Failed to play sound even after interaction:",a)}};document.addEventListener("click",o,{once:!0}),document.addEventListener("touchstart",o,{once:!0}),window.addEventListener("focus",o,{once:!0}),document.hasFocus()&&setTimeout(()=>o(),100)}}};return"outgoing"===o?e("/svmessenger/sounds/OutCall.mp3"):"incoming"===o?(window.focus&&window.focus(),e("/svmessenger/sounds/IncomingCall.mp3")):("connected"===o&&L.current||"rejected"===o&&L.current)&&(L.current.pause(),L.current.currentTime=0,L.current=null),()=>{L.current&&(L.current.pause(),L.current.currentTime=0,L.current=null)}},[o]),t.useEffect(()=>(console.log("üîÑ useEffect for callState changed:",o),"connected"===o?(console.log('‚úÖ callState is "connected", connecting to LiveKit...'),O().catch(e=>{console.error("‚ùå Failed to connect to LiveKit in useEffect:",e)})):console.log('‚è≥ callState is not "connected", waiting... (current:',o,")"),()=>{console.log("üßπ Cleaning up LiveKit connection"),z()}),[o,O,z]),t.useEffect(()=>("connected"===o&&v?P.current=setInterval(()=>{d(e=>e+1)},1e3):(P.current&&(clearInterval(P.current),P.current=null),d(0)),()=>{P.current&&clearInterval(P.current)}),[o,v]),t.useEffect(()=>{var e;if(f&&A.current&&(null==(e=E.current)?void 0:e.localParticipant)){console.log("üé¨ [useEffect] isVideoEnabled changed, attempting to attach local video...");const e=Array.from(E.current.localParticipant.videoTrackPublications.values());if(console.log("üé¨ [useEffect] Found video track publications:",e.length),e.length>0){const a=e[0];if(a.track&&A.current)try{console.log("üé¨ [useEffect] Attaching local video track to element..."),a.track.attach(A.current),console.log("‚úÖ [useEffect] Local video preview attached")}catch(o){console.error("‚ùå [useEffect] Error attaching local video:",o)}else console.warn("‚ö†Ô∏è [useEffect] Missing track or ref:",{hasTrack:!!a.track,hasRef:!!A.current})}else console.log("‚è≥ [useEffect] No video tracks yet, will retry when track is published")}},[f,v]),t.useEffect(()=>(u.connect({onCallSignal:o=>{"CALL_END"===o.eventType?(console.log("üìû CALL_END received in popup:",o),o.conversationId===e.conversationId&&(console.log("üìû CALL_END matches our call, showing rejection animation..."),r("rejected"),L.current&&(L.current.pause(),L.current.currentTime=0,L.current=null),setTimeout(()=>{B()},3e3))):"CALL_REJECT"===o.eventType&&(console.log("üìû CALL_REJECT received in popup:",o),o.conversationId===e.conversationId&&(console.log("üìû CALL_REJECT matches our call, showing rejection animation..."),r("rejected"),L.current&&(L.current.pause(),L.current.currentTime=0,L.current=null),setTimeout(()=>{B()},3e3)))},onConnect:()=>{console.log("WebSocket connected in popup")},onDisconnect:()=>{console.log("WebSocket disconnected in popup")},onError:e=>{console.error("WebSocket error in popup:",e)}}),()=>{u.disconnect()}),[e.conversationId,B]),t.useEffect(()=>{const e=e=>{var o;const a={name:"GlobalError",message:e.message||"Unknown error",filename:e.filename,lineno:e.lineno,colno:e.colno,stack:null==(o=e.error)?void 0:o.stack,timestamp:(new Date).toISOString(),location:"global"};if(console.error("‚ùå [GlobalError] Uncaught error:",a),x.current)try{x.current.postMessage({type:"CAMERA_ERROR",data:a})}catch(t){console.error("Failed to send global error:",t)}try{const e=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");e.push(a),e.length>10&&e.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(e))}catch(r){console.error("Failed to save global error:",r)}},o=e=>{var o,a;const t={name:"UnhandledPromiseRejection",message:(null==(o=e.reason)?void 0:o.message)||"Unhandled promise rejection",stack:null==(a=e.reason)?void 0:a.stack,timestamp:(new Date).toISOString(),location:"global"};if(console.error("‚ùå [GlobalError] Unhandled promise rejection:",t),x.current)try{x.current.postMessage({type:"CAMERA_ERROR",data:t})}catch(r){console.error("Failed to send promise rejection error:",r)}try{const e=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");e.push(t),e.length>10&&e.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(e))}catch(n){console.error("Failed to save promise rejection error:",n)}};return window.addEventListener("error",e),window.addEventListener("unhandledrejection",o),()=>{window.removeEventListener("error",e),window.removeEventListener("unhandledrejection",o)}},[]),t.useEffect(()=>(x.current=new BroadcastChannel("svmessenger-call"),x.current.onmessage=e=>{const{type:o,data:a}=e.data;switch(o){case"CALL_ENDED":console.log("üìû CALL_ENDED received via BroadcastChannel"),r("rejected"),L.current&&(L.current.pause(),L.current.currentTime=0,L.current=null),setTimeout(()=>{B()},3e3);break;case"CALL_REJECTED":console.log("üìû CALL_REJECTED received via BroadcastChannel"),r("rejected"),L.current&&(L.current.pause(),L.current.currentTime=0,L.current=null),setTimeout(()=>{B()},3e3);break;case"CALL_ACCEPTED":console.log("‚úÖ CALL_ACCEPTED received via BroadcastChannel, changing callState to connected"),r("connected");break;case"MUTE_TOGGLED":h(a.isMuted);break;case"DEVICE_CHANGED":a.microphone&&(j.current=a.microphone,H(a.microphone)),a.speaker&&(R.current=a.speaker,$(a.speaker))}},()=>{x.current&&x.current.close()}),[B,H,$]),t.useEffect(()=>{const e=()=>{z()};return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}},[z]);return a.jsx(m,{callState:o,callDuration:s,formatDuration:e=>{const o=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},isMuted:p,isConnected:v,otherUserName:e.otherUserName,otherUserAvatar:e.otherUserAvatar,onMuteToggle:K,onEndCall:B,isVideoEnabled:f,remoteVideoVisible:w,localVideoRef:A,remoteVideoRef:M,onCameraToggle:J,cameraPermissionDenied:C})};console.log("üöÄ Call window popup opened");const h=new URLSearchParams(window.location.search),v={token:h.get("token"),roomName:h.get("roomName"),conversationId:h.get("conversationId"),otherUserId:h.get("otherUserId"),otherUserName:h.get("otherUserName"),otherUserAvatar:h.get("otherUserAvatar"),currentUserId:h.get("currentUserId"),currentUserName:h.get("currentUserName"),currentUserAvatar:h.get("currentUserAvatar"),callType:h.get("callType")||"voice",callState:h.get("callState")||"outgoing"};if(console.log("üìû Call window data:",{hasToken:!!v.token,tokenLength:(null==(e=v.token)?void 0:e.length)||0,roomName:v.roomName,conversationId:v.conversationId,callState:v.callState,otherUserId:v.otherUserId,currentUserId:v.currentUserId}),v.token&&v.roomName&&v.conversationId){console.log("‚úÖ All required data present, mounting React app");const e=document.getElementById("call-window-root");if(e){r(e).render(a.jsx(p,{callData:v})),console.log("‚úÖ React app mounted")}else console.error("‚ùå Container element not found!")}else console.error("‚ùå Missing required call data:",{hasToken:!!v.token,hasRoomName:!!v.roomName,hasConversationId:!!v.conversationId}),document.body.innerHTML='\n        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; gap: 20px;">\n            <h2>–ì—Ä–µ—à–∫–∞</h2>\n            <p>–õ–∏–ø—Å–≤–∞—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏ –¥–∞–Ω–Ω–∏ –∑–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.</p>\n            <button onclick="window.close()" style="padding: 10px 20px; cursor: pointer;">–ó–∞—Ç–≤–æ—Ä–∏</button>\n        </div>\n    ';
