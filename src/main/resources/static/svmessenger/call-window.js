var e;import{j as o,r as t,a as n}from"./svmessenger-vendor-react.js";import{R as a,a as c,L as r}from"./svmessenger-vendor-livekit.js";import{s as i}from"./svmessenger-svWebSocketService.js";import"./svmessenger-vendor.js";import"./svmessenger-vendor-websocket.js";const l=({callState:e,callDuration:t,formatDuration:n,isMuted:a,isConnected:c,otherUserName:r,otherUserAvatar:i,onMuteToggle:l,onEndCall:s})=>{return o.jsx("div",{className:"call-window-container",children:o.jsxs("div",{className:"call-window-modal",children:[o.jsx("div",{className:"call-window-avatar",children:i?o.jsx("img",{src:i,alt:r||"User"}):o.jsx("div",{className:"call-window-avatar-placeholder",children:(d=r,d?d.charAt(0).toUpperCase():"U")})}),o.jsxs("div",{className:"call-window-status",children:[o.jsxs("div",{className:"call-window-title",children:["outgoing"===e&&"–û–±–∞–∂–¥–∞–Ω–µ...","incoming"===e&&"–í—Ö–æ–¥—è—â–æ –æ–±–∞–∂–¥–∞–Ω–µ","connected"===e&&"–í —Ä–∞–∑–≥–æ–≤–æ—Ä"]}),o.jsx("div",{className:"call-window-subtitle",children:"connected"===e&&c?n(t):r||"–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª"}),("incoming"===e||"outgoing"===e)&&o.jsx("div",{className:"call-window-icon",children:o.jsx("i",{className:"bi bi-telephone-fill"})}),"connected"===e&&!c&&o.jsx("div",{className:"call-window-connecting",children:"–°–≤—ä—Ä–∑–≤–∞–Ω–µ..."})]}),o.jsxs("div",{className:"call-window-actions",children:["connected"===e&&o.jsxs(o.Fragment,{children:[o.jsx("button",{className:"call-window-btn-mute "+(a?"muted":""),onClick:l,title:a?"–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞":"–ò–∑–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞",children:a?o.jsx("i",{className:"bi bi-mic-mute-fill"}):o.jsx("i",{className:"bi bi-mic-fill"})}),o.jsx("button",{className:"call-window-btn-end",onClick:s,title:"–ó–∞—Ç–≤–æ—Ä–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:o.jsx("i",{className:"bi bi-telephone-x-fill"})})]}),("outgoing"===e||"incoming"===e)&&o.jsx("button",{className:"call-window-btn-end",onClick:s,title:"outgoing"===e?"–û—Ç–º–µ–Ω–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ":"–û—Ç–∫–∞–∂–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:o.jsx("i",{className:"bi bi-telephone-x-fill"})})]})]})});var d},s=({callData:e})=>{t.useEffect(()=>{console.log("üé¨ CallWindowApp component mounted with callState:",e.callState)},[]);const[n,s]=t.useState(e.callState),[d,u]=t.useState(0),[p,g]=t.useState(!1),[m,h]=t.useState(!1),k=t.useRef(null),v=t.useRef(null),b=t.useRef(new Map),f=t.useRef(null),w=t.useRef(null),y=t.useRef(null),C=t.useRef(null);t.useEffect(()=>{try{const e=localStorage.getItem("svmessenger-audio-settings");if(e){const o=JSON.parse(e);o.microphone&&(f.current=o.microphone),o.speaker&&(w.current=o.speaker)}}catch(e){}},[]);const E=t.useCallback(async()=>{var o,t,n,l;try{k.current&&k.current.isConnected&&await I();const g=new a;if(k.current=g,g.on(c.Connected,()=>{var e;console.log("‚úÖ Room connected event fired"),h(!0),s("connected"),console.log("Room connected, participants:",(null==(e=g.participants)?void 0:e.size)||0),console.log("Local participant identity:",g.localParticipant.identity),g.participants&&g.participants.size>0?(console.log("Found existing participants:",g.participants.size),g.participants.forEach((e,o)=>{e.audioTrackPublications.forEach(e=>{e.track&&(console.log("  - ‚úÖ Attaching existing track for:",o),S(e.track,o))})})):console.log("No existing participants in room - we are the first")}),g.on(c.Disconnected,()=>{h(!1)}),g.on(c.ParticipantConnected,e=>{console.log("üë§ Participant connected:",e.identity),console.log("  - Audio track publications:",e.audioTrackPublications.size),console.log("  - Video track publications:",e.videoTrackPublications.size),e.audioTrackPublications.forEach((o,t)=>{if(console.log("  - Processing audio publication:",t,{hasTrack:!!o.track,isSubscribed:o.isSubscribed,trackSid:o.trackSid,source:o.source}),o.track)console.log("  - ‚úÖ Attaching existing track for participant:",e.identity),S(o.track,e.identity);else{console.log("  - ‚è≥ Track not available yet, subscribing...");try{g.localParticipant.setSubscribed(o,!0),console.log("  - ‚úÖ Successfully requested subscription, waiting for TrackSubscribed event")}catch(n){console.error("  - ‚ùå Failed to subscribe to track:",n)}}})}),g.on(c.ParticipantDisconnected,o=>{console.log("Participant disconnected:",o.identity),T(o.identity);const t=g.localParticipant.identity;if(o.identity!==t){console.log("Other party disconnected, ending call");try{const o={eventType:"CALL_END",conversationId:e.conversationId,callerId:e.currentUserId,receiverId:e.otherUserId,roomName:e.roomName,timestamp:(new Date).toISOString()};i.sendCallSignal(o)}catch(n){console.error("Failed to send CALL_END on participant disconnect:",n)}A()}}),g.on(c.TrackSubscribed,(e,o,t)=>{e&&"audio"===e.kind?(console.log("üéµ Track subscribed event:",{kind:e.kind,participant:t.identity,trackSid:e.sid,publicationSid:o.trackSid,isMuted:e.isMuted}),S(e,t.identity)):console.log("Track subscribed but not audio:",null==e?void 0:e.kind)}),g.on(c.TrackUnsubscribed,(e,o,t)=>{"audio"===e.kind&&T(t.identity)}),console.log("üîå Connecting to LiveKit room:",e.roomName,"with token length:",(null==(o=e.token)?void 0:o.length)||0),console.log("üîå Token preview:",(null==(t=e.token)?void 0:t.substring(0,50))+"..."),await g.connect("wss://smolyanvote-nq17fbx3.livekit.cloud",e.token),console.log("‚úÖ Successfully connected to LiveKit room"),console.log("‚úÖ Room state:",{isConnected:g.isConnected,name:g.name,localParticipant:null==(n=g.localParticipant)?void 0:n.identity,participants:(null==(l=g.participants)?void 0:l.size)||0}),await new Promise(e=>setTimeout(e,300)),f.current&&v.current)try{const e=Array.from(g.localParticipant.audioTrackPublications.values());for(const t of e)t.track&&await g.localParticipant.unpublishTrack(t.track);const o=v.current.getAudioTracks();if(o.length>0){const e=o[0],t=new r(e);await g.localParticipant.publishTrack(t,{source:"microphone"}),console.log("‚úÖ Microphone published successfully from existing stream")}}catch(d){console.error("Failed to publish microphone from stream:",d);try{await g.localParticipant.setMicrophoneEnabled(!0),console.log("‚úÖ Enabled default microphone as fallback")}catch(u){console.error("Failed to enable default microphone:",u)}}else if(f.current)try{const e=f.current,o={audio:!e||{deviceId:{ideal:e}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},t=await navigator.mediaDevices.getUserMedia(o);v.current=t;const n=t.getAudioTracks();if(n.length>0){const e=n[0],o=new r(e);await g.localParticipant.publishTrack(o,{source:"microphone"}),console.log("‚úÖ Microphone published successfully from new stream")}}catch(p){console.error("Failed to get and publish microphone:",p);try{await g.localParticipant.setMicrophoneEnabled(!0),console.log("‚úÖ Enabled default microphone as fallback")}catch(u){console.error("Failed to enable default microphone:",u)}}else try{await g.localParticipant.setMicrophoneEnabled(!0),console.log("‚úÖ Enabled default microphone (no selection)")}catch(p){console.error("Failed to enable default microphone:",p)}}catch(p){if(console.error("Failed to connect to LiveKit:",p),h(!1),s("connected"),k.current){try{await k.current.disconnect()}catch(g){console.error("Failed to disconnect on error:",g)}k.current=null}}},[e.token]);t.useCallback(async()=>{var e,o;if(console.log("üé§ publishMicrophone called"),console.log("  - roomRef.current:",!!k.current),console.log("  - isConnected:",null==(e=k.current)?void 0:e.isConnected),console.log("  - room name:",null==(o=k.current)?void 0:o.name),k.current)if(k.current.isConnected)try{const e=Array.from(k.current.localParticipant.audioTrackPublications.values());for(const t of e)t.track&&await k.current.localParticipant.unpublishTrack(t.track);const o=f.current,c={audio:!o||{deviceId:{ideal:o}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0};let i;try{i=await navigator.mediaDevices.getUserMedia(c),console.log("Got user media stream with",i.getAudioTracks().length,"audio tracks")}catch(t){console.warn("Failed to get user media with device:",t);try{i=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),console.log("Got fallback user media stream")}catch(n){console.error("Failed to get fallback user media:",n);try{await k.current.localParticipant.setMicrophoneEnabled(!0),console.log("Enabled default microphone via setMicrophoneEnabled")}catch(a){console.error("Failed to enable default microphone:",a)}return}}v.current=i;const l=i.getAudioTracks();if(l.length>0){const e=l[0];console.log("Creating LocalAudioTrack from MediaStreamTrack:",e.id);const o=new r(e);await k.current.localParticipant.publishTrack(o,{source:"microphone"}),console.log("‚úÖ Microphone published successfully!"),console.log("  - Track SID:",o.sid),console.log("  - Track kind:",o.kind),console.log("  - Track enabled:",o.isEnabled),console.log("  - Track muted:",o.isMuted),console.log("  - Local participant publications:",k.current.localParticipant.audioTrackPublications.size)}else{console.error("No audio tracks in stream");try{await k.current.localParticipant.setMicrophoneEnabled(!0),console.log("Enabled default microphone as fallback")}catch(n){console.error("Failed to enable default microphone:",n)}}}catch(t){console.error("Failed to publish microphone:",t);try{await k.current.localParticipant.setMicrophoneEnabled(!0),console.log("Enabled default microphone after error")}catch(n){console.error("Failed to enable default microphone:",n)}}else console.error("‚ùå Cannot publish microphone: room not connected",{isConnected:k.current.isConnected,roomName:k.current.name});else console.error("‚ùå Cannot publish microphone: roomRef.current is null")},[]);const S=t.useCallback((e,o)=>{try{console.log("üîä Attaching remote audio track:",{participant:o,trackSid:e.sid,trackKind:e.kind,isMuted:e.isMuted,isEnabled:e.isEnabled});const n=b.current.get(o);if(n){console.log("Removing existing audio element for:",o);try{e.detach(n)}catch(t){console.warn("Error detaching old track:",t)}n.pause(),n.srcObject=null,n.remove()}const a=document.createElement("audio");a.autoplay=!0,a.playsInline=!0,a.volume=1,w.current&&"setSinkId"in HTMLAudioElement.prototype?a.setSinkId(w.current).then(()=>{console.log("Speaker set to:",w.current)}).catch(e=>{console.warn("Failed to set speaker:",e)}):console.log("Using default speaker (setSinkId not available or no speaker selected)"),e.attach(a),b.current.set(o,a),console.log("‚úÖ Remote audio track attached for participant:",o),console.log("Audio element properties:",{autoplay:a.autoplay,volume:a.volume,paused:a.paused,readyState:a.readyState,src:a.src}),a.addEventListener("error",e=>{console.error("‚ùå Remote audio error:",e,{error:a.error,networkState:a.networkState,readyState:a.readyState})}),a.addEventListener("loadedmetadata",()=>{console.log("üìä Remote audio metadata loaded for:",o,{duration:a.duration,readyState:a.readyState})}),a.addEventListener("canplay",()=>{console.log("‚ñ∂Ô∏è Remote audio can play for:",o)}),a.addEventListener("playing",()=>{console.log("üéµ Remote audio is playing for:",o)});const c=a.play();void 0!==c&&c.then(()=>{console.log("‚úÖ Remote audio playing for:",o)}).catch(e=>{console.warn("‚ö†Ô∏è Autoplay prevented for remote audio:",e);const o=()=>{a.play().then(()=>{console.log("‚úÖ Remote audio started after user interaction")}).catch(e=>{console.error("‚ùå Failed to play after user interaction:",e)})};document.addEventListener("click",o,{once:!0}),document.addEventListener("touchstart",o,{once:!0})})}catch(n){console.error("‚ùå Error attaching remote audio track:",n)}},[]),T=t.useCallback(e=>{const o=b.current.get(e);o&&(o.pause(),o.srcObject=null,o.remove(),b.current.delete(e))},[]),N=t.useCallback(async e=>{f.current=e,v.current&&(v.current.getTracks().forEach(e=>e.stop()),v.current=null);try{const o=await navigator.mediaDevices.getUserMedia({audio:!e||{deviceId:{ideal:e}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0});if(v.current=o,k.current&&k.current.isConnected){const e=Array.from(k.current.localParticipant.audioTrackPublications.values());for(const o of e)o.track&&await k.current.localParticipant.unpublishTrack(o.track);const t=o.getAudioTracks();if(t.length>0){const e=t[0],o=new r(e);await k.current.localParticipant.publishTrack(o,{source:"microphone"})}}}catch(o){console.error("Failed to set microphone:",o)}},[]),L=t.useCallback(async e=>{w.current=e,"setSinkId"in HTMLAudioElement.prototype&&b.current.forEach(o=>{o.setSinkId(e).catch(()=>{})})},[]),I=t.useCallback(async()=>{v.current&&(v.current.getTracks().forEach(e=>e.stop()),v.current=null),b.current.forEach(e=>{e.pause(),e.srcObject=null,e.remove()}),b.current.clear(),k.current&&(await k.current.disconnect(),k.current=null),h(!1)},[]),A=t.useCallback(async()=>{console.log("üìû handleEndCall called"),console.log("  - Current callState:",n),console.log("  - Current isConnected:",m),console.log("  - Conversation ID:",e.conversationId);try{const o={eventType:"CALL_END",conversationId:e.conversationId,callerId:e.currentUserId,receiverId:e.otherUserId,roomName:e.roomName,timestamp:(new Date).toISOString()};console.log("üì§ Sending CALL_END signal:",o),i.sendCallSignal(o),console.log("‚úÖ CALL_END signal sent from popup")}catch(o){console.error("‚ùå Failed to send CALL_END signal:",o)}await I(),y.current&&y.current.postMessage({type:"CALL_ENDED_FROM_POPUP",data:{conversationId:e.conversationId}}),console.log("üö™ Closing popup window"),window.close()},[e,I,n,m]),P=t.useCallback(()=>{const e=!p;g(e),k.current&&k.current.isConnected&&(e?k.current.localParticipant.setMicrophoneEnabled(!1):k.current.localParticipant.setMicrophoneEnabled(!0)),y.current&&y.current.postMessage({type:"MUTE_TOGGLED",data:{isMuted:e}})},[p]);t.useEffect(()=>(console.log("üîÑ useEffect for callState changed:",n),"connected"===n?(console.log('‚úÖ callState is "connected", connecting to LiveKit...'),E().catch(e=>{console.error("‚ùå Failed to connect to LiveKit in useEffect:",e)})):console.log('‚è≥ callState is not "connected", waiting... (current:',n,")"),()=>{console.log("üßπ Cleaning up LiveKit connection"),I()}),[n,E,I]),t.useEffect(()=>("connected"===n&&m?C.current=setInterval(()=>{u(e=>e+1)},1e3):(C.current&&(clearInterval(C.current),C.current=null),u(0)),()=>{C.current&&clearInterval(C.current)}),[n,m]),t.useEffect(()=>(i.connect({onCallSignal:o=>{"CALL_END"===o.eventType&&(console.log("üìû CALL_END received in popup:",o),o.conversationId===e.conversationId&&(console.log("üìû CALL_END matches our call, ending..."),A()))},onConnect:()=>{console.log("WebSocket connected in popup")},onDisconnect:()=>{console.log("WebSocket disconnected in popup")},onError:e=>{console.error("WebSocket error in popup:",e)}}),()=>{i.disconnect()}),[e.conversationId,A]),t.useEffect(()=>(y.current=new BroadcastChannel("svmessenger-call"),y.current.onmessage=e=>{const{type:o,data:t}=e.data;switch(o){case"CALL_ENDED":console.log("üìû CALL_ENDED received via BroadcastChannel"),A();break;case"CALL_ACCEPTED":console.log("‚úÖ CALL_ACCEPTED received via BroadcastChannel, changing callState to connected"),s("connected");break;case"MUTE_TOGGLED":g(t.isMuted);break;case"DEVICE_CHANGED":t.microphone&&(f.current=t.microphone,N(t.microphone)),t.speaker&&(w.current=t.speaker,L(t.speaker))}},()=>{y.current&&y.current.close()}),[A,N,L]),t.useEffect(()=>{const e=()=>{I()};return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}},[I]);return o.jsx(l,{callState:n,callDuration:d,formatDuration:e=>{const o=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},isMuted:p,isConnected:m,otherUserName:e.otherUserName,otherUserAvatar:e.otherUserAvatar,onMuteToggle:P,onEndCall:A})};console.log("üöÄ Call window popup opened");const d=new URLSearchParams(window.location.search),u={token:d.get("token"),roomName:d.get("roomName"),conversationId:d.get("conversationId"),otherUserId:d.get("otherUserId"),otherUserName:d.get("otherUserName"),otherUserAvatar:d.get("otherUserAvatar"),currentUserId:d.get("currentUserId"),currentUserName:d.get("currentUserName"),currentUserAvatar:d.get("currentUserAvatar"),callType:d.get("callType")||"voice",callState:d.get("callState")||"outgoing"};if(console.log("üìû Call window data:",{hasToken:!!u.token,tokenLength:(null==(e=u.token)?void 0:e.length)||0,roomName:u.roomName,conversationId:u.conversationId,callState:u.callState,otherUserId:u.otherUserId,currentUserId:u.currentUserId}),u.token&&u.roomName&&u.conversationId){console.log("‚úÖ All required data present, mounting React app");const e=document.getElementById("call-window-root");if(e){n(e).render(o.jsx(s,{callData:u})),console.log("‚úÖ React app mounted")}else console.error("‚ùå Container element not found!")}else console.error("‚ùå Missing required call data:",{hasToken:!!u.token,hasRoomName:!!u.roomName,hasConversationId:!!u.conversationId}),document.body.innerHTML='\n        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; gap: 20px;">\n            <h2>–ì—Ä–µ—à–∫–∞</h2>\n            <p>–õ–∏–ø—Å–≤–∞—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏ –¥–∞–Ω–Ω–∏ –∑–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.</p>\n            <button onclick="window.close()" style="padding: 10px 20px; cursor: pointer;">–ó–∞—Ç–≤–æ—Ä–∏</button>\n        </div>\n    ';
