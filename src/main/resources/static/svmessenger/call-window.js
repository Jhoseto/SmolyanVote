var e;import{R as o,j as a,r as t,a as n}from"./svmessenger-vendor-react.js";import{R as r,a as c,L as l,b as i}from"./svmessenger-vendor-livekit.js";import{g as s,e as d,s as u,a as g}from"./svmessenger-svHelpers.js";import"./svmessenger-vendor.js";import"./svmessenger-vendor-websocket.js";const m=({callState:e,callDuration:t,formatDuration:n,isMuted:r,isConnected:c,otherUserName:l,otherUserAvatar:i,onMuteToggle:u,onEndCall:g,isVideoEnabled:m,remoteVideoVisible:p,localVideoRef:h,remoteVideoRef:v,onCameraToggle:k,cameraPermissionDenied:f})=>{const w=o.useMemo(()=>{if(!l)return"–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª";try{return decodeURIComponent(l)}catch(e){return l}},[l]),b=o.useMemo(()=>{if(!i)return null;try{return decodeURIComponent(i)}catch(e){return i}},[i]),y=e=>{if(!e||""===e.trim())return!1;return!["/default-avatar","default-avatar.png","default-avatar.jpg"].some(o=>e.includes(o))},C=o.useMemo(()=>s(w.charCodeAt(0)||0),[w]),E=o.useMemo(()=>d(w),[w]);return a.jsxs("div",{className:"call-window-container",children:[a.jsxs("div",{className:"call-window-background",children:[a.jsx("div",{className:"call-window-bg-shape shape-1"}),a.jsx("div",{className:"call-window-bg-shape shape-2"}),a.jsx("div",{className:"call-window-bg-shape shape-3"}),a.jsx("div",{className:"call-window-bg-shape shape-4"})]}),"connected"===e?a.jsxs("div",{className:"call-window-video-layout",children:[a.jsx("div",{ref:v,className:"call-window-remote-video "+(p?"video-active":""),children:!p&&a.jsxs("div",{className:"call-window-avatar-fallback",children:[b&&y(b)?a.jsx("img",{src:b,alt:w,onError:e=>{e.target.style.display="none";const o=e.target.nextElementSibling;o&&(o.style.display="flex")}}):null,a.jsx("div",{className:"call-window-avatar-placeholder",style:{display:b&&y(b)?"none":"flex",backgroundColor:C,width:"120px",height:"120px",fontSize:"48px",borderRadius:"50%",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600"},children:E}),a.jsx("p",{className:"call-window-name",children:w}),a.jsx("p",{className:"call-window-status",children:c?"–°–≤—ä—Ä–∑–∞–Ω":"–°–≤—ä—Ä–∑–≤–∞–Ω–µ..."})]})}),m&&a.jsxs("div",{className:"video-quality-badge",children:[a.jsx("i",{className:"bi bi-badge-hd-fill"}),a.jsx("span",{children:"Full HD"})]}),a.jsx("div",{className:"connection-indicator excellent",children:a.jsxs("div",{className:"signal-bars",children:[a.jsx("span",{}),a.jsx("span",{}),a.jsx("span",{})]})}),m&&a.jsxs("div",{className:"call-window-local-video-pip",children:[a.jsx("video",{ref:h,autoPlay:!0,playsInline:!0,muted:!0,className:"local-video-element",style:{objectFit:"cover"}}),a.jsx("div",{className:"pip-label",children:"–í–∏–µ"})]}),a.jsxs("div",{className:"call-window-info",children:[a.jsx("span",{className:"call-duration",children:n(t)}),m&&a.jsx("span",{className:"video-indicator",children:"Video"})]}),a.jsxs("div",{className:"call-window-controls",children:[a.jsx("button",{className:"call-control-btn "+(r?"active":""),onClick:u,title:r?"–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω":"–ò–∑–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω",children:a.jsx("i",{className:`bi bi-mic${r?"-mute":""}-fill`})}),a.jsx("button",{className:"call-control-btn "+(m?"":"inactive"),onClick:k,title:m?"–ò–∑–∫–ª—é—á–∏ –∫–∞–º–µ—Ä–∞":"–í–∫–ª—é—á–∏ –∫–∞–º–µ—Ä–∞",disabled:f,children:a.jsx("i",{className:`bi bi-camera-video${m?"":"-off"}-fill`})}),a.jsx("button",{className:"call-control-btn call-end-btn",onClick:g,title:"–ü—Ä–µ–∫—Ä–∞—Ç–∏",children:a.jsx("i",{className:"bi bi-telephone-x-fill"})})]})]}):a.jsxs("div",{className:"call-window-modal",children:[a.jsxs("div",{className:`call-window-avatar ${"connected"===e?"connected":""} ${"outgoing"===e||"incoming"===e?"pulsing":""}`,children:[b&&y(b)?a.jsx("img",{src:b,alt:w,onError:e=>{e.target.style.display="none";const o=e.target.nextElementSibling;o&&(o.style.display="flex")}}):null,a.jsx("div",{className:"call-window-avatar-placeholder",style:{display:b&&y(b)?"none":"flex",backgroundColor:C},children:E}),"connected"===e&&c&&a.jsx("div",{className:"call-window-avatar-ring"})]}),a.jsxs("div",{className:"call-window-status",children:[a.jsxs("div",{className:"call-window-title",children:["outgoing"===e&&"–û–±–∞–∂–¥–∞–Ω–µ...","incoming"===e&&"–í—Ö–æ–¥—è—â–æ –æ–±–∞–∂–¥–∞–Ω–µ","connected"===e&&a.jsxs(a.Fragment,{children:["–í —Ä–∞–∑–≥–æ–≤–æ—Ä ",w&&`—Å ${w}`]}),"rejected"===e&&"–û–±–∞–∂–¥–∞–Ω–µ—Ç–æ –µ –æ—Ç—Ö–≤—ä—Ä–ª–µ–Ω–æ"]}),a.jsx("div",{className:"call-window-subtitle",children:"connected"===e&&c?n(t):"rejected"===e?"–ó–∞—Ç–≤–∞—Ä—è–Ω–µ...":w}),("incoming"===e||"outgoing"===e)&&a.jsxs("div",{className:"call-window-calling-animation",children:[a.jsxs("div",{className:"call-window-ripple-container",children:[a.jsx("div",{className:"call-window-ripple ripple-1"}),a.jsx("div",{className:"call-window-ripple ripple-2"}),a.jsx("div",{className:"call-window-ripple ripple-3"}),a.jsx("div",{className:"call-window-ripple ripple-4"})]}),a.jsx("div",{className:"call-window-glow-core",children:a.jsx("div",{className:"call-window-glow-inner"})}),a.jsxs("div",{className:"call-window-particles",children:[a.jsx("div",{className:"particle particle-1"}),a.jsx("div",{className:"particle particle-2"}),a.jsx("div",{className:"particle particle-3"}),a.jsx("div",{className:"particle particle-4"}),a.jsx("div",{className:"particle particle-5"}),a.jsx("div",{className:"particle particle-6"})]})]}),"rejected"===e&&a.jsxs("div",{className:"call-window-calling-animation call-window-rejection-animation",children:[a.jsxs("div",{className:"call-window-ripple-container",children:[a.jsx("div",{className:"call-window-ripple ripple-1 rejection-ripple"}),a.jsx("div",{className:"call-window-ripple ripple-2 rejection-ripple"}),a.jsx("div",{className:"call-window-ripple ripple-3 rejection-ripple"}),a.jsx("div",{className:"call-window-ripple ripple-4 rejection-ripple"})]}),a.jsx("div",{className:"call-window-glow-core rejection-glow",children:a.jsx("div",{className:"call-window-glow-inner rejection-glow-inner"})}),a.jsxs("div",{className:"call-window-particles rejection-particles",children:[a.jsx("div",{className:"particle particle-1 rejection-particle"}),a.jsx("div",{className:"particle particle-2 rejection-particle"}),a.jsx("div",{className:"particle particle-3 rejection-particle"}),a.jsx("div",{className:"particle particle-4 rejection-particle"}),a.jsx("div",{className:"particle particle-5 rejection-particle"}),a.jsx("div",{className:"particle particle-6 rejection-particle"})]})]}),"connected"===e&&!c&&a.jsx("div",{className:"call-window-connecting",children:"–°–≤—ä—Ä–∑–≤–∞–Ω–µ..."})]}),a.jsxs("div",{className:"call-window-actions",children:["connected"===e&&a.jsxs(a.Fragment,{children:[a.jsx("button",{className:"call-window-btn-mute "+(r?"muted":""),onClick:u,title:r?"–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞":"–ò–∑–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞",children:r?a.jsx("i",{className:"bi bi-mic-mute muted-icon"}):a.jsx("i",{className:"bi bi-mic active-icon"})}),a.jsx("button",{className:"call-window-btn-end",onClick:g,title:"–ó–∞—Ç–≤–æ—Ä–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:a.jsx("i",{className:"bi bi-telephone end-icon"})})]}),("outgoing"===e||"incoming"===e)&&a.jsx("button",{className:"call-window-btn-end",onClick:g,title:"outgoing"===e?"–û—Ç–º–µ–Ω–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ":"–û—Ç–∫–∞–∂–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:a.jsx("i",{className:"bi bi-telephone end-icon"})}),"rejected"===e&&a.jsx("div",{className:"call-window-actions"})]})]})]})},p=({callData:e})=>{t.useEffect(()=>{console.log("üé¨ CallWindowApp component mounted with callState:",e.callState)},[]);const[o,n]=t.useState(e.callState),[s,d]=t.useState(0),[p,h]=t.useState(!1),[v,k]=t.useState(!1),[f,w]=t.useState(!1),[b,y]=t.useState(!1),[C,E]=t.useState(!1),T=t.useRef(null),N=t.useRef(null),j=t.useRef(new Map),S=t.useRef(null),x=t.useRef(null),R=t.useRef(null),L=t.useRef(null),P=t.useRef(null),I=t.useRef(!1),A=t.useRef(null),M=t.useRef(null),D=t.useRef(new Map);t.useEffect(()=>{try{const e=localStorage.getItem("svmessenger-audio-settings");if(e){const o=JSON.parse(e);o.microphone&&(S.current=o.microphone),o.speaker&&(x.current=o.speaker)}}catch(e){}},[]);const O=t.useCallback(async()=>{var o,a,t,i;try{T.current&&T.current.isConnected&&await $();const m=new r;if(T.current=m,m.on(c.Connected,()=>{var e;console.log("‚úÖ Room connected event fired"),k(!0),n("connected"),console.log("Room connected, participants:",(null==(e=m.participants)?void 0:e.size)||0),console.log("Local participant identity:",m.localParticipant.identity),m.participants&&m.participants.size>0?(console.log("Found existing participants:",m.participants.size),m.participants.forEach((e,o)=>{e.audioTrackPublications.forEach(e=>{e.track&&(console.log("  - ‚úÖ Attaching existing track for:",o),U(e.track,o))})})):console.log("No existing participants in room - we are the first")}),m.on(c.Disconnected,e=>{console.log("Room disconnected event:",e),console.log("  - isDisconnectingRef:",I.current),k(!1),I.current||"CLIENT_REQUESTED"===e||console.log("  - Unexpected disconnect, but not closing popup automatically")}),m.on(c.ParticipantConnected,e=>{console.log("üë§ Participant connected:",e.identity),console.log("  - Audio track publications:",e.audioTrackPublications.size),console.log("  - Video track publications:",e.videoTrackPublications.size),e.audioTrackPublications.forEach((o,a)=>{o.track?(console.log("  - ‚úÖ Attaching existing audio track:",a),U(o.track,e.identity)):console.log("  - ‚è≥ Audio track not ready yet, will attach via TrackSubscribed event")}),e.videoTrackPublications.forEach((o,a)=>{o.track?(console.log("  - ‚úÖ Attaching existing video track:",a),V(o.track,e.identity)):console.log("  - ‚è≥ Video track not ready yet, will attach via TrackSubscribed event")})}),m.on(c.ParticipantDisconnected,o=>{var a,t,n;if(console.log("Participant disconnected:",o.identity),console.log("  - Local participant identity:",null==(a=m.localParticipant)?void 0:a.identity),console.log("  - Disconnected participant identity:",o.identity),console.log("  - Are they the same?",o.identity===(null==(t=m.localParticipant)?void 0:t.identity)),console.log("  - isDisconnectingRef:",I.current),I.current)return void console.log("  - Already disconnecting, ignoring ParticipantDisconnected event");F(o.identity),_(o.identity);const r=null==(n=m.localParticipant)?void 0:n.identity;r&&o.identity!==r?(console.log("‚ö†Ô∏è Other party disconnected, waiting before ending call..."),setTimeout(()=>{if(T.current&&T.current.isConnected&&!I.current){if(Array.from(T.current.participants.values()).some(e=>e.identity===o.identity))console.log("Participant reconnected, not ending call");else{console.log("‚úÖ Participant still disconnected after delay, ending call");try{const o={eventType:"CALL_END",conversationId:e.conversationId,callerId:e.currentUserId,receiverId:e.otherUserId,roomName:e.roomName,timestamp:(new Date).toISOString()};u.sendCallSignal(o)}catch(a){console.error("Failed to send CALL_END on participant disconnect:",a)}B()}}},8e3)):console.log("Local participant disconnected or identity mismatch - not ending call")}),m.on(c.TrackSubscribed,(e,o,a)=>{const t=a===m.localParticipant;if(console.log("‚úÖ [TrackSubscribed] Track subscribed:",{kind:e.kind,participant:a.identity,trackSid:e.sid,isLocal:t}),"audio"===e.kind)console.log("  - üîä Attaching remote audio track"),U(e,a.identity);else if("video"===e.kind)if(t)if(console.log("  - üìπ Attaching local video to preview"),A.current)try{e.attach(A.current),console.log("  - ‚úÖ Local video preview attached")}catch(n){console.error("  - ‚ùå Error attaching local video:",n)}else console.warn("  - ‚ö†Ô∏è localVideoRef not available");else console.log("  - üé¨ Attaching remote video track"),V(e,a.identity)}),m.on(c.LocalTrackPublished,(e,o)=>{var a;if(console.log("üé¨ [LocalTrackPublished] Event fired:",{hasTrack:!!e.track,trackKind:null==(a=e.track)?void 0:a.kind,trackSid:e.trackSid,source:e.source,participantIdentity:null==o?void 0:o.identity}),e.track&&"video"===e.track.kind)if(console.log("üé¨ [LocalTrackPublished] Video track detected:",{trackSid:e.trackSid,source:e.source,trackId:e.track.id,trackEnabled:e.track.isEnabled}),A.current&&e.track)try{console.log("üé¨ [LocalTrackPublished] Attaching to localVideoRef..."),e.track.attach(A.current),console.log("‚úÖ [LocalTrackPublished] Local video preview attached from event"),console.log("üé¨ [LocalTrackPublished] Video element after attach:",{srcObject:!!A.current.srcObject,videoWidth:A.current.videoWidth,videoHeight:A.current.videoHeight})}catch(t){console.error("‚ùå [LocalTrackPublished] Error attaching:",t)}else console.warn("‚ö†Ô∏è [LocalTrackPublished] Missing localVideoRef or track:",{hasRef:!!A.current,hasTrack:!!e.track});else console.log("üé¨ [LocalTrackPublished] Not a video track, ignoring")}),m.on(c.TrackPublished,(e,o)=>{const a=o===m.localParticipant;console.log("üì¢ [TrackPublished] Track published:",{kind:e.kind,participant:o.identity,trackSid:e.trackSid,source:e.source,isLocal:a}),a||console.log("  - Remote track will be auto-subscribed by LiveKit")}),m.on(c.TrackUnsubscribed,(e,o,a)=>{"audio"===e.kind?F(a.identity):"video"===e.kind&&_(a.identity)}),console.log("üîå Connecting to LiveKit room:",e.roomName,"with token length:",(null==(o=e.token)?void 0:o.length)||0),console.log("üîå Token preview:",(null==(a=e.token)?void 0:a.substring(0,50))+"..."),await m.connect("wss://smolyanvote-nq17fbx3.livekit.cloud",e.token),console.log("‚úÖ Successfully connected to LiveKit room"),console.log("‚úÖ Room state:",{isConnected:m.isConnected,name:m.name,localParticipant:null==(t=m.localParticipant)?void 0:t.identity,participants:(null==(i=m.participants)?void 0:i.size)||0}),await new Promise(e=>setTimeout(e,300)),S.current&&N.current)try{const e=Array.from(m.localParticipant.audioTrackPublications.values());for(const a of e)a.track&&await m.localParticipant.unpublishTrack(a.track);const o=N.current.getAudioTracks();if(o.length>0){const e=o[0],a=new l(e);await m.localParticipant.publishTrack(a,{source:"microphone"}),console.log("‚úÖ Microphone published successfully from existing stream")}}catch(s){console.error("Failed to publish microphone from stream:",s);try{await m.localParticipant.setMicrophoneEnabled(!0),console.log("‚úÖ Enabled default microphone as fallback")}catch(d){console.error("Failed to enable default microphone:",d)}}else if(S.current)try{const e=S.current,o={audio:!e||{deviceId:{ideal:e}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},a=await navigator.mediaDevices.getUserMedia(o);N.current=a;const t=a.getAudioTracks();if(t.length>0){const e=t[0],o=new l(e);await m.localParticipant.publishTrack(o,{source:"microphone"}),console.log("‚úÖ Microphone published successfully from new stream")}}catch(g){console.error("Failed to get and publish microphone:",g);try{await m.localParticipant.setMicrophoneEnabled(!0),console.log("‚úÖ Enabled default microphone as fallback")}catch(d){console.error("Failed to enable default microphone:",d)}}else try{await m.localParticipant.setMicrophoneEnabled(!0),console.log("‚úÖ Enabled default microphone (no selection)")}catch(g){console.error("Failed to enable default microphone:",g)}}catch(g){if(console.error("Failed to connect to LiveKit:",g),k(!1),n("connected"),T.current){try{await T.current.disconnect()}catch(m){console.error("Failed to disconnect on error:",m)}T.current=null}}},[e.token]);t.useCallback(async()=>{var e,o;if(console.log("üé§ publishMicrophone called"),console.log("  - roomRef.current:",!!T.current),console.log("  - isConnected:",null==(e=T.current)?void 0:e.isConnected),console.log("  - room name:",null==(o=T.current)?void 0:o.name),T.current)if(T.current.isConnected)try{const e=Array.from(T.current.localParticipant.audioTrackPublications.values());for(const a of e)a.track&&await T.current.localParticipant.unpublishTrack(a.track);const o=S.current,r={audio:!o||{deviceId:{ideal:o}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0};let c;try{c=await navigator.mediaDevices.getUserMedia(r),console.log("Got user media stream with",c.getAudioTracks().length,"audio tracks")}catch(a){console.warn("Failed to get user media with device:",a);try{c=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),console.log("Got fallback user media stream")}catch(t){console.error("Failed to get fallback user media:",t);try{await T.current.localParticipant.setMicrophoneEnabled(!0),console.log("Enabled default microphone via setMicrophoneEnabled")}catch(n){console.error("Failed to enable default microphone:",n)}return}}N.current=c;const i=c.getAudioTracks();if(i.length>0){const e=i[0];console.log("Creating LocalAudioTrack from MediaStreamTrack:",e.id);const o=new l(e);await T.current.localParticipant.publishTrack(o,{source:"microphone"}),console.log("‚úÖ Microphone published successfully!"),console.log("  - Track SID:",o.sid),console.log("  - Track kind:",o.kind),console.log("  - Track enabled:",o.isEnabled),console.log("  - Track muted:",o.isMuted),console.log("  - Local participant publications:",T.current.localParticipant.audioTrackPublications.size)}else{console.error("No audio tracks in stream");try{await T.current.localParticipant.setMicrophoneEnabled(!0),console.log("Enabled default microphone as fallback")}catch(t){console.error("Failed to enable default microphone:",t)}}}catch(a){console.error("Failed to publish microphone:",a);try{await T.current.localParticipant.setMicrophoneEnabled(!0),console.log("Enabled default microphone after error")}catch(t){console.error("Failed to enable default microphone:",t)}}else console.error("‚ùå Cannot publish microphone: room not connected",{isConnected:T.current.isConnected,roomName:T.current.name});else console.error("‚ùå Cannot publish microphone: roomRef.current is null")},[]);const U=t.useCallback((e,o)=>{try{console.log("üîä Attaching remote audio track:",{participant:o,trackSid:e.sid,trackKind:e.kind,isMuted:e.isMuted,isEnabled:e.isEnabled});const t=j.current.get(o);if(t){console.log("Removing existing audio element for:",o);try{e.detach(t)}catch(a){console.warn("Error detaching old track:",a)}t.pause(),t.srcObject=null,t.remove()}const n=document.createElement("audio");n.autoplay=!0,n.playsInline=!0,n.volume=1,x.current&&"setSinkId"in HTMLAudioElement.prototype?n.setSinkId(x.current).then(()=>{console.log("Speaker set to:",x.current)}).catch(e=>{console.warn("Failed to set speaker:",e)}):console.log("Using default speaker (setSinkId not available or no speaker selected)"),e.attach(n),j.current.set(o,n),console.log("‚úÖ Remote audio track attached for participant:",o),console.log("Audio element properties:",{autoplay:n.autoplay,volume:n.volume,paused:n.paused,readyState:n.readyState,src:n.src}),n.addEventListener("error",e=>{console.error("‚ùå Remote audio error:",e,{error:n.error,networkState:n.networkState,readyState:n.readyState})}),n.addEventListener("loadedmetadata",()=>{console.log("üìä Remote audio metadata loaded for:",o,{duration:n.duration,readyState:n.readyState})}),n.addEventListener("canplay",()=>{console.log("‚ñ∂Ô∏è Remote audio can play for:",o)}),n.addEventListener("playing",()=>{console.log("üéµ Remote audio is playing for:",o)});const r=n.play();void 0!==r&&r.then(()=>{console.log("‚úÖ Remote audio playing for:",o)}).catch(e=>{console.warn("‚ö†Ô∏è Autoplay prevented for remote audio:",e);const o=()=>{n.play().then(()=>{console.log("‚úÖ Remote audio started after user interaction")}).catch(e=>{console.error("‚ùå Failed to play after user interaction:",e)})};document.addEventListener("click",o,{once:!0}),document.addEventListener("touchstart",o,{once:!0})})}catch(t){console.error("‚ùå Error attaching remote audio track:",t)}},[]),F=t.useCallback(e=>{const o=j.current.get(e);o&&(o.pause(),o.srcObject=null,o.remove(),j.current.delete(e))},[]),V=t.useCallback((e,o)=>{var a;try{console.log("üìπ Attaching remote video track:",{participant:o,trackSid:e.sid}),D.current||(D.current=new Map);const n=D.current.get(o);if(n&&n.element)try{null==(a=n.track)||a.detach(n.element),n.element.parentNode&&n.element.remove()}catch(t){console.warn("‚ö†Ô∏è Error detaching existing track (non-critical):",t.message)}const r=document.createElement("video");r.autoplay=!0,r.playsInline=!0,r.muted=!1,r.style.width="100%",r.style.height="100%",r.style.objectFit="cover",r.style.objectPosition="center",r.style.backgroundColor="#000",r.className="remote-video-element",e.attach(r),D.current.set(o,{element:r,track:e}),M.current&&(M.current.appendChild(r),y(!0),console.log("‚úÖ Remote video displayed in UI"))}catch(n){console.error("‚ùå Error attaching remote video track:",n),console.warn("‚ö†Ô∏è Remote video track attachment failed, but will retry via TrackSubscribed event")}},[]),_=t.useCallback(e=>{if(console.log("üìπ Detaching remote video track for:",e),D.current){const a=D.current.get(e);if(a){try{if(a.track&&a.element&&a.track.detach(a.element),a.element&&a.element.parentNode)try{a.element.remove()}catch(o){console.warn("‚ö†Ô∏è Error removing element (non-critical):",o.message)}}catch(o){console.warn("‚ö†Ô∏è Error detaching track (non-critical):",o.message)}D.current.delete(e)}}try{g.detachRemoteVideoTrack(e)}catch(o){console.warn("‚ö†Ô∏è Error in service detach (non-critical):",o.message)}y(!1)},[]),G=t.useCallback(async(e,o,a)=>{if(!e||!v)return console.warn("‚ö†Ô∏è [toggleCameraOnRoom] Cannot toggle camera - not connected"),!1;try{if(o){console.log("üé• [toggleCameraOnRoom] ENABLING camera...");const o=Array.from(e.localParticipant.videoTrackPublications.values());console.log("üé• [toggleCameraOnRoom] Existing video tracks:",o.length);for(const a of o)a.track&&(console.log("üé• [toggleCameraOnRoom] Unpublishing existing track:",a.trackSid),await e.localParticipant.unpublishTrack(a.track),a.track.stop());const n={width:{ideal:1920,min:1280},height:{ideal:1080,min:720},frameRate:{ideal:30,min:24},aspectRatio:{ideal:16/9}};a?(n.deviceId={exact:a},console.log("üé• [toggleCameraOnRoom] Using selected camera:",a)):console.log("üé• [toggleCameraOnRoom] No camera selected, using default"),console.log("üé• [toggleCameraOnRoom] Requesting getUserMedia with constraints:",n);const r=await navigator.mediaDevices.getUserMedia({video:n});console.log("üé• [toggleCameraOnRoom] getUserMedia success, stream:",{id:r.id,active:r.active,tracks:r.getVideoTracks().length});const c=r.getVideoTracks();if(console.log("üé• [toggleCameraOnRoom] Video tracks in stream:",c.length),0===c.length)throw new Error("No video track in stream");const l=c[0];console.log("üé• [toggleCameraOnRoom] MediaStreamTrack:",{id:l.id,kind:l.kind,label:l.label,enabled:l.enabled,readyState:l.readyState}),console.log("üé• [toggleCameraOnRoom] Creating LocalVideoTrack...");const s=new i(l);console.log("üé• [toggleCameraOnRoom] LocalVideoTrack created:",{sid:s.sid,kind:s.kind,isMuted:s.isMuted,isEnabled:s.isEnabled}),console.log("üé• [toggleCameraOnRoom] Publishing video track...");try{await e.localParticipant.publishTrack(s,{source:"camera"}),console.log("üé• [toggleCameraOnRoom] Video track published successfully")}catch(t){throw console.error("‚ùå [toggleCameraOnRoom] Error publishing video track:",t),s.stop(),t}const d=Array.from(e.localParticipant.videoTrackPublications.values());return console.log("üé• [toggleCameraOnRoom] Published tracks count:",d.length),d.forEach((e,o)=>{var a;console.log(`  Track ${o+1}:`,{trackSid:e.trackSid,source:e.source,hasTrack:!!e.track,trackId:null==(a=e.track)?void 0:a.id})}),!0}{console.log("üé• [toggleCameraOnRoom] DISABLING camera...");const o=Array.from(e.localParticipant.videoTrackPublications.values());console.log("üé• [toggleCameraOnRoom] Unpublishing",o.length,"video tracks");for(const a of o)a.track&&(console.log("üé• [toggleCameraOnRoom] Unpublishing track:",a.trackSid),await e.localParticipant.unpublishTrack(a.track),a.track.stop());return console.log("‚úÖ [toggleCameraOnRoom] Camera disabled - now billing as audio-only call"),!0}}catch(n){const e={name:n.name,message:n.message,stack:n.stack,timestamp:(new Date).toISOString(),location:"toggleCameraOnRoom"};if(console.error("‚ùå [toggleCameraOnRoom] Failed to toggle camera:",n),console.error("‚ùå [toggleCameraOnRoom] Error details:",e),R.current)try{R.current.postMessage({type:"CAMERA_ERROR",data:e})}catch(r){console.error("Failed to send error via BroadcastChannel:",r)}try{const o=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");o.push(e),o.length>10&&o.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(o))}catch(c){console.error("Failed to save error to localStorage:",c)}return!1}},[v]),J=t.useCallback(async()=>{var e,o,a,t,n,r,c,l,i,s,d,u;if(console.log("üé¨ [handleCameraToggle] START",{hasRoom:!!T.current,isConnectedState:v,roomIsConnected:null==(e=T.current)?void 0:e.isConnected,currentState:f,cameraPermissionDenied:C}),!T.current||!v&&!T.current.isConnected)return void console.warn("‚ö†Ô∏è [handleCameraToggle] Cannot toggle camera - not connected",{hasRoom:!!T.current,isConnectedState:v,roomIsConnected:null==(o=T.current)?void 0:o.isConnected});const m=!f;console.log(`üé¨ [handleCameraToggle] Toggling camera: ${f} ‚Üí ${m}`);try{if(m&&!C){console.log("üé¨ [handleCameraToggle] Requesting camera permission...");try{const e=g.selectedCamera?{video:{deviceId:{exact:g.selectedCamera}}}:{video:!0};console.log("üé¨ [handleCameraToggle] Permission constraints:",e);const o=await navigator.mediaDevices.getUserMedia(e);console.log("üé¨ [handleCameraToggle] Permission granted, stream:",{id:o.id,active:o.active,tracks:o.getTracks().length}),o.getTracks().forEach(e=>{console.log("üé¨ [handleCameraToggle] Stopping test track:",e.id),e.stop()})}catch(p){return console.error("‚ùå [handleCameraToggle] Camera permission denied:",p),E(!0),void alert("–ú–æ–ª—è —Ä–∞–∑—Ä–µ—à–µ—Ç–µ –¥–æ—Å—Ç—ä–ø –¥–æ –∫–∞–º–µ—Ä–∞—Ç–∞ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä–∞.")}}console.log("üé¨ [handleCameraToggle] Toggling camera directly on room..."),console.log("üé¨ [handleCameraToggle] Selected camera:",g.selectedCamera),console.log("üé¨ [handleCameraToggle] Room state:",{hasRoom:!!T.current,isConnected:v,hasLocalParticipant:!!(null==(a=T.current)?void 0:a.localParticipant)});const e=await G(T.current,m,g.selectedCamera);if(console.log("üé¨ [handleCameraToggle] toggleCamera result:",e),e){if(console.log("üé¨ [handleCameraToggle] toggleCamera succeeded, updating state..."),w(m),console.log("üé¨ [handleCameraToggle] isVideoEnabled state updated to:",m),console.log("üé¨ [handleCameraToggle] localVideoRef.current:",{exists:!!A.current,tagName:null==(t=A.current)?void 0:t.tagName,className:null==(n=A.current)?void 0:n.className,id:null==(r=A.current)?void 0:r.id}),m){if(console.log("üé¨ [handleCameraToggle] Attempting to attach local video preview..."),T.current&&T.current.localParticipant){const e=Array.from(T.current.localParticipant.videoTrackPublications.values());if(console.log("üé¨ [handleCameraToggle] Found video track publications:",e.length),e.length>0){const o=e[0];if(console.log("üé¨ [handleCameraToggle] Publication details:",{hasTrack:!!o.track,trackSid:o.trackSid,source:o.source,trackId:null==(c=o.track)?void 0:c.id,trackKind:null==(l=o.track)?void 0:l.kind,trackEnabled:null==(i=o.track)?void 0:i.isEnabled}),o.track&&A.current)try{console.log("üé¨ [handleCameraToggle] Attaching track to video element..."),o.track.attach(A.current),console.log("‚úÖ [handleCameraToggle] Local video preview attached immediately"),console.log("üé¨ [handleCameraToggle] Video element after attach:",{srcObject:!!A.current.srcObject,videoWidth:A.current.videoWidth,videoHeight:A.current.videoHeight,readyState:A.current.readyState})}catch(h){console.error("‚ùå [handleCameraToggle] Error attaching local video:",h),console.error("‚ùå [handleCameraToggle] Error details:",{name:h.name,message:h.message,stack:h.stack})}else console.warn("‚ö†Ô∏è [handleCameraToggle] Missing track or localVideoRef:",{hasTrack:!!o.track,hasRef:!!A.current,trackId:null==(s=o.track)?void 0:s.id,refTagName:null==(d=A.current)?void 0:d.tagName})}else console.log("‚è≥ [handleCameraToggle] No video tracks yet, waiting for LocalTrackPublished event...")}else console.warn("‚ö†Ô∏è [handleCameraToggle] Missing room or localParticipant:",{hasRoom:!!T.current,hasLocalParticipant:!!(null==(u=T.current)?void 0:u.localParticipant)});setTimeout(()=>{if(console.log("üé¨ [handleCameraToggle] Delayed fallback attempt (500ms)..."),T.current&&T.current.localParticipant&&A.current){const e=Array.from(T.current.localParticipant.videoTrackPublications.values());if(console.log("üé¨ [handleCameraToggle] Delayed check - video tracks:",e.length),e.length>0){const o=e[0];if(o.track)try{console.log("üé¨ [handleCameraToggle] Delayed attach attempt..."),o.track.attach(A.current),console.log("‚úÖ [handleCameraToggle] Local video preview attached (delayed fallback)")}catch(h){console.error("‚ùå [handleCameraToggle] Error in delayed attach:",h)}else console.warn("‚ö†Ô∏è [handleCameraToggle] Delayed check - publication has no track")}else console.warn("‚ö†Ô∏è [handleCameraToggle] Delayed check - no video tracks found")}else console.warn("‚ö†Ô∏è [handleCameraToggle] Delayed check - missing room/participant/ref")},500)}else A.current&&(console.log("üé¨ [handleCameraToggle] Clearing local video preview"),A.current.srcObject=null,console.log("üé¨ [handleCameraToggle] Local video preview cleared"));R.current&&R.current.postMessage({type:"CAMERA_TOGGLED",data:{enabled:m}})}else console.log("üé¨ [handleCameraToggle] toggleCamera failed, state NOT updated"),alert("–ù–µ—É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–≤–∞–Ω–µ/–∏–∑–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ –∫–∞–º–µ—Ä–∞—Ç–∞. –ú–æ–ª—è –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.")}catch(k){const e={name:k.name,message:k.message,stack:k.stack,timestamp:(new Date).toISOString(),location:"handleCameraToggle"};if(console.error("‚ùå [handleCameraToggle] Failed to toggle camera:",k),console.error("‚ùå [handleCameraToggle] Error details:",e),console.log("üé¨ [handleCameraToggle] Error occurred, state NOT updated"),R.current)try{R.current.postMessage({type:"CAMERA_ERROR",data:e})}catch(b){console.error("Failed to send error via BroadcastChannel:",b)}try{const o=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");o.push(e),o.length>10&&o.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(o))}catch(y){console.error("Failed to save error to localStorage:",y)}alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤–∫–ª—é—á–≤–∞–Ω–µ/–∏–∑–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ –∫–∞–º–µ—Ä–∞—Ç–∞. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –∫–æ–Ω–∑–æ–ª–∞—Ç–∞ –∑–∞ –¥–µ—Ç–∞–π–ª–∏.")}},[f,C,v,G]),H=t.useCallback(async e=>{S.current=e,N.current&&(N.current.getTracks().forEach(e=>e.stop()),N.current=null);try{const o=await navigator.mediaDevices.getUserMedia({audio:!e||{deviceId:{ideal:e}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0});if(N.current=o,T.current&&T.current.isConnected){const e=Array.from(T.current.localParticipant.audioTrackPublications.values());for(const o of e)o.track&&await T.current.localParticipant.unpublishTrack(o.track);const a=o.getAudioTracks();if(a.length>0){const e=a[0],o=new l(e);await T.current.localParticipant.publishTrack(o,{source:"microphone"})}}}catch(o){console.error("Failed to set microphone:",o)}},[]),K=t.useCallback(async e=>{x.current=e,"setSinkId"in HTMLAudioElement.prototype&&j.current.forEach(o=>{o.setSinkId(e).catch(()=>{})})},[]),$=t.useCallback(async()=>{N.current&&(N.current.getTracks().forEach(e=>e.stop()),N.current=null),j.current.forEach(e=>{e.pause(),e.srcObject=null,e.remove()}),j.current.clear(),T.current&&(await T.current.disconnect(),T.current=null),k(!1)},[]),B=t.useCallback(async()=>{if(I.current)console.log("üìû handleEndCall already in progress, ignoring");else{I.current=!0,console.log("üìû handleEndCall called"),console.log("  - Current callState:",o),console.log("  - Current isConnected:",v),console.log("  - Conversation ID:",e.conversationId),P.current&&(P.current.pause(),P.current.currentTime=0,P.current=null);try{const o={eventType:"CALL_END",conversationId:e.conversationId,callerId:e.currentUserId,receiverId:e.otherUserId,roomName:e.roomName,timestamp:(new Date).toISOString()};console.log("üì§ Sending CALL_END signal:",o),u.sendCallSignal(o),console.log("‚úÖ CALL_END signal sent from popup")}catch(a){console.error("‚ùå Failed to send CALL_END signal:",a)}await $(),R.current&&R.current.postMessage({type:"CALL_ENDED_FROM_POPUP",data:{conversationId:e.conversationId}}),console.log("üö™ Closing popup window"),window.close()}},[e,$,o,v]),W=t.useCallback(async()=>{const e=!p;if(h(e),T.current&&T.current.isConnected)try{const o=Array.from(T.current.localParticipant.audioTrackPublications.values());if(e){for(const e of o)e.track&&e.track.setEnabled(!1);await T.current.localParticipant.setMicrophoneEnabled(!1),console.log("üîá Microphone muted")}else{for(const e of o)e.track&&e.track.setEnabled(!0);await T.current.localParticipant.setMicrophoneEnabled(!0),console.log("üîä Microphone unmuted")}}catch(o){console.error("‚ùå Error toggling microphone:",o)}R.current&&R.current.postMessage({type:"MUTE_TOGGLED",data:{isMuted:e}})},[p]);t.useEffect(()=>{const e=async e=>{try{const o=new Audio(e);o.loop=!0,o.volume=.7,o.preload="auto";let a=o.play();void 0!==a&&(await a,P.current=o,console.log("‚úÖ Call sound started:",e))}catch(a){if(console.warn("‚ö†Ô∏è Failed to play call sound (autoplay blocked?):",a),"incoming"===o){const o=async()=>{try{const a=new Audio(e);a.loop=!0,a.volume=.7,await a.play(),P.current=a,console.log("‚úÖ Call sound started after user interaction"),document.removeEventListener("click",o),document.removeEventListener("touchstart",o),window.removeEventListener("focus",o)}catch(a){console.error("‚ùå Failed to play sound even after interaction:",a)}};document.addEventListener("click",o,{once:!0}),document.addEventListener("touchstart",o,{once:!0}),window.addEventListener("focus",o,{once:!0}),document.hasFocus()&&setTimeout(()=>o(),100)}}};return"outgoing"===o?e("/svmessenger/sounds/OutCall.mp3"):"incoming"===o?(window.focus&&window.focus(),e("/svmessenger/sounds/IncomingCall.mp3")):("connected"===o&&P.current||"rejected"===o&&P.current)&&(P.current.pause(),P.current.currentTime=0,P.current=null),()=>{P.current&&(P.current.pause(),P.current.currentTime=0,P.current=null)}},[o]),t.useEffect(()=>(console.log("üîÑ useEffect for callState changed:",o),"connected"===o?(console.log('‚úÖ callState is "connected", connecting to LiveKit...'),O().catch(e=>{console.error("‚ùå Failed to connect to LiveKit in useEffect:",e)})):console.log('‚è≥ callState is not "connected", waiting... (current:',o,")"),()=>{console.log("üßπ Cleaning up LiveKit connection"),$()}),[o,O,$]),t.useEffect(()=>("connected"===o&&v?L.current=setInterval(()=>{d(e=>e+1)},1e3):(L.current&&(clearInterval(L.current),L.current=null),d(0)),()=>{L.current&&clearInterval(L.current)}),[o,v]),t.useEffect(()=>{var e;if(f&&A.current&&(null==(e=T.current)?void 0:e.localParticipant)){console.log("üé¨ [useEffect] isVideoEnabled changed, attempting to attach local video...");const e=Array.from(T.current.localParticipant.videoTrackPublications.values());if(console.log("üé¨ [useEffect] Found video track publications:",e.length),e.length>0){const a=e[0];if(a.track&&A.current)try{console.log("üé¨ [useEffect] Attaching local video track to element..."),a.track.attach(A.current),console.log("‚úÖ [useEffect] Local video preview attached")}catch(o){console.error("‚ùå [useEffect] Error attaching local video:",o)}else console.warn("‚ö†Ô∏è [useEffect] Missing track or ref:",{hasTrack:!!a.track,hasRef:!!A.current})}else console.log("‚è≥ [useEffect] No video tracks yet, will retry when track is published")}},[f,v]),t.useEffect(()=>(u.connect({onCallSignal:o=>{"CALL_END"===o.eventType?(console.log("üìû CALL_END received in popup:",o),o.conversationId===e.conversationId&&(console.log("üìû CALL_END matches our call, showing rejection animation..."),n("rejected"),P.current&&(P.current.pause(),P.current.currentTime=0,P.current=null),setTimeout(()=>{B()},3e3))):"CALL_REJECT"===o.eventType&&(console.log("üìû CALL_REJECT received in popup:",o),o.conversationId===e.conversationId&&(console.log("üìû CALL_REJECT matches our call, showing rejection animation..."),n("rejected"),P.current&&(P.current.pause(),P.current.currentTime=0,P.current=null),setTimeout(()=>{B()},3e3)))},onConnect:()=>{console.log("WebSocket connected in popup")},onDisconnect:()=>{console.log("WebSocket disconnected in popup")},onError:e=>{console.error("WebSocket error in popup:",e)}}),()=>{u.disconnect()}),[e.conversationId,B]),t.useEffect(()=>{const e=e=>{var o;const a={name:"GlobalError",message:e.message||"Unknown error",filename:e.filename,lineno:e.lineno,colno:e.colno,stack:null==(o=e.error)?void 0:o.stack,timestamp:(new Date).toISOString(),location:"global"};if(console.error("‚ùå [GlobalError] Uncaught error:",a),R.current)try{R.current.postMessage({type:"CAMERA_ERROR",data:a})}catch(t){console.error("Failed to send global error:",t)}try{const e=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");e.push(a),e.length>10&&e.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(e))}catch(n){console.error("Failed to save global error:",n)}},o=e=>{var o,a;const t={name:"UnhandledPromiseRejection",message:(null==(o=e.reason)?void 0:o.message)||"Unhandled promise rejection",stack:null==(a=e.reason)?void 0:a.stack,timestamp:(new Date).toISOString(),location:"global"};if(console.error("‚ùå [GlobalError] Unhandled promise rejection:",t),R.current)try{R.current.postMessage({type:"CAMERA_ERROR",data:t})}catch(n){console.error("Failed to send promise rejection error:",n)}try{const e=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");e.push(t),e.length>10&&e.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(e))}catch(r){console.error("Failed to save promise rejection error:",r)}};return window.addEventListener("error",e),window.addEventListener("unhandledrejection",o),()=>{window.removeEventListener("error",e),window.removeEventListener("unhandledrejection",o)}},[]),t.useEffect(()=>(R.current=new BroadcastChannel("svmessenger-call"),R.current.onmessage=e=>{const{type:o,data:a}=e.data;switch(o){case"CALL_ENDED":console.log("üìû CALL_ENDED received via BroadcastChannel"),n("rejected"),P.current&&(P.current.pause(),P.current.currentTime=0,P.current=null),setTimeout(()=>{B()},3e3);break;case"CALL_REJECTED":console.log("üìû CALL_REJECTED received via BroadcastChannel"),n("rejected"),P.current&&(P.current.pause(),P.current.currentTime=0,P.current=null),setTimeout(()=>{B()},3e3);break;case"CALL_ACCEPTED":console.log("‚úÖ CALL_ACCEPTED received via BroadcastChannel, changing callState to connected"),n("connected");break;case"MUTE_TOGGLED":h(a.isMuted);break;case"DEVICE_CHANGED":a.microphone&&(S.current=a.microphone,H(a.microphone)),a.speaker&&(x.current=a.speaker,K(a.speaker))}},()=>{R.current&&R.current.close()}),[B,H,K]),t.useEffect(()=>{const e=()=>{$()};return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}},[$]);return a.jsx(m,{callState:o,callDuration:s,formatDuration:e=>{const o=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},isMuted:p,isConnected:v,otherUserName:e.otherUserName,otherUserAvatar:e.otherUserAvatar,onMuteToggle:W,onEndCall:B,isVideoEnabled:f,remoteVideoVisible:b,localVideoRef:A,remoteVideoRef:M,onCameraToggle:J,cameraPermissionDenied:C})};console.log("üöÄ Call window popup opened");const h=new URLSearchParams(window.location.search),v={token:h.get("token"),roomName:h.get("roomName"),conversationId:h.get("conversationId"),otherUserId:h.get("otherUserId"),otherUserName:h.get("otherUserName"),otherUserAvatar:h.get("otherUserAvatar"),currentUserId:h.get("currentUserId"),currentUserName:h.get("currentUserName"),currentUserAvatar:h.get("currentUserAvatar"),callType:h.get("callType")||"voice",callState:h.get("callState")||"outgoing"};if(console.log("üìû Call window data:",{hasToken:!!v.token,tokenLength:(null==(e=v.token)?void 0:e.length)||0,roomName:v.roomName,conversationId:v.conversationId,callState:v.callState,otherUserId:v.otherUserId,currentUserId:v.currentUserId}),v.token&&v.roomName&&v.conversationId){console.log("‚úÖ All required data present, mounting React app");const e=document.getElementById("call-window-root");if(e){n(e).render(a.jsx(p,{callData:v})),console.log("‚úÖ React app mounted")}else console.error("‚ùå Container element not found!")}else console.error("‚ùå Missing required call data:",{hasToken:!!v.token,hasRoomName:!!v.roomName,hasConversationId:!!v.conversationId}),document.body.innerHTML='\n        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; gap: 20px;">\n            <h2>–ì—Ä–µ—à–∫–∞</h2>\n            <p>–õ–∏–ø—Å–≤–∞—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏ –¥–∞–Ω–Ω–∏ –∑–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.</p>\n            <button onclick="window.close()" style="padding: 10px 20px; cursor: pointer;">–ó–∞—Ç–≤–æ—Ä–∏</button>\n        </div>\n    ';
