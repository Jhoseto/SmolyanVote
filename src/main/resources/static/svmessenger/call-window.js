var e;import{R as t,j as a,r,a as o}from"./svmessenger-vendor-react.js";import{R as n,a as c,L as l,b as i}from"./svmessenger-vendor-livekit.js";import{g as s,e as d,a as u,s as m}from"./svmessenger-svHelpers.js";import"./svmessenger-vendor.js";import"./svmessenger-vendor-websocket.js";const g=({callState:e,callDuration:r,formatDuration:o,isMuted:n,isConnected:c,otherUserName:l,otherUserAvatar:i,onMuteToggle:u,onEndCall:m,isVideoEnabled:g,remoteVideoVisible:p,localVideoRef:h,remoteVideoRef:v,onCameraToggle:w,cameraPermissionDenied:f,isCameraLoading:k,pipPosition:C,isDragging:b,onPipMouseDown:y})=>{const E=t.useMemo(()=>{if(!l)return"–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª";try{return decodeURIComponent(l)}catch(e){return l}},[l]),T=t.useMemo(()=>{if(!i)return null;try{return decodeURIComponent(i)}catch(e){return i}},[i]),j=e=>{if(!e||""===e.trim())return!1;return!["/default-avatar","default-avatar.png","default-avatar.jpg"].some(t=>e.includes(t))},N=t.useMemo(()=>s(E.charCodeAt(0)||0),[E]),x=t.useMemo(()=>d(E),[E]);return a.jsxs("div",{className:"call-window-container",children:[a.jsxs("div",{className:"call-window-background",children:[a.jsx("div",{className:"call-window-bg-shape shape-1"}),a.jsx("div",{className:"call-window-bg-shape shape-2"}),a.jsx("div",{className:"call-window-bg-shape shape-3"}),a.jsx("div",{className:"call-window-bg-shape shape-4"})]}),"connected"===e?a.jsxs("div",{className:"call-window-video-layout",children:[a.jsx("div",{ref:v,className:"call-window-remote-video "+(p?"video-active":""),children:!p&&a.jsxs("div",{className:"call-window-avatar-fallback",children:[T&&j(T)?a.jsx("img",{src:T,alt:E,onError:e=>{e.target.style.display="none";const t=e.target.nextElementSibling;t&&(t.style.display="flex")}}):null,a.jsx("div",{className:"call-window-avatar-placeholder",style:{display:T&&j(T)?"none":"flex",backgroundColor:N,width:"120px",height:"120px",fontSize:"48px",borderRadius:"50%",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600"},children:x}),a.jsx("p",{className:"call-window-name",children:E}),a.jsx("p",{className:"call-window-status",children:c?"–°–≤—ä—Ä–∑–∞–Ω":"–°–≤—ä—Ä–∑–≤–∞–Ω–µ..."})]})}),g&&a.jsxs("div",{className:"video-quality-badge",children:[a.jsx("i",{className:"bi bi-badge-hd-fill"}),a.jsx("span",{children:"Full HD"})]}),a.jsx("div",{className:"connection-indicator excellent",children:a.jsxs("div",{className:"signal-bars",children:[a.jsx("span",{}),a.jsx("span",{}),a.jsx("span",{})]})}),g&&a.jsxs("div",{className:"call-window-local-video-pip "+(b?"dragging":""),style:{right:"auto",bottom:"auto",left:`${C.x}px`,top:`${C.y}px`,cursor:b?"grabbing":"grab"},onMouseDown:y,children:[a.jsx("video",{ref:h,autoPlay:!0,playsInline:!0,muted:!0,className:"local-video-element",style:{objectFit:"cover"}}),a.jsx("div",{className:"pip-label",children:"–í–∏–µ"})]}),a.jsxs("div",{className:"call-window-info",children:[a.jsx("span",{className:"call-duration",children:o(r)}),g&&a.jsx("span",{className:"video-indicator",children:"Video"})]}),a.jsxs("div",{className:"call-window-controls",children:[a.jsx("button",{className:"call-control-btn "+(n?"active":""),onClick:u,title:n?"–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω":"–ò–∑–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω",children:a.jsx("i",{className:`bi bi-mic${n?"-mute":""}-fill`})}),a.jsx("button",{className:"call-control-btn "+(g?"":"inactive"),onClick:w,title:g?"–ò–∑–∫–ª—é—á–∏ –∫–∞–º–µ—Ä–∞":"–í–∫–ª—é—á–∏ –∫–∞–º–µ—Ä–∞",disabled:f||k,children:k?a.jsx("div",{className:"camera-loading-spinner"}):a.jsx("i",{className:`bi bi-camera-video${g?"":"-off"}-fill`})}),a.jsx("button",{className:"call-control-btn call-end-btn",onClick:m,title:"–ü—Ä–µ–∫—Ä–∞—Ç–∏",children:a.jsx("i",{className:"bi bi-telephone-x-fill"})})]})]}):a.jsxs("div",{className:"call-window-modal",children:[a.jsxs("div",{className:`call-window-avatar ${"connected"===e?"connected":""} ${"outgoing"===e||"incoming"===e?"pulsing":""}`,children:[T&&j(T)?a.jsx("img",{src:T,alt:E,onError:e=>{e.target.style.display="none";const t=e.target.nextElementSibling;t&&(t.style.display="flex")}}):null,a.jsx("div",{className:"call-window-avatar-placeholder",style:{display:T&&j(T)?"none":"flex",backgroundColor:N},children:x}),"connected"===e&&c&&a.jsx("div",{className:"call-window-avatar-ring"})]}),a.jsxs("div",{className:"call-window-status",children:[a.jsxs("div",{className:"call-window-title",children:["outgoing"===e&&"–û–±–∞–∂–¥–∞–Ω–µ...","incoming"===e&&"–í—Ö–æ–¥—è—â–æ –æ–±–∞–∂–¥–∞–Ω–µ","connected"===e&&a.jsxs(a.Fragment,{children:["–í —Ä–∞–∑–≥–æ–≤–æ—Ä ",E&&`—Å ${E}`]}),"rejected"===e&&"–û–±–∞–∂–¥–∞–Ω–µ—Ç–æ –µ –æ—Ç—Ö–≤—ä—Ä–ª–µ–Ω–æ"]}),a.jsx("div",{className:"call-window-subtitle",children:"connected"===e&&c?o(r):"rejected"===e?"–ó–∞—Ç–≤–∞—Ä—è–Ω–µ...":E}),("incoming"===e||"outgoing"===e)&&a.jsxs("div",{className:"call-window-calling-animation",children:[a.jsxs("div",{className:"call-window-ripple-container",children:[a.jsx("div",{className:"call-window-ripple ripple-1"}),a.jsx("div",{className:"call-window-ripple ripple-2"}),a.jsx("div",{className:"call-window-ripple ripple-3"}),a.jsx("div",{className:"call-window-ripple ripple-4"})]}),a.jsx("div",{className:"call-window-glow-core",children:a.jsx("div",{className:"call-window-glow-inner"})}),a.jsxs("div",{className:"call-window-particles",children:[a.jsx("div",{className:"particle particle-1"}),a.jsx("div",{className:"particle particle-2"}),a.jsx("div",{className:"particle particle-3"}),a.jsx("div",{className:"particle particle-4"}),a.jsx("div",{className:"particle particle-5"}),a.jsx("div",{className:"particle particle-6"})]})]}),"rejected"===e&&a.jsxs("div",{className:"call-window-calling-animation call-window-rejection-animation",children:[a.jsxs("div",{className:"call-window-ripple-container",children:[a.jsx("div",{className:"call-window-ripple ripple-1 rejection-ripple"}),a.jsx("div",{className:"call-window-ripple ripple-2 rejection-ripple"}),a.jsx("div",{className:"call-window-ripple ripple-3 rejection-ripple"}),a.jsx("div",{className:"call-window-ripple ripple-4 rejection-ripple"})]}),a.jsx("div",{className:"call-window-glow-core rejection-glow",children:a.jsx("div",{className:"call-window-glow-inner rejection-glow-inner"})}),a.jsxs("div",{className:"call-window-particles rejection-particles",children:[a.jsx("div",{className:"particle particle-1 rejection-particle"}),a.jsx("div",{className:"particle particle-2 rejection-particle"}),a.jsx("div",{className:"particle particle-3 rejection-particle"}),a.jsx("div",{className:"particle particle-4 rejection-particle"}),a.jsx("div",{className:"particle particle-5 rejection-particle"}),a.jsx("div",{className:"particle particle-6 rejection-particle"})]})]}),"connected"===e&&!c&&a.jsx("div",{className:"call-window-connecting",children:"–°–≤—ä—Ä–∑–≤–∞–Ω–µ..."})]}),a.jsxs("div",{className:"call-window-actions",children:["connected"===e&&a.jsxs(a.Fragment,{children:[a.jsx("button",{className:"call-window-btn-mute "+(n?"muted":""),onClick:u,title:n?"–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞":"–ò–∑–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞",children:n?a.jsx("i",{className:"bi bi-mic-mute muted-icon"}):a.jsx("i",{className:"bi bi-mic active-icon"})}),a.jsx("button",{className:"call-window-btn-end",onClick:m,title:"–ó–∞—Ç–≤–æ—Ä–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:a.jsx("i",{className:"bi bi-telephone end-icon"})})]}),("outgoing"===e||"incoming"===e)&&a.jsx("button",{className:"call-window-btn-end",onClick:m,title:"outgoing"===e?"–û—Ç–º–µ–Ω–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ":"–û—Ç–∫–∞–∂–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:a.jsx("i",{className:"bi bi-telephone end-icon"})}),"rejected"===e&&a.jsx("div",{className:"call-window-actions"})]})]})]})},p=({callData:e})=>{const[t,o]=r.useState(e.callState),[s,d]=r.useState(0),[p,h]=r.useState(!1),[v,w]=r.useState(!1),f=r.useRef(null),[k,C]=r.useState(!1),[b,y]=r.useState(!1),[E,T]=r.useState(!1),[j,N]=r.useState(!1),[x,S]=r.useState({x:20,y:20}),[L,I]=r.useState(!1),[P,R]=r.useState({x:0,y:0}),D=r.useRef(null),A=r.useRef(null),M=r.useRef(new Map),U=r.useRef(null),F=r.useRef(null),O=r.useRef(null),_=r.useRef(null),V=r.useRef(null),G=r.useRef(!1),J=r.useRef(!1),$=r.useRef(null),B=r.useRef(null),H=r.useRef(new Map);r.useEffect(()=>{try{const e=localStorage.getItem("svmessenger-audio-settings");if(e){const t=JSON.parse(e);t.microphone&&(U.current=t.microphone),t.speaker&&(F.current=t.speaker)}}catch(e){}},[]);const W=r.useCallback(async()=>{try{D.current&&D.current.isConnected&&await te();const i=new n;if(D.current=i,i.on(c.Connected,()=>{w(!0),o("connected"),J.current=!1,f.current||(f.current=new Date,console.log("üìû [CallWindow] Call start time set on RoomEvent.Connected:",f.current.toISOString()),O.current&&O.current.postMessage({type:"CALL_START_TIME",data:{startTime:f.current.toISOString()}})),i.participants&&i.participants.size>0&&i.participants.forEach((e,t)=>{e.audioTrackPublications.forEach(e=>{e.track&&q(e.track,t)})})}),i.on(c.Disconnected,e=>{w(!1),G.current}),i.on(c.ParticipantConnected,e=>{e.audioTrackPublications.forEach((t,a)=>{t.track&&q(t.track,e.identity)}),e.videoTrackPublications.forEach((t,a)=>{t.track&&z(t.track,e.identity)})}),i.on(c.ParticipantDisconnected,e=>{var t;if(G.current)return;K(e.identity),X(e.identity);const a=null==(t=i.localParticipant)?void 0:t.identity;a&&e.identity!==a&&setTimeout(()=>{if(D.current&&D.current.isConnected&&!G.current){Array.from(D.current.participants.values()).some(t=>t.identity===e.identity)||ae()}},8e3)}),i.on(c.TrackSubscribed,(e,t,a)=>{const r=a===i.localParticipant;if("audio"===e.kind)q(e,a.identity);else if("video"===e.kind)if(r){if($.current)try{e.attach($.current)}catch(o){console.error("Error attaching local video:",o)}}else z(e,a.identity)}),i.on(c.LocalTrackPublished,(e,t)=>{if(e.track&&"video"===e.track.kind&&$.current&&e.track)try{e.track.attach($.current)}catch(a){console.error("Error attaching local video:",a)}}),i.on(c.TrackPublished,(e,t)=>{}),i.on(c.TrackUnsubscribed,(e,t,a)=>{"audio"===e.kind?K(a.identity):"video"===e.kind&&X(a.identity)}),await i.connect("wss://smolyanvote-nq17fbx3.livekit.cloud",e.token),await new Promise(e=>setTimeout(e,300)),U.current&&A.current)try{const e=Array.from(i.localParticipant.audioTrackPublications.values());for(const a of e)a.track&&await i.localParticipant.unpublishTrack(a.track);const t=A.current.getAudioTracks();if(t.length>0){const e=t[0],a=new l(e);await i.localParticipant.publishTrack(a,{source:"microphone"})}}catch(t){console.error("Failed to publish microphone from stream:",t);try{await i.localParticipant.setMicrophoneEnabled(!0)}catch(a){console.error("Failed to enable default microphone:",a)}}else if(U.current)try{const e=U.current,t={audio:!e||{deviceId:{ideal:e}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},a=await navigator.mediaDevices.getUserMedia(t);A.current=a;const r=a.getAudioTracks();if(r.length>0){const e=r[0],t=new l(e);await i.localParticipant.publishTrack(t,{source:"microphone"})}}catch(r){console.error("Failed to get and publish microphone:",r);try{await i.localParticipant.setMicrophoneEnabled(!0)}catch(a){console.error("Failed to enable default microphone:",a)}}else try{await i.localParticipant.setMicrophoneEnabled(!0)}catch(r){console.error("Failed to enable default microphone:",r)}}catch(r){if(console.error("Failed to connect to LiveKit:",r),w(!1),o("connected"),D.current){try{await D.current.disconnect()}catch(i){console.error("Failed to disconnect on error:",i)}D.current=null}}},[e.token]);r.useCallback(async()=>{if(D.current)if(D.current.isConnected)try{const r=Array.from(D.current.localParticipant.audioTrackPublications.values());for(const e of r)e.track&&await D.current.localParticipant.unpublishTrack(e.track);const o=U.current,n={audio:!o||{deviceId:{ideal:o}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0};let c;try{c=await navigator.mediaDevices.getUserMedia(n)}catch(e){try{c=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})}catch(t){console.error("Failed to get fallback user media:",t);try{await D.current.localParticipant.setMicrophoneEnabled(!0)}catch(a){console.error("Failed to enable default microphone:",a)}return}}A.current=c;const i=c.getAudioTracks();if(i.length>0){const e=i[0],t=new l(e);await D.current.localParticipant.publishTrack(t,{source:"microphone"})}else{console.error("No audio tracks in stream");try{await D.current.localParticipant.setMicrophoneEnabled(!0)}catch(t){console.error("Failed to enable default microphone:",t)}}}catch(e){console.error("Failed to publish microphone:",e);try{await D.current.localParticipant.setMicrophoneEnabled(!0)}catch(t){console.error("Failed to enable default microphone:",t)}}else console.error("Cannot publish microphone: room not connected");else console.error("Cannot publish microphone: roomRef.current is null")},[]);const q=r.useCallback((e,t)=>{try{const r=M.current.get(t);if(r){try{e.detach(r)}catch(a){}r.pause(),r.srcObject=null,r.remove()}const o=document.createElement("audio");o.autoplay=!0,o.playsInline=!0,o.volume=1,F.current&&"setSinkId"in HTMLAudioElement.prototype&&o.setSinkId(F.current).catch(()=>{}),e.attach(o),M.current.set(t,o),o.addEventListener("error",e=>{console.error("Remote audio error:",e)});const n=o.play();void 0!==n&&n.catch(e=>{const t=()=>{o.play().catch(e=>{console.error("Failed to play after user interaction:",e)})};document.addEventListener("click",t,{once:!0}),document.addEventListener("touchstart",t,{once:!0})})}catch(r){console.error("‚ùå Error attaching remote audio track:",r)}},[]),K=r.useCallback(e=>{const t=M.current.get(e);t&&(t.pause(),t.srcObject=null,t.remove(),M.current.delete(e))},[]),z=r.useCallback((e,t)=>{var a;try{H.current||(H.current=new Map);const o=H.current.get(t);if(o&&o.element)try{null==(a=o.track)||a.detach(o.element),o.element.parentNode&&o.element.remove()}catch(r){console.warn("‚ö†Ô∏è Error detaching existing track (non-critical):",r.message)}const n=document.createElement("video");n.autoplay=!0,n.playsInline=!0,n.muted=!1,n.style.width="100%",n.style.height="100%",n.style.objectFit="cover",n.style.objectPosition="center",n.style.backgroundColor="#000",n.className="remote-video-element",e.attach(n),H.current.set(t,{element:n,track:e}),B.current&&(B.current.appendChild(n),y(!0))}catch(o){console.error("Error attaching remote video track:",o)}},[]),X=r.useCallback(e=>{if(H.current){const a=H.current.get(e);if(a){try{if(a.track&&a.element&&a.track.detach(a.element),a.element&&a.element.parentNode)try{a.element.remove()}catch(t){}}catch(t){}H.current.delete(e)}}try{u.detachRemoteVideoTrack(e)}catch(t){}y(!1)},[]),Y=r.useCallback(async(e,t,a)=>{if(!e||!v)return!1;try{if(t){const t=Array.from(e.localParticipant.videoTrackPublications.values());for(const a of t)a.track&&(await e.localParticipant.unpublishTrack(a.track),a.track.stop());const o={width:{ideal:1920,min:1280},height:{ideal:1080,min:720},frameRate:{ideal:30,min:24},aspectRatio:{ideal:16/9}};a&&(o.deviceId={exact:a});const n=(await navigator.mediaDevices.getUserMedia({video:o})).getVideoTracks();if(0===n.length)throw new Error("No video track in stream");const c=n[0],l=new i(c);try{await e.localParticipant.publishTrack(l,{source:"camera"})}catch(r){throw console.error("Error publishing video track:",r),l.stop(),r}return!0}{const t=Array.from(e.localParticipant.videoTrackPublications.values());for(const a of t)a.track&&(await e.localParticipant.unpublishTrack(a.track),a.track.stop());return!0}}catch(o){if(console.error("Failed to toggle camera:",o),O.current)try{O.current.postMessage({type:"CAMERA_ERROR",data:errorDetails})}catch(n){console.error("Failed to send error via BroadcastChannel:",n)}try{const e=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");e.push(errorDetails),e.length>10&&e.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(e))}catch(c){console.error("Failed to save error to localStorage:",c)}return!1}},[v]),Q=r.useCallback(async()=>{var e,t,a,r,o,n,c,l,i,s,d,m;if(console.log("üé¨ [handleCameraToggle] START",{hasRoom:!!D.current,isConnectedState:v,roomIsConnected:null==(e=D.current)?void 0:e.isConnected,currentState:k,cameraPermissionDenied:E}),N(!0),!D.current||!v&&!D.current.isConnected)return console.warn("‚ö†Ô∏è [handleCameraToggle] Cannot toggle camera - not connected",{hasRoom:!!D.current,isConnectedState:v,roomIsConnected:null==(t=D.current)?void 0:t.isConnected}),void N(!1);const g=!k;console.log(`üé¨ [handleCameraToggle] Toggling camera: ${k} ‚Üí ${g}`);try{if(g&&!E){console.log("üé¨ [handleCameraToggle] Requesting camera permission...");try{const e=u.selectedCamera?{video:{deviceId:{exact:u.selectedCamera}}}:{video:!0};console.log("üé¨ [handleCameraToggle] Permission constraints:",e);const t=await navigator.mediaDevices.getUserMedia(e);console.log("üé¨ [handleCameraToggle] Permission granted, stream:",{id:t.id,active:t.active,tracks:t.getTracks().length}),t.getTracks().forEach(e=>{console.log("üé¨ [handleCameraToggle] Stopping test track:",e.id),e.stop()})}catch(p){return console.error("‚ùå [handleCameraToggle] Camera permission denied:",p),T(!0),N(!1),void alert("–ú–æ–ª—è —Ä–∞–∑—Ä–µ—à–µ—Ç–µ –¥–æ—Å—Ç—ä–ø –¥–æ –∫–∞–º–µ—Ä–∞—Ç–∞ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä–∞.")}}console.log("üé¨ [handleCameraToggle] Toggling camera directly on room..."),console.log("üé¨ [handleCameraToggle] Selected camera:",u.selectedCamera),console.log("üé¨ [handleCameraToggle] Room state:",{hasRoom:!!D.current,isConnected:v,hasLocalParticipant:!!(null==(a=D.current)?void 0:a.localParticipant)});const e=await Y(D.current,g,u.selectedCamera);if(console.log("üé¨ [handleCameraToggle] toggleCamera result:",e),e){if(console.log("üé¨ [handleCameraToggle] toggleCamera succeeded, updating state..."),C(g),N(!1),console.log("üé¨ [handleCameraToggle] isVideoEnabled state updated to:",g),console.log("üé¨ [handleCameraToggle] localVideoRef.current:",{exists:!!$.current,tagName:null==(r=$.current)?void 0:r.tagName,className:null==(o=$.current)?void 0:o.className,id:null==(n=$.current)?void 0:n.id}),g){if(console.log("üé¨ [handleCameraToggle] Attempting to attach local video preview..."),D.current&&D.current.localParticipant){const e=Array.from(D.current.localParticipant.videoTrackPublications.values());if(console.log("üé¨ [handleCameraToggle] Found video track publications:",e.length),e.length>0){const t=e[0];if(console.log("üé¨ [handleCameraToggle] Publication details:",{hasTrack:!!t.track,trackSid:t.trackSid,source:t.source,trackId:null==(c=t.track)?void 0:c.id,trackKind:null==(l=t.track)?void 0:l.kind,trackEnabled:null==(i=t.track)?void 0:i.isEnabled}),t.track&&$.current)try{console.log("üé¨ [handleCameraToggle] Attaching track to video element..."),t.track.attach($.current),console.log("‚úÖ [handleCameraToggle] Local video preview attached immediately"),console.log("üé¨ [handleCameraToggle] Video element after attach:",{srcObject:!!$.current.srcObject,videoWidth:$.current.videoWidth,videoHeight:$.current.videoHeight,readyState:$.current.readyState})}catch(h){console.error("‚ùå [handleCameraToggle] Error attaching local video:",h),console.error("‚ùå [handleCameraToggle] Error details:",{name:h.name,message:h.message,stack:h.stack})}else console.warn("‚ö†Ô∏è [handleCameraToggle] Missing track or localVideoRef:",{hasTrack:!!t.track,hasRef:!!$.current,trackId:null==(s=t.track)?void 0:s.id,refTagName:null==(d=$.current)?void 0:d.tagName})}else console.log("‚è≥ [handleCameraToggle] No video tracks yet, waiting for LocalTrackPublished event...")}else console.warn("‚ö†Ô∏è [handleCameraToggle] Missing room or localParticipant:",{hasRoom:!!D.current,hasLocalParticipant:!!(null==(m=D.current)?void 0:m.localParticipant)});setTimeout(()=>{if(console.log("üé¨ [handleCameraToggle] Delayed fallback attempt (500ms)..."),D.current&&D.current.localParticipant&&$.current){const e=Array.from(D.current.localParticipant.videoTrackPublications.values());if(console.log("üé¨ [handleCameraToggle] Delayed check - video tracks:",e.length),e.length>0){const t=e[0];if(t.track)try{console.log("üé¨ [handleCameraToggle] Delayed attach attempt..."),t.track.attach($.current),console.log("‚úÖ [handleCameraToggle] Local video preview attached (delayed fallback)")}catch(h){console.error("‚ùå [handleCameraToggle] Error in delayed attach:",h)}else console.warn("‚ö†Ô∏è [handleCameraToggle] Delayed check - publication has no track")}else console.warn("‚ö†Ô∏è [handleCameraToggle] Delayed check - no video tracks found")}else console.warn("‚ö†Ô∏è [handleCameraToggle] Delayed check - missing room/participant/ref")},500)}else $.current&&(console.log("üé¨ [handleCameraToggle] Clearing local video preview"),$.current.srcObject=null,console.log("üé¨ [handleCameraToggle] Local video preview cleared"));O.current&&O.current.postMessage({type:"CAMERA_TOGGLED",data:{enabled:g}})}else console.log("üé¨ [handleCameraToggle] toggleCamera failed, state NOT updated"),N(!1)}catch(w){const e={name:w.name,message:w.message,stack:w.stack,timestamp:(new Date).toISOString(),location:"handleCameraToggle"};if(console.error("‚ùå [handleCameraToggle] Failed to toggle camera:",w),console.error("‚ùå [handleCameraToggle] Error details:",e),console.log("üé¨ [handleCameraToggle] Error occurred, state NOT updated"),O.current)try{O.current.postMessage({type:"CAMERA_ERROR",data:e})}catch(f){console.error("Failed to send error via BroadcastChannel:",f)}try{const t=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");t.push(e),t.length>10&&t.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(t))}catch(b){console.error("Failed to save error to localStorage:",b)}N(!1)}},[k,E,v,Y]),Z=r.useCallback(async e=>{U.current=e,A.current&&(A.current.getTracks().forEach(e=>e.stop()),A.current=null);try{const t=await navigator.mediaDevices.getUserMedia({audio:!e||{deviceId:{ideal:e}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0});if(A.current=t,D.current&&D.current.isConnected){const e=Array.from(D.current.localParticipant.audioTrackPublications.values());for(const t of e)t.track&&await D.current.localParticipant.unpublishTrack(t.track);const a=t.getAudioTracks();if(a.length>0){const e=a[0],t=new l(e);await D.current.localParticipant.publishTrack(t,{source:"microphone"})}}}catch(t){console.error("Failed to set microphone:",t)}},[]),ee=r.useCallback(async e=>{F.current=e,"setSinkId"in HTMLAudioElement.prototype&&M.current.forEach(t=>{t.setSinkId(e).catch(()=>{})})},[]),te=r.useCallback(async()=>{A.current&&(A.current.getTracks().forEach(e=>e.stop()),A.current=null),M.current.forEach(e=>{e.pause(),e.srcObject=null,e.remove()}),M.current.clear(),D.current&&(await D.current.disconnect(),D.current=null),w(!1)},[]),ae=r.useCallback(async()=>{if(!G.current){if(G.current=!0,V.current&&(V.current.pause(),V.current.currentTime=0,V.current=null),!J.current)try{const t="outgoing"===e.callState,a=t?e.currentUserId:e.otherUserId,r=t?e.otherUserId:e.currentUserId,o=new Date,n=f.current?new Date(f.current).toISOString():o.toISOString();console.log("üìû [CallWindow handleEndCall] startTime:",n,"callStartTimeRef:",f.current?new Date(f.current).toISOString():"null");const c=o.toISOString(),l="video"===e.callType||!1,i={eventType:"CALL_END",conversationId:e.conversationId,callerId:a,receiverId:r,roomName:e.roomName,timestamp:(new Date).toISOString(),startTime:n,endTime:c,isVideoCall:l};J.current=!0,m.sendCallSignal(i),f.current=null}catch(t){console.error("‚ùå Failed to send CALL_END signal:",t)}await te(),O.current&&O.current.postMessage({type:"CALL_ENDED_FROM_POPUP",data:{conversationId:e.conversationId}}),window.close()}},[e,te,t,v]),re=r.useCallback(async()=>{const e=!p;if(h(e),D.current&&D.current.isConnected)try{const t=Array.from(D.current.localParticipant.audioTrackPublications.values());if(e){for(const e of t)e.track&&e.track.setEnabled(!1);await D.current.localParticipant.setMicrophoneEnabled(!1),console.log("üîá Microphone muted")}else{for(const e of t)e.track&&e.track.setEnabled(!0);await D.current.localParticipant.setMicrophoneEnabled(!0),console.log("üîä Microphone unmuted")}}catch(t){console.error("‚ùå Error toggling microphone:",t)}O.current&&O.current.postMessage({type:"MUTE_TOGGLED",data:{isMuted:e}})},[p]);r.useEffect(()=>{const e=async e=>{try{const t=new Audio(e);t.loop=!0,t.volume=.7,t.preload="auto";let a=t.play();void 0!==a&&(await a,V.current=t,console.log("‚úÖ Call sound started:",e))}catch(a){if(console.warn("‚ö†Ô∏è Failed to play call sound (autoplay blocked?):",a),"incoming"===t){const t=async()=>{try{const a=new Audio(e);a.loop=!0,a.volume=.7,await a.play(),V.current=a,console.log("‚úÖ Call sound started after user interaction"),document.removeEventListener("click",t),document.removeEventListener("touchstart",t),window.removeEventListener("focus",t)}catch(a){console.error("‚ùå Failed to play sound even after interaction:",a)}};document.addEventListener("click",t,{once:!0}),document.addEventListener("touchstart",t,{once:!0}),window.addEventListener("focus",t,{once:!0}),document.hasFocus()&&setTimeout(()=>t(),100)}}};return"outgoing"===t?e("/svmessenger/sounds/OutCall.mp3"):"incoming"===t?(window.focus&&window.focus(),e("/svmessenger/sounds/IncomingCall.mp3")):("connected"===t&&V.current||"rejected"===t&&V.current)&&(V.current.pause(),V.current.currentTime=0,V.current=null),()=>{V.current&&(V.current.pause(),V.current.currentTime=0,V.current=null)}},[t]),r.useEffect(()=>(console.log("üîÑ useEffect for callState changed:",t),"connected"===t?(console.log('‚úÖ callState is "connected", connecting to LiveKit...'),W().catch(e=>{console.error("‚ùå Failed to connect to LiveKit in useEffect:",e)})):console.log('‚è≥ callState is not "connected", waiting... (current:',t,")"),()=>{console.log("üßπ Cleaning up LiveKit connection"),te()}),[t,W,te]),r.useEffect(()=>("connected"===t&&v?_.current=setInterval(()=>{d(e=>e+1)},1e3):(_.current&&(clearInterval(_.current),_.current=null),d(0)),()=>{_.current&&clearInterval(_.current)}),[t,v]),r.useEffect(()=>{var e;if(k&&$.current&&(null==(e=D.current)?void 0:e.localParticipant)){console.log("üé¨ [useEffect] isVideoEnabled changed, attempting to attach local video...");const e=Array.from(D.current.localParticipant.videoTrackPublications.values());if(console.log("üé¨ [useEffect] Found video track publications:",e.length),e.length>0){const a=e[0];if(a.track&&$.current)try{console.log("üé¨ [useEffect] Attaching local video track to element..."),a.track.attach($.current),console.log("‚úÖ [useEffect] Local video preview attached")}catch(t){console.error("‚ùå [useEffect] Error attaching local video:",t)}else console.warn("‚ö†Ô∏è [useEffect] Missing track or ref:",{hasTrack:!!a.track,hasRef:!!$.current})}else console.log("‚è≥ [useEffect] No video tracks yet, will retry when track is published")}},[k,v]),r.useEffect(()=>(m.connect({onCallSignal:t=>{"CALL_END"===t.eventType?(console.log("üìû CALL_END received in popup:",t),t.conversationId===e.conversationId&&(console.log("üìû CALL_END matches our call, showing rejection animation..."),o("rejected"),V.current&&(V.current.pause(),V.current.currentTime=0,V.current=null),setTimeout(()=>{console.log("üìû Closing popup after CALL_END animation"),window.close()},3e3))):"CALL_REJECT"===t.eventType&&(console.log("üìû CALL_REJECT received in popup:",t),t.conversationId===e.conversationId&&(console.log("üìû CALL_REJECT matches our call, showing rejection animation..."),o("rejected"),V.current&&(V.current.pause(),V.current.currentTime=0,V.current=null),setTimeout(()=>{ae()},3e3)))},onConnect:()=>{console.log("WebSocket connected in popup")},onDisconnect:()=>{console.log("WebSocket disconnected in popup")},onError:e=>{console.error("WebSocket error in popup:",e)}}),()=>{m.disconnect()}),[e.conversationId,ae]),r.useEffect(()=>{const e=e=>{var t;const a={name:"GlobalError",message:e.message||"Unknown error",filename:e.filename,lineno:e.lineno,colno:e.colno,stack:null==(t=e.error)?void 0:t.stack,timestamp:(new Date).toISOString(),location:"global"};if(console.error("‚ùå [GlobalError] Uncaught error:",a),O.current)try{O.current.postMessage({type:"CAMERA_ERROR",data:a})}catch(r){console.error("Failed to send global error:",r)}try{const e=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");e.push(a),e.length>10&&e.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(e))}catch(o){console.error("Failed to save global error:",o)}},t=e=>{var t,a;const r={name:"UnhandledPromiseRejection",message:(null==(t=e.reason)?void 0:t.message)||"Unhandled promise rejection",stack:null==(a=e.reason)?void 0:a.stack,timestamp:(new Date).toISOString(),location:"global"};if(console.error("‚ùå [GlobalError] Unhandled promise rejection:",r),O.current)try{O.current.postMessage({type:"CAMERA_ERROR",data:r})}catch(o){console.error("Failed to send promise rejection error:",o)}try{const e=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");e.push(r),e.length>10&&e.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(e))}catch(n){console.error("Failed to save promise rejection error:",n)}};return window.addEventListener("error",e),window.addEventListener("unhandledrejection",t),()=>{window.removeEventListener("error",e),window.removeEventListener("unhandledrejection",t)}},[]),r.useEffect(()=>(O.current=new BroadcastChannel("svmessenger-call"),O.current.onmessage=e=>{const{type:t,data:a}=e.data;switch(t){case"CALL_ENDED":console.log("üìû CALL_ENDED received via BroadcastChannel"),o("rejected"),V.current&&(V.current.pause(),V.current.currentTime=0,V.current=null),setTimeout(()=>{console.log("üìû Closing popup after CALL_ENDED animation"),window.close()},3e3);break;case"CALL_REJECTED":console.log("üìû CALL_REJECTED received via BroadcastChannel"),o("rejected"),V.current&&(V.current.pause(),V.current.currentTime=0,V.current=null),setTimeout(()=>{ae()},3e3);break;case"CALL_ACCEPTED":console.log("‚úÖ CALL_ACCEPTED received via BroadcastChannel, changing callState to connected"),o("connected");break;case"MUTE_TOGGLED":h(a.isMuted);break;case"DEVICE_CHANGED":a.microphone&&(U.current=a.microphone,Z(a.microphone)),a.speaker&&(F.current=a.speaker,ee(a.speaker))}},()=>{O.current&&O.current.close()}),[ae,Z,ee]),r.useEffect(()=>{const e=()=>{te()};return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}},[te]);const oe=r.useCallback(e=>{e.preventDefault(),I(!0);const t=e.currentTarget.getBoundingClientRect();R({x:e.clientX-t.left,y:e.clientY-t.top})},[]),ne=r.useCallback(e=>{if(!L)return;const t=document.querySelector(".call-window-video-layout");if(!t)return;const a=t.getBoundingClientRect();let r=e.clientX-a.left-P.x,o=e.clientY-a.top-P.y;r=Math.max(10,Math.min(r,a.width-160-10)),o=Math.max(10,Math.min(o,a.height-120-10)),S({x:r,y:o})},[L,P]),ce=r.useCallback(()=>{I(!1)},[]);return r.useEffect(()=>{if(L)return document.addEventListener("mousemove",ne),document.addEventListener("mouseup",ce),()=>{document.removeEventListener("mousemove",ne),document.removeEventListener("mouseup",ce)}},[L,ne,ce]),a.jsx(g,{callState:t,callDuration:s,formatDuration:e=>{const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`},isMuted:p,isConnected:v,otherUserName:e.otherUserName,otherUserAvatar:e.otherUserAvatar,onMuteToggle:re,onEndCall:ae,isVideoEnabled:k,remoteVideoVisible:b,localVideoRef:$,remoteVideoRef:B,onCameraToggle:Q,cameraPermissionDenied:E,isCameraLoading:j,pipPosition:x,isDragging:L,onPipMouseDown:oe})};console.log("üöÄ Call window popup opened");const h=new URLSearchParams(window.location.search),v={token:h.get("token"),roomName:h.get("roomName"),conversationId:h.get("conversationId"),otherUserId:h.get("otherUserId"),otherUserName:h.get("otherUserName"),otherUserAvatar:h.get("otherUserAvatar"),currentUserId:h.get("currentUserId"),currentUserName:h.get("currentUserName"),currentUserAvatar:h.get("currentUserAvatar"),callType:h.get("callType")||"voice",callState:h.get("callState")||"outgoing"};if(console.log("üìû Call window data:",{hasToken:!!v.token,tokenLength:(null==(e=v.token)?void 0:e.length)||0,roomName:v.roomName,conversationId:v.conversationId,callState:v.callState,otherUserId:v.otherUserId,currentUserId:v.currentUserId}),v.token&&v.roomName&&v.conversationId){console.log("‚úÖ All required data present, mounting React app");const e=document.getElementById("call-window-root");if(e){o(e).render(a.jsx(p,{callData:v})),console.log("‚úÖ React app mounted")}else console.error("‚ùå Container element not found!")}else console.error("‚ùå Missing required call data:",{hasToken:!!v.token,hasRoomName:!!v.roomName,hasConversationId:!!v.conversationId}),document.body.innerHTML='\n        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; gap: 20px;">\n            <h2>–ì—Ä–µ—à–∫–∞</h2>\n            <p>–õ–∏–ø—Å–≤–∞—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏ –¥–∞–Ω–Ω–∏ –∑–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.</p>\n            <button onclick="window.close()" style="padding: 10px 20px; cursor: pointer;">–ó–∞—Ç–≤–æ—Ä–∏</button>\n        </div>\n    ';
