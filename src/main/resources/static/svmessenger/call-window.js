var e;import{R as a,j as t,r,a as o}from"./svmessenger-vendor-react.js";import{R as n,a as c,L as l,b as i}from"./svmessenger-vendor-livekit.js";import{g as s,e as d,a as u,s as m}from"./svmessenger-svHelpers.js";import"./svmessenger-vendor.js";import"./svmessenger-vendor-websocket.js";const g=({callState:e,callDuration:r,formatDuration:o,isMuted:n,isConnected:c,otherUserName:l,otherUserAvatar:i,onMuteToggle:u,onEndCall:m,isVideoEnabled:g,remoteVideoVisible:p,localVideoRef:h,remoteVideoRef:v,onCameraToggle:w,cameraPermissionDenied:f,isCameraLoading:k,pipPosition:C,isDragging:b,onPipMouseDown:y})=>{const E=a.useMemo(()=>{if(!l)return"–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª";try{return decodeURIComponent(l)}catch(e){return l}},[l]),j=a.useMemo(()=>{if(!i)return null;try{return decodeURIComponent(i)}catch(e){return i}},[i]),T=e=>{if(!e||""===e.trim())return!1;return!["/default-avatar","default-avatar.png","default-avatar.jpg"].some(a=>e.includes(a))},N=a.useMemo(()=>s(E.charCodeAt(0)||0),[E]),x=a.useMemo(()=>d(E),[E]);return t.jsxs("div",{className:"call-window-container",children:[t.jsxs("div",{className:"call-window-background",children:[t.jsx("div",{className:"call-window-bg-shape shape-1"}),t.jsx("div",{className:"call-window-bg-shape shape-2"}),t.jsx("div",{className:"call-window-bg-shape shape-3"}),t.jsx("div",{className:"call-window-bg-shape shape-4"})]}),"connected"===e?t.jsxs("div",{className:"call-window-video-layout",children:[t.jsx("div",{ref:v,className:"call-window-remote-video "+(p?"video-active":""),children:!p&&t.jsxs("div",{className:"call-window-avatar-fallback",children:[j&&T(j)?t.jsx("img",{src:j,alt:E,onError:e=>{e.target.style.display="none";const a=e.target.nextElementSibling;a&&(a.style.display="flex")}}):null,t.jsx("div",{className:"call-window-avatar-placeholder",style:{display:j&&T(j)?"none":"flex",backgroundColor:N,width:"120px",height:"120px",fontSize:"48px",borderRadius:"50%",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600"},children:x}),t.jsx("p",{className:"call-window-name",children:E}),t.jsx("p",{className:"call-window-status",children:c?"–°–≤—ä—Ä–∑–∞–Ω":"–°–≤—ä—Ä–∑–≤–∞–Ω–µ..."})]})}),g&&t.jsxs("div",{className:"video-quality-badge",children:[t.jsx("i",{className:"bi bi-badge-hd-fill"}),t.jsx("span",{children:"Full HD"})]}),t.jsx("div",{className:"connection-indicator excellent",children:t.jsxs("div",{className:"signal-bars",children:[t.jsx("span",{}),t.jsx("span",{}),t.jsx("span",{})]})}),g&&t.jsxs("div",{className:"call-window-local-video-pip "+(b?"dragging":""),style:{right:"auto",bottom:"auto",left:`${C.x}px`,top:`${C.y}px`,cursor:b?"grabbing":"grab"},onMouseDown:y,children:[t.jsx("video",{ref:h,autoPlay:!0,playsInline:!0,muted:!0,className:"local-video-element",style:{objectFit:"cover"}}),t.jsx("div",{className:"pip-label",children:"–í–∏–µ"})]}),t.jsxs("div",{className:"call-window-info",children:[t.jsx("span",{className:"call-duration",children:o(r)}),g&&t.jsx("span",{className:"video-indicator",children:"Video"})]}),t.jsxs("div",{className:"call-window-controls",children:[t.jsx("button",{className:"call-control-btn "+(n?"active":""),onClick:u,title:n?"–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω":"–ò–∑–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω",children:t.jsx("i",{className:`bi bi-mic${n?"-mute":""}-fill`})}),t.jsx("button",{className:"call-control-btn "+(g?"":"inactive"),onClick:w,title:g?"–ò–∑–∫–ª—é—á–∏ –∫–∞–º–µ—Ä–∞":"–í–∫–ª—é—á–∏ –∫–∞–º–µ—Ä–∞",disabled:f||k,children:k?t.jsx("div",{className:"camera-loading-spinner"}):t.jsx("i",{className:`bi bi-camera-video${g?"":"-off"}-fill`})}),t.jsx("button",{className:"call-control-btn call-end-btn",onClick:m,title:"–ü—Ä–µ–∫—Ä–∞—Ç–∏",children:t.jsx("i",{className:"bi bi-telephone-x-fill"})})]})]}):t.jsxs("div",{className:"call-window-modal",children:[t.jsxs("div",{className:`call-window-avatar ${"connected"===e?"connected":""} ${"outgoing"===e||"incoming"===e?"pulsing":""}`,children:[j&&T(j)?t.jsx("img",{src:j,alt:E,onError:e=>{e.target.style.display="none";const a=e.target.nextElementSibling;a&&(a.style.display="flex")}}):null,t.jsx("div",{className:"call-window-avatar-placeholder",style:{display:j&&T(j)?"none":"flex",backgroundColor:N},children:x}),"connected"===e&&c&&t.jsx("div",{className:"call-window-avatar-ring"})]}),t.jsxs("div",{className:"call-window-status",children:[t.jsxs("div",{className:"call-window-title",children:["outgoing"===e&&"–û–±–∞–∂–¥–∞–Ω–µ...","incoming"===e&&"–í—Ö–æ–¥—è—â–æ –æ–±–∞–∂–¥–∞–Ω–µ","connected"===e&&t.jsxs(t.Fragment,{children:["–í —Ä–∞–∑–≥–æ–≤–æ—Ä ",E&&`—Å ${E}`]}),"rejected"===e&&"–û–±–∞–∂–¥–∞–Ω–µ—Ç–æ –µ –æ—Ç—Ö–≤—ä—Ä–ª–µ–Ω–æ"]}),t.jsx("div",{className:"call-window-subtitle",children:"connected"===e&&c?o(r):"rejected"===e?"–ó–∞—Ç–≤–∞—Ä—è–Ω–µ...":E}),("incoming"===e||"outgoing"===e)&&t.jsxs("div",{className:"call-window-calling-animation",children:[t.jsxs("div",{className:"call-window-ripple-container",children:[t.jsx("div",{className:"call-window-ripple ripple-1"}),t.jsx("div",{className:"call-window-ripple ripple-2"}),t.jsx("div",{className:"call-window-ripple ripple-3"}),t.jsx("div",{className:"call-window-ripple ripple-4"})]}),t.jsx("div",{className:"call-window-glow-core",children:t.jsx("div",{className:"call-window-glow-inner"})}),t.jsxs("div",{className:"call-window-particles",children:[t.jsx("div",{className:"particle particle-1"}),t.jsx("div",{className:"particle particle-2"}),t.jsx("div",{className:"particle particle-3"}),t.jsx("div",{className:"particle particle-4"}),t.jsx("div",{className:"particle particle-5"}),t.jsx("div",{className:"particle particle-6"})]})]}),"rejected"===e&&t.jsxs("div",{className:"call-window-calling-animation call-window-rejection-animation",children:[t.jsxs("div",{className:"call-window-ripple-container",children:[t.jsx("div",{className:"call-window-ripple ripple-1 rejection-ripple"}),t.jsx("div",{className:"call-window-ripple ripple-2 rejection-ripple"}),t.jsx("div",{className:"call-window-ripple ripple-3 rejection-ripple"}),t.jsx("div",{className:"call-window-ripple ripple-4 rejection-ripple"})]}),t.jsx("div",{className:"call-window-glow-core rejection-glow",children:t.jsx("div",{className:"call-window-glow-inner rejection-glow-inner"})}),t.jsxs("div",{className:"call-window-particles rejection-particles",children:[t.jsx("div",{className:"particle particle-1 rejection-particle"}),t.jsx("div",{className:"particle particle-2 rejection-particle"}),t.jsx("div",{className:"particle particle-3 rejection-particle"}),t.jsx("div",{className:"particle particle-4 rejection-particle"}),t.jsx("div",{className:"particle particle-5 rejection-particle"}),t.jsx("div",{className:"particle particle-6 rejection-particle"})]})]}),"connected"===e&&!c&&t.jsx("div",{className:"call-window-connecting",children:"–°–≤—ä—Ä–∑–≤–∞–Ω–µ..."})]}),t.jsxs("div",{className:"call-window-actions",children:["connected"===e&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"call-window-btn-mute "+(n?"muted":""),onClick:u,title:n?"–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞":"–ò–∑–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞",children:n?t.jsx("i",{className:"bi bi-mic-mute muted-icon"}):t.jsx("i",{className:"bi bi-mic active-icon"})}),t.jsx("button",{className:"call-window-btn-end",onClick:m,title:"–ó–∞—Ç–≤–æ—Ä–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:t.jsx("i",{className:"bi bi-telephone end-icon"})})]}),("outgoing"===e||"incoming"===e)&&t.jsx("button",{className:"call-window-btn-end",onClick:m,title:"outgoing"===e?"–û—Ç–º–µ–Ω–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ":"–û—Ç–∫–∞–∂–∏ –æ–±–∞–∂–¥–∞–Ω–µ—Ç–æ",children:t.jsx("i",{className:"bi bi-telephone end-icon"})}),"rejected"===e&&t.jsx("div",{className:"call-window-actions"})]})]})]})},p=({callData:e})=>{const[a,o]=r.useState(e.callState),[s,d]=r.useState(0),[p,h]=r.useState(!1),[v,w]=r.useState(!1),f=r.useRef(null),[k,C]=r.useState(!1),[b,y]=r.useState(!1),[E,j]=r.useState(!1),[T,N]=r.useState(!1),[x,S]=r.useState({x:20,y:20}),[L,P]=r.useState(!1),[I,R]=r.useState({x:0,y:0}),D=r.useRef(null),A=r.useRef(null),M=r.useRef(new Map),U=r.useRef(null),F=r.useRef(null),O=r.useRef(null),_=r.useRef(null),V=r.useRef(null),G=r.useRef(!1),J=r.useRef(!1),$=r.useRef(null),B=r.useRef(null),H=r.useRef(new Map);r.useEffect(()=>{try{const e=localStorage.getItem("svmessenger-audio-settings");if(e){const a=JSON.parse(e);a.microphone&&(U.current=a.microphone),a.speaker&&(F.current=a.speaker)}}catch(e){}},[]);const q=r.useCallback(async()=>{try{D.current&&D.current.isConnected&&await ae();const i=new n;if(D.current=i,i.on(c.Connected,()=>{w(!0),o("connected"),J.current=!1,f.current||(f.current=new Date),i.participants&&i.participants.size>0&&i.participants.forEach((e,a)=>{e.audioTrackPublications.forEach(e=>{e.track&&W(e.track,a)})})}),i.on(c.Disconnected,e=>{w(!1),G.current}),i.on(c.ParticipantConnected,e=>{e.audioTrackPublications.forEach((a,t)=>{a.track&&W(a.track,e.identity)}),e.videoTrackPublications.forEach((a,t)=>{a.track&&z(a.track,e.identity)})}),i.on(c.ParticipantDisconnected,e=>{var a;if(G.current)return;K(e.identity),X(e.identity);const t=null==(a=i.localParticipant)?void 0:a.identity;t&&e.identity!==t&&setTimeout(()=>{if(D.current&&D.current.isConnected&&!G.current){Array.from(D.current.participants.values()).some(a=>a.identity===e.identity)||te()}},8e3)}),i.on(c.TrackSubscribed,(e,a,t)=>{const r=t===i.localParticipant;if("audio"===e.kind)W(e,t.identity);else if("video"===e.kind)if(r){if($.current)try{e.attach($.current)}catch(o){console.error("Error attaching local video:",o)}}else z(e,t.identity)}),i.on(c.LocalTrackPublished,(e,a)=>{if(e.track&&"video"===e.track.kind&&$.current&&e.track)try{e.track.attach($.current)}catch(t){console.error("Error attaching local video:",t)}}),i.on(c.TrackPublished,(e,a)=>{}),i.on(c.TrackUnsubscribed,(e,a,t)=>{"audio"===e.kind?K(t.identity):"video"===e.kind&&X(t.identity)}),await i.connect("wss://smolyanvote-nq17fbx3.livekit.cloud",e.token),await new Promise(e=>setTimeout(e,300)),U.current&&A.current)try{const e=Array.from(i.localParticipant.audioTrackPublications.values());for(const t of e)t.track&&await i.localParticipant.unpublishTrack(t.track);const a=A.current.getAudioTracks();if(a.length>0){const e=a[0],t=new l(e);await i.localParticipant.publishTrack(t,{source:"microphone"})}}catch(a){console.error("Failed to publish microphone from stream:",a);try{await i.localParticipant.setMicrophoneEnabled(!0)}catch(t){console.error("Failed to enable default microphone:",t)}}else if(U.current)try{const e=U.current,a={audio:!e||{deviceId:{ideal:e}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},t=await navigator.mediaDevices.getUserMedia(a);A.current=t;const r=t.getAudioTracks();if(r.length>0){const e=r[0],a=new l(e);await i.localParticipant.publishTrack(a,{source:"microphone"})}}catch(r){console.error("Failed to get and publish microphone:",r);try{await i.localParticipant.setMicrophoneEnabled(!0)}catch(t){console.error("Failed to enable default microphone:",t)}}else try{await i.localParticipant.setMicrophoneEnabled(!0)}catch(r){console.error("Failed to enable default microphone:",r)}}catch(r){if(console.error("Failed to connect to LiveKit:",r),w(!1),o("connected"),D.current){try{await D.current.disconnect()}catch(i){console.error("Failed to disconnect on error:",i)}D.current=null}}},[e.token]);r.useCallback(async()=>{if(D.current)if(D.current.isConnected)try{const r=Array.from(D.current.localParticipant.audioTrackPublications.values());for(const e of r)e.track&&await D.current.localParticipant.unpublishTrack(e.track);const o=U.current,n={audio:!o||{deviceId:{ideal:o}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0};let c;try{c=await navigator.mediaDevices.getUserMedia(n)}catch(e){try{c=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})}catch(a){console.error("Failed to get fallback user media:",a);try{await D.current.localParticipant.setMicrophoneEnabled(!0)}catch(t){console.error("Failed to enable default microphone:",t)}return}}A.current=c;const i=c.getAudioTracks();if(i.length>0){const e=i[0],a=new l(e);await D.current.localParticipant.publishTrack(a,{source:"microphone"})}else{console.error("No audio tracks in stream");try{await D.current.localParticipant.setMicrophoneEnabled(!0)}catch(a){console.error("Failed to enable default microphone:",a)}}}catch(e){console.error("Failed to publish microphone:",e);try{await D.current.localParticipant.setMicrophoneEnabled(!0)}catch(a){console.error("Failed to enable default microphone:",a)}}else console.error("Cannot publish microphone: room not connected");else console.error("Cannot publish microphone: roomRef.current is null")},[]);const W=r.useCallback((e,a)=>{try{const r=M.current.get(a);if(r){try{e.detach(r)}catch(t){}r.pause(),r.srcObject=null,r.remove()}const o=document.createElement("audio");o.autoplay=!0,o.playsInline=!0,o.volume=1,F.current&&"setSinkId"in HTMLAudioElement.prototype&&o.setSinkId(F.current).catch(()=>{}),e.attach(o),M.current.set(a,o),o.addEventListener("error",e=>{console.error("Remote audio error:",e)});const n=o.play();void 0!==n&&n.catch(e=>{const a=()=>{o.play().catch(e=>{console.error("Failed to play after user interaction:",e)})};document.addEventListener("click",a,{once:!0}),document.addEventListener("touchstart",a,{once:!0})})}catch(r){console.error("‚ùå Error attaching remote audio track:",r)}},[]),K=r.useCallback(e=>{const a=M.current.get(e);a&&(a.pause(),a.srcObject=null,a.remove(),M.current.delete(e))},[]),z=r.useCallback((e,a)=>{var t;try{H.current||(H.current=new Map);const o=H.current.get(a);if(o&&o.element)try{null==(t=o.track)||t.detach(o.element),o.element.parentNode&&o.element.remove()}catch(r){console.warn("‚ö†Ô∏è Error detaching existing track (non-critical):",r.message)}const n=document.createElement("video");n.autoplay=!0,n.playsInline=!0,n.muted=!1,n.style.width="100%",n.style.height="100%",n.style.objectFit="cover",n.style.objectPosition="center",n.style.backgroundColor="#000",n.className="remote-video-element",e.attach(n),H.current.set(a,{element:n,track:e}),B.current&&(B.current.appendChild(n),y(!0))}catch(o){console.error("Error attaching remote video track:",o)}},[]),X=r.useCallback(e=>{if(H.current){const t=H.current.get(e);if(t){try{if(t.track&&t.element&&t.track.detach(t.element),t.element&&t.element.parentNode)try{t.element.remove()}catch(a){}}catch(a){}H.current.delete(e)}}try{u.detachRemoteVideoTrack(e)}catch(a){}y(!1)},[]),Y=r.useCallback(async(e,a,t)=>{if(!e||!v)return!1;try{if(a){const a=Array.from(e.localParticipant.videoTrackPublications.values());for(const t of a)t.track&&(await e.localParticipant.unpublishTrack(t.track),t.track.stop());const o={width:{ideal:1920,min:1280},height:{ideal:1080,min:720},frameRate:{ideal:30,min:24},aspectRatio:{ideal:16/9}};t&&(o.deviceId={exact:t});const n=(await navigator.mediaDevices.getUserMedia({video:o})).getVideoTracks();if(0===n.length)throw new Error("No video track in stream");const c=n[0],l=new i(c);try{await e.localParticipant.publishTrack(l,{source:"camera"})}catch(r){throw console.error("Error publishing video track:",r),l.stop(),r}return!0}{const a=Array.from(e.localParticipant.videoTrackPublications.values());for(const t of a)t.track&&(await e.localParticipant.unpublishTrack(t.track),t.track.stop());return!0}}catch(o){if(console.error("Failed to toggle camera:",o),O.current)try{O.current.postMessage({type:"CAMERA_ERROR",data:errorDetails})}catch(n){console.error("Failed to send error via BroadcastChannel:",n)}try{const e=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");e.push(errorDetails),e.length>10&&e.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(e))}catch(c){console.error("Failed to save error to localStorage:",c)}return!1}},[v]),Q=r.useCallback(async()=>{var e,a,t,r,o,n,c,l,i,s,d,m;if(console.log("üé¨ [handleCameraToggle] START",{hasRoom:!!D.current,isConnectedState:v,roomIsConnected:null==(e=D.current)?void 0:e.isConnected,currentState:k,cameraPermissionDenied:E}),N(!0),!D.current||!v&&!D.current.isConnected)return console.warn("‚ö†Ô∏è [handleCameraToggle] Cannot toggle camera - not connected",{hasRoom:!!D.current,isConnectedState:v,roomIsConnected:null==(a=D.current)?void 0:a.isConnected}),void N(!1);const g=!k;console.log(`üé¨ [handleCameraToggle] Toggling camera: ${k} ‚Üí ${g}`);try{if(g&&!E){console.log("üé¨ [handleCameraToggle] Requesting camera permission...");try{const e=u.selectedCamera?{video:{deviceId:{exact:u.selectedCamera}}}:{video:!0};console.log("üé¨ [handleCameraToggle] Permission constraints:",e);const a=await navigator.mediaDevices.getUserMedia(e);console.log("üé¨ [handleCameraToggle] Permission granted, stream:",{id:a.id,active:a.active,tracks:a.getTracks().length}),a.getTracks().forEach(e=>{console.log("üé¨ [handleCameraToggle] Stopping test track:",e.id),e.stop()})}catch(p){return console.error("‚ùå [handleCameraToggle] Camera permission denied:",p),j(!0),N(!1),void alert("–ú–æ–ª—è —Ä–∞–∑—Ä–µ—à–µ—Ç–µ –¥–æ—Å—Ç—ä–ø –¥–æ –∫–∞–º–µ—Ä–∞—Ç–∞ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä–∞.")}}console.log("üé¨ [handleCameraToggle] Toggling camera directly on room..."),console.log("üé¨ [handleCameraToggle] Selected camera:",u.selectedCamera),console.log("üé¨ [handleCameraToggle] Room state:",{hasRoom:!!D.current,isConnected:v,hasLocalParticipant:!!(null==(t=D.current)?void 0:t.localParticipant)});const e=await Y(D.current,g,u.selectedCamera);if(console.log("üé¨ [handleCameraToggle] toggleCamera result:",e),e){if(console.log("üé¨ [handleCameraToggle] toggleCamera succeeded, updating state..."),C(g),N(!1),console.log("üé¨ [handleCameraToggle] isVideoEnabled state updated to:",g),console.log("üé¨ [handleCameraToggle] localVideoRef.current:",{exists:!!$.current,tagName:null==(r=$.current)?void 0:r.tagName,className:null==(o=$.current)?void 0:o.className,id:null==(n=$.current)?void 0:n.id}),g){if(console.log("üé¨ [handleCameraToggle] Attempting to attach local video preview..."),D.current&&D.current.localParticipant){const e=Array.from(D.current.localParticipant.videoTrackPublications.values());if(console.log("üé¨ [handleCameraToggle] Found video track publications:",e.length),e.length>0){const a=e[0];if(console.log("üé¨ [handleCameraToggle] Publication details:",{hasTrack:!!a.track,trackSid:a.trackSid,source:a.source,trackId:null==(c=a.track)?void 0:c.id,trackKind:null==(l=a.track)?void 0:l.kind,trackEnabled:null==(i=a.track)?void 0:i.isEnabled}),a.track&&$.current)try{console.log("üé¨ [handleCameraToggle] Attaching track to video element..."),a.track.attach($.current),console.log("‚úÖ [handleCameraToggle] Local video preview attached immediately"),console.log("üé¨ [handleCameraToggle] Video element after attach:",{srcObject:!!$.current.srcObject,videoWidth:$.current.videoWidth,videoHeight:$.current.videoHeight,readyState:$.current.readyState})}catch(h){console.error("‚ùå [handleCameraToggle] Error attaching local video:",h),console.error("‚ùå [handleCameraToggle] Error details:",{name:h.name,message:h.message,stack:h.stack})}else console.warn("‚ö†Ô∏è [handleCameraToggle] Missing track or localVideoRef:",{hasTrack:!!a.track,hasRef:!!$.current,trackId:null==(s=a.track)?void 0:s.id,refTagName:null==(d=$.current)?void 0:d.tagName})}else console.log("‚è≥ [handleCameraToggle] No video tracks yet, waiting for LocalTrackPublished event...")}else console.warn("‚ö†Ô∏è [handleCameraToggle] Missing room or localParticipant:",{hasRoom:!!D.current,hasLocalParticipant:!!(null==(m=D.current)?void 0:m.localParticipant)});setTimeout(()=>{if(console.log("üé¨ [handleCameraToggle] Delayed fallback attempt (500ms)..."),D.current&&D.current.localParticipant&&$.current){const e=Array.from(D.current.localParticipant.videoTrackPublications.values());if(console.log("üé¨ [handleCameraToggle] Delayed check - video tracks:",e.length),e.length>0){const a=e[0];if(a.track)try{console.log("üé¨ [handleCameraToggle] Delayed attach attempt..."),a.track.attach($.current),console.log("‚úÖ [handleCameraToggle] Local video preview attached (delayed fallback)")}catch(h){console.error("‚ùå [handleCameraToggle] Error in delayed attach:",h)}else console.warn("‚ö†Ô∏è [handleCameraToggle] Delayed check - publication has no track")}else console.warn("‚ö†Ô∏è [handleCameraToggle] Delayed check - no video tracks found")}else console.warn("‚ö†Ô∏è [handleCameraToggle] Delayed check - missing room/participant/ref")},500)}else $.current&&(console.log("üé¨ [handleCameraToggle] Clearing local video preview"),$.current.srcObject=null,console.log("üé¨ [handleCameraToggle] Local video preview cleared"));O.current&&O.current.postMessage({type:"CAMERA_TOGGLED",data:{enabled:g}})}else console.log("üé¨ [handleCameraToggle] toggleCamera failed, state NOT updated"),N(!1)}catch(w){const e={name:w.name,message:w.message,stack:w.stack,timestamp:(new Date).toISOString(),location:"handleCameraToggle"};if(console.error("‚ùå [handleCameraToggle] Failed to toggle camera:",w),console.error("‚ùå [handleCameraToggle] Error details:",e),console.log("üé¨ [handleCameraToggle] Error occurred, state NOT updated"),O.current)try{O.current.postMessage({type:"CAMERA_ERROR",data:e})}catch(f){console.error("Failed to send error via BroadcastChannel:",f)}try{const a=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");a.push(e),a.length>10&&a.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(a))}catch(b){console.error("Failed to save error to localStorage:",b)}N(!1)}},[k,E,v,Y]),Z=r.useCallback(async e=>{U.current=e,A.current&&(A.current.getTracks().forEach(e=>e.stop()),A.current=null);try{const a=await navigator.mediaDevices.getUserMedia({audio:!e||{deviceId:{ideal:e}},echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0});if(A.current=a,D.current&&D.current.isConnected){const e=Array.from(D.current.localParticipant.audioTrackPublications.values());for(const a of e)a.track&&await D.current.localParticipant.unpublishTrack(a.track);const t=a.getAudioTracks();if(t.length>0){const e=t[0],a=new l(e);await D.current.localParticipant.publishTrack(a,{source:"microphone"})}}}catch(a){console.error("Failed to set microphone:",a)}},[]),ee=r.useCallback(async e=>{F.current=e,"setSinkId"in HTMLAudioElement.prototype&&M.current.forEach(a=>{a.setSinkId(e).catch(()=>{})})},[]),ae=r.useCallback(async()=>{A.current&&(A.current.getTracks().forEach(e=>e.stop()),A.current=null),M.current.forEach(e=>{e.pause(),e.srcObject=null,e.remove()}),M.current.clear(),D.current&&(await D.current.disconnect(),D.current=null),w(!1)},[]),te=r.useCallback(async()=>{if(!G.current){if(G.current=!0,V.current&&(V.current.pause(),V.current.currentTime=0,V.current=null),!J.current)try{const a="outgoing"===e.callState,t=a?e.currentUserId:e.otherUserId,r=a?e.otherUserId:e.currentUserId,o=new Date,n=f.current?new Date(f.current).toISOString():o.toISOString(),c=o.toISOString(),l="video"===e.callType||!1,i={eventType:"CALL_END",conversationId:e.conversationId,callerId:t,receiverId:r,roomName:e.roomName,timestamp:(new Date).toISOString(),startTime:n,endTime:c,isVideoCall:l};J.current=!0,m.sendCallSignal(i),f.current=null}catch(a){console.error("‚ùå Failed to send CALL_END signal:",a)}await ae(),O.current&&O.current.postMessage({type:"CALL_ENDED_FROM_POPUP",data:{conversationId:e.conversationId}}),window.close()}},[e,ae,a,v]),re=r.useCallback(async()=>{const e=!p;if(h(e),D.current&&D.current.isConnected)try{const a=Array.from(D.current.localParticipant.audioTrackPublications.values());if(e){for(const e of a)e.track&&e.track.setEnabled(!1);await D.current.localParticipant.setMicrophoneEnabled(!1),console.log("üîá Microphone muted")}else{for(const e of a)e.track&&e.track.setEnabled(!0);await D.current.localParticipant.setMicrophoneEnabled(!0),console.log("üîä Microphone unmuted")}}catch(a){console.error("‚ùå Error toggling microphone:",a)}O.current&&O.current.postMessage({type:"MUTE_TOGGLED",data:{isMuted:e}})},[p]);r.useEffect(()=>{const e=async e=>{try{const a=new Audio(e);a.loop=!0,a.volume=.7,a.preload="auto";let t=a.play();void 0!==t&&(await t,V.current=a,console.log("‚úÖ Call sound started:",e))}catch(t){if(console.warn("‚ö†Ô∏è Failed to play call sound (autoplay blocked?):",t),"incoming"===a){const a=async()=>{try{const t=new Audio(e);t.loop=!0,t.volume=.7,await t.play(),V.current=t,console.log("‚úÖ Call sound started after user interaction"),document.removeEventListener("click",a),document.removeEventListener("touchstart",a),window.removeEventListener("focus",a)}catch(t){console.error("‚ùå Failed to play sound even after interaction:",t)}};document.addEventListener("click",a,{once:!0}),document.addEventListener("touchstart",a,{once:!0}),window.addEventListener("focus",a,{once:!0}),document.hasFocus()&&setTimeout(()=>a(),100)}}};return"outgoing"===a?e("/svmessenger/sounds/OutCall.mp3"):"incoming"===a?(window.focus&&window.focus(),e("/svmessenger/sounds/IncomingCall.mp3")):("connected"===a&&V.current||"rejected"===a&&V.current)&&(V.current.pause(),V.current.currentTime=0,V.current=null),()=>{V.current&&(V.current.pause(),V.current.currentTime=0,V.current=null)}},[a]),r.useEffect(()=>(console.log("üîÑ useEffect for callState changed:",a),"connected"===a?(console.log('‚úÖ callState is "connected", connecting to LiveKit...'),q().catch(e=>{console.error("‚ùå Failed to connect to LiveKit in useEffect:",e)})):console.log('‚è≥ callState is not "connected", waiting... (current:',a,")"),()=>{console.log("üßπ Cleaning up LiveKit connection"),ae()}),[a,q,ae]),r.useEffect(()=>("connected"===a&&v?_.current=setInterval(()=>{d(e=>e+1)},1e3):(_.current&&(clearInterval(_.current),_.current=null),d(0)),()=>{_.current&&clearInterval(_.current)}),[a,v]),r.useEffect(()=>{var e;if(k&&$.current&&(null==(e=D.current)?void 0:e.localParticipant)){console.log("üé¨ [useEffect] isVideoEnabled changed, attempting to attach local video...");const e=Array.from(D.current.localParticipant.videoTrackPublications.values());if(console.log("üé¨ [useEffect] Found video track publications:",e.length),e.length>0){const t=e[0];if(t.track&&$.current)try{console.log("üé¨ [useEffect] Attaching local video track to element..."),t.track.attach($.current),console.log("‚úÖ [useEffect] Local video preview attached")}catch(a){console.error("‚ùå [useEffect] Error attaching local video:",a)}else console.warn("‚ö†Ô∏è [useEffect] Missing track or ref:",{hasTrack:!!t.track,hasRef:!!$.current})}else console.log("‚è≥ [useEffect] No video tracks yet, will retry when track is published")}},[k,v]),r.useEffect(()=>(m.connect({onCallSignal:a=>{"CALL_END"===a.eventType?(console.log("üìû CALL_END received in popup:",a),a.conversationId===e.conversationId&&(console.log("üìû CALL_END matches our call, showing rejection animation..."),o("rejected"),V.current&&(V.current.pause(),V.current.currentTime=0,V.current=null),setTimeout(()=>{console.log("üìû Closing popup after CALL_END animation"),window.close()},3e3))):"CALL_REJECT"===a.eventType&&(console.log("üìû CALL_REJECT received in popup:",a),a.conversationId===e.conversationId&&(console.log("üìû CALL_REJECT matches our call, showing rejection animation..."),o("rejected"),V.current&&(V.current.pause(),V.current.currentTime=0,V.current=null),setTimeout(()=>{te()},3e3)))},onConnect:()=>{console.log("WebSocket connected in popup")},onDisconnect:()=>{console.log("WebSocket disconnected in popup")},onError:e=>{console.error("WebSocket error in popup:",e)}}),()=>{m.disconnect()}),[e.conversationId,te]),r.useEffect(()=>{const e=e=>{var a;const t={name:"GlobalError",message:e.message||"Unknown error",filename:e.filename,lineno:e.lineno,colno:e.colno,stack:null==(a=e.error)?void 0:a.stack,timestamp:(new Date).toISOString(),location:"global"};if(console.error("‚ùå [GlobalError] Uncaught error:",t),O.current)try{O.current.postMessage({type:"CAMERA_ERROR",data:t})}catch(r){console.error("Failed to send global error:",r)}try{const e=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");e.push(t),e.length>10&&e.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(e))}catch(o){console.error("Failed to save global error:",o)}},a=e=>{var a,t;const r={name:"UnhandledPromiseRejection",message:(null==(a=e.reason)?void 0:a.message)||"Unhandled promise rejection",stack:null==(t=e.reason)?void 0:t.stack,timestamp:(new Date).toISOString(),location:"global"};if(console.error("‚ùå [GlobalError] Unhandled promise rejection:",r),O.current)try{O.current.postMessage({type:"CAMERA_ERROR",data:r})}catch(o){console.error("Failed to send promise rejection error:",o)}try{const e=JSON.parse(localStorage.getItem("svmessenger-camera-errors")||"[]");e.push(r),e.length>10&&e.shift(),localStorage.setItem("svmessenger-camera-errors",JSON.stringify(e))}catch(n){console.error("Failed to save promise rejection error:",n)}};return window.addEventListener("error",e),window.addEventListener("unhandledrejection",a),()=>{window.removeEventListener("error",e),window.removeEventListener("unhandledrejection",a)}},[]),r.useEffect(()=>(O.current=new BroadcastChannel("svmessenger-call"),O.current.onmessage=e=>{const{type:a,data:t}=e.data;switch(a){case"CALL_ENDED":console.log("üìû CALL_ENDED received via BroadcastChannel"),o("rejected"),V.current&&(V.current.pause(),V.current.currentTime=0,V.current=null),setTimeout(()=>{console.log("üìû Closing popup after CALL_ENDED animation"),window.close()},3e3);break;case"CALL_REJECTED":console.log("üìû CALL_REJECTED received via BroadcastChannel"),o("rejected"),V.current&&(V.current.pause(),V.current.currentTime=0,V.current=null),setTimeout(()=>{te()},3e3);break;case"CALL_ACCEPTED":console.log("‚úÖ CALL_ACCEPTED received via BroadcastChannel, changing callState to connected"),o("connected");break;case"MUTE_TOGGLED":h(t.isMuted);break;case"DEVICE_CHANGED":t.microphone&&(U.current=t.microphone,Z(t.microphone)),t.speaker&&(F.current=t.speaker,ee(t.speaker))}},()=>{O.current&&O.current.close()}),[te,Z,ee]),r.useEffect(()=>{const e=()=>{ae()};return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e)}},[ae]);const oe=r.useCallback(e=>{e.preventDefault(),P(!0);const a=e.currentTarget.getBoundingClientRect();R({x:e.clientX-a.left,y:e.clientY-a.top})},[]),ne=r.useCallback(e=>{if(!L)return;const a=document.querySelector(".call-window-video-layout");if(!a)return;const t=a.getBoundingClientRect();let r=e.clientX-t.left-I.x,o=e.clientY-t.top-I.y;r=Math.max(10,Math.min(r,t.width-160-10)),o=Math.max(10,Math.min(o,t.height-120-10)),S({x:r,y:o})},[L,I]),ce=r.useCallback(()=>{P(!1)},[]);return r.useEffect(()=>{if(L)return document.addEventListener("mousemove",ne),document.addEventListener("mouseup",ce),()=>{document.removeEventListener("mousemove",ne),document.removeEventListener("mouseup",ce)}},[L,ne,ce]),t.jsx(g,{callState:a,callDuration:s,formatDuration:e=>{const a=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},isMuted:p,isConnected:v,otherUserName:e.otherUserName,otherUserAvatar:e.otherUserAvatar,onMuteToggle:re,onEndCall:te,isVideoEnabled:k,remoteVideoVisible:b,localVideoRef:$,remoteVideoRef:B,onCameraToggle:Q,cameraPermissionDenied:E,isCameraLoading:T,pipPosition:x,isDragging:L,onPipMouseDown:oe})};console.log("üöÄ Call window popup opened");const h=new URLSearchParams(window.location.search),v={token:h.get("token"),roomName:h.get("roomName"),conversationId:h.get("conversationId"),otherUserId:h.get("otherUserId"),otherUserName:h.get("otherUserName"),otherUserAvatar:h.get("otherUserAvatar"),currentUserId:h.get("currentUserId"),currentUserName:h.get("currentUserName"),currentUserAvatar:h.get("currentUserAvatar"),callType:h.get("callType")||"voice",callState:h.get("callState")||"outgoing"};if(console.log("üìû Call window data:",{hasToken:!!v.token,tokenLength:(null==(e=v.token)?void 0:e.length)||0,roomName:v.roomName,conversationId:v.conversationId,callState:v.callState,otherUserId:v.otherUserId,currentUserId:v.currentUserId}),v.token&&v.roomName&&v.conversationId){console.log("‚úÖ All required data present, mounting React app");const e=document.getElementById("call-window-root");if(e){o(e).render(t.jsx(p,{callData:v})),console.log("‚úÖ React app mounted")}else console.error("‚ùå Container element not found!")}else console.error("‚ùå Missing required call data:",{hasToken:!!v.token,hasRoomName:!!v.roomName,hasConversationId:!!v.conversationId}),document.body.innerHTML='\n        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; gap: 20px;">\n            <h2>–ì—Ä–µ—à–∫–∞</h2>\n            <p>–õ–∏–ø—Å–≤–∞—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏ –¥–∞–Ω–Ω–∏ –∑–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.</p>\n            <button onclick="window.close()" style="padding: 10px 20px; cursor: pointer;">–ó–∞—Ç–≤–æ—Ä–∏</button>\n        </div>\n    ';
