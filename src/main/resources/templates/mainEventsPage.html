<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Събития - SmolyanVote</title>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Display&display=swap" rel="stylesheet">
  <div th:replace="~{fragments/topHtmlStyles :: navbarStyles}"></div>
  <link rel="stylesheet" href="/css/mainEventPage.css">
  <link rel="stylesheet" href="/css/eventSimpleCard.css">
  <link rel="stylesheet" href="/css/particles-background.css">
</head>
<body class="main-events-page">
<!-- Landscape Warning - Mobile Portrait Only -->


<!-- Навигация -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<!-- Hero секция -->
<section class="hero particles-background-wrapper" style="background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2)), url('/images/web/why.webp') no-repeat center -250px;">
  <div class="particles-background" data-particles-theme="white" data-particles-count="60"></div>
  <div class="container">
    <h1 class="display-4 fw-bold">Събития</h1>
    <p class="lead">
      Открийте или създайте събития, които оформят бъдещето на Смолян.<br>
      Търсете събития по ключова дума или потребител, за да намерите точно това, което ви интересува.<br>
      Използвайте филтри по категории, местоположение и статус, за да персонализирате избора си.<br>
      Участвайте активно, като гласувате в референдуми и анкети.<br>
      Създайте свои собствени събития и ангажирайте общността.<br>
      <strong>Важно!</strong> Преди да създадете ново събитие, проверете дали не съществува вече подобно такова.
    </p>
    <div class="create-event-buttons">
      <div th:if="${#authorization.expression('isAuthenticated()')}">
        <a th:href="@{/createNewEvent}" class="event-create-item" data-type="event">
          <span class="event-create-icon"><i class="bi bi-pencil-square"></i></span>
          <span class="event-create-content"><h6>Създай Опростен Вид Събитие</h6></span>
        </a>
        <a th:href="@{/referendum}" class="event-create-item" data-type="referendum">
          <span class="event-create-icon"><i class="bi bi-file-earmark-plus"></i></span>
          <span class="event-create-content"><h6>Създай Референдум</h6></span>
        </a>
        <a th:href="@{/multipoll/createMultiPoll}" class="event-create-item" data-type="poll">
          <span class="event-create-icon"><i class="bi bi-list-check"></i></span>
          <span class="event-create-content"><h6>Създай Анкета с Множествен Избор</h6></span>
        </a>
      </div>
      <div th:if="${#authorization.expression('!isAuthenticated()')}">
        <a href="javascript:void(0);" onclick="showLoginWarning()" class="event-create-item" data-type="event">
          <span class="event-create-icon"><i class="bi bi-pencil-square"></i></span>
          <span class="event-create-content"><h6>Създай Опростен Вид Събитие</h6></span>
        </a>
        <a href="javascript:void(0);" onclick="showLoginWarning()" class="event-create-item" data-type="referendum">
          <span class="event-create-icon"><i class="bi bi-file-earmark-plus"></i></span>
          <span class="event-create-content"><h6>Създай Референдум</h6></span>
        </a>
        <a href="javascript:void(0);" onclick="showLoginWarning()" class="event-create-item" data-type="poll">
          <span class="event-create-icon"><i class="bi bi-list-check"></i></span>
          <span class="event-create-content"><h6>Създай Анкета с Множествен Избор</h6></span>
        </a>
      </div>
    </div>
  </div>
</section>

    <!-- Статистики и аналитика (компактни) -->
    <section class="statistics-section py-2" th:if="${statistics != null}">
      <div class="container">
        <div class="row g-2">
          <div class="col-6 col-md-3">
            <div class="stat-card-compact">
              <div class="stat-icon-compact"><i class="bi bi-calendar-event"></i></div>
              <div class="stat-value-compact" th:text="${statistics.totalEvents}">0</div>
              <div class="stat-label-compact">Общо</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stat-card-compact">
              <div class="stat-icon-compact"><i class="bi bi-check-circle"></i></div>
              <div class="stat-value-compact" th:text="${statistics.totalActive}">0</div>
              <div class="stat-label-compact">Активни</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stat-card-compact">
              <div class="stat-icon-compact"><i class="bi bi-clock-history"></i></div>
              <div class="stat-value-compact" th:text="${statistics.totalRecent}">0</div>
              <div class="stat-label-compact">7 дни</div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="stat-card-compact">
              <div class="stat-icon-compact"><i class="bi bi-calendar-month"></i></div>
              <div class="stat-value-compact" th:text="${statistics.totalMonthly}">0</div>
              <div class="stat-label-compact">Месец</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Mobile Filters Toggle Button -->
    <div class="mobile-filters-toggle d-md-none mb-3">
      <button class="btn btn-primary w-100" type="button" onclick="toggleMobileFilters()">
        <i class="bi bi-funnel me-2"></i>
        Филтри
        <span class="badge bg-light text-dark ms-2" id="activeFiltersCount" th:if="${hasActiveFilters}" th:text="${(currentSearch != null ? 1 : 0) + (currentLocation != null ? 1 : 0) + (currentType != null ? 1 : 0) + (currentStatus != null ? 1 : 0) + (currentDatePeriod != null ? 1 : 0) + (currentPopularity != null ? 1 : 0)}">0</span>
      </button>
    </div>

    <!-- Секция за търсене и филтри -->
  <section class="search-section">
    <div class="container">
      <!-- Mobile Filters Sidebar -->
      <div class="mobile-filters-sidebar" id="mobileFiltersSidebar">
        <div class="mobile-filters-header">
          <h5>Филтри</h5>
          <button class="btn-close" onclick="toggleMobileFilters()" aria-label="Close"></button>
        </div>
        <div class="mobile-filters-content">
          <!-- Тук ще копираме филтрите от основната форма -->
        </div>
        <div class="mobile-filters-footer">
          <button class="btn btn-secondary" onclick="clearMobileFilters()">Изчисти</button>
          <button class="btn btn-primary" onclick="applyMobileFilters()">Приложи</button>
        </div>
      </div>
      <div class="mobile-filters-overlay" id="mobileFiltersOverlay" onclick="toggleMobileFilters()"></div>
      <!-- Бързи филтри (Quick Filters) -->
      <div class="quick-filters mb-3" th:if="${#authorization.expression('isAuthenticated()')}">
        <div class="quick-filters-label">
          <i class="bi bi-lightning-charge me-2"></i>
          <span>Бързи филтри:</span>
        </div>
        <div class="quick-filters-buttons">
          <a th:href="@{/mainEvents(quickFilter='my-events')}" 
             class="quick-filter-btn" 
             th:classappend="${currentQuickFilter == 'my-events'} ? 'active'">
            <i class="bi bi-person-circle me-1"></i>
            Моите събития
          </a>
          <a th:href="@{/mainEvents(quickFilter='following')}" 
             class="quick-filter-btn"
             th:classappend="${currentQuickFilter == 'following'} ? 'active'">
            <i class="bi bi-people me-1"></i>
            Следвани автори
          </a>
          <a th:href="@{/mainEvents(quickFilter='not-voted')}" 
             class="quick-filter-btn"
             th:classappend="${currentQuickFilter == 'not-voted'} ? 'active'">
            <i class="bi bi-circle me-1"></i>
            Не съм гласувал
          </a>
          <a th:href="@{/mainEvents(quickFilter='voted')}" 
             class="quick-filter-btn"
             th:classappend="${currentQuickFilter == 'voted'} ? 'active'">
            <i class="bi bi-check-circle me-1"></i>
            Гласувал съм
          </a>
          <a th:href="@{/mainEvents(quickFilter='new-events')}" 
             class="quick-filter-btn"
             th:classappend="${currentQuickFilter == 'new-events'} ? 'active'">
            <i class="bi bi-clock-history me-1"></i>
            Нови събития
          </a>
        </div>
      </div>

      <!-- Показване на информация за резултатите -->
      <div class="results-info mb-3" th:if="${not events.isEmpty()}">
        <p class="text-muted mb-0">
          Показани <strong th:text="${startResult ?: 0}">0</strong>-<strong th:text="${endResult ?: 0}">0</strong>
          от общо <strong th:text="${totalElements ?: 0}">0</strong> събития
          <span th:if="${hasActiveFilters}" class="ms-2">
            <i class="bi bi-funnel-fill text-primary"></i>
            <small>Филтрирани резултати</small>
          </span>
        </p>
      </div>

    <div class="search-filter-container">
      <form id="searchForm" th:action="@{/mainEvents}" method="get">
        <div class="filter-sort-group">
          <!-- Търсене -->
          <div class="search-bar">
            <input type="text" id="eventSearch" name="search"
                   th:value="${currentSearch}"
                   placeholder="Търси по думи или автор..."
                   aria-label="Търси събития"
                   autocomplete="off"
                   maxlength="100">
            <button type="submit" class="search-button" aria-label="Търси">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--medium-gray)" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </button>
          </div>

          <!-- Филтър по локация -->
          <div class="filter-dropdown">
            <select name="location" id="eventLocationFilter" onchange="resetPageAndSubmit()">
              <option value="" th:selected="${currentLocation == null}">Всички локации</option>
              <option th:each="location : ${T(smolyanVote.smolyanVote.models.enums.Locations).values()}"
                      th:value="${location.name()}"
                      th:text="${location.toBG()}"
                      th:selected="${currentLocation != null and currentLocation.toUpperCase() == location.name()}"></option>
            </select>
          </div>

          <!-- Филтър по тип събитие -->
          <div class="filter-dropdown">
            <select name="type" id="eventTypeFilter" onchange="resetPageAndSubmit()">
              <option value="" th:selected="${currentType == null}">Всички видове</option>
              <option value="event" th:selected="${currentType == 'event'}">Опростен вид събития</option>
              <option value="referendum" th:selected="${currentType == 'referendum'}">Референдум</option>
              <option value="poll" th:selected="${currentType == 'poll'}">Анкета с множествен избор</option>
            </select>
          </div>

          <!-- Филтър по статус -->
          <div class="filter-dropdown">
            <select name="status" id="eventStatusFilter" onchange="resetPageAndSubmit()">
              <option value="" th:selected="${currentStatus == null}">Всички статуси</option>
              <option value="active" th:selected="${currentStatus == 'active'}">Активен</option>
              <option value="inactive" th:selected="${currentStatus == 'inactive'}">Неактивен</option>
            </select>
          </div>

          <!-- Филтър по времеви период -->
          <div class="filter-dropdown">
            <select name="datePeriod" id="eventDatePeriodFilter" onchange="resetPageAndSubmit()">
              <option value="" th:selected="${currentDatePeriod == null}">Всички периоди</option>
              <option value="last-7-days" th:selected="${currentDatePeriod == 'last-7-days'}">Последни 7 дни</option>
              <option value="last-month" th:selected="${currentDatePeriod == 'last-month'}">Последен месец</option>
              <option value="last-year" th:selected="${currentDatePeriod == 'last-year'}">Последна година</option>
            </select>
          </div>

          <!-- Филтър по популярност -->
          <div class="filter-dropdown">
            <select name="popularity" id="eventPopularityFilter" onchange="resetPageAndSubmit()">
              <option value="" th:selected="${currentPopularity == null}">Всички</option>
              <option value="most-voted" th:selected="${currentPopularity == 'most-voted'}">Най-гласувани</option>
              <option value="most-viewed" th:selected="${currentPopularity == 'most-viewed'}">Най-преглеждани</option>
              <option value="most-commented" th:selected="${currentPopularity == 'most-commented'}">Най-коментирани</option>
            </select>
          </div>


          <!-- Сортиране -->
          <div class="filter-dropdown">
            <select name="sort" id="eventSort" onchange="resetPageAndSubmit()">
              <option value="" th:selected="${currentSort == null}">Сортирай по</option>
              <option value="date-desc" th:selected="${currentSort == 'date-desc'}">Най-нови</option>
              <option value="date-asc" th:selected="${currentSort == 'date-asc'}">Най-стари</option>
              <option value="popularity" th:selected="${currentSort == 'popularity'}">Популярност</option>
              <option value="name" th:selected="${currentSort == 'name'}">Име (А-Я)</option>
            </select>
          </div>

          <!-- Бутони за управление на филтрите -->
          <div class="filter-actions d-flex gap-2">
            <button type="button" class="btn btn-outline-primary" 
                    onclick="shareFiltersLink()" 
                    title="Сподели линк с текущите филтри">
              <i class="bi bi-share me-1"></i>
              Сподели
            </button>
            <a th:href="@{/mainEvents(reset=true)}" class="btn btn-outline-secondary"
               th:title="'Изчисти всички филтри'"
               onclick="return handleFilterReset(event)">
              <i class="bi bi-arrow-clockwise me-1"></i>
              Изчисти филтри
            </a>
          </div>
        </div>

        <!-- Скрити полета за запазване на текущата страница при търсене -->
        <input type="hidden" name="page" id="hiddenPage" th:value="${currentPage ?: 0}"/>
        <input type="hidden" name="size" th:value="${size ?: 6}"/>
        <!-- Запазване на новите филтри при търсене -->
        <input type="hidden" name="datePeriod" th:if="${currentDatePeriod != null}" th:value="${currentDatePeriod}"/>
        <input type="hidden" name="popularity" th:if="${currentPopularity != null}" th:value="${currentPopularity}"/>
      </form>
    </div>

    <!-- Активни филтри -->
    <div class="active-filters mt-3" th:if="${hasActiveFilters}">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <span class="text-muted small">Активни филтри:</span>

        <span th:if="${currentSearch != null}" class="badge bg-primary rounded-pill">
          <i class="bi bi-search me-1"></i>
          <span th:text="'&quot;' + ${currentSearch} + '&quot;'">търсене</span>
          <a th:href="@{/mainEvents(location=${currentLocation}, type=${currentType}, status=${currentStatus}, sort=${currentSort}, datePeriod=${currentDatePeriod}, popularity=${currentPopularity})}"
             class="text-white ms-1" style="text-decoration: none;">×</a>
        </span>

        <span th:if="${currentLocation != null}" class="badge bg-success rounded-pill">
          <i class="bi bi-geo-alt me-1"></i>
          <span th:text="${T(smolyanVote.smolyanVote.models.enums.Locations).valueOf(currentLocation.toUpperCase()).toBG()}">локация</span>
          <a th:href="@{/mainEvents(search=${currentSearch}, type=${currentType}, status=${currentStatus}, sort=${currentSort}, datePeriod=${currentDatePeriod}, popularity=${currentPopularity})}"
             class="text-white ms-1" style="text-decoration: none;">×</a>
        </span>

        <span th:if="${currentType != null}" class="badge bg-info rounded-pill">
          <i class="bi bi-tag me-1"></i>
          <span th:text="${currentType == 'event' ? 'Опростен вид Събитие' : (currentType == 'referendum' ? 'Референдум' : 'Множествена Анкета')}">тип</span>
          <a th:href="@{/mainEvents(search=${currentSearch}, location=${currentLocation}, status=${currentStatus}, sort=${currentSort}, datePeriod=${currentDatePeriod}, popularity=${currentPopularity})}"
             class="text-white ms-1" style="text-decoration: none;">×</a>
        </span>

        <span th:if="${currentStatus != null}" class="badge bg-warning rounded-pill">
          <i class="bi bi-circle-fill me-1"></i>
          <span th:text="${currentStatus == 'active' ? 'Активен' : 'Неактивен'}">статус</span>
          <a th:href="@{/mainEvents(search=${currentSearch}, location=${currentLocation}, type=${currentType}, sort=${currentSort}, datePeriod=${currentDatePeriod}, popularity=${currentPopularity})}"
             class="text-white ms-1" style="text-decoration: none;">×</a>
        </span>

        <span th:if="${currentDatePeriod != null}" class="badge bg-secondary rounded-pill">
          <i class="bi bi-calendar me-1"></i>
          <span th:text="${currentDatePeriod == 'last-7-days' ? 'Последни 7 дни' : (currentDatePeriod == 'last-month' ? 'Последен месец' : 'Последна година')}">период</span>
          <a th:href="@{/mainEvents(search=${currentSearch}, location=${currentLocation}, type=${currentType}, status=${currentStatus}, sort=${currentSort}, popularity=${currentPopularity})}"
             class="text-white ms-1" style="text-decoration: none;">×</a>
        </span>

        <span th:if="${currentPopularity != null}" class="badge bg-danger rounded-pill">
          <i class="bi bi-star me-1"></i>
          <span th:text="${currentPopularity == 'most-voted' ? 'Най-гласувани' : (currentPopularity == 'most-viewed' ? 'Най-преглеждани' : 'Най-коментирани')}">популярност</span>
          <a th:href="@{/mainEvents(search=${currentSearch}, location=${currentLocation}, type=${currentType}, status=${currentStatus}, sort=${currentSort}, datePeriod=${currentDatePeriod})}"
             class="text-white ms-1" style="text-decoration: none;">×</a>
        </span>

      </div>
    </div>
  </div>
</section>

<!-- Препоръчани събития - Collapsible Panel -->
<section class="recommended-section-collapsible mb-3" th:if="${recommendedEvents != null and !recommendedEvents.isEmpty()}">
  <div class="container">
    <div class="recommended-panel">
      <button class="recommended-panel-header" type="button" onclick="toggleRecommendedPanel()">
        <div class="d-flex align-items-center justify-content-between w-100">
          <div class="d-flex align-items-center">
            <i class="bi bi-star-fill text-warning me-2"></i>
            <span class="fw-bold">Препоръчани за теб</span>
            <span class="badge bg-warning text-dark ms-2" th:text="${recommendedEvents.size()}">0</span>
          </div>
          <i class="bi bi-chevron-down recommended-chevron"></i>
        </div>
      </button>
      <div class="recommended-panel-content" id="recommendedPanelContent">
        <div class="row g-2 mt-2">
          <div class="col-lg-3 col-md-4 col-sm-6 mb-2" th:each="event : ${recommendedEvents}">
            <div th:replace="~{fragments/simpleEventView :: simple-event(event=${event})}"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Събития -->
<section class="event-container py-5">
  <div class="container">
    <!-- View Toggle -->
    <div class="view-controls mb-4 d-flex justify-content-start align-items-center gap-3">
      <div class="view-toggle-group d-flex align-items-center gap-2">
        <span class="text-muted small">Изглед:</span>
        <div class="btn-group" role="group">
          <input type="radio" class="btn-check" name="viewMode" id="viewGrid" value="grid" 
                 th:checked="${viewMode == null or viewMode == 'grid'}" onchange="changeViewMode('grid')">
          <label class="btn btn-outline-primary" for="viewGrid" title="Grid изглед">
            <i class="bi bi-grid-3x3-gap"></i>
          </label>
          <input type="radio" class="btn-check" name="viewMode" id="viewList" value="list" 
                 th:checked="${viewMode == 'list'}" onchange="changeViewMode('list')">
          <label class="btn btn-outline-primary" for="viewList" title="List изглед">
            <i class="bi bi-list-ul"></i>
          </label>
        </div>
      </div>
    </div>

    <!-- Съобщение за грешка -->
    <div class="alert alert-danger" role="alert" th:if="${error}">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <span th:text="${error}">Грешка</span>
    </div>

    <!-- Съобщение при липса на резултати -->
    <div class="text-center py-5" th:if="${events.isEmpty() and error == null}">
      <div class="mb-4">
        <i class="bi bi-search display-1 text-muted"></i>
      </div>
      <h3 class="text-muted" th:text="${noResultsMessage ?: 'Няма намерени събития'}">Няма намерени събития</h3>
      <div th:if="${hasActiveFilters}" class="mt-3">
        <a th:href="@{/mainEvents}" class="btn btn-primary">
          <i class="bi bi-arrow-clockwise me-2"></i>
          Покажи всички събития
        </a>
      </div>
    </div>

    <!-- Списък със събития - Grid изглед -->
    <div class="events-grid row" id="eventsGrid" th:if="${not events.isEmpty()}" 
         th:classappend="${viewMode == 'list'} ? 'd-none' : ''">
      <div class="col-lg-3 col-md-4 col-sm-6 mb-3" th:each="event : ${events.content}">
        <div th:replace="~{fragments/simpleEventView :: simple-event(event=${event})}"></div>
      </div>
    </div>

    <!-- Списък със събития - List изглед -->
    <div class="events-list" id="eventsList" th:if="${not events.isEmpty()}" 
         th:classappend="${viewMode != 'list'} ? 'd-none' : ''">
      <div class="event-list-item mb-3" th:each="event : ${events.content}">
        <div th:replace="~{fragments/simpleEventView :: simple-event(event=${event})}"></div>
      </div>
    </div>

    <!-- Подобрена пагинация -->
    <nav aria-label="Пагинация" th:if="${not events.isEmpty() and totalPages > 1}">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="pagination-info">
          <small class="text-muted">
            Страница <strong th:text="${currentPage + 1}">1</strong> от <strong th:text="${totalPages}">1</strong>
          </small>
        </div>

        <!-- Избор на размер на страницата -->
        <div class="page-size-selector">
          <label for="pageSizeSelect" class="form-label small text-muted mb-0 me-2">Събития на страница:</label>
          <select id="pageSizeSelect" class="form-select form-select-sm" style="width: auto;" onchange="changePageSize(this.value)">
            <option value="8" th:selected="${size == 8}">8</option>
            <option value="16" th:selected="${size == 16}">16</option>
            <option value="32" th:selected="${size == 32}">32</option>
            <option value="64" th:selected="${size == 64}">64</option>
          </select>
        </div>
      </div>

      <ul class="pagination justify-content-center">
        <!-- Първа страница -->
        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
          <a class="page-link" th:href="@{/mainEvents(page=0, size=${size}, search=${currentSearch}, location=${currentLocation}, type=${currentType}, status=${currentStatus}, sort=${currentSort})}"
             aria-label="Първа страница" th:title="'Първа страница'">
            «
          </a>
        </li>

        <!-- Предишна страница -->
        <li class="page-item" th:classappend="${not hasPreviousPage} ? 'disabled'">
          <a class="page-link" th:href="@{/mainEvents(page=${currentPage - 1}, size=${size}, search=${currentSearch}, location=${currentLocation}, type=${currentType}, status=${currentStatus}, sort=${currentSort})}"
             aria-label="Предишна страница" th:title="'Предишна страница'">
            ‹
          </a>
        </li>

        <!-- Страници -->
        <th:block th:if="${startPage != null and endPage != null and startPage <= endPage}">
          <li class="page-item" th:each="pageNumber : ${#numbers.sequence(startPage, endPage)}"
              th:classappend="${pageNumber == currentPage} ? 'active'">
            <a class="page-link"
               th:href="@{/mainEvents(page=${pageNumber}, size=${size}, search=${currentSearch}, location=${currentLocation}, type=${currentType}, status=${currentStatus}, sort=${currentSort})}"
               th:text="${pageNumber + 1}"
               th:title="'Страница ' + ${pageNumber + 1}">1</a>
          </li>
        </th:block>

        <!-- Следваща страница -->
        <li class="page-item" th:classappend="${not hasNextPage} ? 'disabled'">
          <a class="page-link" th:href="@{/mainEvents(page=${currentPage + 1}, size=${size}, search=${currentSearch}, location=${currentLocation}, type=${currentType}, status=${currentStatus}, sort=${currentSort})}"
             aria-label="Следваща страница" th:title="'Следваща страница'">
            ›
          </a>
        </li>

        <!-- Последна страница -->
        <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
          <a class="page-link" th:href="@{/mainEvents(page=${totalPages - 1}, size=${size}, search=${currentSearch}, location=${currentLocation}, type=${currentType}, status=${currentStatus}, sort=${currentSort})}"
             aria-label="Последна страница" th:title="'Последна страница'">
            »
          </a>
        </li>
      </ul>
    </nav>
  </div>
</section>


<!-- Loading overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Зареждане...</span>
  </div>
</div>

<!-- Футър -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- JavaScript за модала -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Отваряне на модала
    document.querySelectorAll('.delete-btn').forEach(button => {
      button.addEventListener('click', () => {
        const modalId = button.getAttribute('data-modal-id');
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = 'flex';
          setTimeout(() => {
            modal.classList.add('active');
          }, 10);
          modal.setAttribute('aria-hidden', 'false');
          document.body.style.overflow = 'hidden';
        }
      });
    });

    // Затваряне на модала
    document.querySelectorAll('.custom-modal-close, .custom-btn-secondary').forEach(element => {
      element.addEventListener('click', () => {
        const modalId = element.getAttribute('data-modal-id');
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.remove('active');
          setTimeout(() => {
            modal.style.display = 'none';
          }, 300);
          modal.setAttribute('aria-hidden', 'true');
          document.body.style.overflow = '';
        }
      });
    });

    // Затваряне при клик извън модала
    document.querySelectorAll('.custom-modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
          setTimeout(() => {
            modal.style.display = 'none';
          }, 300);
          modal.setAttribute('aria-hidden', 'true');
          document.body.style.overflow = '';
        }
      });
    });
  });
</script>
<!-- Custom JavaScript -->
<script src="/js/mainEvent/uiUtils.js"></script>
<script src="/js/mainEvent/filterManager.js"></script>
<script src="/js/mainEvent/searchAutocomplete.js"></script>
<script src="/js/mainEvent/progressBars.js"></script>
<script src="/js/mainEvent/customDropdowns.js"></script>
<script src="/js/mainEvent/searchAndFilters.js"></script>
<script src="/js/mainEvent/mainEventsPage.js"></script>
<!-- JS библиотеки -->
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<script src="/js/utils/particles-background.js"></script>
<div th:replace="~{fragments/bottomHtmlStyles :: bottomStyles}"></div>
<!-- Допълнителна инициализация на аватари за събития -->
<script>
    (function() {
        // Функция за инициализация на placeholder аватари
        function initializePlaceholderAvatars() {
            const placeholders = document.querySelectorAll('.author-avatar.avatar-placeholder');
            
            placeholders.forEach(placeholder => {
                // Проверяваме дали вече е инициализиран
                if (placeholder.dataset.avatarInitialized === 'true') {
                    return;
                }
                
                // Вземаме username от data-username атрибута
                const username = placeholder.getAttribute('data-username') || 
                                placeholder.dataset.username || 
                                'User';
                
                // Маркираме като инициализиран
                placeholder.dataset.avatarInitialized = 'true';
                
                // Генерира инициали и цвят
                if (window.avatarUtils) {
                    const initials = window.avatarUtils.getInitials(username);
                    const color = window.avatarUtils.getAvatarColor(username);
                    
                    placeholder.textContent = initials;
                    placeholder.style.backgroundColor = color;
                    placeholder.style.color = '#ffffff';
                    placeholder.style.fontWeight = '700';
                    placeholder.style.fontSize = '14px';
                    placeholder.style.display = 'flex';
                    placeholder.style.alignItems = 'center';
                    placeholder.style.justifyContent = 'center';
                    placeholder.style.textTransform = 'uppercase';
                }
            });
        }
        
        // Инициализация при зареждане на DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(initializePlaceholderAvatars, 100);
                setTimeout(initializePlaceholderAvatars, 500);
                setTimeout(initializePlaceholderAvatars, 1000);
            });
        } else {
            // DOM вече е зареден
            setTimeout(initializePlaceholderAvatars, 100);
            setTimeout(initializePlaceholderAvatars, 500);
            setTimeout(initializePlaceholderAvatars, 1000);
        }
        
        // Също така използваме avatarUtils инициализацията
        if (window.avatarUtils) {
            setTimeout(() => {
                window.avatarUtils.initializeAllAvatars();
            }, 300);
        }
    })();
</script>


<script>
// View Mode Management
(function() {
    // Зареждане на viewMode от localStorage или URL параметър
    const urlParams = new URLSearchParams(window.location.search);
    const viewModeFromUrl = urlParams.get('viewMode');
    const viewModeFromStorage = localStorage.getItem('eventsViewMode');
    const currentViewMode = viewModeFromUrl || viewModeFromStorage || 'grid';
    
    // Прилагане на изгледа при зареждане
    if (currentViewMode === 'list') {
        document.getElementById('eventsGrid')?.classList.add('d-none');
        document.getElementById('eventsList')?.classList.remove('d-none');
        document.getElementById('viewList')?.setAttribute('checked', 'checked');
    }
    
    // Функция за промяна на view mode
    window.changeViewMode = function(mode) {
        const gridView = document.getElementById('eventsGrid');
        const listView = document.getElementById('eventsList');
        
        if (mode === 'list') {
            gridView?.classList.add('d-none');
            listView?.classList.remove('d-none');
        } else {
            gridView?.classList.remove('d-none');
            listView?.classList.add('d-none');
        }
        
        // Запазване в localStorage
        localStorage.setItem('eventsViewMode', mode);
        
        // Запазване в предпочитанията
        if (window.filterManager) {
            const preferences = window.filterManager.getPreferences();
            preferences.viewMode = mode;
            window.filterManager.savePreferences(preferences);
        }
        
        // Обновяване на URL без презареждане
        const url = new URL(window.location);
        url.searchParams.set('viewMode', mode);
        window.history.pushState({}, '', url);
        
        // Обновяване на филтрите в URL
        if (window.filterManager) {
            window.filterManager.updateURL(null, { keepPage: true });
        }
    };
    
})();

// Функция за споделяне на линк с филтри
async function shareFiltersLink() {
    if (!window.filterManager) {
        showErrorMessage('Системата за управление на филтрите не е заредена.');
        return;
    }
    
    try {
        const success = await window.filterManager.copyShareableLink();
        if (success) {
            showSuccessMessage('Линкът с филтрите е копиран в клипборда! Можете да го споделите.');
        } else {
            // Fallback - показване на линка в диалог
            const link = window.filterManager.getShareableLink();
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'info',
                    title: 'Сподели линк',
                    html: `
                        <p>Копирайте този линк:</p>
                        <input type="text" class="form-control" value="${link}" readonly onclick="this.select()">
                    `,
                    confirmButtonText: 'Затвори'
                });
            } else {
                prompt('Копирайте този линк:', link);
            }
        }
    } catch (error) {
        console.error('Error sharing link:', error);
        showErrorMessage('Възникна грешка при копирането на линка.');
    }
}

// Функция за обработка на reset на филтрите
function handleFilterReset(event) {
    event.preventDefault();
    
    showConfirmDialog(
        'Изчистване на филтри',
        'Сигурни ли сте, че искате да изчистите всички филтри?',
        () => {
            if (window.filterManager) {
                window.filterManager.clearAllFilters();
            }
            window.location.href = event.target.href;
        }
    );
    
    return false;
}


// Recommended Panel Toggle Function
function toggleRecommendedPanel() {
    const panelContent = document.getElementById('recommendedPanelContent');
    const panelHeader = document.querySelector('.recommended-panel-header');
    
    if (panelContent && panelHeader) {
        const isExpanded = panelContent.classList.contains('expanded');
        
        if (isExpanded) {
            panelContent.classList.remove('expanded');
            panelHeader.classList.remove('active');
        } else {
            panelContent.classList.add('expanded');
            panelHeader.classList.add('active');
        }
    }
}

// Mobile Filters Functions
function toggleMobileFilters() {
    const sidebar = document.getElementById('mobileFiltersSidebar');
    const overlay = document.getElementById('mobileFiltersOverlay');
    
    if (sidebar && overlay) {
        const isOpen = sidebar.classList.contains('open');
        
        if (isOpen) {
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
        } else {
            // Копираме филтрите в sidebar
            copyFiltersToSidebar();
            sidebar.classList.add('open');
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
    }
}

function copyFiltersToSidebar() {
    const mainFilters = document.querySelectorAll('.filter-sort-group .filter-dropdown');
    const sidebarContent = document.querySelector('.mobile-filters-content');
    
    if (!sidebarContent) return;
    
    sidebarContent.innerHTML = '';
    
    mainFilters.forEach(filter => {
        const cloned = filter.cloneNode(true);
        cloned.querySelector('select').removeAttribute('onchange');
        sidebarContent.appendChild(cloned);
    });
}

function applyMobileFilters() {
    const sidebar = document.getElementById('mobileFiltersSidebar');
    const form = document.getElementById('searchForm');
    
    if (!form || !sidebar) return;
    
    // Копираме стойностите от sidebar към основната форма
    const sidebarSelects = sidebar.querySelectorAll('select');
    sidebarSelects.forEach(sidebarSelect => {
        const name = sidebarSelect.name;
        const mainSelect = form.querySelector(`select[name="${name}"]`);
        if (mainSelect) {
            mainSelect.value = sidebarSelect.value;
        }
    });
    
    // Затваряме sidebar
    toggleMobileFilters();
    
    // Submit формата
    if (window.filterManager) {
        window.filterManager.updateURL(null, { resetPage: true });
    }
    form.submit();
}

function clearMobileFilters() {
    const sidebar = document.getElementById('mobileFiltersSidebar');
    if (!sidebar) return;
    
    const selects = sidebar.querySelectorAll('select');
    selects.forEach(select => {
        select.value = '';
    });
}

// Event Title Tooltip Functionality
document.addEventListener('DOMContentLoaded', function() {
    initEventTitleTooltips();
});

function initEventTitleTooltips() {
    const titles = document.querySelectorAll('.card-title[data-full-title]');
    
    titles.forEach(title => {
        // Проверяваме дали текстът е truncated
        const isTruncated = title.scrollHeight > title.clientHeight;
        
        if (!isTruncated) {
            // Ако не е truncated, не показваме tooltip
            title.style.cursor = 'default';
            return;
        }
        
        // Създаваме tooltip елемент
        const tooltip = document.createElement('div');
        tooltip.className = 'event-title-tooltip';
        tooltip.textContent = title.getAttribute('data-full-title');
        document.body.appendChild(tooltip);
        
        // Показваме tooltip при hover
        title.addEventListener('mouseenter', function(e) {
            const rect = title.getBoundingClientRect();
            tooltip.style.display = 'block';
            
            // Позициониране на tooltip
            const tooltipRect = tooltip.getBoundingClientRect();
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            let top = rect.bottom + 10;
            
            // Проверка дали tooltip излиза извън екрана от дясно
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            
            // Проверка дали tooltip излиза извън екрана от ляво
            if (left < 10) {
                left = 10;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            
            // Анимация
            setTimeout(() => {
                tooltip.classList.add('show');
            }, 10);
        });
        
        title.addEventListener('mouseleave', function() {
            tooltip.classList.remove('show');
            setTimeout(() => {
                tooltip.style.display = 'none';
            }, 300);
        });
    });
}

</script>

</body>
</html>