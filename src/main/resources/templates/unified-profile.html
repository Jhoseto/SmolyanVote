<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${isOwnProfile} ? '–ú–æ—è—Ç –ø—Ä–æ—Ñ–∏–ª' : ${user.username} + ' - –ü—Ä–æ—Ñ–∏–ª'">–ü—Ä–æ—Ñ–∏–ª</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Existing Thymeleaf fragments -->
    <div th:replace="~{fragments/topHtmlStyles :: navbarStyles}"></div>
    <!-- Custom Styles -->
    <link rel="stylesheet" href="/css/userProfile.css">
</head>
<body>

<!-- Navigation -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<!-- HERO SECTION -->
<div class="profile-hero" id="profileHero">
    <!-- Animated Background -->
    <div class="hero-background">
        <div class="gradient-overlay"></div>
        <div class="floating-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
        </div>
    </div>

    <!-- Profile Header Card -->
    <div class="container">
        <div class="profile-header-card glass-card">
            <!-- Avatar Section -->
            <div class="avatar-section">
                <div class="avatar-container">
                    <div class="user-avatar profile-avatar avatar-placeholder"
                         th:attr="data-user-image=${user.imageUrl},data-username=${user.username}">
                    </div>
                    <div class="online-indicator" th:classappend="${user.onlineStatus == 1} ? 'online' : 'offline'"></div>
                </div>
            </div>

            <!-- User Info Section -->
            <div class="user-info-section" th:attr="data-user-id=${user.id}">
                <div class="name-and-role">
                    <h1 class="username" th:text="${user.username}">Username</h1>
                    <div class="role-badge" th:classappend="${user.role.name()}">
                        <i class="bi bi-shield-check" th:if="${user.role.name() == 'ADMIN'}"></i>
                        <i class="bi bi-person" th:if="${user.role.name() == 'USER'}"></i>
                        <span th:text="${user.role.name() == 'ADMIN'} ? '–ê–¥–º–∏–Ω' : '–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª'">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª</span>
                    </div>
                </div>

                <div class="bio-section" th:if="${user.bio != null and !user.bio.isEmpty()}">
                    <p class="user-bio" th:text="${user.bio}">–ë–∏–æ–≥—Ä–∞—Ñ–∏—è –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è</p>
                </div>

                <!-- meta-info —Å–µ–∫—Ü–∏—è—Ç–∞ - –ü–†–ê–í–ò–õ–ï–ù –ü–û–î–•–û–î -->
                <div class="meta-info">
                    <div class="info-item" th:if="${user.location != null}">
                        <i class="bi bi-geo-alt"></i>
                        <span th:text="${user.location.toBG()}">–õ–æ–∫–∞—Ü–∏—è</span>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-calendar-plus"></i>
                        <span th:text="${user.created != null ? '–ß–ª–µ–Ω –æ—Ç ' + #dates.format(user.created, 'MM.yyyy') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ –¥–∞—Ç–∞'}">–ß–ª–µ–Ω –æ—Ç</span>
                    </div>
                    <div class="info-item">
                        <i class="bi bi-clock"></i>
                        <span th:text="${user.lastOnline != null ? '–ü–æ—Å–ª–µ–¥–Ω–æ –æ–Ω–ª–∞–π–Ω ' + #dates.format(user.lastOnline, 'dd.MM.yyyy HH:mm') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}">–ü–æ—Å–ª–µ–¥–Ω–æ –æ–Ω–ª–∞–π–Ω</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons Section -->
            <div class="action-buttons">
                <!-- Own Profile Actions -->
                <div th:if="${isOwnProfile}" class="own-profile-actions">
                    <button class="btn btn-primary action-btn edit-profile-btn" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                        <i class="bi bi-pencil-square"></i>
                        <span>–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ø—Ä–æ—Ñ–∏–ª</span>
                    </button>
                    <button class="btn btn-outline-secondary action-btn settings-btn">
                        <i class="bi bi-gear"></i>
                        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </button>
                </div>

                <!-- Other Profile Actions -->
                <div th:unless="${isOwnProfile}" class="other-profile-actions">
                    <button class="btn btn-primary action-btn follow-btn" data-action="follow" th:attr="data-user-id=${user.id}">
                        <i class="bi bi-person-plus"></i>
                        <span>–°–ª–µ–¥–≤–∞–π</span>
                    </button>
                    <button class="btn btn-outline-secondary action-btn message-btn">
                        <i class="bi bi-chat-dots"></i>
                        <span>–°—ä–æ–±—â–µ–Ω–∏–µ</span>
                    </button>
                    <div class="dropdown d-inline-block">
                        <button class="btn btn-outline-secondary action-btn dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="bi bi-flag"></i> –î–æ–∫–ª–∞–¥–≤–∞–π</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- STATISTICS DASHBOARD -->
<div class="statistics-section">
    <div class="container">
        <div class="stats-grid">
            <div class="stat-card glass-card" data-stat="events">
                <div class="stat-icon">
                    <i class="bi bi-calendar-event"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" th:text="${user.userEventsCount ?: 0}">0</div>
                    <div class="stat-label">–°—ä–±–∏—Ç–∏—è</div>
                </div>
            </div>

            <div class="stat-card glass-card" data-stat="votes">
                <div class="stat-icon">
                    <i class="bi bi-hand-thumbs-up"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" th:text="${user.totalVotes ?: 0}">0</div>
                    <div class="stat-label">–ì–ª–∞—Å–æ–≤–µ</div>
                </div>
            </div>

            <div class="stat-card glass-card" data-stat="publications">
                <div class="stat-icon">
                    <i class="bi bi-file-text"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" th:text="${user.publicationsCount ?: 0}">0</div>
                    <div class="stat-label">–ü—É–±–ª–∏–∫–∞—Ü–∏–∏</div>
                </div>
            </div>

            <div class="stat-card glass-card" data-stat="signals">
                <div class="stat-icon">
                    <i class="bi bi-flag"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" th:text="${user.signalsCount ?: 0}">0</div>
                    <div class="stat-label">–°–∏–≥–Ω–∞–ª–∏</div>
                </div>
            </div>

            <div class="stat-card glass-card reputation-card" data-stat="reputation">
                <div class="stat-icon">
                    <i class="bi bi-star-fill"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number reputation-score" th:text="${reputationScore ?: 0}">0</div>
                    <div class="stat-label">–†–µ–ø—É—Ç–∞—Ü–∏—è</div>
                </div>
                <div class="reputation-badge">
                    <span class="badge-text" th:text="${reputationBadge ?: '–ù–æ–≤ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª'}">–ù–æ–≤ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MAIN CONTENT TABS -->
<div class="content-section">
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tab-navigation glass-card">
            <button class="tab-btn active" data-tab="overview">
                <i class="bi bi-house-door"></i>
                <span>–ü—Ä–µ–≥–ª–µ–¥</span>
            </button>
            <button class="tab-btn" data-tab="events">
                <i class="bi bi-calendar-event"></i>
                <span>–°—ä–±–∏—Ç–∏—è</span>
                <div class="tab-counter" th:text="${user.userEventsCount ?: 0}">0</div>
            </button>
            <button class="tab-btn" data-tab="publications">
                <i class="bi bi-file-text"></i>
                <span>–ü—É–±–ª–∏–∫–∞—Ü–∏–∏</span>
                <div class="tab-counter" th:text="${user.publicationsCount ?: 0}">0</div>
            </button>
            <button class="tab-btn" data-tab="signals">
                <i class="bi bi-flag"></i>
                <span>–°–∏–≥–Ω–∞–ª–∏</span>
            </button>
            <button class="tab-btn" data-tab="bi-messenger">
                <i class="bi bi-messenger"></i>
                <span>–õ–∏—á–Ω–∏ –°—ä–æ–±—â–µ–Ω–∏—è</span>
            </button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content-container">
            <!-- Overview Tab -->
            <div class="tab-content active" id="overview">
                <div class="row">
                    <!-- Recent Activity -->
                    <div class="col-lg-8">
                        <div class="content-card glass-card">
                            <div class="card-header">
                                <h3><i class="bi bi-clock-history"></i> –ò–∑–≤–µ—Å—Ç–∏—è </h3>
                            </div>
                            <div class="card-body">
                                <div class="activity-timeline">
                                    <div class="timeline-item">
                                        <div class="timeline-marker"></div>
                                        <div class="timeline-content">
                                            <div class="activity-type">–°—ä–∑–¥–∞–¥–µ —Å—ä–±–∏—Ç–∏–µ</div>
                                            <div class="activity-title">–ù–æ–≤–∞ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ –∑–∞ –ø–∞—Ä–∫</div>
                                            <div class="activity-time">–ü—Ä–µ–¥–∏ 2 —á–∞—Å–∞</div>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-marker"></div>
                                        <div class="timeline-content">
                                            <div class="activity-type">–ì–ª–∞—Å—É–≤–∞ –≤ —Ä–µ—Ñ–µ—Ä–µ–Ω–¥—É–º</div>
                                            <div class="activity-title">–†–µ–º–æ–Ω—Ç –Ω–∞ –æ–±—â–∏–Ω—Å–∫–∏ –ø—ä—Ç–∏—â–∞</div>
                                            <div class="activity-time">–ü—Ä–µ–¥–∏ 5 —á–∞—Å–∞</div>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-marker"></div>
                                        <div class="timeline-content">
                                            <div class="activity-type">–ü—É–±–ª–∏–∫—É–≤–∞ —Å—Ç–∞—Ç–∏—è</div>
                                            <div class="activity-title">–ù–æ–≤–∏–Ω–∏ –æ—Ç –æ–±—â–∏–Ω–∞—Ç–∞</div>
                                            <div class="activity-time">–ü—Ä–µ–¥–∏ 1 –¥–µ–Ω</div>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-outline-primary load-more-btn">
                                    <i class="bi bi-arrow-down-circle"></i>
                                    –ü–æ–∫–∞–∂–∏ –ø–æ–≤–µ—á–µ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="col-lg-4">
                        <div class="content-card glass-card">
                            <div class="card-header">
                                <h3><i class="bi bi-graph-up"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                            </div>
                            <div class="card-body">
                                <div class="quick-stats">
                                    <div class="quick-stat-item">
                                        <div class="stat-icon-small">
                                            <i class="bi bi-people"></i>
                                        </div>
                                        <div class="stat-info">
                                            <div class="stat-value">89</div>
                                            <div class="stat-name">–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–∏</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Achievements -->
                        <div class="content-card glass-card">
                            <div class="card-header">
                                <h3><i class="bi bi-trophy"></i> –ü–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>
                            </div>
                            <div class="card-body">
                                <div class="achievements-grid">
                                    <div class="achievement-badge earned">
                                        <i class="bi bi-calendar-check"></i>
                                        <span class="achievement-name">–ü—ä—Ä–≤–æ —Å—ä–±–∏—Ç–∏–µ</span>
                                    </div>
                                    <div class="achievement-badge earned">
                                        <i class="bi bi-hand-thumbs-up"></i>
                                        <span class="achievement-name">10 –≥–ª–∞—Å–∞</span>
                                    </div>
                                    <div class="achievement-badge">
                                        <i class="bi bi-people"></i>
                                        <span class="achievement-name">50 –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è</span>
                                    </div>
                                    <div class="achievement-badge">
                                        <i class="bi bi-star"></i>
                                        <span class="achievement-name">VIP —Å—Ç–∞—Ç—É—Å</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Events Tab -->
            <div class="tab-content" id="events">
                <div class="content-header">
                    <h2>–°—ä–±–∏—Ç–∏—è –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞ </h2>
                    <div class="content-filters">
                        <button class="filter-btn active" data-filter="all">–í—Å–∏—á–∫–∏</button>
                        <button class="filter-btn" data-filter="SIMPLEEVENT">–ü—Ä–æ—Å—Ç–∏ —Å—ä–±–∏—Ç–∏—è</button>
                        <button class="filter-btn" data-filter="REFERENDUM">–†–µ—Ñ–µ—Ä–µ–Ω–¥—É–º–∏</button>
                        <button class="filter-btn" data-filter="MULTI_POLL">–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–∏ –ê–Ω–∫–µ—Ç–∏</button>
                    </div>
                </div>
                <div class="events-grid" id="eventsGrid">
                    <!-- Real events from backend -->
                    <div th:each="event : ${userEvents}" class="event-card glass-card"
                         th:attr="data-event-type=${event.eventType.name()}, data-event-id=${event.id}">
                        <div class="event-image">
                            <img th:src="${event.images != null and !event.images.isEmpty() ? event.images[0] : '/images/eventImages/defaultEvent.png'}"
                                 th:alt="${event.title}"
                                 onerror="this.src='/images/eventImages/defaultEvent.png';">
                            <div class="event-type-badge" th:text="${event.eventType.name() == 'SIMPLEEVENT' ? '–û–ø—Ä–æ—Å—Ç–µ–Ω –í–∏–¥ –°—ä–±–∏—Ç–∏–µ' : (event.eventType.name() == 'REFERENDUM' ? '–†–µ—Ñ–µ—Ä–µ–Ω–¥—É–º' : '–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–∞ –ê–Ω–∫–µ—Ç–∞')}">–°—ä–±–∏—Ç–∏–µ</div>
                        </div>
                        <div class="event-content">
                            <h4 class="event-title" th:text="${event.title}">–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ</h4>
                            <p class="event-description" th:text="${#strings.abbreviate(event.description ?: '–ù—è–º–∞ –æ–ø–∏—Å–∞–Ω–∏–µ', 100)}">–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ...</p>
                            <div class="event-stats">
                                <span><i class="bi bi-people"></i> <span th:text="${event.totalVotes ?: 0}">0</span> –≥–ª–∞—Å–∞</span>
                                <span><i class="bi bi-eye"></i> <span th:text="${event.viewCounter ?: 0}">0</span> –ø—Ä–µ–≥–ª–µ–¥–∞</span>
                            </div>
                        </div>
                    </div>

                    <!-- Empty state -->
                    <div th:if="${#lists.isEmpty(userEvents)}" class="empty-state">
                        <i class="bi bi-calendar-x"></i>
                        <h4>–ù—è–º–∞ —Å—ä–±–∏—Ç–∏—è</h4>
                        <p th:text="${isOwnProfile} ? '–í—Å–µ –æ—â–µ –Ω–µ —Å—Ç–µ —Å—ä–∑–¥–∞–ª–∏ —Å—ä–±–∏—Ç–∏—è.' : '–¢–æ–∑–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª –Ω—è–º–∞ —Å—ä–±–∏—Ç–∏—è.'">–ù—è–º–∞ —Å—ä–±–∏—Ç–∏—è.</p>
                    </div>
                </div>
            </div>

            <!-- Publications Tab -->
            <div class="tab-content" id="publications">
                <div class="content-header">
                    <h2>–ü—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è</h2>
                </div>
                <div class="publications-grid" id="publicationsGrid">
                    <!-- Dynamic content loaded here via JavaScript -->
                    <div class="loading-state" style="display: none;">
                        <i class="bi bi-hourglass-split"></i>
                        <p>–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏...</p>
                    </div>
                    <div class="empty-state" id="publicationsEmpty">
                        <i class="bi bi-file-text"></i>
                        <h4>–ù—è–º–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</h4>
                        <p th:text="${isOwnProfile} ? '–í—Å–µ –æ—â–µ –Ω–µ —Å—Ç–µ –ø—É–±–ª–∏–∫—É–≤–∞–ª–∏ –Ω–∏—â–æ.' : '–¢–æ–∑–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª –Ω—è–º–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.'">–ù—è–º–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.</p>
                    </div>
                </div>
            </div>

            <!-- Signals Tab -->
            <div class="tab-content" id="signals">
                <div class="content-header">
                    <h2>–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏ —Å–∏–≥–Ω–∞–ª–∏</h2>
                </div>
                <div class="signals-grid" id="signalsGrid">
                    <!-- Dynamic content loaded here via JavaScript -->
                    <div class="loading-state" style="display: none;">
                        <i class="bi bi-hourglass-split"></i>
                        <p>–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å–∏–≥–Ω–∞–ª–∏...</p>
                    </div>
                    <div class="empty-state" id="signalsEmpty">
                        <i class="bi bi-flag"></i>
                        <h4>–ù—è–º–∞ —Å–∏–≥–Ω–∞–ª–∏</h4>
                        <p th:text="${isOwnProfile} ? '–í—Å–µ –æ—â–µ –Ω–µ —Å—Ç–µ –ø–æ–¥–∞–ª–∏ —Å–∏–≥–Ω–∞–ª–∏.' : '–¢–æ–∑–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª –Ω—è–º–∞ —Å–∏–≥–Ω–∞–ª–∏.'">–ù—è–º–∞ —Å–∏–≥–Ω–∞–ª–∏.</p>
                    </div>
                </div>
            </div>

            <!-- Activity Tab -->
            <div class="tab-content" id="messenger">
                <div class="content-header">
                    <h2>–õ–∏—á–Ω–∏ —Å—ä–æ–±—â–µ–Ω–∏—è</h2>
                </div>
                <div class="activity-feed" id="messengerFeed">
                    <!-- Dynamic content loaded here via JavaScript -->
                    <div class="empty-state">
                        <i class="bi bi-messenger"></i>
                        <h4>–ù—è–º–∞ —Å—ä–æ–±—â–µ–Ω–∏—è</h4>
                        <p>–°—ä–æ–±—â–µ–Ω–∏—è—Ç–∞ —â–µ —Å–µ –ø–æ–∫–∞–∑–≤–∞ —Ç—É–∫...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div class="modal fade" id="editProfileModal" tabindex="-1" th:if="${isOwnProfile}">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content glass-modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="bi bi-pencil-square"></i>
                    –†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞
                </h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" enctype="multipart/form-data" th:action="@{/profile/update}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="avatar-upload-section">
                                <div class="current-avatar">
                                    <div class="user-avatar profile-avatar avatar-placeholder"
                                         th:attr="data-user-image=${user.imageUrl},data-username=${user.username}">
                                    </div>
                                </div>
                                <div class="upload-controls">
                                    <input type="file" id="profileImage" name="profileImage" accept="image/*" class="d-none">
                                    <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('profileImage').click()">
                                        <i class="bi bi-camera"></i>
                                        –°–º–µ–Ω–∏ —Å–Ω–∏–º–∫–∞
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="form-group">
                                <label class="form-label">–ë–∏–æ–≥—Ä–∞—Ñ–∏—è</label>
                                <textarea class="form-control" name="bio" rows="4" maxlength="240"
                                          th:text="${user.bio}" placeholder="–†–∞–∑–∫–∞–∂–µ—Ç–µ –Ω–µ—â–æ –∑–∞ —Å–µ–±–µ —Å–∏..."></textarea>
                                <div class="form-text">–ú–∞–∫—Å–∏–º—É–º 240 —Å–∏–º–≤–æ–ª–∞</div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">–õ–æ–∫–∞—Ü–∏—è</label>
                                <select class="form-select" name="location" required>
                                    <option value="">–ò–∑–±–µ—Ä–∏ –ª–æ–∫–∞—Ü–∏—è</option>
                                    <option th:each="loc : ${locations}"
                                            th:value="${loc.name()}"
                                            th:text="${loc.toBG()}"
                                            th:selected="${user.location != null and user.location.name() == loc.name()}">
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–∫–∞–∑</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i>
                        –ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Post Detail Modal Fragment -->
<div th:replace="~{fragments/publications-detail-modal :: postModal}"></div>


<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner-ring"></div>
        <div class="loading-text">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>
    </div>
</div>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- User Data for JavaScript -->
<div id="current-user-data" style="display: none;"
     th:if="${currentUser != null}"
     th:data-user-id="${currentUser.id}"
     th:data-username="${currentUser.username}"
     th:data-image-url="${currentUser.imageUrl}"
     th:data-is-own-profile="${isOwnProfile}"></div>




<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–º–µ avatar placeholders
        setTimeout(() => {
            initializeAvatarPlaceholders();
            // –°—ä—â–æ —Ç–∞–∫–∞ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            if (window.avatarUtils) {
                window.avatarUtils.updateAll();
            }
        }, 300);

        if (window.PublicationsManager) {
            window.publicationsManager = new PublicationsManager();
        }

        if (window.PublicationDetailModal) {
            window.publicationModal = new PublicationDetailModal();
        }

        if (window.PostInteractions) {
            window.postInteractions = new PostInteractions();
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –∑–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ avatar placeholders
    function initializeAvatarPlaceholders() {
        document.querySelectorAll('.avatar-placeholder').forEach(placeholder => {
            const imageUrl = placeholder.getAttribute('data-user-image');
            const username = placeholder.getAttribute('data-username');
            const userId = placeholder.getAttribute('data-user-id');
            const size = placeholder.offsetWidth || 40;
            const className = placeholder.className.replace('avatar-placeholder', '').trim();

            if (window.createAvatar && username) {
                // –î–æ–±–∞–≤—è–º–µ user-id –∞—Ç—Ä–∏–±—É—Ç –∞–∫–æ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞
                const avatarHtml = window.createAvatar(imageUrl, username, size, className);
                placeholder.outerHTML = avatarHtml;
            }
        });
    }
</script>

<!-- ====== AUTO OPEN MODAL SCRIPT ====== -->
<script th:if="${autoOpenModal}">
    document.addEventListener('DOMContentLoaded', function() {
        // –ò–∑—á–∞–∫–∞–π –¥–∞ —Å–µ –∑–∞—Ä–µ–¥—è—Ç –≤—Å–∏—á–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
        setTimeout(function() {
            const publicationId = /*[[${modalPublicationId}]]*/ null;

            if (publicationId && window.openPostModal) {
                console.log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ –º–æ–¥–∞–ª –∑–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—è:', publicationId);

                // –û—Ç–≤–æ—Ä–∏ –º–æ–¥–∞–ª–∞ —Å—ä—Å —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∞—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è
                window.openPostModal(publicationId);

                // –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–ª–µ–¥ 3 —Å–µ–∫—É–Ω–¥–∏
                setTimeout(function() {
                    showAutoRedirectNotification();
                }, 3000);
            }
        }, 1500);
    });

    function showAutoRedirectNotification() {
        // –°—ä–∑–¥–∞–π notification –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–µ–Ω–∞—Å–æ—á–≤–∞–Ω–µ
        const notification = document.createElement('div');
        notification.innerHTML = `
        <div style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
                    background: #4cb15c; color: white; padding: 16px 24px;
                    border-radius: 12px; z-index: 10001; font-family: 'Inter', sans-serif;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.2); max-width: 400px; text-align: center;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <i class="bi bi-info-circle" style="font-size: 20px;"></i>
                <div>
                    <div style="font-weight: 600; margin-bottom: 4px;">–°–ø–æ–¥–µ–ª–µ–Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—è</div>
                    <div style="font-size: 14px; opacity: 0.9;">–©–µ –±—ä–¥–µ—Ç–µ –ø—Ä–µ–Ω–∞—Å–æ—á–µ–Ω–∏ –∫—ä–º –ø—É–±–ª–∏–∫–∞—Ü–∏–∏—Ç–µ —Å–ª–µ–¥ 30 —Å–µ–∫—É–Ω–¥–∏</div>
                </div>
            </div>
            <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: center;">
                <button onclick="window.location.href='/publications'"
                        style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
                               color: white; padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer;">
                    –û—Ç–∏–¥–∏ —Å–µ–≥–∞
                </button>
                <button onclick="this.closest('div').style.display='none'"
                        style="background: none; border: 1px solid rgba(255,255,255,0.3);
                               color: white; padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer;">
                    –ó–∞—Ç–≤–æ—Ä–∏
                </button>
            </div>
        </div>
    `;

        document.body.appendChild(notification);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–µ–Ω–∞—Å–æ—á–≤–∞–Ω–µ —Å–ª–µ–¥ 30 —Å–µ–∫—É–Ω–¥–∏
        setTimeout(function() {
            window.location.href = '/publications';
        }, 30000);
    }
</script>
<script th:if="${autoOpenModal}" th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
        const postId = /*[[${modalPublicationId}]]*/ null;
        if (postId && window.openPostModal) {
            setTimeout(() => {
                window.openPostModal(postId);
            }, 500);
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const openModalId = urlParams.get('openModal');

        if (openModalId && window.openPostModal) {
            setTimeout(() => {
                window.openPostModal(openModalId);
            }, 1000);
        }
    });
</script>



<!-- Scripts -->
<div th:replace="~{fragments/bottomHtmlStyles :: bottomStyles}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/userProfile/profile-interactions.js"></script>

<script src="/js/publications/publicationsApi.js"></script>
<script src="/js/publications/postInteractions.js"></script>
<script src="/js/publications/publicationsMain.js"></script>
<script src="/js/publications/publicationDetailModal.js"></script>




</body>
</html>