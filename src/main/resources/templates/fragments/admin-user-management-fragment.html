<!-- Fragment: admin-user-management-fragment.html -->
<!-- Път: src/main/resources/templates/fragments/admin-user-management-fragment.html -->

<div th:fragment="userManagement" class="monitoring-section">
    <h2 class="section-header collapsible-header" data-toggle="user-management">
        <span><i class="bi bi-people-fill"></i> User Management</span>
        <i class="bi bi-chevron-down collapse-icon"></i>
    </h2>

    <div class="collapsible-content" id="user-management">

        <!-- ===== 1. USER STATISTICS DASHBOARD ===== -->
        <div class="user-stats-section">
            <div class="stats-header">
                <h4><i class="bi bi-graph-up-arrow"></i> User Statistics Overview</h4>
                <div class="stats-period" id="user-stats-period">Real-time данни</div>
            </div>

            <div class="user-stats-grid">
                <!-- Total Users Card -->
                <div class="user-stat-card primary">
                    <div class="stat-icon">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="total-users-count">0</div>
                        <div class="stat-label">Общо потребители</div>
                        <div class="stat-change">
                            <span class="change-indicator positive" id="total-users-change">+0</span>
                            <span class="change-period">тази седмица</span>
                        </div>
                    </div>
                </div>

                <!-- Active Users Card -->
                <div class="user-stat-card success">
                    <div class="stat-icon">
                        <i class="bi bi-person-check"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="active-users-count">0</div>
                        <div class="stat-label">Активни потребители</div>
                        <div class="stat-change">
                            <span class="change-indicator" id="active-users-change">0%</span>
                            <span class="change-period">от общо</span>
                        </div>
                    </div>
                </div>

                <!-- Online Users Card -->
                <div class="user-stat-card info">
                    <div class="stat-icon">
                        <i class="bi bi-circle-fill text-success"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="online-users-count">0</div>
                        <div class="stat-label">Онлайн сега</div>
                        <div class="stat-change">
                            <span class="change-indicator" id="online-users-change">0</span>
                            <span class="change-period">последните 5 мин</span>
                        </div>
                    </div>
                </div>

                <!-- New Registrations Card -->
                <div class="user-stat-card warning">
                    <div class="stat-icon">
                        <i class="bi bi-person-plus"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="new-registrations-count">0</div>
                        <div class="stat-label">Нови днес</div>
                        <div class="stat-change">
                            <span class="change-indicator" id="new-registrations-change">0</span>
                            <span class="change-period">седмица: <span id="weekly-registrations">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Role Distribution Card -->
                <div class="user-stat-card admin">
                    <div class="stat-icon">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="admin-users-count">0</div>
                        <div class="stat-label">Администратори</div>
                        <div class="stat-change">
                            <span class="change-indicator" id="regular-users-count">0</span>
                            <span class="change-period">обикновени</span>
                        </div>
                    </div>
                </div>

                <!-- Engagement Score Card -->
                <div class="user-stat-card engagement">
                    <div class="stat-icon">
                        <i class="bi bi-lightning-charge"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="avg-engagement-score">0</div>
                        <div class="stat-label">Средна активност</div>
                        <div class="stat-change">
                            <span class="change-indicator" id="high-activity-users">0</span>
                            <span class="change-period">високо активни</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== 2. ADVANCED USER SEARCH & MANAGEMENT ===== -->
        <div class="user-search-section">
            <div class="search-header">
                <h4><i class="bi bi-search"></i> Advanced User Search & Management</h4>
                <div class="search-actions">
                    <button type="button" class="btn btn-sm btn-outline-success" id="users-refresh-btn">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="export-users-btn">
                        <i class="bi bi-download"></i> Export CSV
                    </button>
                </div>
            </div>

            <!-- Search & Filters -->
            <div class="user-search-controls">
                <div class="search-filters-row">
                    <div class="search-input-wrapper">
                        <input type="text" class="form-control" id="user-search-input"
                               placeholder="Търси по username, email, име...">
                        <i class="bi bi-search search-icon"></i>
                    </div>

                    <select class="form-select" id="role-filter">
                        <option value="">Всички роли</option>
                        <option value="USER">Потребители</option>
                        <option value="ADMIN">Администратори</option>
                    </select>

                    <select class="form-select" id="status-filter">
                        <option value="">Всички статуси</option>
                        <option value="active">Активни</option>
                        <option value="inactive">Неактивни</option>
                        <option value="online">Онлайн</option>
                        <option value="banned">Блокирани</option>
                    </select>

                    <select class="form-select" id="activity-filter">
                        <option value="">Всяка активност</option>
                        <option value="high">Висока активност</option>
                        <option value="medium">Средна активност</option>
                        <option value="low">Ниска активност</option>
                        <option value="inactive">Неактивни</option>
                    </select>
                </div>

                <div class="search-filters-row secondary">
                    <input type="date" class="form-control" id="registration-from"
                           placeholder="От дата">
                    <input type="date" class="form-control" id="registration-to"
                           placeholder="До дата">

                    <button type="button" class="btn btn-outline-secondary" id="clear-filters-btn">
                        <i class="bi bi-x-circle"></i> Изчисти
                    </button>
                </div>
            </div>

            <!-- Bulk Operations Bar -->
            <div class="bulk-operations-bar" id="bulk-operations-bar" style="display: none;">
                <div class="bulk-info">
                    <span id="selected-users-count">0</span> избрани потребители
                </div>
                <div class="bulk-actions">
                    <button type="button" class="btn btn-sm btn-success" id="bulk-promote-btn">
                        <i class="bi bi-arrow-up-circle"></i> Повиши в админ
                    </button>
                    <button type="button" class="btn btn-sm btn-warning" id="bulk-demote-btn">
                        <i class="bi bi-arrow-down-circle"></i> Понижи в потребител
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" id="bulk-ban-btn">
                        <i class="bi bi-ban"></i> Блокирай
                    </button>
                    <button type="button" class="btn btn-sm btn-info" id="bulk-unban-btn">
                        <i class="bi bi-check-circle"></i> Отблокирай
                    </button>
                </div>
            </div>

            <!-- Users Table -->
            <div class="users-table-container">
                <table class="table table-hover users-table" id="users-table">
                    <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" class="form-check-input" id="select-all-users">
                        </th>
                        <th class="sortable" data-column="username" style="width: 150px;">
                            <i class="bi bi-person"></i> Username
                            <i class="bi bi-chevron-down sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="email" style="width: 200px;">
                            <i class="bi bi-envelope"></i> Email
                            <i class="bi bi-chevron-down sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="role" style="width: 100px;">
                            <i class="bi bi-shield"></i> Роля
                            <i class="bi bi-chevron-down sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="status" style="width: 100px;">
                            <i class="bi bi-activity"></i> Статус
                            <i class="bi bi-chevron-down sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="created" style="width: 120px;">
                            <i class="bi bi-calendar"></i> Регистрация
                            <i class="bi bi-chevron-down sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="lastOnline" style="width: 120px;">
                            <i class="bi bi-clock"></i> Последно онлайн
                            <i class="bi bi-chevron-down sort-icon"></i>
                        </th>
                        <th style="width: 80px;">
                            <i class="bi bi-bar-chart"></i> Активност
                        </th>
                        <th style="width: 120px;">
                            <i class="bi bi-gear"></i> Действия
                        </th>
                    </tr>
                    </thead>
                    <tbody id="users-table-body">
                    <!-- JavaScript ще попълни тук -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="users-pagination" id="users-pagination">
                <div class="pagination-info">
                    Показани <span id="users-from">0</span>-<span id="users-to">0</span> от
                    <span id="users-total">0</span> потребители
                </div>
                <div class="pagination-controls">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="prev-page-btn">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <span class="page-info">
                        Страница <span id="current-page">1</span> от <span id="total-pages">1</span>
                    </span>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="next-page-btn">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ===== 3. ROLE MANAGEMENT INTERFACE ===== -->
        <div class="role-management-section">
            <div class="role-header">
                <h4><i class="bi bi-shield-check"></i> Role Management Interface</h4>
                <div class="role-actions">
                    <button type="button" class="btn btn-sm btn-outline-info" id="role-history-btn">
                        <i class="bi bi-clock-history"></i> History
                    </button>
                </div>
            </div>

            <!-- Role Change History -->
            <div class="role-history-container">
                <table class="table table-striped role-history-table" id="role-history-table">
                    <thead>
                    <tr>
                        <th style="width: 150px;">Потребител</th>
                        <th style="width: 100px;">От роля</th>
                        <th style="width: 100px;">Към роля</th>
                        <th style="width: 150px;">Променен от</th>
                        <th style="width: 140px;">Дата</th>
                        <th>Причина</th>
                    </tr>
                    </thead>
                    <tbody id="role-history-body">
                    <!-- JavaScript ще попълни тук -->
                    </tbody>
                </table>
            </div>

            <!-- Permission Matrix -->
            <div class="permission-matrix-container">
                <h5><i class="bi bi-grid-3x3"></i> Permission Matrix Visualization</h5>
                <div class="permissions-grid">
                    <div class="permission-category">
                        <h6>Content Management</h6>
                        <div class="permission-items">
                            <div class="permission-item">
                                <span class="permission-name">Създава публикации</span>
                                <div class="permission-roles">
                                    <span class="role-badge user">USER</span>
                                    <span class="role-badge admin">ADMIN</span>
                                </div>
                            </div>
                            <div class="permission-item">
                                <span class="permission-name">Изтрива публикации</span>
                                <div class="permission-roles">
                                    <span class="role-badge admin">ADMIN</span>
                                </div>
                            </div>
                            <div class="permission-item">
                                <span class="permission-name">Модерира коментари</span>
                                <div class="permission-roles">
                                    <span class="role-badge admin">ADMIN</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="permission-category">
                        <h6>User Management</h6>
                        <div class="permission-items">
                            <div class="permission-item">
                                <span class="permission-name">Блокира потребители</span>
                                <div class="permission-roles">
                                    <span class="role-badge admin">ADMIN</span>
                                </div>
                            </div>
                            <div class="permission-item">
                                <span class="permission-name">Повишава роли</span>
                                <div class="permission-roles">
                                    <span class="role-badge admin">ADMIN</span>
                                </div>
                            </div>
                            <div class="permission-item">
                                <span class="permission-name">Вижда admin panel</span>
                                <div class="permission-roles">
                                    <span class="role-badge admin">ADMIN</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="permission-category">
                        <h6>System Access</h6>
                        <div class="permission-items">
                            <div class="permission-item">
                                <span class="permission-name">Reports management</span>
                                <div class="permission-roles">
                                    <span class="role-badge admin">ADMIN</span>
                                </div>
                            </div>
                            <div class="permission-item">
                                <span class="permission-name">Activity monitoring</span>
                                <div class="permission-roles">
                                    <span class="role-badge admin">ADMIN</span>
                                </div>
                            </div>
                            <div class="permission-item">
                                <span class="permission-name">System metrics</span>
                                <div class="permission-roles">
                                    <span class="role-badge admin">ADMIN</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ===== USER MANAGEMENT MODALS ===== -->
<div th:fragment="userModals">

    <!-- User Details Modal -->
    <div class="modal fade" id="user-details-modal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-circle"></i> Детайли за потребителя
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="user-details-content">

                        <!-- User Profile Section -->
                        <div class="detail-section">
                            <h6><i class="bi bi-person-vcard"></i> Профилна информация</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="user-avatar-section">
                                        <img id="modal-user-avatar" src="" alt="User Avatar" class="user-avatar">
                                        <div class="user-status-indicator" id="modal-user-status"></div>
                                    </div>
                                </div>
                                <div class="col-md-9">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Username:</strong> <span id="modal-user-username">-</span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Email:</strong> <span id="modal-user-email">-</span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Роля:</strong> <span id="modal-user-role">-</span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Статус:</strong> <span id="modal-user-status-text">-</span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Регистрация:</strong> <span id="modal-user-registration">-</span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Последно онлайн:</strong> <span id="modal-user-last-online">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Activity Stats Section -->
                        <div class="detail-section">
                            <h6><i class="bi bi-graph-up"></i> Статистики за активност</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="activity-stat">
                                        <div class="stat-number" id="modal-user-publications">0</div>
                                        <div class="stat-label">Публикации</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="activity-stat">
                                        <div class="stat-number" id="modal-user-comments">0</div>
                                        <div class="stat-label">Коментари</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="activity-stat">
                                        <div class="stat-number" id="modal-user-votes">0</div>
                                        <div class="stat-label">Гласувания</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="activity-stat">
                                        <div class="stat-number" id="modal-user-events">0</div>
                                        <div class="stat-label">Събития</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity Section -->
                        <div class="detail-section">
                            <h6><i class="bi bi-clock-history"></i> Последна активност</h6>
                            <div class="recent-activity-list" id="modal-user-recent-activity">
                                <!-- JavaScript ще попълни тук -->
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Затвори</button>
                    <button type="button" class="btn btn-warning" id="modal-ban-user-btn">
                        <i class="bi bi-ban"></i> Блокирай
                    </button>
                    <button type="button" class="btn btn-success" id="modal-promote-user-btn">
                        <i class="bi bi-arrow-up-circle"></i> Повиши роля
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ban User Modal -->
    <div class="modal fade" id="ban-user-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-ban text-danger"></i> Блокиране на потребител
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="ban-user-form">
                        <p class="text-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Сигурни ли сте че искате да блокирате потребителя?
                        </p>

                        <div class="mb-3">
                            <label class="form-label">Тип блокиране:</label>
                            <select class="form-select" id="ban-type-select">
                                <option value="temporary">Временно блокиране</option>
                                <option value="permanent">Постоянно блокиране</option>
                            </select>
                        </div>

                        <div class="mb-3" id="ban-duration-section">
                            <label class="form-label">Продължителност:</label>
                            <select class="form-select" id="ban-duration-select">
                                <option value="1">1 ден</option>
                                <option value="3">3 дни</option>
                                <option value="7">1 седмица</option>
                                <option value="30">1 месец</option>
                                <option value="custom">Персонализиран период</option>
                            </select>
                        </div>

                        <div class="mb-3" id="custom-ban-date-section" style="display: none;">
                            <label class="form-label">До дата:</label>
                            <input type="date" class="form-control" id="custom-ban-date">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Причина за блокиране:</label>
                            <select class="form-select" id="ban-reason-select">
                                <option value="spam">Спам</option>
                                <option value="inappropriate">Неподходящо съдържание</option>
                                <option value="harassment">Тормоз</option>
                                <option value="fake_account">Фалшив акаунт</option>
                                <option value="violation">Нарушение на правилата</option>
                                <option value="other">Друго</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Допълнителни бележки:</label>
                            <textarea class="form-control" id="ban-notes" rows="3"
                                      placeholder="Опционални допълнителни бележки..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отказ</button>
                    <button type="button" class="btn btn-danger" id="confirm-ban-btn">
                        <i class="bi bi-ban"></i> Блокирай потребителя
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Role Change Modal -->
    <div class="modal fade" id="role-change-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-arrow-up-circle text-success"></i> Промяна на роля
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="role-change-form">
                        <p class="text-info">
                            <i class="bi bi-info-circle"></i>
                            Променяте ролята на потребителя
                        </p>

                        <div class="mb-3">
                            <label class="form-label">Нова роля:</label>
                            <select class="form-select" id="new-role-select">
                                <option value="USER">Потребител</option>
                                <option value="ADMIN">Администратор</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Причина за промяната:</label>
                            <textarea class="form-control" id="role-change-reason" rows="3"
                                      placeholder="Обяснете защо променяте ролята..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отказ</button>
                    <button type="button" class="btn btn-success" id="confirm-role-change-btn">
                        <i class="bi bi-check-circle"></i> Потвърди промяната
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>