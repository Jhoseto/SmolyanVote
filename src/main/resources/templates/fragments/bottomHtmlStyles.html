<div th:fragment="bottomStyles">
    <!-- ПЪРВО authentication check -->
    <script th:inline="javascript">
        window.isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
    </script>

    <!-- ✅ Cookie Consent Configuration -->
    <script>
        // Конфигурация за Cookie Consent Core
        window.cookieConsentConfig = {
            cookieName: 'smolyanvote_cookie_consent',
            cookieExpiry: 397, // 13 месеца
            cookiePath: '/',
            cookieSameSite: 'Lax',
            cookieSecure: window.location.protocol === 'https:' || 
                         window.location.hostname === 'localhost' ||
                         window.location.hostname === '127.0.0.1',
            debug: true // Поставяне на true за debugging
        };

        // Конфигурация за Google Consent Mode
        window.googleConsentConfig = {
            gtagId: 'G-9G3Y2XM1JE',
            loadAnalyticsOnConsent: true, // Динамично зареждане след съгласие
            debug: true
        };

        // Конфигурация за Cookie Consent UI
        window.cookieConsentUIConfig = {
            bannerId: 'cookie-consent-banner',
            modalId: 'cookie-consent-modal',
            showBannerOnLoad: true,
            debug: true
        };
    </script>

    <!-- ✅ Cookie Consent Modules (зареждане в правилния ред) -->
    <script src="/js/cookie-consent/cookie-consent-core.js"></script>
    <script src="/js/cookie-consent/google-consent-mode.js"></script>
    <script src="/js/cookie-consent/cookie-consent-ui.js"></script>

    <!-- ✅ Cookie Consent HTML Fragments -->
    <div th:replace="~{fragments/cookieConsent :: cookieConsentBanner}"></div>
    <div th:replace="~{fragments/cookieConsent :: cookieConsentModal}"></div>

    <!-- ✅ Инициализация на Cookie Consent системата -->
    <script>
        // Инициализация след като всички модули са заредени
        (function() {
            function initCookieConsent() {
                // Проверка дали всички модули са заредени
                if (!window.CookieConsentCore || !window.GoogleConsentMode || !window.CookieConsentUI) {
                    return false;
                }

                // Създаване на CookieConsentCore инстанция ПЪРВО
                if (!window.cookieConsent) {
                    window.cookieConsent = new window.CookieConsentCore(window.cookieConsentConfig);
                }

                // Създаване на GoogleConsentMode инстанция ВТОРО
                if (!window.googleConsentMode) {
                    window.googleConsentMode = new window.GoogleConsentMode(window.googleConsentConfig);
                }

                // Създаване на CookieConsentUI инстанция ТРЕТО (след като Core е готов)
                if (!window.cookieConsentUI) {
                    // Малко забавяне за да се гарантира че HTML фрагментите са рендерирани
                    setTimeout(function() {
                        if (!window.cookieConsentUI) {
                            window.cookieConsentUI = new window.CookieConsentUI(window.cookieConsentUIConfig);
                        }
                    }, 100);
                }

                return true;
            }

            // Опит за инициализация веднага ако DOM е готов
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    // Опитваме се няколко пъти за да сме сигурни че всички скриптове са заредени
                    let attempts = 0;
                    const maxAttempts = 10;
                    const checkInterval = setInterval(function() {
                        attempts++;
                        if (initCookieConsent() || attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                        }
                    }, 100);
                });
            } else {
                // DOM вече е готов
                let attempts = 0;
                const maxAttempts = 10;
                const checkInterval = setInterval(function() {
                    attempts++;
                    if (initCookieConsent() || attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                    }
                }, 100);
            }
        })();
    </script>

    <script src="/js/utils/avatarUtils.js"></script>
    <script src="/js/footer.js"></script>

    <!-- Проста универсална инициализация за аватари -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Стандартна avatarUtils инициализация
                if (window.avatarUtils) {
                    window.avatarUtils.updateAll();
                }
            }, 300);
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- ⭐  SockJS за WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>

    <!-- CSRF Protection (преди notifications) -->
    <script src="/js/utils/csrf.js"></script>

    <!-- Notifications СЛЕД SockJS и CSRF -->
    <script src="/js/notifications.js"></script>

    <!-- Mobile Menu -->
    <script src="/js/mobile-menu.js"></script>
    
    <!-- SVMessenger Widget (винаги на последно място) -->
    <div th:replace="~{fragments/svMessengerWidget :: svMessengerWidget}"></div>
</div>