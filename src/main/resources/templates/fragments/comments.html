<!-- @thymesVar id="eventId" type="java.lang.Long" -->
<!-- @thymesVar id="comments" type="java.util.List<smolyanVote.smolyanVote.models.CommentsEntity>" -->
<!-- @thymesVar id="currentUser" type="smolyanVote.smolyanVote.models.UserEntity" -->
<!-- @thymesVar id="comment" type="smolyanVote.smolyanVote.models.CommentsEntity" -->
<!-- @thymesVar id="reply" type="smolyanVote.smolyanVote.models.CommentsEntity" -->

<div th:fragment="comments(targetId, comments, currentUser)">
    <div class="container mt-5" id="comments-section" th:data-event-id="${targetId}">
        <h3 class="mb-4">–ö–æ–º–µ–Ω—Ç–∞—Ä–∏</h3>

        <!-- –§–æ—Ä–º–∞ –∑–∞ –Ω–æ–≤ –∫–æ–º–µ–Ω—Ç–∞—Ä -->
        <form id="comment-form" action="javascript:void(0);" method="post">
            <input type="hidden" name="targetId" th:value="${targetId}" />
            <input type="hidden" name="author" th:value="${currentUser.getUsername()}" />
            <input type="hidden" name="text" id="comment-hidden" />


            <div class="mb-3 d-flex align-items-center comment-header">
                <img th:src="${currentUser.getImageUrl()}" alt="–°–Ω–∏–º–∫–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è" class="user-img rounded-circle me-3" />
                <div class="comment-author" th:text="${currentUser.getUsername()}">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª</div>
            </div>

            <!-- Quill —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
            <div id="editor-container" style="height: 150px;"></div>

            <button type="submit" class="btn btn-primary mt-2">–ü—É–±–ª–∏–∫—É–≤–∞–π</button>
        </form>

        <hr />

        <!-- –°–ø–∏—Å—ä–∫ —Å –∫–æ–º–µ–Ω—Ç–∞—Ä–∏ -->
        <div id="comment-list">
            <div th:each="comment : ${comments}" th:id="'comment-' + ${comment.id}" class="comment-box">
                <div class="comment-header mb-2 d-flex align-items-center">
                    <img th:src="${comment.getAuthorImage()}" alt="–°–Ω–∏–º–∫–∞" class="rounded-circle me-3 comment-img" />
                    <div>
                        <div class="comment-author fw-bold" th:text="${comment.author}">–ê–≤—Ç–æ—Ä</div>
                        <small th:text="${comment.getCreatedAt() != null ? #dates.format(comment.getCreatedAt(), 'dd.MM.yyyy / HH:mm') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ –¥–∞—Ç–∞'}">–î–∞—Ç–∞</small>
                    </div>
                </div>

                <div class="comment-text" th:utext="${comment.text}">–¢–µ–∫—Å—Ç</div>

                <!-- –ë—É—Ç–æ–Ω –∑–∞ –æ—Ç–≥–æ–≤–æ—Ä -->
                <button class="btn btn-sm btn-outline-secondary reply-btn mt-2" th:data-id="${comment.id}">–ù–∞–ø–∏—à–∏ –æ—Ç–≥–æ–≤–æ—Ä</button>

                <!-- Like/Dislike -->
                <div class="mt-2 d-flex align-items-center gap-3">
                    <button class="btn btn-sm like-btn" th:data-id="${comment.id}" data-type="like">
                        üëç <span th:text="${comment.getLikeCount()}">0</span>
                    </button>
                    <button class="btn btn-sm dislike-btn" th:data-id="${comment.id}" data-type="dislike">
                        üëé <span th:text="${comment.getUnlikeCount()}">0</span>
                    </button>
                </div>

                <!-- –§–æ—Ä–º–∞ –∑–∞ –æ—Ç–≥–æ–≤–æ—Ä -->
                <form class="reply-form mt-3 d-none" th:id="'reply-form-' + ${comment.id}" data-bound="false">
                    <input type="hidden" name="targetId" th:value="${targetId}" />
                    <input type="hidden" name="parentId" th:value="${comment.id}" />
                    <input type="hidden" name="author" th:value="${currentUser.username}" />

                    <textarea name="text" placeholder="–û—Ç–≥–æ–≤–æ—Ä..." class="form-control form-control-sm mb-2" rows="2" required></textarea>
                    <button type="submit" class="btn btn-sm btn-primary">–ò–∑–ø—Ä–∞—Ç–∏</button>
                </form>

                <!-- –ü–æ–¥–∫–æ–º–µ–Ω—Ç–∞—Ä–∏ -->
                <div class="replies ms-4 mt-3" th:id="'replies-container-' + ${comment.id}">
                    <div class="replies-list" style="display: none;">
                        <div th:each="reply : ${comment.replies}" class="reply-box mb-2">
                            <div class="d-flex align-items-start">
                                <img th:src="${reply.getAuthorImage()}" alt="–°–Ω–∏–º–∫–∞" class="rounded-circle me-2 reply-img mt-1" />
                                <div>
                                    <div class="comment-author fw-bold" th:text="${reply.author}">–ê–≤—Ç–æ—Ä</div>
                                    <div class="reply-text" th:utext="${reply.text}">–¢–µ–∫—Å—Ç</div>
                                    <small th:text="${reply.getCreatedAt() != null ? #dates.format(reply.getCreatedAt(), 'dd.MM.yyyy / HH:mm') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ –¥–∞—Ç–∞'}">–î–∞—Ç–∞</small>
                                    <div class="mt-1 d-flex align-items-center gap-2">
                                        <button class="btn btn-sm like-btn" th:data-id="${reply.id}" data-type="like">
                                            üëç <span th:text="${reply.getLikeCount()}">0</span>
                                        </button>
                                        <button class="btn btn-sm dislike-btn" th:data-id="${reply.id}" data-type="dislike">
                                            üëé <span th:text="${reply.getUnlikeCount()}">0</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –ë—É—Ç–æ–Ω –∑–∞ –ø–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏ -->
                    <div class="text-center mt-2">
                        <button
                                th:if="${#lists.size(comment.replies) > 0}"
                                th:text="'–ü–æ–∫–∞–∂–∏ –≤—Å–∏—á–∫–∏ (' + ${#lists.size(comment.replies)} + ') –æ—Ç–≥–æ–≤–æ—Ä–∏'"
                                class="show-replies-btn"
                                style="background: none; border: none; color: #4d4d4d; padding: 0; font-size: 0.9rem; cursor: pointer; text-decoration: underline; display: none;">
                            –ü–æ–∫–∞–∂–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
