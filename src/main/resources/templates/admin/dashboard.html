<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - SmolyanVote</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <div th:replace="~{fragments/topHtmlStyles :: navbarStyles}"></div>
    <link rel="stylesheet" href="/css/admin-dashboard.css">
    <link rel="stylesheet" href="/css/admin-activity-wall.css">
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="admin-container">
    <div class="admin-header">
        <h1><i class="bi bi-gear-fill"></i> Admin Dashboard</h1>
        <p>SmolyanVote system</p>
        <h3><i class="bi bi-clock"></i> Last Refresh</h3>
        <p>Updated: <span class="last-refresh">--</span></p>
        <button id="refresh-btn" class="btn btn-outline-success btn-sm">
            <i class="bi bi-arrow-clockwise"></i> Обнови данни
        </button>
    </div>

    <!-- ОСНОВНИ СИСТЕМНИ СТАТУСИ -->
    <div class="monitoring-section">
        <h2 class="section-header" data-toggle="system-status">
            <i class="bi bi-activity"></i> Health Status
            <i class="bi bi-chevron-down collapse-icon"></i>
        </h2>
        <div class="dashboard-grid collapsible-content" id="system-status">
            <div class="dashboard-card">
                <h3><i class="bi bi-heart-pulse"></i> Общо здраве</h3>
                <p>Status: <span id="health-status" class="status-active">--</span></p>
                <p>Uptime: <span id="uptime">--</span> мин</p>
            </div>

            <div class="dashboard-card">
                <h3><i class="bi bi-database"></i> База данни</h3>
                <p>Връзка: <span id="db-status">--</span></p>
                <p>Active connections: <strong id="db-active-connections">--</strong></p>
                <p>Pending: <strong id="db-pending-connections">--</strong></p>
            </div>

            <div class="dashboard-card">
                <h3><i class="bi bi-cloud"></i> Cloudinary</h3>
                <p>Service: <span id="cloudinary-status">--</span></p>
                <p>Cloud: <span id="cloudinary-name">--</span></p>
            </div>

            <div class="dashboard-card">
                <h3><i class="bi bi-envelope"></i> Email Service</h3>
                <p>Service: <span id="email-status">--</span></p>
                <p>Host: <span id="email-host">--</span></p>
            </div>
        </div>
    </div>

    <!-- PERFORMANCE METRICS -->
    <div class="monitoring-section">
        <h2 class="section-header" data-toggle="performance-metrics">
            <i class="bi bi-speedometer2"></i> Performance Metrics
            <i class="bi bi-chevron-down collapse-icon"></i>
        </h2>
        <div class="dashboard-grid collapsible-content collapsed" id="performance-metrics">
            <div class="dashboard-card">
                <h3><i class="bi bi-cpu"></i> CPU & Memory</h3>
                <p>CPU Usage: <strong id="cpu-usage">--</strong>%</p>
                <p>Memory Used: <strong id="memory-used">--</strong>MB / <strong id="memory-max">--</strong>MB</p>
                <p>Usage: <strong id="memory-usage-percent">--</strong>%</p>
            </div>

            <div class="dashboard-card">
                <h3><i class="bi bi-graph-up"></i> Response Times</h3>
                <p>Avg Response: <strong id="avg-response-time">--</strong>ms</p>
                <p>Requests/sec: <strong id="requests-per-second">--</strong></p>
                <p>Error Rate: <strong id="error-rate">--</strong>%</p>
            </div>

            <div class="dashboard-card">
                <h3><i class="bi bi-hdd"></i> Disk & Storage</h3>
                <p>Disk Usage: <strong id="disk-usage-percent">--</strong>%</p>
                <p>Free Space: <strong id="disk-free-space">--</strong>GB</p>
            </div>

            <div class="dashboard-card">
                <h3><i class="bi bi-diagram-3"></i> JVM Threads</h3>
                <p>Live Threads: <strong id="threads-live">--</strong></p>
                <p>Peak Threads: <strong id="threads-peak">--</strong></p>
            </div>
        </div>
    </div>

    <!-- HTTP STATUS MONITORING -->
    <div class="monitoring-section">
        <h2 class="section-header" data-toggle="http-monitoring">
            <i class="bi bi-bar-chart"></i> HTTP Status Monitoring
            <i class="bi bi-chevron-down collapse-icon"></i>
        </h2>
        <div class="dashboard-grid collapsible-content collapsed" id="http-monitoring">
            <div class="dashboard-card">
                <h3><i class="bi bi-check-circle text-success"></i> Success Responses</h3>
                <p>HTTP 200: <strong id="http-200">--</strong></p>
            </div>

            <div class="dashboard-card">
                <h3><i class="bi bi-exclamation-triangle text-warning"></i> Client Errors</h3>
                <p>HTTP 404: <strong id="http-404">--</strong></p>
            </div>

            <div class="dashboard-card">
                <h3><i class="bi bi-x-circle text-danger"></i> Server Errors</h3>
                <p>HTTP 500: <strong id="http-500">--</strong></p>
            </div>

            <div class="dashboard-card">
                <h3><i class="bi bi-exclamation-circle"></i> Total Errors</h3>
                <p>Total: <strong id="total-errors">--</strong></p>
            </div>
        </div>
    </div>


    <!-- REPORTS MANAGEMENT  -->
    <div class="monitoring-section">
        <h2 class="section-header" data-toggle="reports-management">
            <span><i class="bi bi-flag"></i> Reports Management</span>
            <i class="bi bi-chevron-down collapse-icon"></i>
        </h2>
        <div class="collapsible-content" id="reports-management">

            <!-- Professional Header -->
            <div class="reports-management-header">
                <div class="reports-stats">
                    <div class="stat-item">
                        <i class="bi bi-hourglass-split" style="color: #d97706;"></i>
                        <span>Pending: <strong id="reports-pending-count">--</strong></span>
                    </div>
                    <div class="stat-item">
                        <i class="bi bi-bar-chart" style="color: #3b82f6;"></i>
                        <span>Total: <strong id="reports-total-count">--</strong></span>
                    </div>
                </div>
                <div class="reports-actions">
                    <button id="reports-refresh-btn" class="btn btn-sm btn-outline-success">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                    <button id="mark-reviewed-btn" class="btn btn-sm btn-success" disabled>
                        <i class="bi bi-check"></i> Mark Reviewed
                    </button>
                    <button id="delete-reports-btn" class="btn btn-sm btn-danger" disabled>
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>

            <!-- Professional Reports Table -->
            <div class="reports-table-container">
                <table id="reports-table" class="table">
                    <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="select-all-reports">
                        </th>
                        <th class="sortable" data-column="entityType" style="width: 120px;">
                            Тип
                        </th>
                        <th class="sortable" data-column="reportCount" style="width: 100px;">
                            Брой репорти
                        </th>
                        <th class="sortable" data-column="numberOfReporters" style="width: 150px;">
                            Докладвачи
                        </th>
                        <th style="width: 200px;">
                            Описание
                        </th>
                        <th class="sortable" data-column="mostCommonReason" style="width: 150px;">
                            Най-честа причина
                        </th>
                        <th class="sortable" data-column="status" style="width: 100px;">
                            Статус
                        </th>
                        <th class="sortable" data-column="lastReportDate" style="width: 140px;">
                            Дата
                        </th>
                        <th style="width: 100px;">
                            Действия
                        </th>
                    </tr>
                    </thead>
                    <tbody id="reports-table-body">
                    <!-- JavaScript ще попълни тук -->
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <!-- ====== ACTIVITY WALL SECTION ====== -->
    <div class="monitoring-section">
        <h2 class="section-header collapsible-header" data-toggle="activity-wall">
            <span><i class="bi bi-activity"></i> Real-time Activity Wall</span>
            <i class="bi bi-chevron-down collapse-icon"></i>
        </h2>

        <div class="collapsible-content" id="activity-wall">

            <!-- Activity Header with Stats and Controls -->
            <div class="activity-wall-header">
                <div class="activity-stats">
                    <div class="stat-item">
                        <i class="bi bi-list-ul"></i>
                        <span>Общо: <strong id="total-activities">0</strong></span>
                    </div>
                    <div class="stat-item">
                        <i class="bi bi-funnel"></i>
                        <span>Филтрирани: <strong id="filtered-activities">0</strong></span>
                    </div>
                    <div class="stat-item">
                        <i class="bi bi-clock"></i>
                        <span>Последна: <strong id="last-activity-time">--</strong></span>
                    </div>
                    <div class="stat-item">
                        <i class="bi bi-people"></i>
                        <span>Онлайн: <strong id="stats-online-users">0</strong></span>
                    </div>
                </div>

                <div class="activity-controls">
                    <div id="liveIndicator" class="live-indicator">
                        <div class="live-dot"></div>
                        <span>Live</span>
                    </div>

                    <button id="activity-pause-btn" class="btn btn-sm btn-warning">
                        <i class="bi bi-pause-fill"></i> Пауза
                    </button>

                    <button id="refresh-activities-btn" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>

                    <button id="auto-scroll-btn" class="btn btn-sm btn-outline-secondary active" title="Автоматично скролиране">
                        <i class="bi bi-arrow-down-circle"></i>
                    </button>

                    <button id="scroll-to-top-btn" class="btn btn-sm btn-outline-secondary" title="Към началото">
                        <i class="bi bi-arrow-up-circle"></i>
                    </button>

                    <button id="activity-clear-btn" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash"></i> Изчисти
                    </button>

                    <button id="activity-export-btn" class="btn btn-sm btn-success">
                        <i class="bi bi-download"></i> Експорт
                    </button>
                </div>
            </div>

            <!-- Advanced Statistics Dashboard -->
            <div class="activity-stats-dashboard">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6><i class="bi bi-clock me-2"></i>Последният час</h6>
                            </div>
                            <div class="stats-card-body">
                                <div class="stats-number" id="stats-last-hour">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6><i class="bi bi-calendar-day me-2"></i>Днес</h6>
                            </div>
                            <div class="stats-card-body">
                                <div class="stats-number" id="stats-today">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6><i class="bi bi-graph-up me-2"></i>Типове съдържание</h6>
                            </div>
                            <div class="stats-card-body" id="entity-type-chart">
                                <div class="text-muted">Зареждане...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6><i class="bi bi-pie-chart me-2"></i>Категории действия</h6>
                            </div>
                            <div class="stats-card-body" id="action-category-chart">
                                <div class="text-muted">Зареждане...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6><i class="bi bi-bar-chart me-2"></i>Активности по часове</h6>
                            </div>
                            <div class="stats-card-body" id="hourly-activity-chart">
                                <div class="text-muted">Зареждане...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6><i class="bi bi-people me-2"></i>Топ потребители</h6>
                            </div>
                            <div class="stats-card-body" id="top-users-chart">
                                <div class="text-muted">Зареждане...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6><i class="bi bi-trophy me-2"></i>Топ 5 потребители</h6>
                            </div>
                            <div class="stats-card-body" id="top-users-list">
                                <div class="text-muted">Зареждане...</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="stats-card">
                            <div class="stats-card-header">
                                <h6><i class="bi bi-lightning me-2"></i>Топ 5 действия</h6>
                            </div>
                            <div class="stats-card-body" id="top-actions-list">
                                <div class="text-muted">Зареждане...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Filters -->
            <div class="activity-filters">
                <!-- Basic Type Filters -->
                <div class="filter-group">
                    <label class="filter-label">Тип:</label>
                    <button class="activity-filter-btn active" data-filter="create">Създаване</button>
                    <button class="activity-filter-btn active" data-filter="interact">Взаимодействие</button>
                    <button class="activity-filter-btn active" data-filter="moderate">Модерация</button>
                    <button class="activity-filter-btn active" data-filter="auth">Автентикация</button>
                    <button class="activity-filter-btn active" data-filter="other">Други</button>
                </div>

                <!-- Entity Type Filter -->
                <div class="filter-group">
                    <label class="filter-label" for="entity-type-filter">Съдържание:</label>
                    <select id="entity-type-filter" class="form-select form-select-sm">
                        <option value="">Всички типове</option>
                    </select>
                </div>

                <!-- Action Category Filter -->
                <div class="filter-group">
                    <label class="filter-label" for="action-category-filter">Действие:</label>
                    <select id="action-category-filter" class="form-select form-select-sm">
                        <option value="">Всички действия</option>
                    </select>
                </div>

                <!-- Date Range Filter -->
                <div class="filter-group">
                    <label class="filter-label" for="date-range-filter">Период:</label>
                    <select id="date-range-filter" class="form-select form-select-sm">
                        <option value="">Всички периоди</option>
                    </select>
                </div>

                <!-- Custom Date Range -->
                <div class="filter-group">
                    <label class="filter-label">От:</label>
                    <input type="datetime-local" id="custom-date-start" class="form-control form-control-sm">
                    <label class="filter-label">До:</label>
                    <input type="datetime-local" id="custom-date-end" class="form-control form-control-sm">
                </div>

                <!-- User Filter -->
                <div class="filter-group">
                    <label class="filter-label" for="activity-user-filter">Потребител:</label>
                    <div class="input-group input-group-sm">
                        <input type="text" id="activity-user-filter" class="form-control" placeholder="Търси потребител...">
                        <button id="clear-user-filter" class="btn btn-outline-secondary" type="button" style="display: none;">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>

                <!-- IP Filter -->
                <div class="filter-group">
                    <label class="filter-label" for="ip-filter">IP адрес:</label>
                    <div class="input-group input-group-sm">
                        <input type="text" id="ip-filter" class="form-control" placeholder="Търси IP...">
                        <button id="clear-ip-filter" class="btn btn-outline-secondary" type="button" style="display: none;">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>

                <!-- Clear All Filters -->
                <div class="filter-group">
                    <button id="clear-all-filters-btn" class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-funnel"></i> Изчисти филтрите
                    </button>
                </div>
            </div>

            <!-- Activity Stream Table -->
            <div class="activity-stream-container">
                <div class="table-responsive">
                    <table class="table table-hover activity-stream-table">
                        <thead class="table-dark sticky-top">
                        <tr>
                            <th style="width: 120px;">Време</th>
                            <th style="width: 50px;">Тип</th>
                            <th style="width: 180px;">Потребител</th>
                            <th style="width: 200px;">Действие</th>
                            <th>Детайли</th>
                            <th style="width: 130px;">IP адрес</th>
                        </tr>
                        </thead>
                        <tbody id="activity-stream-body">
                        <tr>
                            <td colspan="6" class="text-center activity-loading">
                                <i class="bi bi-arrow-clockwise spin"></i>
                                <div>Зареждане на активности...</div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- Activity Details Modal -->
    <div class="modal fade" id="activity-details-modal" tabindex="-1" aria-labelledby="activityDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="activityDetailsModalLabel">
                        <i class="bi bi-info-circle me-2"></i>Детайли за активност
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">ID:</label>
                                <div id="modal-activity-id" class="form-control-plaintext">--</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Време:</label>
                                <div id="modal-activity-time" class="form-control-plaintext">--</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Потребител:</label>
                                <div id="modal-activity-user" class="form-control-plaintext">--</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Действие:</label>
                                <div id="modal-activity-action" class="form-control-plaintext">--</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Тип съдържание:</label>
                                <div id="modal-activity-entity-type" class="form-control-plaintext">--</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">ID на съдържанието:</label>
                                <div id="modal-activity-entity-id" class="form-control-plaintext">--</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">IP адрес:</label>
                                <div id="modal-activity-ip" class="form-control-plaintext">--</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Детайли:</label>
                        <div id="modal-activity-details" class="form-control-plaintext border p-2 bg-light">--</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">User Agent:</label>
                        <div id="modal-activity-user-agent" class="form-control-plaintext border p-2 bg-light text-break">--</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="copy-activity-details" class="btn btn-outline-primary">
                        <i class="bi bi-clipboard me-2"></i>Копирай детайлите
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Затвори</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!--imports -->
<script src="/js/admin/admin-dashboard.js"></script>
<script src="/js/admin/reports.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>

<!-- Activity Wall -->
<script src="/js/admin/activityWall/activity-wall-utils.js"></script>
<script src="/js/admin/activityWall/activity-wall.js"></script>
<script src="/js/admin/activityWall/activity-wall-advanced.js"></script>

<!-- Bottom Styles -->
<div th:replace="~{fragments/bottomHtmlStyles :: bottomStyles}"></div>

</body>
</html>